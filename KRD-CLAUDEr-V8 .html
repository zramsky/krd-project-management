<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Kelly Ram Designs - Project Management System v8 (GitHub Tracked)</title>
    <!-- html2pdf library for PDF generation -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.10.1/html2pdf.bundle.min.js"></script>
    
    <!-- Firebase SDKs -->
    <script type="module">
        // Import the functions you need from the SDKs you need
        import { initializeApp } from "https://www.gstatic.com/firebasejs/12.1.0/firebase-app.js";
        import { getFirestore, collection, doc, setDoc, getDoc, getDocs, updateDoc, deleteDoc, onSnapshot } from "https://www.gstatic.com/firebasejs/12.1.0/firebase-firestore.js";

        // Your web app's Firebase configuration
        const firebaseConfig = {
            apiKey: "AIzaSyACBu_uzIh-gdJV1yNdczDNLaVjkCkwci4",
            authDomain: "kellyramdesigns-498af.firebaseapp.com",
            projectId: "kellyramdesigns-498af",
            storageBucket: "kellyramdesigns-498af.firebasestorage.app",
            messagingSenderId: "768167199138",
            appId: "1:768167199138:web:b7a99cb9ef2dd2fba9f2fb"
        };

        // Initialize Firebase
        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);
        
        // Make Firebase functions available globally
        window.firebaseApp = app;
        window.firestore = db;
        window.firestoreFunctions = {
            collection,
            doc,
            setDoc,
            getDoc,
            getDocs,
            updateDoc,
            deleteDoc,
            onSnapshot
        };
    </script>
    <style>
        /* Import Inter font */
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap');
        
        :root {
            /* Backgrounds */
            --main-bg: #F5F5F4;           /* Soft Warm Gray */
            --section-bg: #EDEAE6;        /* Pale Pebble */
            --card-bg: #F2EFEB;           /* Mist Linen */
            --hover-bg: #E8E4DF;          /* Whisper Beige */
            
            /* Primary & Secondary Branding */
            --primary-brand: #D8A7A7;     /* Dusty Rose */
            --secondary-brand: #9CAEC2;   /* Slate Blue */
            --highlight: #B7C4B2;         /* Sage Green */
            
            /* Section-Specific Colors */
            --dashboard-bg: #EAE0D5;      /* Pale Sandstone */
            --task-bg: #D3DCE6;           /* Powder Blue */
            --calendar-bg: #CBBEDC;       /* Misty Lilac */
            --client-bg: #EED3D3;         /* Blush Nude */
            --media-bg: #D1C9D6;          /* Ash Lavender */
            --finance-bg: #F0E5D8;        /* Champagne Beige */
            
            /* Text & Icons */
            --text-primary: #333333;      /* Charcoal Gray */
            --text-secondary: #666666;    /* Slate Gray */
            --text-tertiary: #A3A3A3;     /* Stone Gray */
            --text-inverse: #FAFAFA;      /* Soft White */
            
            /* Feedback & States */
            --success: #B7C4B2;           /* Sage Green */
            --warning: #D8C690;           /* Muted Gold */
            --error: #E2A39D;             /* Soft Terracotta */
            --info: #9CAEC2;              /* Slate Blue */
            
            /* Additional Variables */
            --dusty-blue: #9CAEC2;        /* Same as secondary-brand */
            --lavender-mist: #CBBEDC;     /* Same as calendar-bg */
            --soft-rose: #D8A7A7;         /* Same as primary-brand */
              --header-height: 0px;         /* Computed at runtime */
        }

        body {
            font-family: 'Inter', -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            margin: 0;
            padding: 20px;
            background: var(--main-bg);
            min-height: 100vh;
            color: var(--text-primary);
            font-weight: 400;
            line-height: 1.6;
        }
        
        .container {
            max-width: 1400px;
            margin: 0 auto;
            background: var(--card-bg);
            border-radius: 20px;
            box-shadow: 0 10px 40px rgba(51, 51, 51, 0.06);
              overflow: visible;
            border: 1px solid var(--section-bg);
        }
        
        .header {
            background: linear-gradient(135deg, var(--primary-brand), var(--secondary-brand));
            color: var(--text-inverse);
            padding: 30px;
            text-align: center;
              position: -webkit-sticky;
              position: sticky;
              top: 0;
              z-index: 1000;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 20px;
        }

          .theme-toggle {
              position: absolute;
              right: 20px;
              top: 20px;
              display: inline-flex;
              align-items: center;
              justify-content: center;
              width: 40px;
              height: 40px;
              background: var(--card-bg);
              color: var(--text-primary);
              border: 1px solid var(--section-bg);
              border-radius: 50%;
              box-shadow: 0 2px 10px rgba(0,0,0,0.08);
              cursor: pointer;
              user-select: none;
          }
          .theme-toggle button {
              all: unset;
              display: inline-flex;
              align-items: center;
              justify-content: center;
              width: 100%;
              height: 100%;
              font-size: 18px;
              line-height: 1;
              cursor: pointer;
          }

          /* Reversible branding enhancements */
          .brand-boosted .header {
              padding: 36px;
              background: linear-gradient(135deg, color-mix(in srgb, var(--primary-brand) 85%, #ffffff 15%), color-mix(in srgb, var(--secondary-brand) 85%, #ffffff 15%));
              border-bottom: 4px solid var(--soft-rose);
          }

          /* Dark theme overrides (Brand palette) */
          .theme-dark {
              /* Backgrounds */
              --main-bg: #1E1E1E;           /* Charcoal */
              --section-bg: #2A2A2A;        /* Graphite */
              --card-bg: #2A2A2A;           /* Graphite */
              --hover-bg: #333333;          /* Slightly lighter for hover */

              /* Primary & Secondary Branding */
              --primary-brand: #B87C7C;     /* Dusty Rose (deepened) */
              --secondary-brand: #7D91A8;   /* Slate Blue (muted) */

              /* Text & Icons */
              --text-primary: #E0E0E0;      /* Light Gray */
              --text-secondary: #AAAAAA;    /* Medium Gray */
              --text-tertiary: #8A8A8A;     /* Deeper muted */
              --text-inverse: #0F0F10;

              /* Section-Specific Colors (aligned with dark surfaces) */
              --dashboard-bg: #2A2A2A;
              --task-bg: #2A2A2A;
              --calendar-bg: #2A2A2A;
              --client-bg: #2A2A2A;
              --media-bg: #2A2A2A;
              --finance-bg: #2A2A2A;

              /* Feedback & States */
              --success: #8FA290;           /* Deep Sage */
              --warning: #B6A76A;           /* Antique Gold */
              --error: #D18D86;             /* Soft Terracotta (kept) */
              --info: #7D91A8;              /* Align with secondary */
          }
          .theme-dark { --panel-surface: #3A3A3A; }

          .theme-dark .container { box-shadow: 0 10px 40px rgba(0,0,0,0.5); }
          .theme-dark .tab.active { box-shadow: 0 -4px 20px rgba(0,0,0,0.4); }
          .theme-dark .logo { box-shadow: 0 4px 15px rgba(0,0,0,0.6); }
          /* Project cards in dark mode */
          .theme-dark .project-card {
              background: linear-gradient(135deg, #303030, #262626);
              border-color: rgba(255,255,255,0.08);
              box-shadow: 0 8px 28px rgba(0,0,0,0.55);
              position: relative;
              padding-left: 32px;
          }
          .theme-dark .project-card:hover {
              box-shadow: 0 10px 36px rgba(0,0,0,0.6);
          }
          .theme-dark .project-card::before {
              content: '';
              position: absolute;
              left: 0;
              top: 0;
              bottom: 0;
              width: 6px;
              background: linear-gradient(180deg, var(--primary-brand), var(--secondary-brand));
              border-radius: 16px 0 0 16px;
              opacity: 0.95;
          }
          .theme-dark #projects .tab-content {
              background: linear-gradient(135deg, #242424, #1E1E1E);
          }
          .theme-dark .project-title { color: var(--text-primary); }
          .theme-dark .project-client, .theme-dark .project-meta { color: var(--text-secondary); }

          /* Dark-mode only panel restyle for progress areas */
          .theme-dark .progress-panel {
              background: var(--panel-surface, #3A3A3A) !important;
              box-shadow: inset 0 0 0 1px rgba(255,255,255,0.05);
              border: 1px solid rgba(255,255,255,0.08);
          }
          .theme-dark .progress-panel .remaining-text { color: var(--success) !important; }
          .theme-dark .progress-panel .worked-text { color: #F5F5F5 !important; }
          /* Status chips tuned for dark palette */
          .theme-dark .status-consultation { background: linear-gradient(135deg, #7D91A8, #6B7E96); color: #E0E0E0; }
          .theme-dark .status-design { background: linear-gradient(135deg, #7D91A8, #6B7E96); color: #E0E0E0; }
          .theme-dark .status-sourcing { background: linear-gradient(135deg, #B87C7C, #A36F6F); color: #E0E0E0; }
          .theme-dark .status-ordering { background: linear-gradient(135deg, #B6A76A, #9E905C); color: #1E1E1E; }
          .theme-dark .status-delivery { background: linear-gradient(135deg, #8FA290, #788D7C); color: #1E1E1E; }
          .theme-dark .status-completed { background: linear-gradient(135deg, #7FA184, #6C8F71); color: #1E1E1E; }
          .brand-boosted .logo {
              width: 72px;
              height: 72px;
              border-radius: 12px;
          }
          .brand-boosted .logo svg { width: 48px; height: 48px; }
          .brand-boosted .header h1 { font-weight: 700; letter-spacing: 2.5px; }
          .brand-boosted .header p { opacity: 0.95; font-weight: 400; }

          /* Optional extra-large logo mode (reversible via class) */
          .brand-logo-xl .logo { width: 92px; height: 92px; }
          .brand-logo-xl .logo svg { width: 64px; height: 64px; }
          .brand-logo-xl .header { padding: 40px; }

          /* Optional left-aligned brand layout with accent stripe */
          .brand-left-layout .header {
              justify-content: flex-start;
              gap: 24px;
              position: relative;
          }
          .brand-left-layout .header::after {
              content: '';
              position: absolute;
              left: 0;
              top: 0;
              bottom: 0;
              width: 6px;
              background: linear-gradient(180deg, var(--primary-brand), var(--secondary-brand));
              border-radius: 0 6px 6px 0;
          }
          .brand-left-layout .header-text { text-align: left; }
        
        .logo {
            width: 60px;
            height: 60px;
            background: var(--card-bg);
            border-radius: 8px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: 700;
            color: var(--text-primary);
            font-size: 24px;
            box-shadow: 0 4px 15px rgba(51, 51, 51, 0.15);
        }
        
        .logo svg {
            width: 40px;
            height: 40px;
            fill: var(--text-primary);
        }
        
        .header-text {
            text-align: left;
        }
        
        .header h1 {
            margin: 0 0 5px 0;
            font-size: 2.2em;
            font-weight: 500;
            letter-spacing: 2px;
            color: var(--text-primary);
        }
        
        .header p {
            margin: 0;
            opacity: 0.8;
            font-size: 1.1em;
            font-weight: 300;
        }
        
        .tabs {
            display: flex;
            background: var(--section-bg);
              position: -webkit-sticky;
              position: sticky;
              top: var(--header-height);
              z-index: 900;
        }
        
        .tab {
            flex: 1;
            padding: 18px 15px;
            text-align: center;
            cursor: pointer;
            transition: all 0.3s ease;
            border: none;
            background: transparent;
            font-size: 15px;
            font-weight: 500;
            color: var(--text-secondary);
        }
        
        .tab.active {
            background: var(--card-bg);
            color: var(--text-primary);
            border-radius: 15px 15px 0 0;
            transform: translateY(-2px);
            box-shadow: 0 -4px 20px rgba(51, 51, 51, 0.12);
            font-weight: 600;
        }
        
        .tab:hover:not(.active) {
            background: var(--hover-bg);
            transform: translateY(-1px);
        }
        
        .tab-content {
            display: none;
            padding: 40px;
            background: var(--card-bg);
        }
        
        .tab-content.active {
            display: block;
        }
        
        .btn {
            background: linear-gradient(135deg, var(--secondary-brand), var(--info));
            color: var(--text-inverse);
            padding: 12px 25px;
            border: none;
            border-radius: 25px;
            cursor: pointer;
            font-size: 14px;
            font-weight: 500;
            font-family: 'Inter', sans-serif;
            transition: all 0.3s ease;
            box-shadow: 0 4px 15px rgba(156, 174, 194, 0.25);
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }
        
        .btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 25px rgba(168, 200, 216, 0.4);
        }
        
        .btn-success {
            background: linear-gradient(135deg, var(--success), var(--highlight));
        }
        
        .btn-coral {
            background: linear-gradient(135deg, var(--primary-brand), var(--client-bg));
        }
        
        .btn-small {
            padding: 8px 16px;
            font-size: 12px;
        }
        
        .card {
            background: var(--card-bg);
            border-radius: 16px;
            padding: 25px;
            box-shadow: 0 4px 20px rgba(51, 51, 51, 0.06);
            margin-bottom: 25px;
            border: 1px solid var(--section-bg);
        }
        
        .card p {
            font-size: 16px;
            margin-bottom: 14px;
            line-height: 1.5;
        }
        
        .card strong {
            font-size: 18px;
            font-weight: 600;
            color: var(--text-primary);
            letter-spacing: 0.3px;
        }
        
        .two-column {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 30px;
        }
        
        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(180px, 1fr));
            gap: 15px;
            margin-bottom: 25px;
        }
        
        .stat-card {
            background: linear-gradient(135deg, var(--dashboard-bg), var(--card-bg));
            border-radius: 12px;
            padding: 18px;
            text-align: center;
            box-shadow: 0 2px 12px rgba(51, 51, 51, 0.06);
            border: 1px solid var(--section-bg);
        }
        
        .stat-value {
            font-size: 2em;
            font-weight: 700;
            color: var(--text-primary);
            margin-bottom: 6px;
        }
        
        .stat-label {
            font-size: 12px;
            color: var(--text-secondary);
            text-transform: uppercase;
            letter-spacing: 1px;
            font-weight: 600;
        }
        
        .project-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(350px, 1fr));
            gap: 25px;
            margin-bottom: 30px;
        }
        
        .project-card {
            background: linear-gradient(135deg, var(--client-bg), var(--card-bg));
            border-radius: 16px;
            padding: 25px;
            box-shadow: 0 4px 20px rgba(51, 51, 51, 0.08);
            border: 1px solid var(--section-bg);
            cursor: pointer;
            transition: all 0.3s ease;
        }
        
        .project-card:hover {
            transform: translateY(-3px);
            box-shadow: 0 8px 30px rgba(51, 51, 51, 0.12);
        }
        
        /* Section-Specific Tab Content Styling */
        #dashboard .tab-content {
            background: linear-gradient(135deg, var(--dashboard-bg), var(--main-bg));
        }
        
        #projects .tab-content {
            background: linear-gradient(135deg, var(--task-bg), var(--main-bg));
        }
        

        
        /* Typography Improvements */
        h1, h2, h3, h4, h5, h6 {
            font-family: 'Inter', sans-serif;
            font-weight: 600;
            line-height: 1.4;
        }
        
        input, textarea, select, button {
            font-family: 'Inter', sans-serif;
        }
        
        .custom-alert {
            font-family: 'Inter', sans-serif;
        }
        
        .project-header {
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
            margin-bottom: 15px;
        }
        
        .project-title {
            font-size: 18px;
            font-weight: 700;
            color: var(--text-primary);
            margin: 0;
        }
        
        .project-status {
            padding: 6px 12px;
            border-radius: 20px;
            font-size: 11px;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }
        
        .status-consultation { background: linear-gradient(135deg, #e67e22, #d35400); color: white; }
        .status-design { background: linear-gradient(135deg, #3498db, #2980b9); color: white; }
        .status-sourcing { background: linear-gradient(135deg, #9b59b6, #8e44ad); color: white; }
        .status-ordering { background: linear-gradient(135deg, #f39c12, #e67e22); color: white; }
        .status-delivery { background: linear-gradient(135deg, #16a085, #1abc9c); color: white; }
        .status-completed { background: linear-gradient(135deg, #27ae60, #2ecc71); color: white; }
        
        .project-client {
            margin-bottom: 15px;
            font-size: 15px;
            color: var(--text-secondary);
        }
        
        .project-meta {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-top: 15px;
            font-size: 13px;
            color: var(--text-secondary);
        }
        
        .project-value {
            font-weight: 700;
            color: var(--text-primary);
            font-size: 14px;
        }
        
        .form-group {
            margin-bottom: 20px;
        }
        
        label {
            display: block;
            margin-bottom: 8px;
            font-weight: 500;
            color: var(--text-primary);
            font-size: 14px;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }
        
        input, textarea, select {
            width: 100%;
            padding: 12px;
            border: 2px solid var(--section-bg);
            border-radius: 12px;
            font-size: 15px;
            transition: all 0.3s ease;
            background: var(--card-bg);
            color: var(--text-primary);
        }
        
        input:focus, textarea:focus, select:focus {
            border-color: var(--secondary-brand);
            outline: none;
            box-shadow: 0 0 0 3px rgba(168, 200, 216, 0.2);
        }
        
        .modal {
            display: none;
            position: fixed;
            z-index: 1000;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            background: rgba(45, 43, 40, 0.8);
            backdrop-filter: blur(5px);
        }
        
        .modal-content {
            background: var(--card-bg);
            margin: 2% auto;
            padding: 0;
            border-radius: 20px;
            width: 95%;
              max-width: 1300px;
            max-height: 90vh;
            overflow: hidden;
            box-shadow: 0 20px 60px rgba(45, 43, 40, 0.3);
            display: flex;
            flex-direction: column;
        }
        
            .modal-header {
                background: linear-gradient(135deg, var(--dusty-blue), var(--lavender-mist));
                padding: 16px 20px 0; /* leave room for tabs */
                border-radius: 20px 20px 0 0;
                position: sticky;
                top: 0;
                z-index: 100;
            }
            .modal-header-inner {
                display: flex;
                justify-content: space-between;
                align-items: center;
                padding-bottom: 12px;
            }
        
        .modal-body {
              padding: 30px;
            flex: 1;
            overflow-y: auto;
            display: flex;
            flex-direction: column;
        }

          /* Modal form layout refinements */
          .modal-body .two-column {
              display: grid;
              grid-template-columns: 1fr 1fr;
              column-gap: 30px;
              row-gap: 18px;
          }

          .modal-body .form-group {
              margin-bottom: 0;
          }

          .modal-body label {
              margin-bottom: 6px;
              font-weight: 600;
              letter-spacing: 0.3px;
          }

          .modal-body input,
          .modal-body select,
          .modal-body textarea {
              border: 2px solid var(--section-bg);
              border-radius: 12px;
              background: var(--card-bg);
          }

          .modal-body ::placeholder {
              color: var(--text-tertiary);
              opacity: 1;
          }

          .modal-actions {
              margin-top: 24px;
              display: flex;
              gap: 12px;
          }
        
            .project-tabs {
                background: var(--card-bg);
                padding: 8px;
                margin: 8px 40px 10px;
                display: flex;
                justify-content: center;
                gap: 8px;
                width: calc(100% - 80px);
                box-sizing: border-box;
                border-radius: 12px;
                border: 1px solid var(--section-bg);
                box-shadow: 0 6px 18px rgba(0,0,0,0.08);
            }
        
        .project-sections-container {
            flex: 1;
            overflow-y: auto;
        }
        
        
        .close {
            color: var(--text-primary);
            font-size: 28px;
            font-weight: bold;
            cursor: pointer;
            transition: color 0.3s;
        }
        
        .close:hover {
            color: var(--text-secondary);
        }
        
            .project-tabs {
                display: flex;
                margin-bottom: 12px;
                width: calc(100% - 80px);
            }
        
            .project-tab {
                flex: 1 1 0;
                padding: 12px 16px;
                cursor: pointer;
                border: none;
                background: transparent;
                color: var(--text-secondary);
                font-size: 18px;
                font-weight: 600;
                border-radius: 10px;
                text-align: center;
                transition: background 0.2s ease, color 0.2s ease, transform 0.2s ease;
                white-space: nowrap;
                min-width: 120px;
            }
        
            .project-tab.active {
                color: var(--text-primary);
                background: var(--hover-bg);
                transform: translateY(-1px);
            }

          /* Dark mode treatment for project tabs surface */
            .theme-dark .project-tabs {
                background: var(--panel-surface, #3A3A3A);
                border: 1px solid rgba(255,255,255,0.08);
                box-shadow: 0 10px 24px rgba(0,0,0,0.4);
            }
            .theme-dark .project-tab { color: #E0E0E0; }
            .theme-dark .project-tab.active {
                color: #FFFFFF;
                background: #424242;
            }
        
          .project-section {
              display: none;
              padding: 30px 40px 20px; /* extra top padding below tabs */
          }
        
        .project-section.active {
            display: block;
        }
        
        .section-header {
            background: var(--task-bg);
            padding: 15px 20px;
            border-radius: 10px;
            margin: 10px 0;
            cursor: pointer;
            display: flex;
            justify-content: space-between;
            align-items: center;
            transition: all 0.3s ease;
            -webkit-user-select: none;
            user-select: none;
        }
        
        .section-header:hover {
            background: var(--lavender-mist);
        }
        
        .section-content {
            display: none;
            padding: 20px;
            background: rgba(255,255,255,0.5);
            border-radius: 0 0 10px 10px;
            margin-bottom: 15px;
        }
        
        .section-content.expanded {
            display: block;
        }
        
        .item-grid {
            display: grid;
            grid-template-columns: 2fr 0.8fr 1fr 1fr 0.8fr 0.8fr 1fr 1fr auto;
            gap: 10px;
            align-items: center;
            padding: 10px 12px;
            background: var(--card-bg);
            border-radius: 8px;
            margin-bottom: 10px;
            border: 1px solid var(--section-bg);
            font-size: 14px;
        }
        
        .item-grid.header {
            background: var(--task-bg);
            font-weight: 600;
            color: var(--text-primary);
            margin-bottom: 8px;
            padding: 8px 12px;
            align-items: baseline;
        }
        /* Prevent wrapping for the Customer Total column (7th column) */
        .item-grid > div:nth-child(7) {
            white-space: nowrap;
        }
        /* Keep Customer Total note below the title and align all headers baseline */
        .item-grid.header {
            align-items: baseline;
        }
        .item-grid.header > div:nth-child(7) br {
            display: initial;
        }
        .item-grid.header > div:nth-child(7) small {
            margin-left: 0;
            white-space: normal;
            display: block;
        }
        
        .custom-alert {
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background: var(--card-bg);
            border: 2px solid var(--gentle-blue);
            border-radius: 16px;
            padding: 30px;
            box-shadow: 0 20px 60px rgba(45, 43, 40, 0.3);
            z-index: 2000;
            max-width: 400px;
            width: 90%;
            max-height: 70vh;
            overflow-y: auto;
            text-align: center;
        }
        
        .custom-alert-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(45, 43, 40, 0.7);
            backdrop-filter: blur(5px);
            z-index: 1999;
        }
        
        .upcoming-event {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 12px 15px;
            background: rgba(255,255,255,0.7);
            border-radius: 8px;
            margin-bottom: 10px;
            border-left: 4px solid var(--gentle-blue);
        }
        
        @media print {
            body * { visibility: hidden; }
            .invoice-preview, .invoice-preview * { visibility: visible; }
            .invoice-preview { position: absolute; left: 0; top: 0; width: 100%; }
            .btn { display: none !important; }
        }
        
        /* Mobile Optimizations */
        @media (max-width: 768px) {
            /* Remove default body padding */
            body {
                padding-top: 0;
                margin: 0;
            }
            
            /* Improved mobile header container */
            .header-container {
                position: fixed;
                top: 0;
                left: 0;
                right: 0;
                background: var(--main-bg);
                z-index: 1000;
                border-bottom: 2px solid var(--section-bg);
                box-shadow: 0 2px 8px rgba(0,0,0,0.1);
                padding: 10px 20px;
                height: 70px;
                display: flex;
                align-items: center;
                justify-content: center;
            }
            
            /* Hide theme toggle on mobile */
            .theme-toggle {
                display: none !important;
            }
            
            /* Better aligned mobile header */
            .header {
                display: flex;
                align-items: center;
                justify-content: center;
                gap: 15px;
                height: 100%;
                width: 100%;
                max-width: 400px;
            }
            
            /* More prominent logo on mobile */
            .logo svg {
                width: 45px !important;
                height: 45px !important;
            }
            
            /* Header text adjustments */
            .header-text {
                text-align: left;
                display: flex;
                flex-direction: column;
                justify-content: center;
                flex: 1;
            }
            
            /* Better header title */
            h1 {
                font-size: 20px !important;
                margin: 0 !important;
                font-weight: 700;
                line-height: 1.2;
                color: var(--text-primary);
            }
            
            /* Navigation Tabs */
            .tabs {
                flex-direction: row;
                gap: 5px;
                padding: 5px;
                background: var(--section-bg);
                border-radius: 8px;
                margin: 8px 0 0 0;
                justify-content: center;
            }
            
            .tab {
                flex: 1;
                text-align: center;
                padding: 8px 12px;
                margin: 0;
                font-size: 14px;
                border-radius: 6px;
            }
            
            /* Container and Layout */
            .container {
                padding: 75px 15px 20px 15px; /* Adjusted for improved header height */
                max-width: 100%;
            }
            
            /* Grid Layouts */
            .project-grid, .two-column, .stats-grid {
                grid-template-columns: 1fr;
                gap: 15px;
            }
            
            /* Dashboard Cards */
            .card {
                padding: 15px;
                margin-bottom: 15px;
            }
            
            .card h3 {
                font-size: 18px;
                margin-bottom: 15px;
            }
            
            /* Stats Grid Mobile */
            .stats-grid {
                grid-template-columns: repeat(2, 1fr);
                gap: 10px;
            }
            
            .stat-item {
                padding: 12px;
                text-align: center;
            }
            
            .stat-value {
                font-size: 20px !important;
            }
            
            /* Project Cards */
            .project-card {
                padding: 15px;
                margin-bottom: 15px;
            }
            
            .project-card h4 {
                font-size: 16px;
            }
            
            /* Item Grid */
            .item-grid {
                grid-template-columns: 1fr;
                gap: 10px;
            }
            
            /* Project Tabs */
            .project-tabs {
                flex-wrap: wrap;
                gap: 5px;
                justify-content: center;
            }
            
            .project-tab {
                min-width: auto;
                padding: 8px 12px;
                font-size: 14px;
            }
            
            /* Buttons */
            .btn {
                width: 100%;
                margin-bottom: 10px;
                padding: 12px;
                font-size: 16px;
            }
            
            .btn-row {
                flex-direction: column;
                gap: 10px;
            }
            
            /* Calendar Mobile */
            .calendar-grid {
                font-size: 12px;
            }
            
            .calendar-day {
                min-height: 40px;
                padding: 4px 2px;
                font-size: 12px;
            }
            
            .calendar-day-number {
                font-size: 12px;
            }
            
            /* Forms */
            .form-group {
                margin-bottom: 15px;
            }
            
            .form-group label {
                font-size: 14px;
                margin-bottom: 5px;
            }
            
            .form-group input,
            .form-group select,
            .form-group textarea {
                font-size: 16px; /* Prevent zoom on iOS */
                padding: 12px;
                width: 100%;
                box-sizing: border-box;
            }
            
            /* Modals */
            .modal {
                margin: 10px;
                max-height: 90vh;
                overflow-y: auto;
                -webkit-overflow-scrolling: touch;
            }
            
            .modal-header {
                padding: 15px;
                position: sticky;
                top: 0;
                background: var(--card-bg);
                z-index: 10;
            }
            
            .modal-header h3 {
                font-size: 18px;
            }
            
            .modal-body {
                padding: 15px;
            }
            
            .modal-footer {
                padding: 15px;
                position: sticky;
                bottom: 0;
                background: var(--card-bg);
                border-top: 1px solid var(--section-bg);
            }
            
            /* Tables */
            .table-responsive {
                overflow-x: auto;
                -webkit-overflow-scrolling: touch;
            }
            
            table {
                min-width: 600px;
            }
            
            /* Invoice Table Mobile */
            .invoice-confirm-table {
                font-size: 14px;
            }
            
            .invoice-confirm-table th,
            .invoice-confirm-table td {
                padding: 8px 6px;
                min-width: 80px;
            }
            
            /* Quick Actions */
            .quick-actions {
                display: flex;
                flex-direction: column;
                gap: 10px;
            }
            
            /* Touch Targets */
            button, .btn, input[type="button"], input[type="submit"] {
                min-height: 44px; /* iOS recommended touch target */
                min-width: 44px;
            }
            
            /* Spacing */
            .section {
                margin-bottom: 20px;
                padding: 15px;
            }
            
            /* Hide desktop-only elements */
            .desktop-only {
                display: none !important;
            }
            
            /* Show mobile-only elements */
            .mobile-only {
                display: block !important;
            }
            
            /* Hide ALL tabs on mobile */
            .tabs {
                display: none !important;
            }
            
            /* Hide Dashboard content on mobile */
            #dashboard {
                display: none !important;
            }
            
            /* Show Projects tab content by default on mobile */
            #projects {
                display: block !important;
            }
            
            /* Projects header adjustments for mobile */
            #projects > div:first-child {
                margin-bottom: 0 !important;
                padding-bottom: 0 !important;
            }
            
            /* Hide entire header section with filters/buttons on mobile */
            #projects > div:first-child > div:first-child {
                display: none !important;
            }
            
            #projects h2 {
                display: none !important; /* Hide Projects title on mobile */
            }
            
            /* Center the New Project button on mobile */
            .mobile-only {
                text-align: center;
                margin: 0 auto 25px auto;
                padding: 0 20px;
            }
            
            /* Improve New Project button styling */
            .mobile-only .btn {
                padding: 15px 30px !important;
                font-size: 18px !important;
                font-weight: 600 !important;
                border-radius: 25px !important;
                box-shadow: 0 4px 12px rgba(0,0,0,0.15) !important;
                margin: 0 !important;
                width: auto !important;
                max-width: 280px;
            }
            
            /* Improve project card spacing and layout */
            .project-card {
                margin: 0 0 20px 0 !important;
                border-radius: 16px !important;
                box-shadow: 0 2px 12px rgba(0,0,0,0.08) !important;
                padding: 20px !important;
            }
            
            /* Improve project titles */
            .project-card h4 {
                font-size: 20px !important;
                font-weight: 600 !important;
                margin-bottom: 8px !important;
                line-height: 1.3 !important;
            }
            
            /* Improve client text */
            .project-card p {
                font-size: 16px !important;
                color: var(--text-secondary) !important;
                margin-bottom: 12px !important;
            }
            
            /* Hide project grid on mobile - we'll show it in a separate view */
            .project-grid {
                display: none !important;
            }
            
            /* Mobile main buttons - well distributed layout */
            .mobile-main-buttons {
                display: flex;
                flex-direction: column;
                justify-content: space-evenly;
                align-items: center;
                min-height: calc(100vh - 150px);
                padding: 40px 20px;
                margin-top: 0;
                gap: 0;
            }
            
            /* Clean button styling with optimal spacing */
            .mobile-btn {
                width: 85% !important;
                max-width: 300px !important;
                padding: 18px 24px !important;
                font-size: 17px !important;
                font-weight: 600 !important;
                border-radius: 20px !important;
                display: flex !important;
                align-items: center !important;
                justify-content: center !important;
                gap: 15px !important;
                box-shadow: 0 3px 15px rgba(0,0,0,0.08) !important;
                margin: 15px 0 !important;
                transition: all 0.3s ease !important;
                border: none !important;
                position: relative !important;
                /* DEBUG: Ensure clicks work */
                pointer-events: auto !important;
                cursor: pointer !important;
                z-index: 999 !important;
            }
            
            .mobile-btn:active {
                transform: translateY(1px);
                box-shadow: 0 1px 6px rgba(0,0,0,0.12) !important;
            }
            
            .mobile-btn:hover {
                transform: translateY(-1px);
                box-shadow: 0 6px 20px rgba(0,0,0,0.15) !important;
            }
            
            .btn-icon {
                font-size: 26px;
            }
            
            .btn-title {
                font-size: 18px;
                font-weight: 600;
            }
            
            .notes-btn {
                background: linear-gradient(135deg, var(--secondary-brand), #c0a6a6) !important;
                color: white !important;
                border: none !important;
                box-shadow: 0 4px 15px rgba(160, 146, 146, 0.3) !important;
            }
            
            .event-btn {
                background: linear-gradient(135deg, var(--primary-brand), #e6b8b8) !important;
                color: white !important;
                border: none !important;
                box-shadow: 0 4px 15px rgba(216, 167, 167, 0.3) !important;
            }
            
            .projects-btn {
                background: linear-gradient(135deg, #8B9A8C, #A0B1A0) !important;
                color: white !important;
                border: none !important;
                box-shadow: 0 4px 15px rgba(139, 154, 140, 0.35) !important;
                text-shadow: 0 1px 2px rgba(0,0,0,0.1) !important;
            }
            
            /* Mobile Projects Modal */
            .mobile-projects-modal .modal {
                width: 95% !important;
                max-width: 400px !important;
                max-height: 85vh !important;
                background: var(--card-bg) !important;
                border: 1px solid var(--section-bg) !important;
                box-shadow: 0 8px 32px rgba(0,0,0,0.12) !important;
            }
            
            /* Mobile modal improvements */
            .modal-overlay {
                background: rgba(0, 0, 0, 0.6) !important;
                backdrop-filter: blur(4px) !important;
            }
            
            .modal {
                background: var(--card-bg) !important;
                border: 1px solid var(--section-bg) !important;
                box-shadow: 0 8px 32px rgba(0,0,0,0.15) !important;
            }
            
            .modal-header {
                background: var(--section-bg) !important;
                border-bottom: 1px solid var(--section-bg) !important;
                padding: 15px 20px !important;
            }
            
            .modal-header h3 {
                color: var(--text-primary) !important;
                margin: 0 !important;
                font-weight: 600 !important;
            }
            
            .modal-body {
                padding: 20px !important;
                background: var(--card-bg) !important;
            }
            
            .modal-footer {
                background: var(--section-bg) !important;
                border-top: 1px solid var(--section-bg) !important;
                padding: 15px 20px !important;
                display: flex !important;
                gap: 10px !important;
                justify-content: flex-end !important;
            }
            
            .mobile-projects-grid {
                display: flex;
                flex-direction: column;
                gap: 15px;
                max-height: 60vh;
                overflow-y: auto;
                padding: 10px 0;
            }
            
            .mobile-project-card {
                background: var(--card-bg);
                border-radius: 12px;
                padding: 16px;
                border: 1px solid var(--section-bg);
                cursor: pointer;
                transition: all 0.2s ease;
                box-shadow: 0 2px 8px rgba(0,0,0,0.06);
            }
            
            .mobile-project-card:hover {
                background: var(--hover-bg);
                transform: translateY(-2px);
                box-shadow: 0 4px 12px rgba(0,0,0,0.12);
            }
            
            .mobile-project-card h4 {
                margin: 0 0 8px 0 !important;
                font-size: 16px !important;
                font-weight: 600 !important;
                color: var(--text-primary) !important;
            }
            
            .mobile-project-card p {
                margin: 0 0 8px 0 !important;
                font-size: 14px !important;
                color: var(--text-secondary) !important;
            }
            
            .mobile-project-card .status-badge {
                display: inline-block;
                font-size: 10px !important;
                padding: 4px 8px !important;
                border-radius: 12px !important;
                font-weight: 600 !important;
                margin-bottom: 8px;
            }
            
            .project-meta {
                display: flex;
                justify-content: space-between;
                font-size: 12px !important;
                color: var(--text-tertiary) !important;
            }
            
            /* Mobile form styling */
            .form-group label {
                color: var(--text-primary) !important;
                font-weight: 600 !important;
                margin-bottom: 8px !important;
                display: block !important;
            }
            
            .form-group input,
            .form-group select,
            .form-group textarea {
                background: var(--main-bg) !important;
                border: 2px solid var(--section-bg) !important;
                border-radius: 8px !important;
                padding: 12px !important;
                font-size: 16px !important;
                color: var(--text-primary) !important;
                width: 100% !important;
                box-sizing: border-box !important;
                transition: border-color 0.2s ease !important;
            }
            
            .form-group input:focus,
            .form-group select:focus,
            .form-group textarea:focus {
                outline: none !important;
                border-color: var(--primary-brand) !important;
                box-shadow: 0 0 0 3px rgba(216, 167, 167, 0.1) !important;
            }
            
            /* Button improvements for modals */
            .btn-primary {
                background: var(--primary-brand) !important;
                border: 2px solid var(--primary-brand) !important;
                color: white !important;
                padding: 10px 20px !important;
                border-radius: 8px !important;
                font-weight: 600 !important;
            }
            
            .btn-secondary {
                background: transparent !important;
                border: 2px solid var(--text-tertiary) !important;
                color: var(--text-secondary) !important;
                padding: 10px 20px !important;
                border-radius: 8px !important;
                font-weight: 600 !important;
            }
            
            /* Close button styling */
            .close-modal {
                background: none !important;
                border: none !important;
                color: var(--text-secondary) !important;
                font-size: 24px !important;
                cursor: pointer !important;
                padding: 0 !important;
                width: 30px !important;
                height: 30px !important;
                display: flex !important;
                align-items: center !important;
                justify-content: center !important;
                border-radius: 50% !important;
                transition: all 0.2s ease !important;
            }
            
            .close-modal:hover {
                background: var(--hover-bg) !important;
                color: var(--text-primary) !important;
            }
        }
        
        /* Tablet Optimizations */
        @media (min-width: 769px) and (max-width: 1024px) {
            .container {
                padding: 20px;
            }
            
            .stats-grid {
                grid-template-columns: repeat(3, 1fr);
            }
            
            .project-grid {
                grid-template-columns: repeat(2, 1fr);
            }
        }
        
        /* Header Container - Desktop */
        .header-container {
            position: relative;
            background: var(--main-bg);
        }
        
        /* Desktop and mobile utility classes */
        .mobile-only {
            display: none;
        }
        
        .desktop-only {
            display: block;
        }

        /* Invoice Confirmation Table Styles */
        .invoice-confirm-table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 0;
            background: white;
            border-radius: 0 0 12px 12px;
            overflow: hidden;
            box-shadow: 0 4px 20px rgba(51,51,51,0.12);
            border: 1px solid var(--section-bg);
            border-top: none;
        }
        
        .invoice-confirm-table th {
            background: var(--section-bg);
            color: var(--text-primary);
            padding: 18px 16px;
            text-align: left;
            font-weight: 600;
            font-size: 14px;
            border: none;
            position: sticky;
            top: 76px; /* Height of sticky controls section */
            z-index: 10;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        
        /* Ensure table stretches full width when headers are sticky */
        .invoice-confirm-table {
            position: relative;
            margin-top: 0;
            width: 100%;
            border-radius: 0 0 12px 12px;
            overflow: hidden;
            border-top: none;
        }
        
        /* Make sticky headers span full modal width */
        .invoice-confirm-table thead {
            position: relative;
        }
        
        .invoice-confirm-table th:first-child {
            text-align: center;
            width: 50px;
        }
        
        .invoice-confirm-table td {
            padding: 16px;
            border-bottom: 1px solid #f1f1f1;
            vertical-align: middle;
            font-size: 14px;
            color: var(--text-primary);
            box-sizing: border-box;
        }

        /* New Clean Invoice Review Styles */
        .invoice-review-container {
            border: 1px solid var(--section-bg);
            border-radius: 8px;
            overflow: hidden;
            background: white;
            box-shadow: 0 4px 20px rgba(51,51,51,0.08);
        }

        .invoice-review-header {
            position: sticky;
            top: 0;
            z-index: 10;
            background: white;
            border-bottom: 1px solid var(--section-bg);
        }

        .review-controls {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 16px 20px;
            background: #f8f9fa;
            border-bottom: 1px solid #e9ecef;
        }

        .controls-left {
            display: flex;
            align-items: center;
            gap: 16px;
        }

        .select-all-btn {
            background: #4A90A4;
            color: white;
            border: 1px solid #4A90A4;
            padding: 8px 16px;
            border-radius: 6px;
            font-size: 13px;
            font-weight: 600;
            cursor: pointer;
            display: flex;
            align-items: center;
            gap: 6px;
            transition: all 0.2s ease;
            height: 36px;
            box-sizing: border-box;
        }

        .select-all-btn:hover {
            background: #3d7a8c;
            border-color: #3d7a8c;
        }

        .select-all-btn.active {
            background: #2e5c6b;
            border-color: #2e5c6b;
        }

        .select-all-btn.active:hover {
            background: #1f3e47;
            border-color: #1f3e47;
        }

        .add-item-btn {
            background: var(--primary-brand);
            color: white;
            border: 1px solid var(--primary-brand);
            padding: 8px 16px;
            border-radius: 6px;
            font-size: 13px;
            font-weight: 600;
            cursor: pointer;
            display: flex;
            align-items: center;
            gap: 6px;
            transition: background 0.2s ease;
            height: 36px;
            box-sizing: border-box;
        }

        .add-item-btn:hover {
            background: var(--secondary-brand);
        }

        .item-counter {
            color: var(--text-secondary);
            font-size: 14px;
            font-weight: 500;
        }

        .table-headers {
            display: grid;
            grid-template-columns: 70px 1fr 100px 70px 90px 80px 120px;
            background: var(--section-bg);
            border-bottom: 1px solid #e9ecef;
        }

        .header-cell {
            padding: 16px 12px;
            font-weight: 600;
            font-size: 14px;
            color: var(--text-primary);
            border-right: 1px solid #e9ecef;
        }

        .header-cell:last-child {
            border-right: none;
        }

        .header-select {
            text-align: center;
        }

        .invoice-table {
            width: 100%;
            border-collapse: collapse;
        }

        .item-row {
            border-bottom: 1px solid #f1f1f1;
            transition: background 0.2s ease;
        }

        .item-row:hover {
            background: #fafafa;
        }

        .item-row.new-item {
            background: #f0f9ff;
        }

        .item-row td {
            padding: 12px;
            vertical-align: middle;
            border-right: 1px solid #f1f1f1;
        }

        .item-row td:last-child {
            border-right: none;
        }

        .cell-select {
            width: 70px;
            text-align: center;
            background: #fafafa;
        }

        .cell-name {
            min-width: 200px;
        }

        .cell-price {
            width: 100px;
        }

        .cell-qty {
            width: 70px;
        }

        .cell-shipping {
            width: 90px;
        }

        .cell-tax {
            width: 80px;
        }

        .cell-total {
            width: 120px;
            font-weight: 700;
            color: #2c3e50;
            font-size: 15px;
        }

        .field-input {
            width: 100%;
            border: 1px solid #e9ecef;
            border-radius: 4px;
            padding: 8px;
            font-size: 14px;
            background: white;
            transition: border-color 0.2s ease;
        }

        .field-input:focus {
            outline: none;
            border-color: var(--primary-brand);
            box-shadow: 0 0 0 2px rgba(216, 167, 167, 0.2);
        }

        .field-input.error {
            border-color: #dc3545;
            background: #fff5f5;
        }

        .name-container {
            position: relative;
        }

        .new-badge {
            position: absolute;
            top: -8px;
            right: -8px;
            background: var(--primary-brand);
            color: white;
            font-size: 10px;
            font-weight: 600;
            padding: 2px 6px;
            border-radius: 8px;
            text-transform: uppercase;
        }
        
        .invoice-confirm-table td:first-child {
            text-align: center;
            background: #fafafa;
        }
        
        .invoice-confirm-table tr:hover {
            background: var(--hover-bg);
            transform: translateY(-1px);
            transition: all 0.2s ease;
        }
        
        .invoice-confirm-table tr:last-child td {
            border-bottom: none;
        }
        
        .editable-field {
            background: white;
            border: 2px solid #e1e5e9;
            padding: 8px 12px;
            border-radius: 6px;
            width: 100%;
            color: var(--text-primary);
            font-size: 14px;
            font-weight: 500;
            transition: all 0.3s ease;
            min-width: 80px;
        }
        
        .editable-field:hover {
            border-color: var(--secondary-brand);
            background: #f8f9fa;
            transform: translateY(-1px);
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
        }
        
        .editable-field:focus {
            border-color: var(--primary-brand);
            background: white;
            outline: none;
            box-shadow: 0 0 0 3px rgba(216, 167, 167, 0.15), 0 4px 12px rgba(0,0,0,0.15);
            transform: translateY(-2px);
        }
        
        .confirm-checkbox {
            width: 20px;
            height: 20px;
            cursor: pointer;
            accent-color: var(--primary-brand);
            transform: scale(1.2);
            transition: all 0.2s ease;
        }
        
        .confirm-checkbox:hover {
            transform: scale(1.3);
        }
        
        .confirm-checkbox:checked {
            animation: checkboxPulse 0.3s ease;
        }
        
        @keyframes checkboxPulse {
            0% { transform: scale(1.2); }
            50% { transform: scale(1.4); }
            100% { transform: scale(1.2); }
        }
        
        .total-cell {
            font-weight: 700;
            color: var(--primary-brand);
            font-size: 15px;
            text-align: right;
        }
        
        /* New item styling */
        .new-item-row {
            background: linear-gradient(90deg, rgba(216, 167, 167, 0.1), rgba(156, 174, 194, 0.1));
            border-left: 3px solid var(--primary-brand);
        }
        
        .new-item-indicator {
            display: inline-flex;
            align-items: center;
            gap: 4px;
            font-size: 11px;
            color: var(--primary-brand);
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }
        
        
        .field-warning {
            border-color: var(--warning) !important;
            background: rgba(216, 198, 144, 0.1) !important;
        }
        
        .field-error {
            border-color: var(--error) !important;
            background: rgba(226, 163, 157, 0.1) !important;
        }
        
        /* Sticky controls styling */
        .sticky-controls {
            margin-top: 0;
            margin-bottom: 0;
            border-radius: 8px;
        }
        
        /* Enhanced button hover effects */
        button:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(0,0,0,0.15) !important;
        }
        
        button:active {
            transform: translateY(0);
        }
        
        button:disabled {
            opacity: 0.5;
            cursor: not-allowed;
            transform: none !important;
            box-shadow: none !important;
        }
        
        /* Loading state for generate button */
        .btn-loading {
            position: relative;
            color: transparent !important;
        }
        
        .btn-loading::after {
            content: "";
            position: absolute;
            width: 16px;
            height: 16px;
            top: 50%;
            left: 50%;
            margin-left: -8px;
            margin-top: -8px;
            border-radius: 50%;
            border: 2px solid transparent;
            border-top-color: currentColor;
            animation: spin 1s ease infinite;
        }
    </style>
</head>
    <body class="brand-boosted brand-logo-xl">
    <!-- Header Container for Mobile -->
    <div class="header-container">
        <div class="header">
              <div class="theme-toggle" title="Toggle theme">
                  <button id="themeSwitchBtn" aria-label="Toggle theme"></button>
              </div>
            <div class="logo">
                <svg viewBox="0 0 400 300" xmlns="http://www.w3.org/2000/svg">
                    <!-- House/Building Icon inspired by the logo -->
                    <g stroke="currentColor" stroke-width="6" fill="none">
                        <!-- Main building structure -->
                        <path d="M50 250 L50 150 L120 100 L190 150 L190 250 Z"/>
                        <path d="M210 250 L210 170 L280 120 L350 170 L350 250 Z"/>
                        <!-- Rooflines -->
                        <path d="M30 150 L120 90 L210 150"/>
                        <path d="M190 170 L280 110 L370 170"/>
                        <!-- Vertical support lines -->
                        <line x1="80" y1="130" x2="80" y2="250"/>
                        <line x1="160" y1="130" x2="160" y2="250"/>
                        <line x1="240" y1="150" x2="240" y2="250"/>
                        <line x1="320" y1="150" x2="320" y2="250"/>
                        <!-- Horizontal foundation lines -->
                        <line x1="30" y1="250" x2="370" y2="250"/>
                    </g>
                </svg>
            </div>
            <div class="header-text">
                <h1>Kelly Ram Designs</h1>
                <div class="desktop-only" style="font-size: 11px; color: var(--text-secondary); margin-top: 5px;">
                    v8.1  GitHub Tracked  Last Updated: August 2025  Build: 4dc2018
                </div>
                <p class="desktop-only">Professional Project Management System</p>
            </div>
        </div>
        
        <div class="tabs">
            <button class="tab active" onclick="showTab('dashboard', event)">Dashboard</button>
            <button class="tab" onclick="showTab('projects', event)">Projects</button>
        </div>
    </div>

    <div class="container">

        <!-- Dashboard Tab -->
        <div id="dashboard" class="tab-content active">
            <h2 style="margin-bottom: 30px; color: var(--text-primary); font-weight: 300;">Business Overview</h2>
            
            <div class="stats-grid">
                <div class="stat-card">
                    <div class="stat-value" id="activeProjectsStat">0</div>
                    <div class="stat-label">Active Projects</div>
                </div>
                <div class="stat-card">
                    <div class="stat-value" id="totalRevenueStat">$0</div>
                    <div class="stat-label">Total Profit</div>
                </div>
                <div class="stat-card">
                    <div class="stat-value" id="totalPaidHoursStat">0</div>
                    <div class="stat-label">Total Paid Hours</div>
                </div>
                <div class="stat-card">
                    <div class="stat-value" id="totalProjectsStat">0</div>
                    <div class="stat-label">Total Projects</div>
                </div>
            </div>

            <div class="two-column">
                <div class="card">
                    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px;">
                        <h3 style="margin: 0; color: var(--text-primary);">Events Calendar</h3>
                        <div style="display: flex; gap: 8px; align-items: center;">
                            <button onclick="changeCalendarMonth(-1)" style="background: var(--section-bg); border: none; border-radius: 50%; width: 30px; height: 30px; cursor: pointer; display: flex; align-items: center; justify-content: center; color: var(--text-primary);" title="Previous Month"></button>
                            <span id="calendarMonthYear" style="font-weight: 600; min-width: 120px; text-align: center; color: var(--text-primary); font-size: 14px;"></span>
                            <button onclick="changeCalendarMonth(1)" style="background: var(--section-bg); border: none; border-radius: 50%; width: 30px; height: 30px; cursor: pointer; display: flex; align-items: center; justify-content: center; color: var(--text-primary);" title="Next Month"></button>
                    </div>
                    </div>
                    
                    <!-- Calendar Grid -->
                    <div id="eventsCalendar" style="display: grid; grid-template-columns: repeat(7, 1fr); gap: 2px; margin-bottom: 15px;">
                        <!-- Days of week header -->
                        <div style="padding: 8px 4px; text-align: center; font-weight: 600; font-size: 12px; color: var(--text-secondary);">Sun</div>
                        <div style="padding: 8px 4px; text-align: center; font-weight: 600; font-size: 12px; color: var(--text-secondary);">Mon</div>
                        <div style="padding: 8px 4px; text-align: center; font-weight: 600; font-size: 12px; color: var(--text-secondary);">Tue</div>
                        <div style="padding: 8px 4px; text-align: center; font-weight: 600; font-size: 12px; color: var(--text-secondary);">Wed</div>
                        <div style="padding: 8px 4px; text-align: center; font-weight: 600; font-size: 12px; color: var(--text-secondary);">Thu</div>
                        <div style="padding: 8px 4px; text-align: center; font-weight: 600; font-size: 12px; color: var(--text-secondary);">Fri</div>
                        <div style="padding: 8px 4px; text-align: center; font-weight: 600; font-size: 12px; color: var(--text-secondary);">Sat</div>
                        <!-- Calendar days will be populated here -->
                    </div>
                    

                </div>
                <div class="card">
                    <h3 style="margin-top: 0; color: var(--text-primary);">Quick Actions</h3>
                    <button class="btn btn-success" onclick="openNewProjectModal()" style="width: 100%; margin-bottom: 15px;">New Project</button>
                    <button class="btn btn-coral" onclick="showTab('projects', event)" style="width: 100%; margin-bottom: 15px;">View All Projects</button>
                    <button class="btn" onclick="addQuickEvent()" style="width: 100%; margin-bottom: 15px;">Quick Add Event</button>
                </div>
            </div>
        </div>

        <!-- Projects Tab -->
        <div id="projects" class="tab-content">
            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 30px;">
                <div>
                    <h2 style="margin: 0; color: var(--text-primary); font-weight: 300;">Projects</h2>
                    <div class="desktop-only" style="margin-top: 10px; display: flex; gap: 10px; align-items: center;">
                        <input type="text" id="projectSearch" placeholder="Search projects..." style="padding: 8px 12px; border: 2px solid var(--section-bg); border-radius: 20px; width: 250px; font-size: 14px;" onkeyup="filterProjects()">
                        <select id="statusFilter" onchange="filterProjects()" style="padding: 8px 12px; border: 2px solid var(--section-bg); border-radius: 12px;">
                            <option value="active">Active Only</option>
                            <option value="">All Status</option>
                            <option value="consultation">Consultation</option>
                            <option value="design">Design</option>
                            <option value="sourcing">Sourcing</option>
                            <option value="ordering">Ordering</option>
                            <option value="delivery">Delivery</option>
                            <option value="completed">Completed</option>
                        </select>
                    </div>
                </div>
                <div class="desktop-only">
                    <button class="btn" onclick="duplicateProject()" style="margin-right: 10px;">Duplicate Last</button>
                    <button class="btn btn-success" onclick="openNewProjectModal()">Create New Project</button>
                </div>
                <div class="mobile-only mobile-main-buttons">
                    <button class="btn mobile-btn notes-btn" onclick="openNotesModal()" ontouchstart="">
                        <span class="btn-icon"></span>
                        <span class="btn-title">Add Notes</span>
                    </button>
                    <button class="btn mobile-btn event-btn" onclick="alert('Add Event feature coming soon!')" ontouchstart="">
                        <span class="btn-icon"></span>
                        <span class="btn-title">Add Event</span>
                    </button>
                    <button class="btn mobile-btn projects-btn" onclick="alert('Open Projects feature coming soon!')" ontouchstart="">
                        <span class="btn-icon"></span>
                        <span class="btn-title">Open Projects</span>
                    </button>
                </div>
            </div>
            
            <div class="project-grid" id="projectGrid">
                <!-- Projects will be populated here -->
            </div>
        </div>


    </div>

    <!-- New/Edit Project Modal -->
    <div id="projectModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2 id="modalTitle" style="margin: 0; color: var(--text-primary);">Create New Project</h2>
                <span class="close" onclick="closeProjectModal()">&times;</span>
            </div>
            <div class="modal-body">
                <div class="two-column">
                    <div>
                        <div class="form-group">
                            <label for="projectName">Project Name:</label>
                            <input type="text" id="projectName" required>
                        </div>
                        <div class="form-group">
                            <label for="clientName">Client Name:</label>
                            <input type="text" id="clientName" required>
                        </div>
                        <div class="form-group">
                            <label for="clientEmail">Client Email:</label>
                            <input type="email" id="clientEmail" placeholder="client@example.com">
                        </div>
                        <div class="form-group">
                            <label for="clientPhone">Client Phone:</label>
                            <input type="tel" id="clientPhone" placeholder="(555) 123-4567">
                        </div>
                        <div class="form-group">
                            <label for="clientAddress">Client Address:</label>
                            <textarea id="clientAddress" rows="2" placeholder="Full address"></textarea>
                        </div>
                    </div>
                    <div>
                        <div class="form-group">
                            <label for="projectStatus">Project Status:</label>
                            <select id="projectStatus">
                                <option value="consultation">Consultation</option>
                                <option value="design">Design Phase</option>
                                <option value="sourcing">Sourcing</option>
                                <option value="ordering">Ordering</option>
                                <option value="delivery">Delivery</option>
                                <option value="completed">Completed</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label for="startDate">Start Date:</label>
                            <input type="date" id="startDate">
                        </div>
                        <div class="form-group">
                            <label for="budget">Budget (Optional):</label>
                            <input type="number" id="budget" step="0.01" placeholder="Leave blank if no budget">
                        </div>
                        <div class="form-group">
                            <label for="hourlyRate">Hourly Rate:</label>
                            <input type="number" id="hourlyRate" step="0.01" value="75" placeholder="75.00">
                        </div>
                        <div class="form-group">
                            <label for="hoursPaid">Hours Paid:</label>
                            <input type="text" id="hoursPaid" value="10:00" placeholder="e.g. 10:00 or 5:30">
                        </div>
                        <div class="form-group">
                            <label for="projectNotes">Notes:</label>
                            <textarea id="projectNotes" rows="3"></textarea>
                        </div>
                    </div>
                </div>
                
                <div class="modal-actions">
                    <button class="btn btn-success" onclick="saveProject()">Save Project</button>
                    <button class="btn" onclick="closeProjectModal()">Cancel</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Project Detail Modal -->
    <div id="projectDetailModal" class="modal">
        <div class="modal-content">
          <div class="modal-header">
              <div class="modal-header-inner">
                  <div>
                    <h2 id="projectDetailTitle" style="margin: 0; color: var(--text-primary);">Project Details</h2>
                    <span id="projectDetailClient" style="color: var(--text-secondary); font-size: 16px;"></span>
                  </div>
                  <span class="close" onclick="closeProjectDetailModal()">&times;</span>
              </div>
              <div class="project-tabs">
                  <button class="project-tab active" onclick="showProjectSection('overview', this)">Details</button>
                  <button class="project-tab" onclick="showProjectSection('items', this)">Items</button>
                  <button class="project-tab" onclick="showProjectSection('orders', this)">Orders</button>
                  <button class="project-tab" onclick="showProjectSection('moodboards', this)">Mood Boards</button>
                  <button class="project-tab" onclick="showProjectSection('invoice', this)">Invoice</button>
              </div>
            </div>
          <div class="modal-body">
              <div class="project-sections-container">
                    <!-- Project Details Section -->
                    <div id="overview" class="project-section active">
                    <!-- Top Priority: Client Info, Hours & Quick Actions in compact layout -->
                    <div style="display: grid; grid-template-columns: 2fr 1fr 1.5fr; gap: 20px; margin-bottom: 20px;">
                        <div class="card">
                            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px;">
                                <h4 style="margin: 0; font-size: 16px;">Client Info</h4>
                                <button class="btn btn-small btn-coral" onclick="editProjectInfo()"> Edit</button>
                            </div>
                            <p style="margin: 8px 0; font-size: 14px;"><strong>Client:</strong> <span id="detailClientName"></span></p>
                            <p style="margin: 8px 0; font-size: 14px;"><strong>Email:</strong> <span id="detailClientEmail"></span></p>
                            <p style="margin: 8px 0; font-size: 14px;"><strong>Phone:</strong> <span id="detailClientPhone"></span></p>
                            <p style="margin: 8px 0; font-size: 14px;"><strong>Address:</strong> <span id="detailClientAddress"></span></p>
                            <p style="margin: 8px 0; font-size: 14px;"><strong>Status:</strong> <span id="detailStatus"></span></p>
                            <p style="margin: 8px 0; font-size: 14px;"><strong>Start Date:</strong> <span id="detailStartDate"></span></p>
                            <p style="margin: 8px 0; font-size: 14px;"><strong>Budget:</strong> <span id="detailBudget"></span></p>
                        </div>
                        
                        <div class="card">
                            <h4 style="margin: 0 0 10px 0; font-size: 16px;">Hours</h4>
                            <div style="text-align: center; padding: 12px; background: var(--task-bg); border-radius: 8px; margin-bottom: 10px;">
                                <div style="font-size: 20px; font-weight: 700; color: var(--text-primary);" id="detailHoursWorked">0</div>
                                <div style="font-size: 11px; color: var(--text-secondary);">Worked</div>
                            </div>
                            <div style="text-align: center; padding: 12px; background: var(--info); border-radius: 8px; margin-bottom: 10px;">
                                <div style="font-size: 20px; font-weight: 700; color: var(--text-primary);" id="detailHoursPaid">0</div>
                                <div style="font-size: 11px; color: var(--text-secondary);">Paid Hours</div>
                            </div>
                            <div style="text-align: center; padding: 12px; background: var(--success); border-radius: 8px;">
                                <div style="font-size: 20px; font-weight: 700; color: var(--text-primary);" id="detailHoursRemaining">0</div>
                                <div style="font-size: 11px; color: var(--text-secondary);">Remaining</div>
                            </div>
                        </div>

                        <div class="card">
                            <h4 style="margin: 0 0 10px 0; font-size: 16px;">Quick Actions</h4>
                            <button class="btn" onclick="changeProjectStatus()" style="margin: 4px 0; width: 100%; padding: 10px 15px; font-size: 14px; background: var(--secondary-brand); color: white;"> Change Status</button>
                            <button class="btn" onclick="addEvent()" style="margin: 4px 0; width: 100%; padding: 10px 15px; font-size: 14px; background: var(--highlight); color: white;"> Add Event</button>
                            <button class="btn" onclick="logProjectHours()" style="margin: 4px 0; width: 100%; padding: 10px 15px; font-size: 14px; background: var(--warning); color: var(--text-primary);"> Log Hours</button>                                          
                            <button class="btn" onclick="addPaidHours()" style="margin: 4px 0; width: 100%; padding: 10px 15px; font-size: 14px; background: var(--success); color: white;"> Add Paid Hours</button>
                        </div>
                    </div>

                    <!-- Upcoming Events only -->
                    <div class="card" style="margin-top: 20px;">
                        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px;">
                            <h4 style="margin: 0; font-size: 16px;">Upcoming Events</h4>
                            <button onclick="addProjectEvent()" style="background: var(--primary-brand); color: white; border: none; padding: 8px 16px; border-radius: 6px; font-size: 13px; cursor: pointer; display: flex; align-items: center; gap: 6px; transition: all 0.2s ease;" onmouseover="this.style.transform='translateY(-1px)'; this.style.boxShadow='0 4px 8px rgba(0,0,0,0.15)'" onmouseout="this.style.transform='translateY(0)'; this.style.boxShadow='none'">
                                <span style="font-size: 14px;">+</span>
                                Add Event
                            </button>
                        </div>
                        <div id="projectUpcomingEvents"></div>
                    </div>
                    
                    <!-- Project Notes -->
                    <div class="card" style="margin-top: 20px;">
                        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px;">
                            <h4 style="margin: 0; font-size: 16px;"> Project Notes</h4>
                            <button onclick="addProjectNote()" style="background: var(--secondary-brand); color: white; border: none; padding: 8px 16px; border-radius: 6px; font-size: 13px; cursor: pointer; display: flex; align-items: center; gap: 6px; transition: all 0.2s ease;" onmouseover="this.style.transform='translateY(-1px)'; this.style.boxShadow='0 4px 8px rgba(0,0,0,0.15)'" onmouseout="this.style.transform='translateY(0)'; this.style.boxShadow='none'">
                                <span style="font-size: 14px;">+</span>
                                Add Note
                            </button>
                        </div>
                        <div id="projectNotes" style="max-height: 400px; overflow-y: auto;"></div>
                    </div>
                    

                </div>

                <!-- Items Section -->
                <div id="items" class="project-section">
                    <div style="margin-bottom: 30px;">
                    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
                        <h3 style="margin: 0; color: var(--text-primary);">Project Items</h3>
                            <div style="display: flex; gap: 12px; align-items: center;">
                                <button onclick="toggleFileManagement()" style="padding: 12px 20px; background: var(--secondary-brand); color: white; border-radius: 10px; font-weight: 500; border: none; cursor: pointer; transition: all 0.2s ease; display: flex; align-items: center; gap: 8px;" onmouseover="this.style.transform='translateY(-2px)'; this.style.boxShadow='0 6px 20px rgba(156, 174, 194, 0.3)'" onmouseout="this.style.transform='translateY(0)'; this.style.boxShadow='none'">
                                    <span id="fileManagementIcon" style="transition: transform 0.2s ease;"></span>
                                    <span>File Tools</span>
                                </button>
                                <button class="btn" onclick="addNewSection()" style="background: var(--success); color: white; padding: 12px 24px; border-radius: 10px; font-weight: 600; border: none; cursor: pointer; transition: all 0.2s ease; display: flex; align-items: center; gap: 8px;" onmouseover="this.style.transform='translateY(-2px)'; this.style.boxShadow='0 6px 20px rgba(183, 196, 178, 0.3)'" onmouseout="this.style.transform='translateY(0)'; this.style.boxShadow='none'">
                                    <span style="font-size: 16px;">+</span>
                                    Add New Section
                                </button>
                            </div>
                        </div>
                        
                        <!-- Collapsible File Management Actions -->
                        <div id="fileManagementSection" style="display: none; margin-bottom: 20px; overflow: hidden; transition: all 0.3s ease;">
                                <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 15px; padding: 20px; background: var(--section-bg); border-radius: 12px; border: 1px solid var(--hover-bg);">
                                    <div style="text-align: center;">
                                        <div style="width: 50px; height: 50px; background: var(--primary-brand); border-radius: 12px; display: flex; align-items: center; justify-content: center; margin: 0 auto 12px; color: white; font-size: 20px;"></div>
                                        <h4 style="margin: 0 0 8px 0; font-size: 16px; color: var(--text-primary);">Import Items</h4>
                                        <p style="margin: 0 0 15px 0; font-size: 13px; color: var(--text-secondary); line-height: 1.4;">Upload a CSV file with your project items</p>
                                        <button class="btn" onclick="importItemsCSV()" style="background: var(--primary-brand); color: white; padding: 10px 20px; border-radius: 8px; font-weight: 500; border: none; cursor: pointer; transition: all 0.2s ease; width: 100%;" onmouseover="this.style.background='#c49999'" onmouseout="this.style.background='var(--primary-brand)'">
                                            Import CSV
                                        </button>
                                    </div>
                                    
                                    <div style="text-align: center;">
                                        <div style="width: 50px; height: 50px; background: var(--secondary-brand); border-radius: 12px; display: flex; align-items: center; justify-content: center; margin: 0 auto 12px; color: white; font-size: 20px;"></div>
                                        <h4 style="margin: 0 0 8px 0; font-size: 16px; color: var(--text-primary);">Get Template</h4>
                                        <p style="margin: 0 0 15px 0; font-size: 13px; color: var(--text-secondary); line-height: 1.4;">Download the CSV template with proper formatting</p>
                                        <button class="btn" onclick="downloadCSVTemplate()" style="background: var(--secondary-brand); color: white; padding: 10px 20px; border-radius: 8px; font-weight: 500; border: none; cursor: pointer; transition: all 0.2s ease; width: 100%;" onmouseover="this.style.background='#8a9bb0'" onmouseout="this.style.background='var(--secondary-brand)'">
                                            Download Template
                                        </button>
                                    </div>
                                    
                                    <div style="text-align: center;">
                                        <div style="width: 50px; height: 50px; background: var(--highlight); border-radius: 12px; display: flex; align-items: center; justify-content: center; margin: 0 auto 12px; color: white; font-size: 20px;"></div>
                                        <h4 style="margin: 0 0 8px 0; font-size: 16px; color: var(--text-primary);">Export Items</h4>
                                        <p style="margin: 0 0 15px 0; font-size: 13px; color: var(--text-secondary); line-height: 1.4;">Download all project items as CSV file</p>
                                        <button class="btn" onclick="downloadProjectItemsCSV()" style="background: var(--highlight); color: white; padding: 10px 20px; border-radius: 8px; font-weight: 500; border: none; cursor: pointer; transition: all 0.2s ease; width: 100%;" onmouseover="this.style.background='#a5b29f'" onmouseout="this.style.background='var(--highlight)'">
                                            Export Items
                                        </button>
                                    </div>
                                </div>
                            </div>
                        </div>
                    
                    <div id="projectSections">
                        <!-- Sections will be populated here -->
                    </div>
                    </div>
                </div>

                <!-- Orders Section -->
                <div id="orders" class="project-section">
                    <!-- Delivery Progress -->
                    <div class="card" style="margin-bottom: 25px;">
                        <h3 style="margin: 0 0 20px 0; text-align: center; color: var(--text-primary); font-weight: 600;">Delivery Progress</h3>
                        
                        
                        <!-- Status Legend -->
                        <div style="display: grid; grid-template-columns: repeat(4, 1fr); gap: 15px;">
                            <div onclick="setOrderFilter('pending')" id="pendingFilter" style="text-align: center; padding: 15px; background: var(--warning); color: white; border-radius: 8px; cursor: pointer; transition: all 0.2s ease; position: relative;" 
                                 onmouseover="this.style.transform='translateY(-2px)'; this.style.boxShadow='0 4px 12px rgba(0,0,0,0.2)'" 
                                 onmouseout="this.style.transform='translateY(0)'; this.style.boxShadow='none'">
                                <div style="font-size: 24px; font-weight: 700; margin-bottom: 5px;" id="pendingTotal">0</div>
                                <div style="font-size: 14px; font-weight: 500;">PENDING</div>
                            </div>
                            <div onclick="setOrderFilter('ordered')" id="orderedFilter" style="text-align: center; padding: 15px; background: var(--secondary-brand); color: white; border-radius: 8px; cursor: pointer; transition: all 0.2s ease; position: relative;" 
                                 onmouseover="this.style.transform='translateY(-2px)'; this.style.boxShadow='0 4px 12px rgba(0,0,0,0.2)'" 
                                 onmouseout="this.style.transform='translateY(0)'; this.style.boxShadow='none'">
                                <div style="font-size: 24px; font-weight: 700; margin-bottom: 5px;" id="orderedTotal">0</div>
                                <div style="font-size: 14px; font-weight: 500;">ORDERED</div>
                            </div>
                            <div onclick="setOrderFilter('shipped')" id="shippedFilter" style="text-align: center; padding: 15px; background: var(--primary-brand); color: white; border-radius: 8px; cursor: pointer; transition: all 0.2s ease; position: relative;" 
                                 onmouseover="this.style.transform='translateY(-2px)'; this.style.boxShadow='0 4px 12px rgba(0,0,0,0.2)'" 
                                 onmouseout="this.style.transform='translateY(0)'; this.style.boxShadow='none'">
                                <div style="font-size: 24px; font-weight: 700; margin-bottom: 5px;" id="shippedTotal">0</div>
                                <div style="font-size: 14px; font-weight: 500;">SHIPPED</div>
                            </div>
                            <div onclick="setOrderFilter('delivered')" id="deliveredFilter" style="text-align: center; padding: 15px; background: var(--success); color: white; border-radius: 8px; cursor: pointer; transition: all 0.2s ease; position: relative;" 
                                 onmouseover="this.style.transform='translateY(-2px)'; this.style.boxShadow='0 4px 12px rgba(0,0,0,0.2)'" 
                                 onmouseout="this.style.transform='translateY(0)'; this.style.boxShadow='none'">
                                <div style="font-size: 24px; font-weight: 700; margin-bottom: 5px;" id="deliveredTotal">0</div>
                                <div style="font-size: 14px; font-weight: 500;">DELIVERED</div>
                            </div>
                        </div>
                        
                        <!-- Clear Filter Button -->
                        <div id="clearFilterButton" style="text-align: center; margin-top: 15px; display: none;">
                            <button onclick="setOrderFilter('')" style="background: var(--hover-bg); color: var(--text-primary); border: none; padding: 8px 16px; border-radius: 6px; font-size: 13px; cursor: pointer; font-weight: 500; transition: all 0.2s ease;" 
                                    onmouseover="this.style.background='var(--section-bg)'" 
                                    onmouseout="this.style.background='var(--hover-bg)'">
                                 Show All Items
                            </button>
                        </div>
                    </div>
                    
                    
                    
                    <!-- Order Sections -->
                    <div id="orderSectionsList">
                        <!-- Order sections will be populated here -->
                    </div>
                </div>

                <!-- Mood Boards Section -->
                <div id="moodboards" class="project-section">
                    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
                        <h3 style="margin: 0; color: var(--text-primary);">Mood Boards</h3>
                        <button class="btn btn-success" onclick="uploadMoodBoard()">Upload Mood Board</button>
                    </div>
                    <div id="moodBoardGallery">
                        <!-- Mood boards will be populated here -->
                    </div>
                </div>

                <!-- Invoice Section -->
                <div id="invoice" class="project-section">
                    <div style="margin-bottom: 30px;">
                        <h3 style="margin: 0 0 15px 0; color: var(--text-primary);">Generate Invoices by Section</h3>
                        <p style="margin: 0 0 20px 0; color: var(--text-secondary); font-size: 14px;">Create separate invoices for each project section/category. This allows for flexible billing and payment tracking.</p>
                        
                        <div id="sectionInvoiceList" style="display: grid; gap: 15px;">
                            <!-- Section invoice options will be populated here -->
                        </div>
                    </div>
                    
                    <div class="invoice-preview" id="projectInvoicePreview">
                        <!-- Invoice preview will be populated here -->
                    </div>
                </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Invoice Confirmation Modal -->
    <div id="invoiceConfirmModal" class="modal">
        <div class="modal-content" style="max-width: 900px; max-height: 90vh; overflow-y: auto;">
            <div class="modal-header" style="position: sticky; top: 0; z-index: 10; background: var(--card-bg);">
                <div style="display: flex; justify-content: space-between; align-items: center; width: 100%;">
                    <h2 style="margin: 0; color: var(--text-primary);"> Confirm Invoice Items</h2>
                    <span class="close" onclick="closeInvoiceConfirmModal()">&times;</span>
                </div>
            </div>
            <div style="padding: 20px;">
                <div style="background: linear-gradient(135deg, #f8f9fa, #e9ecef); padding: 20px; border-radius: 12px; margin-bottom: 24px; border-left: 4px solid var(--primary-brand);">
                    <div style="display: flex; align-items: center; gap: 12px; margin-bottom: 12px;">
                        <div style="background: var(--primary-brand); color: white; border-radius: 50%; width: 32px; height: 32px; display: flex; align-items: center; justify-content: center; font-weight: 600;"></div>
                        <h3 style="margin: 0; color: var(--text-primary); font-weight: 600; font-size: 16px;">Review Invoice Items</h3>
                    </div>
                    <p style="margin: 0; color: var(--text-secondary); font-size: 14px; line-height: 1.5;">
                        Please review and confirm all item details before generating the invoice. Click any field to edit pricing, quantities, shipping, or tax amounts.
                    </p>
                </div>
                
                <div id="invoiceConfirmationTable">
                    <!-- Confirmation table will be populated here -->
                </div>
                
                <div style="margin-top: 32px; padding: 24px; background: linear-gradient(135deg, #f8f9fa, #e9ecef); border-radius: 12px; border-top: 3px solid var(--primary-brand);">
                    <div style="display: flex; justify-content: space-between; align-items: center; gap: 20px;">
                        <div style="display: flex; flex-direction: column; gap: 4px;">
                            <div style="color: var(--text-primary); font-weight: 600; font-size: 16px;">
                                Ready to Generate Invoice
                            </div>
                            <div style="color: var(--text-secondary); font-size: 14px;">
                                <span id="confirmedItemsCountBottom">0</span> of <span id="totalItemsCountBottom">0</span> items confirmed
                            </div>
                        </div>
                        <div style="display: flex; gap: 12px;">
                            <button class="btn" onclick="closeInvoiceConfirmModal()" 
                                    style="background: white; color: var(--text-primary); border: 2px solid #e9ecef; padding: 12px 24px; border-radius: 8px; font-weight: 600; transition: all 0.2s ease;">
                                Cancel
                            </button>
                            <button id="confirmInvoiceBtn" class="btn" onclick="generateConfirmedInvoice()" 
                                    style="background: linear-gradient(135deg, var(--primary-brand), var(--secondary-brand)); color: white; border: none; padding: 12px 28px; border-radius: 8px; font-weight: 600; box-shadow: 0 4px 12px rgba(216, 167, 167, 0.3); transition: all 0.2s ease;" disabled>
                                <span style="display: flex; align-items: center; gap: 8px;">
                                    <span></span>
                                    <span>Generate Invoice</span>
                                </span>
                            </button>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
    
    <style>
        /* Ensure modal scrolls properly */
        .modal {
            padding: 20px;
            box-sizing: border-box;
        }
        
        .modal-content {
            margin: 0 auto;
            position: relative;
        }
    </style>

    <script>
        // Notes modal function moved to end of script with other mobile functions
        
        // Sample data with enhanced structure
        // Global variables
        window.projects = JSON.parse(localStorage.getItem('projects') || '[]');
        let projects = window.projects; // Keep reference for existing code
        let currentProject = null;
        let invoiceCounter = parseInt(localStorage.getItem('invoiceCounter') || '1204');


        // Firebase Database Helper Functions
        async function saveProjects() {
            try {
                // Ensure global reference is up to date
                window.projects = projects;
                
                if (window.firestore && window.firestoreFunctions) {
                    const { doc, setDoc } = window.firestoreFunctions;
                    await setDoc(doc(window.firestore, 'appData', 'projects'), {
                        projects: projects,
                        lastUpdated: new Date().toISOString()
                    });
                    console.log('Projects saved to Firebase');
                }
            } catch (error) {
                console.error('Error saving projects:', error);
            }
            
            // Always save to localStorage as backup
            localStorage.setItem('projects', JSON.stringify(projects));
        }

        async function saveInvoiceCounter() {
            try {
                if (window.firestore && window.firestoreFunctions) {
                    const { doc, setDoc } = window.firestoreFunctions;
                    await setDoc(doc(window.firestore, 'appData', 'invoiceCounter'), {
                        counter: invoiceCounter,
                        lastUpdated: new Date().toISOString()
                    });
                    console.log('Invoice counter saved to Firebase');
                }
            } catch (error) {
                console.error('Error saving invoice counter:', error);
            }
            
            // Always save to localStorage as backup
            localStorage.setItem('invoiceCounter', invoiceCounter.toString());
        }

        async function loadProjects() {
            try {
                if (window.firestore && window.firestoreFunctions) {
                    const { doc, getDoc } = window.firestoreFunctions;
                    const docSnap = await getDoc(doc(window.firestore, 'appData', 'projects'));
                    if (docSnap.exists()) {
                        const data = docSnap.data();
                        projects = data.projects || [];
                        window.projects = projects; // Update global reference
                        console.log('Projects loaded from Firebase');
                        return true;
                    } else {
                        console.log('No projects found in Firebase, using localStorage');
                        return false;
                    }
                } else {
                    return false;
                }
            } catch (error) {
                console.error('Error loading projects:', error);
                return false;
            }
        }

        async function loadInvoiceCounter() {
            try {
                if (window.firestore && window.firestoreFunctions) {
                    const { doc, getDoc } = window.firestoreFunctions;
                    const docSnap = await getDoc(doc(window.firestore, 'appData', 'invoiceCounter'));
                    if (docSnap.exists()) {
                        const data = docSnap.data();
                        invoiceCounter = data.counter || 1204;
                        console.log('Invoice counter loaded from Firebase');
                        return true;
                    } else {
                        console.log('No invoice counter found in Firebase, using localStorage');
                        return false;
                    }
                } else {
                    return false;
                }
            } catch (error) {
                console.error('Error loading invoice counter:', error);
                return false;
            }
        }

        // Initialize data loading
        async function initializeApp() {
            try {
                // Wait for Firebase to be ready
                let attempts = 0;
                while (!window.firestore && attempts < 10) {
                    await new Promise(resolve => setTimeout(resolve, 100));
                    attempts++;
                }

                const projectsLoaded = await loadProjects();
                const counterLoaded = await loadInvoiceCounter();
                
                if (!projectsLoaded || !counterLoaded) {
                    console.log('Using localStorage fallback');
                }
                
                // Migrate old data if needed
                migrateOldProjects();
                
                // Initialize UI
                updateDashboard();
                updateEventsCalendar();
                
                // Check if mobile and switch to Projects tab
                if (window.innerWidth <= 768) {
                    showTab('projects');
                }
                
                // Make sure functions are globally available
                window.showAddNotesModal = showAddNotesModal;
                window.showMobileAddEventModal = showMobileAddEventModal;
                window.showMobileProjectsView = showMobileProjectsView;
                
                // Set up mobile button event listeners as fallback
                setupMobileButtonListeners();
                
                // Debug: Test if functions are callable
                console.log('showAddNotesModal available:', typeof window.showAddNotesModal);
                console.log('Projects loaded:', Array.isArray(window.projects) ? window.projects.length : 'No projects');
                
                console.log('App initialized successfully');
            } catch (error) {
                console.error('Error initializing app:', error);
            }
        }

        // Replace all localStorage.setItem calls with our save functions
        function saveData() {
            saveProjects();
            saveInvoiceCounter();
        }

        // Global helper functions for hours:minutes input format
        function parseHoursMinutes(input) {
            if (!input) return 0;
            
            // Handle decimal input (backwards compatibility)
            if (!isNaN(parseFloat(input)) && !input.includes(':')) {
                return parseFloat(input);
            }
            
            // Handle hours:minutes format (5:45, 5:30, 2:15, etc.)
            const timeMatch = input.toString().match(/^(\d+):?(\d{0,2})$/);
            if (!timeMatch) return NaN;
            
            const hours = parseInt(timeMatch[1]) || 0;
            const minutes = parseInt(timeMatch[2]) || 0;
            
            if (minutes >= 60) return NaN;
            
            return hours + (minutes / 60);
        }

        function formatHoursMinutes(decimalHours) {
            if (!decimalHours) return '0:00';
            const hours = Math.floor(decimalHours);
            const minutes = Math.round((decimalHours - hours) * 60);
            return `${hours}:${minutes.toString().padStart(2, '0')}`;
        }
        let expandedSections = new Set(); // Track which sections are expanded
        
        // Migrate old project format to new pricing structure
        function migrateOldProjects() {
            let needsSaving = false;
            projects.forEach(project => {
                if (project.sections) {
                    project.sections.forEach(section => {
                        section.items.forEach(item => {
                            // If item has old 'price' field but no 'customerPrice', migrate it
                            if (item.price && !item.customerPrice) {
                                item.customerPrice = item.price;
                                item.wholesalePrice = item.price * 0.7; // Estimate 30% markup
                                item.shipping = 0;
                                item.tax = 0;
                                needsSaving = true;
                            }
                            
                            // Migrate old item property to name property
                            if (item.item && !item.name) {
                                item.name = item.item;
                                delete item.item;
                                needsSaving = true;
                            }
                            
                            // Migrate orderStatus to deliveryStatus
                            if (item.orderStatus && !item.deliveryStatus) {
                                item.deliveryStatus = item.orderStatus;
                                delete item.orderStatus;
                                needsSaving = true;
                            }
                            
                            // Ensure deliveryStatus exists
                            if (!item.deliveryStatus) {
                                item.deliveryStatus = 'pending';
                                needsSaving = true;
                            }
                            
                            // Ensure shippingInfo exists
                            if (!item.shippingInfo) {
                                item.shippingInfo = {
                                    carrier: '',
                                    trackingNumber: '',
                                    shippingMethod: '',
                                    estimatedDelivery: '',
                                    shippingCost: parseFloat(item.shipping) || 0,
                                    orderDate: '',
                                    notes: ''
                                };
                                needsSaving = true;
                            }
                            
                            // Ensure readyToOrder exists
                            if (item.readyToOrder === undefined) {
                                item.readyToOrder = false;
                                needsSaving = true;
                            }
                        });
                    });
                }
            });
            if (needsSaving) {
                saveProjects();
            }
        }

        // Add sample project with enhanced data if none exist
        if (projects.length === 0) {
            projects = [{
                id: 1,
                name: "Modern Office Redesign",
                client: "Mitchel Pisarz",
                clientEmail: "mitchel@example.com",
                clientPhone: "(555) 123-4567",
                clientAddress: "123 Business Ave, Suite 100\nNew York, NY 10001",
                status: "ordering",
                startDate: "2025-01-01",
                budget: 2500,
                hoursPaid: 20,
                hoursWorked: 12.5,
                notes: "Complete office transformation with modern aesthetic",
                sections: [
                    {
                        id: 1,
                        name: "Reception Area",
                        items: [
                            { id: 1, name: "Reception Desk", qty: 1, customerPrice: 899.00, wholesalePrice: 650.00, shipping: 75.00, tax: 67.43, link: "https://example.com/desk", readyToOrder: true, deliveryStatus: "pending", shippingInfo: { carrier: '', trackingNumber: '', shippingMethod: '', estimatedDelivery: '', shippingCost: 75.00, orderDate: '', notes: '' } },
                            { id: 2, name: "Waiting Chairs", qty: 4, customerPrice: 249.00, wholesalePrice: 175.00, shipping: 25.00, tax: 79.84, link: "https://example.com/chairs", readyToOrder: false, deliveryStatus: "pending", shippingInfo: { carrier: '', trackingNumber: '', shippingMethod: '', estimatedDelivery: '', shippingCost: 25.00, orderDate: '', notes: '' } }
                        ]
                    },
                    {
                        id: 2,
                        name: "Conference Room",
                        items: [
                            { id: 3, name: "Conference Table", qty: 1, customerPrice: 1299.00, wholesalePrice: 950.00, shipping: 125.00, tax: 113.99, link: "https://example.com/table", readyToOrder: true, deliveryStatus: "pending", shippingInfo: { carrier: '', trackingNumber: '', shippingMethod: '', estimatedDelivery: '', shippingCost: 125.00, orderDate: '', notes: '' } },
                            { id: 4, name: "Conference Chairs", qty: 8, customerPrice: 189.00, wholesalePrice: 135.00, shipping: 15.00, tax: 12.32, link: "https://example.com/conf-chairs", readyToOrder: true, deliveryStatus: "pending", shippingInfo: { carrier: '', trackingNumber: '', shippingMethod: '', estimatedDelivery: '', shippingCost: 15.00, orderDate: '', notes: '' } }
                        ]
                    }
                ],
                events: [
                    { id: 1, type: "consultation", title: "Initial Consultation", date: "2025-01-01", time: "10:00", notes: "Discussed client needs", completed: true },
                    { id: 2, type: "design", title: "Design Presentation", date: "2025-01-15", time: "14:00", notes: "Presented concepts", completed: true },
                    { id: 3, type: "meeting", title: "Final Review", date: "2025-01-30", time: "11:00", notes: "Final design approval", completed: false }
                ],
                hoursLog: [
                    { id: 1, date: "2025-01-01", hours: 2, description: "Initial consultation and space assessment" },
                    { id: 2, date: "2025-01-10", hours: 4, description: "Research and design development" },
                    { id: 3, date: "2025-01-15", hours: 3, description: "Design presentation preparation" },
                    { id: 4, date: "2025-01-20", hours: 2.5, description: "Client feedback and revisions" },
                    { id: 5, date: "2025-01-25", hours: 1, description: "Vendor coordination" }
                ],
                moodBoards: [],
                moodBoardsByRoom: {},
                invoiceNumber: "011204",
                amountPaid: 0
            }];
            saveProjects();
        }

        function showTab(tabName, event) {
            document.querySelectorAll('.tab-content').forEach(tab => {
                tab.classList.remove('active');
            });
            document.querySelectorAll('.tab').forEach(tab => {
                tab.classList.remove('active');
            });

            document.getElementById(tabName).classList.add('active');
            if (event && event.target) {
                event.target.classList.add('active');
            }

            if (tabName === 'dashboard') {
                updateDashboard();
                updateUpcomingEvents();
            } else if (tabName === 'projects') {
                displayProjects();
            }
        }

        function updateDashboard() {
            const totalProjects = projects.length;
            const activeProjects = projects.filter(p => p.status !== 'completed').length;
            
            let totalProfit = 0;
            let totalPaidHours = 0;
            
            projects.forEach(project => {
                const hourlyRate = project.hourlyRate || 75;
                const hoursPaid = project.hoursPaid || 0;
                
                // 1. Hourly income (hours paid  rate)
                const hourlyIncome = hoursPaid * hourlyRate;
                
                // 2. Item profit (only from ordered items, excluding grayed out sections)
                let itemProfit = 0;
                if (project.sections) {
                    project.sections.forEach(section => {
                        // Skip grayed out sections
                        if (section.isGrayedOut) return;
                        
                        section.items.forEach(item => {
                            // Only include profit from items that have been ordered
                            if (item.readyToOrder && item.orderStatus && item.orderStatus !== 'pending') {
                                const sellPrice = (item.customerPrice || item.price || 0) * (item.qty || 1);
                                const wholesalePrice = (item.wholesalePrice || 0) * (item.qty || 1);
                                const profit = sellPrice - wholesalePrice;
                                itemProfit += profit > 0 ? profit : 0; // Only positive profit
                            }
                        });
                    });
                }
                
                totalProfit += hourlyIncome + itemProfit;
                totalPaidHours += hoursPaid;
            });

            document.getElementById('totalProjectsStat').textContent = totalProjects;
            document.getElementById('totalRevenueStat').textContent = `$${totalProfit.toLocaleString('en-US', { minimumFractionDigits: 0, maximumFractionDigits: 0 })}`;
            document.getElementById('totalPaidHoursStat').textContent = `${Math.floor(totalPaidHours)} hrs`;
            document.getElementById('activeProjectsStat').textContent = activeProjects;
        }

        // Calendar state
        let currentCalendarDate = new Date();
        let calendarEvents = {};

        function updateEventsCalendar() {
            // Collect all events by date
            calendarEvents = {};
            
            projects.forEach(project => {
                if (project.events) {
                    project.events.forEach(event => {
                        if (!event.completed) {
                            const dateKey = new Date(event.date + 'T00:00:00').toDateString();
                            if (!calendarEvents[dateKey]) {
                                calendarEvents[dateKey] = [];
                            }
                            calendarEvents[dateKey].push({
                                ...event, 
                                projectName: project.name, 
                                clientName: project.client,
                                projectId: project.id
                            });
                        }
                    });
                }
            });
            
            renderCalendar();
        }

        function renderCalendar() {
            const calendar = document.getElementById('eventsCalendar');
            const monthYear = document.getElementById('calendarMonthYear');
            
            // Update month/year display
            const monthNames = ['January', 'February', 'March', 'April', 'May', 'June',
                'July', 'August', 'September', 'October', 'November', 'December'];
            monthYear.textContent = `${monthNames[currentCalendarDate.getMonth()]} ${currentCalendarDate.getFullYear()}`;
            
            // Clear existing days (keep header)
            const existingDays = calendar.querySelectorAll('.calendar-day');
            existingDays.forEach(day => day.remove());
            
            // Get first day of month and number of days
            const firstDay = new Date(currentCalendarDate.getFullYear(), currentCalendarDate.getMonth(), 1);
            const lastDay = new Date(currentCalendarDate.getFullYear(), currentCalendarDate.getMonth() + 1, 0);
            const startDate = new Date(firstDay);
            startDate.setDate(startDate.getDate() - firstDay.getDay()); // Start on Sunday
            
            const today = new Date();
            today.setHours(0, 0, 0, 0);
            
            // Generate 42 days (6 weeks)
            for (let i = 0; i < 42; i++) {
                const cellDate = new Date(startDate);
                cellDate.setDate(startDate.getDate() + i);
                
                const isCurrentMonth = cellDate.getMonth() === currentCalendarDate.getMonth();
                const isToday = cellDate.toDateString() === today.toDateString();
                const dateKey = cellDate.toDateString();
                const dayEvents = calendarEvents[dateKey] || [];
                
                const dayCell = document.createElement('div');
                dayCell.className = 'calendar-day';
                dayCell.style.cssText = `
                    padding: 6px 4px;
                    text-align: center;
                    cursor: pointer;
                    border-radius: 6px;
                    transition: all 0.2s ease;
                    font-size: 13px;
                    font-weight: ${isToday ? '600' : '400'};
                    color: ${isCurrentMonth ? 'var(--text-primary)' : 'var(--text-tertiary)'};
                    background: ${isToday ? 'var(--primary-brand)' : 'transparent'};
                    position: relative;
                    min-height: 32px;
                    display: flex;
                    flex-direction: column;
                    align-items: center;
                    justify-content: center;
                `;
                
                if (isToday) {
                    dayCell.style.color = 'white';
                }
                
                // Day number
                const dayNumber = document.createElement('div');
                dayNumber.textContent = cellDate.getDate();
                dayNumber.style.cssText = 'line-height: 1;';
                dayCell.appendChild(dayNumber);
                
                // Event indicators
                if (dayEvents.length > 0 && isCurrentMonth) {
                    const eventIndicator = document.createElement('div');
                    eventIndicator.style.cssText = `
                        font-size: 14px;
                        line-height: 1;
                        margin-top: 2px;
                        display: flex;
                        justify-content: center;
                        filter: drop-shadow(0 1px 2px rgba(0,0,0,0.3));
                    `;
                    
                    // Choose star color based on whether it's today or not
                    const starColor = isToday ? 'white' : 'var(--primary-brand)';
                    const shadowFilter = isToday ? 'drop-shadow(0 1px 3px rgba(0,0,0,0.5))' : 'drop-shadow(0 1px 2px rgba(0,0,0,0.3))';
                    eventIndicator.style.filter = shadowFilter;
                    
                    // Simple star indicator - more legible and consistent
                    if (dayEvents.length === 1) {
                        eventIndicator.innerHTML = `<span style="color: ${starColor};"></span>`;
                    } else if (dayEvents.length <= 3) {
                        eventIndicator.innerHTML = `<span style="color: ${starColor};"></span>`;
            } else {
                        eventIndicator.innerHTML = `<span style="color: ${starColor};"></span>`;
                    }
                    
                    dayCell.appendChild(eventIndicator);
                }
                
                // Hover effects
                if (isCurrentMonth) {
                    dayCell.onmouseover = () => {
                        if (!isToday) {
                            dayCell.style.background = 'var(--hover-bg)';
                        }
                    };
                    dayCell.onmouseout = () => {
                        if (!isToday) {
                            dayCell.style.background = 'transparent';
                        }
                    };
                    
                    // Click handler
                    dayCell.onclick = () => showDayEvents(cellDate, dayEvents);
                }
                
                calendar.appendChild(dayCell);
            }
        }

        function getEventTypeColor(type) {
            const colors = {
                'consultation': 'var(--secondary-brand)',
                'design': 'var(--success)',
                'meeting': 'var(--warning)',
                'delivery': 'var(--error)'
            };
            return colors[type] || 'var(--warning)';
        }

        function changeCalendarMonth(direction) {
            currentCalendarDate.setMonth(currentCalendarDate.getMonth() + direction);
            renderCalendar();
        }

        function showDayEvents(date, events) {
            showDayViewModal(date, events);
        }

        function showDayViewModal(selectedDate, events) {
            // Create modal overlay
            const overlay = document.createElement('div');
            overlay.style.cssText = `
                position: fixed;
                top: 0;
                left: 0;
                width: 100%;
                height: 100%;
                background: rgba(0, 0, 0, 0.7);
                backdrop-filter: blur(5px);
                z-index: 2000;
                display: flex;
                align-items: center;
                justify-content: center;
                padding: 20px;
            `;

            // Create modal content
            const modal = document.createElement('div');
            modal.style.cssText = `
                background: var(--card-bg);
                border-radius: 12px;
                box-shadow: 0 20px 40px rgba(0, 0, 0, 0.3);
                width: 100%;
                max-width: 800px;
                height: 90vh;
                display: flex;
                flex-direction: column;
                overflow: hidden;
            `;

            // Header
            const header = document.createElement('div');
            header.style.cssText = `
                padding: 20px 24px;
                border-bottom: 1px solid var(--hover-bg);
                display: flex;
                justify-content: space-between;
                align-items: center;
                background: var(--section-bg);
            `;

            const dateOptions = { 
                weekday: 'long', 
                year: 'numeric', 
                month: 'long', 
                day: 'numeric' 
            };
            
            header.innerHTML = `
                        <div>
                    <h3 style="margin: 0; color: var(--text-primary); font-size: 20px;">${selectedDate.toLocaleDateString('en-US', dateOptions)}</h3>
                    <p style="margin: 4px 0 0 0; color: var(--text-secondary); font-size: 14px;">${events.length} event${events.length === 1 ? '' : 's'} scheduled</p>
                        </div>
                <button onclick="closeDayViewModal()" style="background: none; border: none; font-size: 24px; color: var(--text-secondary); cursor: pointer; padding: 8px; border-radius: 50%; transition: all 0.2s ease;" onmouseover="this.style.background='var(--hover-bg)'" onmouseout="this.style.background='none'">&times;</button>
            `;

            // Body with hourly grid
            const body = document.createElement('div');
            body.style.cssText = `
                flex: 1;
                overflow-y: auto;
                padding: 0;
                position: relative;
            `;

            // Create hourly grid
            body.innerHTML = createHourlyGrid(selectedDate, events);

            // Footer with quick add
            const footer = document.createElement('div');
            footer.style.cssText = `
                padding: 16px 24px;
                border-top: 1px solid var(--hover-bg);
                background: var(--section-bg);
                display: flex;
                gap: 12px;
                align-items: center;
            `;

            footer.innerHTML = `
                <button onclick="addEventToDay('${selectedDate.toISOString()}')" style="
                    background: var(--primary-brand);
                    color: white;
                    border: none;
                    padding: 10px 20px;
                    border-radius: 8px;
                    font-weight: 500;
                    cursor: pointer;
                    display: flex;
                    align-items: center;
                    gap: 8px;
                    transition: all 0.2s ease;
                " onmouseover="this.style.transform='translateY(-1px)'; this.style.boxShadow='0 4px 12px rgba(0,0,0,0.15)'" onmouseout="this.style.transform='translateY(0)'; this.style.boxShadow='none'">
                    <span style="font-size: 16px;">+</span>
                    Add Event
                </button>
                <span style="color: var(--text-secondary); font-size: 13px;">Click on any time slot to quickly add an event</span>
            `;

            modal.appendChild(header);
            modal.appendChild(body);
            modal.appendChild(footer);
            overlay.appendChild(modal);
            document.body.appendChild(overlay);

            // Store reference for closing
            window.currentDayViewModal = overlay;
            
            // Close on overlay click
            overlay.addEventListener('click', (e) => {
                if (e.target === overlay) {
                    closeDayViewModal();
                }
            });
        }

        function createHourlyGrid(selectedDate, events) {
            const hours = [];
            
            // Generate 24 hours
            for (let hour = 0; hour < 24; hour++) {
                const timeString = formatHour(hour);
                const hourEvents = filterEventsForHour(events, hour);
                
                hours.push(`
                    <div class="hour-slot" style="
                        display: flex;
                        border-bottom: 1px solid var(--hover-bg);
                        min-height: 60px;
                        position: relative;
                    ">
                        <div style="
                            width: 80px;
                            padding: 12px 16px;
                            background: var(--section-bg);
                            color: var(--text-secondary);
                            font-size: 12px;
                            font-weight: 500;
                            display: flex;
                            align-items: flex-start;
                            justify-content: flex-end;
                            border-right: 1px solid var(--hover-bg);
                        ">${timeString}</div>
                        <div style="
                            flex: 1;
                            padding: 8px 16px;
                            cursor: pointer;
                            transition: background 0.2s ease;
                            position: relative;
                        " 
                        onmouseover="this.style.background='var(--hover-bg)'" 
                        onmouseout="this.style.background='transparent'"
                        onclick="addEventAtTime('${selectedDate.toISOString()}', ${hour})"
                        data-hour="${hour}">
                            ${hourEvents.map(event => createEventBlock(event)).join('')}
                            ${hourEvents.length === 0 ? '<div style="height: 44px; display: flex; align-items: center; color: var(--text-tertiary); font-size: 13px; font-style: italic;">Click to add event</div>' : ''}
                        </div>
                    </div>
                `);
            }

            return hours.join('');
        }

        function formatHour(hour) {
            if (hour === 0) return '12:00 AM';
            if (hour < 12) return `${hour}:00 AM`;
            if (hour === 12) return '12:00 PM';
            return `${hour - 12}:00 PM`;
        }

        function filterEventsForHour(events, targetHour) {
            return events.filter(event => {
                if (!event.time) return targetHour === 9; // Default to 9 AM for events without time
                
                const timeMatch = event.time.match(/(\d{1,2}):(\d{2})\s*(AM|PM)?/i);
                if (!timeMatch) return targetHour === 9;
                
                let hour = parseInt(timeMatch[1]);
                const ampm = timeMatch[3]?.toLowerCase();
                
                if (ampm === 'pm' && hour !== 12) hour += 12;
                if (ampm === 'am' && hour === 12) hour = 0;
                
                return hour === targetHour;
            });
        }

        function createEventBlock(event) {
            const color = getEventTypeColor(event.type || 'meeting');
            return `
                <div style="
                    background: ${color};
                    color: white;
                    padding: 8px 12px;
                    border-radius: 6px;
                    margin-bottom: 4px;
                    font-size: 13px;
                    line-height: 1.3;
                    box-shadow: 0 2px 4px rgba(0,0,0,0.1);
                    cursor: pointer;
                    transition: all 0.2s ease;
                " 
                onmouseover="this.style.transform='translateY(-1px)'; this.style.boxShadow='0 4px 8px rgba(0,0,0,0.2)'" 
                onmouseout="this.style.transform='translateY(0)'; this.style.boxShadow='0 2px 4px rgba(0,0,0,0.1)'"
                onclick="event.stopPropagation(); editEventInline('${event.projectId}', '${event.id}')">
                    <div style="font-weight: 600; margin-bottom: 2px;">${event.title}</div>
                    <div style="font-size: 11px; opacity: 0.9;">${event.projectName}</div>
                    ${event.time ? `<div style="font-size: 11px; opacity: 0.8;"> ${event.time}</div>` : ''}
                </div>
            `;
        }

        function addEventAtTime(dateString, hour) {
            const selectedDate = new Date(dateString);
            const timeString = formatHour(hour);
            
            showCustomPrompt(
                `Add Event - ${timeString}`,
                [
                    { type: 'select', name: 'projectId', label: 'Project', options: projects.map(p => ({ value: p.id, text: `${p.name} - ${p.client}` })), required: true },
                    { type: 'text', name: 'title', label: 'Event Title', required: true },
                    { type: 'select', name: 'type', label: 'Event Type', options: [
                        { value: 'consultation', text: 'Consultation' },
                        { value: 'design', text: 'Design' },
                        { value: 'meeting', text: 'Meeting' },
                        { value: 'delivery', text: 'Delivery' }
                    ], defaultValue: 'meeting', required: true },
                    { type: 'time', name: 'time', label: 'Time', defaultValue: `${hour.toString().padStart(2, '0')}:00`, required: true },
                    { type: 'textarea', name: 'notes', label: 'Notes' }
                ],
                (data) => {
                    const project = projects.find(p => p.id == data.projectId);
                    if (!project) return;

                    if (!project.events) project.events = [];
                    
                    const newEvent = {
                        id: Date.now() + Math.random(),
                        title: data.title,
                        type: data.type,
                        date: selectedDate.toISOString().split('T')[0],
                        time: data.time,
                        notes: data.notes,
                        completed: false
                    };

                    project.events.push(newEvent);
                    saveProjects();
                    
                    // Refresh the day view
                    closeDayViewModal();
                    updateEventsCalendar();
                    
                    // Reopen the day view to show the new event
                    setTimeout(() => {
                        showDayViewModal(selectedDate, getEventsForDate(selectedDate));
                    }, 100);
                    
                    showCustomAlert('Event added successfully! ');
                }
            );
        }

        function addEventToDay(dateString) {
            const selectedDate = new Date(dateString);
            addEventAtTime(dateString, 9); // Default to 9 AM
        }

        function getEventsForDate(date) {
            const dateKey = date.toDateString();
            return calendarEvents[dateKey] || [];
        }

        function editEventInline(projectId, eventId) {
            const project = projects.find(p => p.id == projectId);
            if (!project || !project.events) return;
            
            const event = project.events.find(e => e.id == eventId);
            if (!event) return;

            showCustomPrompt(
                'Edit Event',
                [
                    { type: 'text', name: 'title', label: 'Event Title', defaultValue: event.title, required: true },
                    { type: 'select', name: 'type', label: 'Event Type', options: [
                        { value: 'consultation', text: 'Consultation' },
                        { value: 'design', text: 'Design' },
                        { value: 'meeting', text: 'Meeting' },
                        { value: 'delivery', text: 'Delivery' }
                    ], defaultValue: event.type || 'meeting', required: true },
                    { type: 'time', name: 'time', label: 'Time', defaultValue: event.time || '09:00', required: true },
                    { type: 'textarea', name: 'notes', label: 'Notes', defaultValue: event.notes || '' },
                    { type: 'checkbox', name: 'completed', label: 'Mark as completed', defaultValue: event.completed || false }
                ],
                (data) => {
                    event.title = data.title;
                    event.type = data.type;
                    event.time = data.time;
                    event.notes = data.notes;
                    event.completed = data.completed;
                    
                    saveProjects();
                    
                    // Refresh the day view
                    const selectedDate = new Date(event.date + 'T00:00:00');
                    closeDayViewModal();
                    updateEventsCalendar();
                    
                    setTimeout(() => {
                        showDayViewModal(selectedDate, getEventsForDate(selectedDate));
                    }, 100);
                    
                    showCustomAlert('Event updated successfully! ');
                }
            );
        }

        function closeDayViewModal() {
            if (window.currentDayViewModal) {
                window.currentDayViewModal.remove();
                window.currentDayViewModal = null;
            }
        }

        // Update the main function call
        function updateUpcomingEvents() {
            updateEventsCalendar();
        }

        function displayProjects() {
            // Set default filter to active projects only
            document.getElementById('statusFilter').value = 'active';
            filterProjects();
        }

        function filterProjects() {
            const searchTerm = document.getElementById('projectSearch').value.toLowerCase();
            const statusFilter = document.getElementById('statusFilter').value;
            
            const grid = document.getElementById('projectGrid');
            grid.innerHTML = '';
            
            const filteredProjects = projects.filter(project => {
                const matchesSearch = !searchTerm || 
                    project.name.toLowerCase().includes(searchTerm) || 
                    project.client.toLowerCase().includes(searchTerm);
                    
                let matchesStatus = true;
                if (statusFilter === 'active') {
                    matchesStatus = project.status !== 'completed';
                } else if (statusFilter) {
                    matchesStatus = project.status === statusFilter;
                }
                
                return matchesSearch && matchesStatus;
            });
            
            filteredProjects.forEach(project => {
                // Calculate total profit = hourly income + item profit from ordered items
                let totalProfit = 0;
                
                // 1. Hourly income (hours paid  rate)
                const hourlyRate = project.hourlyRate || 75; // Default to $75/hour if not set
                const hoursPaid = project.hoursPaid || 0;
                const hourlyIncome = hoursPaid * hourlyRate;
                
                // 2. Item profit (only from ordered items)
                let itemProfit = 0;
                if (project.sections) {
                    project.sections.forEach(section => {
                        // Skip grayed out sections
                        if (section.isGrayedOut) return;
                        
                        section.items.forEach(item => {
                            // Only include profit from items that have been ordered
                            if (item.readyToOrder && item.orderStatus && item.orderStatus !== 'pending') {
                                const sellPrice = (item.customerPrice || item.price || 0) * (item.qty || 1);
                                const wholesalePrice = (item.wholesalePrice || 0) * (item.qty || 1);
                                const profit = sellPrice - wholesalePrice;
                                itemProfit += profit > 0 ? profit : 0; // Only positive profit
                            }
                        });
                    });
                }
                
                totalProfit = hourlyIncome + itemProfit;
                
                const card = document.createElement('div');
                card.className = 'project-card';
                
                // Set innerHTML FIRST, then add event listeners
                card.innerHTML = `
                    <div class="project-header" style="position: relative;">
                        <h3 class="project-title">${project.name}</h3>
                        <div style="display: flex; align-items: center; gap: 10px;">
                            <span class="project-status status-${project.status}">${project.status}</span>
                            <button class="project-delete-btn" data-project-id="${project.id}"
                                    style="background: var(--error); color: white; border: none; border-radius: 50%; width: 24px; height: 24px; font-size: 12px; cursor: pointer; display: flex; align-items: center; justify-content: center;"
                                    title="Delete Project"></button>
                        </div>
                    </div>
                    <div class="project-client" style="margin-bottom: 15px; font-size: 15px; color: var(--text-secondary);">Client: ${project.client}</div>
                    
                      <div class="progress-panel" style="background: rgba(255,255,255,0.7); padding: 15px; border-radius: 10px; margin-bottom: 15px;">
                        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 8px;">
                            <span style="color: var(--text-secondary); font-size: 14px;">Hours Progress</span>
                              <span class="remaining-text" style="font-weight: 700; font-size: 16px; color: ${(project.hoursPaid || 0) - (project.hoursWorked || 0) > 0 ? '#27ae60' : '#e74c3c'};">Remaining: ${formatHoursMinutes((project.hoursPaid || 0) - (project.hoursWorked || 0))}</span>
                        </div>
                        <div style="display: flex; justify-content: space-between; font-size: 15px; margin-bottom: 10px;">
                              <span class="worked-text" style="color: var(--text-primary);"><strong>Worked:</strong> ${formatHoursMinutes(project.hoursWorked || 0)}</span>
                            <span style="color: var(--text-secondary);"><strong>Paid:</strong> ${Math.floor(project.hoursPaid || 0)} hrs</span>
                        </div>
                        
                        <!-- Delivery Progress Section -->
                        ${(() => {
                            const readyItems = [];
                            let deliveredCount = 0;
                            if (project.sections) {
                                project.sections.forEach(section => {
                                    section.items.forEach(item => {
                                        if (item.readyToOrder) {
                                            readyItems.push(item);
                                            if (item.orderStatus === 'delivered') deliveredCount++;
                                        }
                                    });
                                });
                            }
                            const deliveryPercentage = readyItems.length > 0 ? (deliveredCount / readyItems.length) * 100 : 0;
                            return readyItems.length > 0 ? `
                                <div style="margin-top: 8px;">
                                    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 4px;">
                                        <span style="color: var(--text-secondary); font-size: 12px;">Delivery Progress</span>
                                        <span style="color: var(--text-secondary); font-size: 12px;">${deliveredCount}/${readyItems.length} delivered</span>
                                    </div>
                                    <div style="background: #e0e0e0; border-radius: 6px; height: 6px; overflow: hidden;">
                                        <div style="height: 100%; background: linear-gradient(90deg, #27ae60, #2ecc71); border-radius: 6px; width: ${deliveryPercentage}%; transition: width 0.3s ease;"></div>
                                    </div>
                                </div>
                            ` : '';
                        })()}
                    </div>
                    
                    <div class="project-meta">
                        <span style="color: var(--text-secondary); font-size: 13px;">Started: ${new Date(project.startDate).toLocaleDateString()}</span>
                        <span class="project-value">${totalProfit.toLocaleString('en-US', { style: 'currency', currency: 'USD' })}</span>
                    </div>
                `;
                
                // Add event listeners AFTER innerHTML is set
                const deleteBtn = card.querySelector('.project-delete-btn');
                
                deleteBtn.addEventListener('click', (e) => {
                    e.stopPropagation();
                    deleteProject(project.id);
                });
                
                // Also allow clicking anywhere on the card (except buttons)
                card.addEventListener('click', (e) => {
                    if (!e.target.closest('button')) {
                        openProjectDetail(project.id);
                    }
                });
                
                grid.appendChild(card);
            });
            
            if (filteredProjects.length === 0) {
                grid.innerHTML = '<p style="text-align: center; color: var(--text-secondary); grid-column: 1 / -1; padding: 40px;">No projects found matching your criteria.</p>';
            }
        }

        function openNewProjectModal() {
            document.getElementById('modalTitle').textContent = 'Create New Project';
            document.getElementById('projectModal').style.display = 'block';
            currentProject = null;
            
            // Reset form with smart defaults
            document.getElementById('projectName').value = '';
            document.getElementById('clientName').value = '';
            document.getElementById('clientEmail').value = '';
            document.getElementById('clientPhone').value = '';
            document.getElementById('clientAddress').value = '';
            document.getElementById('projectStatus').value = 'consultation';
            document.getElementById('startDate').valueAsDate = new Date();
            document.getElementById('budget').value = '';
            document.getElementById('hoursPaid').value = '10:00';
            document.getElementById('projectNotes').value = '';
        }

        function closeProjectModal() {
            document.getElementById('projectModal').style.display = 'none';
        }

        function saveProject() {
            const project = {
                id: currentProject ? currentProject.id : Date.now(),
                name: document.getElementById('projectName').value,
                client: document.getElementById('clientName').value,
                clientEmail: document.getElementById('clientEmail').value,
                clientPhone: document.getElementById('clientPhone').value,
                clientAddress: document.getElementById('clientAddress').value,
                status: document.getElementById('projectStatus').value,
                startDate: document.getElementById('startDate').value,
                budget: parseFloat(document.getElementById('budget').value) || null,
                hourlyRate: parseFloat(document.getElementById('hourlyRate').value) || 75,
                hoursPaid: parseHoursMinutes(document.getElementById('hoursPaid').value) || 0,
                hoursWorked: currentProject ? (currentProject.hoursWorked || 0) : 0,
                notes: document.getElementById('projectNotes').value,
                sections: currentProject ? (currentProject.sections || []) : [],
                events: currentProject ? (currentProject.events || []) : [],
                hoursLog: currentProject ? (currentProject.hoursLog || []) : [],
                moodBoards: currentProject ? (currentProject.moodBoards || []) : [],
                moodBoardsByRoom: currentProject ? (currentProject.moodBoardsByRoom || {}) : {},
                invoiceNumber: currentProject ? currentProject.invoiceNumber : (++invoiceCounter).toString().padStart(6, '0'),
                amountPaid: currentProject ? currentProject.amountPaid : 0
            };
            
            const isNewProject = !currentProject;

            if (currentProject) {
                const index = projects.findIndex(p => p.id === currentProject.id);
                projects[index] = project;
            } else {
                projects.push(project);
            }

            saveProjects();
            saveInvoiceCounter();
            
            closeProjectModal();
            displayProjects();
            updateDashboard();
            
            // If this is a new project, automatically open it for the user
            if (isNewProject) {
                // Ensure projects list is updated first
                displayProjects();
                
                // Use requestAnimationFrame for better timing
                requestAnimationFrame(() => {
                    setTimeout(() => {
                        try {
                            openProjectDetail(project.id);
                        } catch (error) {
                            console.error('Error auto-opening project:', error);
                            showCustomAlert('Project saved! Click on the project card to open it.');
                        }
                    }, 150);
                });
            }
            
            showCustomAlert('Project saved successfully! ');
        }

        function deleteProject(projectId) {
            const project = projects.find(p => p.id === projectId);
            if (!project) return;
            
            showCustomPrompt(
                'Delete Project',
                [
                    { type: 'text', name: 'confirmation', label: `Type "delete" to confirm deletion of "${project.name}"`, required: true, placeholder: 'Type delete' }
                ],
                (data) => {
                    if (data.confirmation.toLowerCase() !== 'delete') {
                        showCustomAlert('Please type "delete" to confirm. Deletion cancelled.');
                        return;
                    }
                    
                    const index = projects.findIndex(p => p.id === projectId);
                    if (index !== -1) {
                        projects.splice(index, 1);
                        saveProjects();
                        
                        displayProjects();
                        updateDashboard();
                        
                        showCustomAlert(`Project "${project.name}" deleted successfully.`);
                    }
                }
            );
        }

        function openProjectDetail(projectId) {
            try {
                const project = projects.find(p => p.id === projectId);
                if (!project) {
                    showCustomAlert('Project not found. Please refresh the page and try again.');
                    return;
                }
                
                currentProject = project;
                
                // Check if required elements exist before accessing them
                const titleElement = document.getElementById('projectDetailTitle');
                const clientElement = document.getElementById('projectDetailClient');
                
                if (titleElement) titleElement.textContent = project.name;
                if (clientElement) clientElement.textContent = `Client: ${project.client}`;
                
                // Populate project details with safety checks
                const safeSetText = (id, value) => {
                    const element = document.getElementById(id);
                    if (element) element.textContent = value;
                };
                
                safeSetText('detailClientName', project.client);
                safeSetText('detailClientEmail', project.clientEmail || 'Not provided');
                safeSetText('detailClientPhone', project.clientPhone || 'Not provided');
                safeSetText('detailClientAddress', project.clientAddress || 'Not provided');
                safeSetText('detailStatus', project.status);
                safeSetText('detailStartDate', new Date(project.startDate).toLocaleDateString());
                safeSetText('detailBudget', project.budget ? `$${project.budget.toLocaleString('en-US', { minimumFractionDigits: 2, maximumFractionDigits: 2 })}` : 'No budget set');
                // Hours will be updated by updateProjectHours() function

            
                showProjectSection('overview');
                updateProjectHours();
                updateProjectUpcomingEvents();
                updateProjectNotes();
                
                const modal = document.getElementById('projectDetailModal');
                if (modal) {
                    modal.style.display = 'block';
                } else {
                    throw new Error('Project detail modal not found');
                }
                
            } catch (error) {
                console.error('Error opening project detail:', error);
                showCustomAlert('Error opening project details. Please try again.');
            }
        }
        
        // Function to edit project information
        function editProjectInfo() {
            if (!currentProject) return;
            
            showCustomPrompt(
                'Edit Project Information',
                [
                    { type: 'text', name: 'projectName', label: 'Project Name', required: true, defaultValue: currentProject.name },
                    { type: 'text', name: 'client', label: 'Client Name', required: true, defaultValue: currentProject.client },
                    { type: 'email', name: 'clientEmail', label: 'Client Email', defaultValue: currentProject.clientEmail || '' },
                    { type: 'tel', name: 'clientPhone', label: 'Client Phone', defaultValue: currentProject.clientPhone || '' },
                    { type: 'textarea', name: 'clientAddress', label: 'Client Address', defaultValue: currentProject.clientAddress || '' },
                    { type: 'number', name: 'hourlyRate', label: 'Hourly Rate ($)', step: '0.01', defaultValue: currentProject.hourlyRate || '75', placeholder: '75.00' },
                    { type: 'select', name: 'status', label: 'Project Status', options: [
                        { value: 'consultation', text: 'Consultation' },
                        { value: 'planning', text: 'Planning' },
                        { value: 'design', text: 'Design' },
                        { value: 'ordering', text: 'Ordering' },
                        { value: 'delivery', text: 'Delivery' },
                        { value: 'completed', text: 'Completed' }
                    ], defaultValue: currentProject.status },
                    { type: 'date', name: 'startDate', label: 'Start Date', defaultValue: currentProject.startDate },
                    { type: 'number', name: 'budget', label: 'Budget (Optional)', step: '0.01', defaultValue: currentProject.budget || '' }
                ],
                (data) => {
                    // Update the current project
                    currentProject.name = data.projectName;
                    currentProject.client = data.client;
                    currentProject.clientEmail = data.clientEmail;
                    currentProject.clientPhone = data.clientPhone;
                    currentProject.clientAddress = data.clientAddress;
                    currentProject.hourlyRate = data.hourlyRate ? parseFloat(data.hourlyRate) : 75;
                    currentProject.status = data.status;
                    currentProject.startDate = data.startDate;
                    currentProject.budget = data.budget ? parseFloat(data.budget) : null;
                    
                    saveCurrentProject();
                    
                    // Refresh the project detail view with updated information
                    const titleEl = document.getElementById('projectDetailTitle');
                    if (titleEl) titleEl.textContent = currentProject.name;
                    document.getElementById('detailClientName').textContent = currentProject.client;
                    document.getElementById('detailClientEmail').textContent = currentProject.clientEmail || 'Not provided';
                    document.getElementById('detailClientPhone').textContent = currentProject.clientPhone || 'Not provided';
                    document.getElementById('detailStatus').textContent = currentProject.status;
                    document.getElementById('detailBudget').textContent = currentProject.budget ? `$${currentProject.budget.toLocaleString('en-US', { minimumFractionDigits: 2, maximumFractionDigits: 2 })}` : 'No budget set';
                    
                    displayProjects(); // Refresh the projects list
                    showCustomAlert('Project information updated successfully! ');
                }
            );
        }

        function closeProjectDetailModal() {
            document.getElementById('projectDetailModal').style.display = 'none';
            currentProject = null;
        }

        function showProjectSection(sectionName, element) {
            document.querySelectorAll('.project-section').forEach(section => {
                section.classList.remove('active');
            });
            document.querySelectorAll('.project-tab').forEach(tab => {
                tab.classList.remove('active');
            });
            
            document.getElementById(sectionName).classList.add('active');
            
            // Use the passed element or find the clicked tab
            if (element) {
                element.classList.add('active');
            } else {
                // Fallback: find the tab by section name
                const tabButton = document.querySelector(`button.project-tab[onclick*="${sectionName}"]`);
                if (tabButton) tabButton.classList.add('active');
            }
            
            if (sectionName === 'items') {
                updateProjectSections();
            } else if (sectionName === 'orders') {
                updateReadyToOrderItems();
            } else if (sectionName === 'moodboards') {
                updateMoodBoards();
            } else if (sectionName === 'invoice') {
                updateSectionInvoiceList();
            }
        }

        function updateProjectSections() {
            if (!currentProject) return;
            
            const container = document.getElementById('projectSections');
            container.innerHTML = '';
            
            if (!currentProject.sections || currentProject.sections.length === 0) {
                container.innerHTML = '<p style="color: var(--text-secondary); text-align: center; padding: 20px;">No sections yet. Add your first section above!</p>';
                return;
            }
            
            // Separate sections into active and deactivated
            const activeSections = [];
            const deactivatedSections = [];
            
            currentProject.sections.forEach((section, originalIndex) => {
                if (section.isGrayedOut) {
                    deactivatedSections.push({ section, originalIndex });
                } else {
                    activeSections.push({ section, originalIndex });
                }
            });

            // Render active sections first
            activeSections.forEach(({ section, originalIndex: sectionIndex }) => {
                const sectionDiv = document.createElement('div');
                sectionDiv.innerHTML = `
                    <div class="section-header" onclick="toggleSection(${sectionIndex})" role="button" tabindex="0" onkeydown="if(event.key==='Enter'||event.key===' '){event.preventDefault(); toggleSection(${sectionIndex});}" style="opacity: ${section.isGrayedOut ? '0.6' : '1'};">
                        <div style="cursor: pointer; flex-grow: 1; display: flex; align-items: center;">
                            <strong style="${section.isGrayedOut ? 'text-decoration: line-through;' : ''}">${section.name}</strong>
                            <span style="color: var(--text-secondary); margin-left: 10px;">(${section.items.length} items)</span>
                            ${section.isGrayedOut ? '<span style="color: var(--text-tertiary); font-size: 11px; font-weight: 500; background: var(--text-tertiary); color: white; padding: 2px 8px; border-radius: 12px; margin-left: 10px;">INACTIVE</span>' : ''}
                        </div>
                        <div style="display: flex; align-items: center; gap: 12px; margin-top: 10px;">
                            <button class="btn" onclick="event.stopPropagation(); ${section.items.length > 0 ? `toggleAllSectionItems(${sectionIndex}, ${!section.items.every(item => item.readyToOrder)})` : 'showCustomAlert(\"No items in this section to mark as ready.\")'}" 
                                    style="padding: 8px 16px; font-size: 14px; border-radius: 8px; ${section.items.length > 0 ? `background: ${section.items.every(item => item.readyToOrder) ? 'var(--success)' : 'var(--highlight)'}; color: white;` : 'background: var(--hover-bg); color: var(--text-tertiary); cursor: not-allowed;'} border: none; font-weight: 500; transition: all 0.2s ease; display: flex; align-items: center; gap: 6px;" 
                                    ${section.items.length > 0 ? `onmouseover="this.style.transform='translateY(-1px)'; this.style.boxShadow='0 4px 12px rgba(0,0,0,0.15)'" onmouseout="this.style.transform='translateY(0)'; this.style.boxShadow='none'"` : ''}>
                                <div style="width: 16px; height: 16px; border-radius: 50%; border: 2px solid ${section.items.length > 0 ? 'rgba(255,255,255,0.8)' : 'var(--text-tertiary)'}; background: ${section.items.length > 0 && section.items.every(item => item.readyToOrder) ? 'rgba(255,255,255,0.9)' : 'transparent'}; display: flex; align-items: center; justify-content: center; font-size: 10px; font-weight: bold; color: var(--text-primary);">
                                    ${section.items.length > 0 && section.items.every(item => item.readyToOrder) ? '' : ''}
                                </div>
                                ${section.items.length === 0 ? 'No Items' : (section.items.every(item => item.readyToOrder) ? 'All Ready' : 'Mark All Ready')}
                            </button>
                            
                            <button class="btn" onclick="event.stopPropagation(); toggleSectionGrayOut(${sectionIndex})" 
                                    style="padding: 8px 16px; font-size: 14px; border-radius: 8px; background: ${section.isGrayedOut ? 'var(--success)' : 'var(--warning)'}; color: ${section.isGrayedOut ? 'white' : 'var(--text-primary)'}; border: none; font-weight: 500; transition: all 0.2s ease; display: flex; align-items: center; gap: 6px;" 
                                    onmouseover="this.style.transform='translateY(-1px)'; this.style.boxShadow='0 4px 12px rgba(0,0,0,0.15)'" 
                                    onmouseout="this.style.transform='translateY(0)'; this.style.boxShadow='none'" 
                                    title="${section.isGrayedOut ? 'Reactivate this section' : 'Deactivate this section'}">
                                <span style="font-size: 12px;">${section.isGrayedOut ? '' : ''}</span>
                                ${section.isGrayedOut ? 'Activate' : 'Deactivate'}
                            </button>
                            
                            <button class="btn" onclick="event.stopPropagation(); deleteSection(${sectionIndex})" 
                                    style="padding: 8px 16px; font-size: 14px; border-radius: 8px; background: var(--error); color: white; border: none; font-weight: 500; transition: all 0.2s ease; display: flex; align-items: center; gap: 6px;" 
                                    onmouseover="this.style.transform='translateY(-1px)'; this.style.boxShadow='0 4px 12px rgba(226,163,157,0.4)'" 
                                    onmouseout="this.style.transform='translateY(0)'; this.style.boxShadow='none'" 
                                    title="Delete this section permanently">
                                <span style="font-size: 12px;"></span>
                                Delete
                            </button>
                        </div>
                    </div>
                    <div class="section-content" id="section-${sectionIndex}">
                        <div class="item-grid header">
                            <div>Item Name</div>
                            <div>Qty</div>
                            <div>Cost<br><small style="opacity: 0.7;">(Wholesale)</small></div>
                            <div>Sell Price<br><small style="opacity: 0.7;">(Per Unit)</small></div>
                            <div>Shipping<br><small style="opacity: 0.7;">($)</small></div>
                            <div>Tax<br><small style="opacity: 0.7;">($)</small></div>
                            <div>Customer Total<br><small style="opacity: 0.7;">(Final Price)</small></div>
                            <div>Product Link</div>
                            <div>Order Status</div>
                        </div>
                                                ${section.items.map((item, itemIndex) => `
                            <div class="item-grid">
                                <div>
                                    <input type="text" value="${item.name || item.item || 'Unnamed Item'}"
                                           onchange="updateItemName(${sectionIndex}, ${itemIndex}, this.value)"
                                           style="width: 100%; padding: 4px 6px; border: 1px solid transparent; border-radius: 4px; font-size: 13px; font-weight: 600; color: var(--text-primary); background: transparent; transition: all 0.2s ease;"
                                           onfocus="this.style.border='1px solid var(--section-bg)'; this.style.background='var(--card-bg)'"
                                           onblur="updateItemName(${sectionIndex}, ${itemIndex}, this.value); this.style.border='1px solid transparent'; this.style.background='transparent'">
                                </div>
                                <div>
                                    <input type="number" value="${item.qty || 1}" min="1" 
                                           onchange="updateItemQuantity(${sectionIndex}, ${itemIndex}, this.value)"
                                           style="width: 50px; padding: 4px 6px; border: 1px solid var(--section-bg); border-radius: 4px; text-align: center; font-size: 13px;">
                                </div>
                                <div>
                                    <input type="number" value="${item.wholesalePrice || 0}" step="0.01" min="0"
                                           onchange="updateItemWholesalePrice(${sectionIndex}, ${itemIndex}, this.value)"
                                           style="width: 70px; padding: 4px 6px; border: 1px solid var(--section-bg); border-radius: 4px; text-align: right; font-size: 13px;"
                                           placeholder="$0.00">
                                </div>
                                <div>
                                    <input type="number" value="${item.customerPrice || item.price || 0}" step="0.01" min="0"
                                           onchange="updateItemCustomerPrice(${sectionIndex}, ${itemIndex}, this.value)"
                                           style="width: 70px; padding: 4px 6px; border: 1px solid var(--section-bg); border-radius: 4px; text-align: right; font-size: 13px;"
                                           placeholder="$0.00">
                                </div>
                                <div>
                                    <input type="number" value="${item.shipping || 0}" step="0.01" min="0"
                                           onchange="updateItemShipping(${sectionIndex}, ${itemIndex}, this.value)"
                                           style="width: 50px; padding: 4px 6px; border: 1px solid var(--section-bg); border-radius: 4px; text-align: right; font-size: 13px;"
                                           placeholder="$0.00">
                                </div>
                                <div>
                                    <input type="number" value="${item.tax || 0}" step="0.01" min="0"
                                           onchange="updateItemTax(${sectionIndex}, ${itemIndex}, this.value)"
                                           style="width: 50px; padding: 4px 6px; border: 1px solid var(--section-bg); border-radius: 4px; text-align: right; font-size: 13px;"
                                           placeholder="$0.00">
                                </div>
                                <div>
                                    <span style="font-weight: 600; color: var(--text-primary);">
                                        ${(((item.customerPrice || item.price || 0) * (item.qty || 1)) + (item.shipping || 0) + (item.tax || 0)).toLocaleString('en-US', { style: 'currency', currency: 'USD' })}
                                    </span>
                                </div>
                                <div>
                                    ${item.link ? 
                                        `<div style="display: flex; align-items: center; gap: 4px;">
                                            <a href="${item.link}" target="_blank" style="color: var(--secondary-brand); text-decoration: none; font-weight: 500; font-size: 12px;"> View</a>
                                            <button onclick="editItemLink(${sectionIndex}, ${itemIndex})" style="background: none; border: 1px solid var(--section-bg); border-radius: 3px; padding: 1px 4px; font-size: 10px; cursor: pointer;" title="Edit Link"></button>
                                        </div>` :
                                        `<button onclick="editItemLink(${sectionIndex}, ${itemIndex})" style="background: var(--section-bg); border: 1px solid var(--section-bg); border-radius: 4px; padding: 4px 8px; font-size: 11px; cursor: pointer; color: var(--text-secondary);">+ Add Link</button>`
                                    }
                                </div>
                                <div>
                                    <button onclick="toggleReadyToOrder(${sectionIndex}, ${itemIndex}, ${!item.readyToOrder})" 
                                            style="
                                                background: ${item.readyToOrder ? 'linear-gradient(135deg, var(--success), var(--highlight))' : 'linear-gradient(135deg, #f8f9fa, #e9ecef)'};
                                                border: 2px solid ${item.readyToOrder ? 'var(--success)' : 'var(--section-bg)'};
                                                color: ${item.readyToOrder ? 'white' : 'var(--text-secondary)'};
                                                padding: 4px 8px;
                                                border-radius: 12px;
                                                font-size: 11px;
                                                font-weight: 600;
                                                cursor: pointer;
                                                transition: all 0.3s ease;
                                                text-transform: uppercase;
                                                letter-spacing: 0.3px;
                                                box-shadow: 0 1px 4px rgba(0,0,0,0.1);
                                            "
                                            onmouseover="this.style.transform='translateY(-1px)'; this.style.boxShadow='0 2px 8px rgba(0,0,0,0.2)'"
                                            onmouseout="this.style.transform='translateY(0px)'; this.style.boxShadow='0 1px 4px rgba(0,0,0,0.1)'">
                                        ${item.readyToOrder ? ' READY' : 'Mark Ready'}
                                    </button>
                                </div>
                            </div>
                        `).join('')}
                        <div style="margin-top: 15px;">
                            <button class="btn btn-success" onclick="addItemToSection(${sectionIndex})">Add Item to ${section.name}</button>
                        </div>
                    </div>
                `;
                container.appendChild(sectionDiv);
                
                // Restore expanded state
                if (expandedSections.has(sectionIndex)) {
                    const content = document.getElementById(`section-${sectionIndex}`);
                    content.classList.add('expanded');
                }
            });

            // Add deactivated sections in a collapsible group
            if (deactivatedSections.length > 0) {
                const deactivatedGroupDiv = document.createElement('div');
                deactivatedGroupDiv.style.cssText = 'margin-top: 20px; border-top: 1px solid var(--hover-bg); padding-top: 20px;';
                
                // Deactivated sections header
                const deactivatedHeader = document.createElement('div');
                deactivatedHeader.style.cssText = `
                    display: flex;
                    align-items: center;
                    padding: 12px 16px;
                    background: var(--section-bg);
                    border-radius: 8px;
                    cursor: pointer;
                    margin-bottom: 10px;
                    transition: all 0.2s ease;
                `;
                deactivatedHeader.onmouseover = () => deactivatedHeader.style.background = 'var(--hover-bg)';
                deactivatedHeader.onmouseout = () => deactivatedHeader.style.background = 'var(--section-bg)';
                
                deactivatedHeader.innerHTML = `
                    <span id="deactivatedToggleIcon" style="margin-right: 10px; transition: transform 0.2s ease;"></span>
                    <strong style="color: var(--text-secondary);">Deactivated Sections</strong>
                    <span style="color: var(--text-tertiary); margin-left: 10px; font-size: 13px;">(${deactivatedSections.length})</span>
                `;
                
                // Deactivated sections container (initially hidden)
                const deactivatedContainer = document.createElement('div');
                deactivatedContainer.id = 'deactivatedSectionsContainer';
                deactivatedContainer.style.cssText = 'display: none; overflow: hidden; transition: all 0.3s ease;';
                
                // Render deactivated sections
                deactivatedSections.forEach(({ section, originalIndex: sectionIndex }) => {
                    const sectionDiv = document.createElement('div');
                    sectionDiv.innerHTML = `
                        <div class="section-header" onclick="toggleSection(${sectionIndex})" role="button" tabindex="0" onkeydown="if(event.key==='Enter'||event.key===' '){event.preventDefault(); toggleSection(${sectionIndex});}" style="opacity: 0.6;">
                            <div style="cursor: pointer; flex-grow: 1; display: flex; align-items: center;">
                                <strong style="text-decoration: line-through;">${section.name}</strong>
                                <span style="color: var(--text-secondary); margin-left: 10px;">(${section.items.length} items)</span>
                                <span style="color: var(--text-tertiary); font-size: 11px; font-weight: 500; background: var(--text-tertiary); color: white; padding: 2px 8px; border-radius: 12px; margin-left: 10px;">INACTIVE</span>
                            </div>
                            <div style="display: flex; align-items: center; gap: 12px; margin-top: 10px;">
                                <button class="btn" onclick="event.stopPropagation(); ${section.items.length > 0 ? `toggleAllSectionItems(${sectionIndex}, ${!section.items.every(item => item.readyToOrder)})` : 'showCustomAlert(\"No items in this section to mark as ready.\")'}"
                                        style="padding: 8px 16px; font-size: 14px; border-radius: 8px; background: var(--hover-bg); color: var(--text-tertiary); cursor: not-allowed; border: none; font-weight: 500; transition: all 0.2s ease; display: flex; align-items: center; gap: 6px;">
                                    <div style="width: 16px; height: 16px; border-radius: 50%; border: 2px solid var(--text-tertiary); background: transparent; display: flex; align-items: center; justify-content: center; font-size: 10px; font-weight: bold; color: var(--text-primary);"></div>
                                    No Items
                                </button>
                                
                                <button class="btn" onclick="event.stopPropagation(); toggleSectionGrayOut(${sectionIndex})"
                                        style="padding: 8px 16px; font-size: 14px; border-radius: 8px; background: var(--success); color: white; border: none; font-weight: 500; transition: all 0.2s ease; display: flex; align-items: center; gap: 6px;"
                                        onmouseover="this.style.transform='translateY(-1px)'; this.style.boxShadow='0 4px 12px rgba(0,0,0,0.15)'"
                                        onmouseout="this.style.transform='translateY(0)'; this.style.boxShadow='none'"
                                        title="Reactivate this section">
                                    <span style="font-size: 12px;"></span>
                                    Activate
                                </button>
                                
                                <button class="btn" onclick="event.stopPropagation(); deleteSection(${sectionIndex})"
                                        style="padding: 8px 16px; font-size: 14px; border-radius: 8px; background: var(--error); color: white; border: none; font-weight: 500; transition: all 0.2s ease; display: flex; align-items: center; gap: 6px;"
                                        onmouseover="this.style.transform='translateY(-1px)'; this.style.boxShadow='0 4px 12px rgba(226,163,157,0.4)'"
                                        onmouseout="this.style.transform='translateY(0)'; this.style.boxShadow='none'"
                                        title="Delete this section permanently">
                                    <span style="font-size: 12px;"></span>
                                    Delete
                                </button>
                            </div>
                        </div>
                        <div class="section-content" id="section-${sectionIndex}">
                            <div class="item-grid header">
                                <div>Item Name</div>
                                <div>Qty</div>
                                <div>Cost<br><small style="opacity: 0.7;">(Wholesale)</small></div>
                                <div>Sell Price<br><small style="opacity: 0.7;">(Per Unit)</small></div>
                                <div>Shipping<br><small style="opacity: 0.7;">($)</small></div>
                                <div>Tax<br><small style="opacity: 0.7;">($)</small></div>
                                <div>Total<br><small style="opacity: 0.7;">(Per Unit)</small></div>
                                <div>Link</div>
                                <div>Ready?</div>
                            </div>
                            ${section.items.map((item, itemIndex) => `
                                <div class="item-grid">
                                    <div>
                                        <input type="text" value="${item.name || item.item || 'Unnamed Item'}"
                                               onchange="updateItemName(${sectionIndex}, ${itemIndex}, this.value)"
                                               style="width: 100%; padding: 4px 6px; border: 1px solid transparent; border-radius: 4px; font-size: 13px; font-weight: 600; color: var(--text-primary); background: transparent; transition: all 0.2s ease;"
                                               onfocus="this.style.border='1px solid var(--section-bg)'; this.style.background='var(--card-bg)'"
                                               onblur="updateItemName(${sectionIndex}, ${itemIndex}, this.value); this.style.border='1px solid transparent'; this.style.background='transparent'">
                                    </div>
                                    <div>
                                        <input type="number" value="${item.qty || 1}" min="1" 
                                               onchange="updateItemQuantity(${sectionIndex}, ${itemIndex}, this.value)"
                                               style="width: 50px; padding: 4px 6px; border: 1px solid var(--section-bg); border-radius: 4px; text-align: center; font-size: 13px;">
                                    </div>
                                    <div>
                                        <input type="number" value="${item.wholesalePrice || 0}" step="0.01" min="0"
                                               onchange="updateItemWholesalePrice(${sectionIndex}, ${itemIndex}, this.value)"
                                               style="width: 70px; padding: 4px 6px; border: 1px solid var(--section-bg); border-radius: 4px; text-align: right; font-size: 13px;"
                                               placeholder="$0.00">
                                    </div>
                                    <div>
                                        <input type="number" value="${item.customerPrice || item.price || 0}" step="0.01" min="0"
                                               onchange="updateItemCustomerPrice(${sectionIndex}, ${itemIndex}, this.value)"
                                               style="width: 70px; padding: 4px 6px; border: 1px solid var(--section-bg); border-radius: 4px; text-align: right; font-size: 13px;"
                                               placeholder="$0.00">
                                    </div>
                                    <div>
                                        <input type="number" value="${item.shipping || 0}" step="0.01" min="0"
                                               onchange="updateItemShipping(${sectionIndex}, ${itemIndex}, this.value)"
                                               style="width: 50px; padding: 4px 6px; border: 1px solid var(--section-bg); border-radius: 4px; text-align: right; font-size: 13px;"
                                               placeholder="$0.00">
                                    </div>
                                    <div>
                                        <input type="number" value="${item.tax || 0}" step="0.01" min="0"
                                               onchange="updateItemTax(${sectionIndex}, ${itemIndex}, this.value)"
                                               style="width: 50px; padding: 4px 6px; border: 1px solid var(--section-bg); border-radius: 4px; text-align: right; font-size: 13px;"
                                               placeholder="$0.00">
                                    </div>
                                    <div>
                                        <span style="font-weight: 600; color: var(--text-primary);">
                                            ${(((item.customerPrice || item.price || 0) * (item.qty || 1)) + (item.shipping || 0) + (item.tax || 0)).toLocaleString('en-US', { style: 'currency', currency: 'USD' })}
                                        </span>
                                    </div>
                                    <div>
                                        ${item.link ? 
                                            `<div style="display: flex; align-items: center; gap: 4px;">
                                                <a href="${item.link}" target="_blank" style="color: var(--secondary-brand); text-decoration: none; font-weight: 500; font-size: 12px;"> View</a>
                                                <button onclick="editItemLink(${sectionIndex}, ${itemIndex})" style="background: none; border: 1px solid var(--section-bg); border-radius: 3px; padding: 1px 4px; font-size: 10px; cursor: pointer;" title="Edit Link"></button>
                                            </div>` :
                                            `<button onclick="editItemLink(${sectionIndex}, ${itemIndex})" style="background: var(--section-bg); border: 1px solid var(--section-bg); border-radius: 4px; padding: 4px 8px; font-size: 11px; cursor: pointer; color: var(--text-secondary);">+ Add Link</button>`
                                        }
                                    </div>
                                    <div>
                                        <button onclick="toggleReadyToOrder(${sectionIndex}, ${itemIndex}, ${!item.readyToOrder})" 
                                                style="
                                                    background: ${item.readyToOrder ? 'linear-gradient(135deg, var(--success), var(--highlight))' : 'linear-gradient(135deg, #f8f9fa, #e9ecef)'};
                                                    border: 2px solid ${item.readyToOrder ? 'var(--success)' : 'var(--section-bg)'};
                                                    color: ${item.readyToOrder ? 'white' : 'var(--text-secondary)'};
                                                    padding: 4px 8px;
                                                    border-radius: 12px;
                                                    font-size: 11px;
                                                    font-weight: 600;
                                                    cursor: pointer;
                                                    transition: all 0.3s ease;
                                                    text-transform: uppercase;
                                                    letter-spacing: 0.3px;
                                                    box-shadow: 0 1px 4px rgba(0,0,0,0.1);
                                                "
                                                onmouseover="this.style.transform='translateY(-1px)'; this.style.boxShadow='0 2px 8px rgba(0,0,0,0.2)'"
                                                onmouseout="this.style.transform='translateY(0px)'; this.style.boxShadow='0 1px 4px rgba(0,0,0,0.1)'">
                                            ${item.readyToOrder ? ' READY' : 'Mark Ready'}
                                        </button>
                                    </div>
                                </div>
                            `).join('')}
                        </div>
                    `;
                    deactivatedContainer.appendChild(sectionDiv);
                    
                    // Restore expanded state for deactivated sections too
                    if (expandedSections.has(sectionIndex)) {
                        const content = document.getElementById(`section-${sectionIndex}`);
                        content.classList.add('expanded');
                    }
                });
                
                // Add click handler to toggle deactivated sections
                deactivatedHeader.onclick = () => {
                    const container = document.getElementById('deactivatedSectionsContainer');
                    const icon = document.getElementById('deactivatedToggleIcon');
                    
                    if (container.style.display === 'none') {
                        container.style.display = 'block';
                        icon.style.transform = 'rotate(90deg)';
                        icon.textContent = '';
                    } else {
                        container.style.display = 'none';
                        icon.style.transform = 'rotate(0deg)';
                        icon.textContent = '';
                    }
                };
                
                deactivatedGroupDiv.appendChild(deactivatedHeader);
                deactivatedGroupDiv.appendChild(deactivatedContainer);
                container.appendChild(deactivatedGroupDiv);
            }
        }

        function toggleSection(sectionIndex) {
            const content = document.getElementById(`section-${sectionIndex}`);
            content.classList.toggle('expanded');
            
            // Track expanded state
            if (content.classList.contains('expanded')) {
                expandedSections.add(sectionIndex);
            } else {
                expandedSections.delete(sectionIndex);
            }
        }

        function toggleSectionGrayOut(sectionIndex) {
            if (!currentProject || !currentProject.sections || !currentProject.sections[sectionIndex]) return;
            
            const section = currentProject.sections[sectionIndex];
            const willGrayOut = !section.isGrayedOut;
            
            // Toggle the gray out state immediately without confirmation
            section.isGrayedOut = willGrayOut;
            saveCurrentProject();
            updateProjectSections();
            updateReadyToOrderItems(); // Refresh orders to exclude/include grayed out sections
        }

        function deleteSection(sectionIndex) {
            if (!currentProject || !currentProject.sections || !currentProject.sections[sectionIndex]) return;
            
            const section = currentProject.sections[sectionIndex];
            const itemCount = section.items ? section.items.length : 0;
            
            showCustomPrompt(
                'Delete Section',
                [
                    { type: 'text', name: 'confirmation', label: `Type "delete" to confirm deletion of "${section.name}"\n\nThis will permanently delete:\n ${itemCount} item${itemCount === 1 ? '' : 's'}\n All associated data\n\nThis action cannot be undone.`, required: true, placeholder: 'Type delete' }
                ],
                (data) => {
                    if (data.confirmation.toLowerCase() !== 'delete') {
                        showCustomAlert('Please type "delete" to confirm. Section deletion cancelled.');
                        return;
                    }
                    
                    // Remove the section from expanded sections tracking
                    expandedSections.delete(sectionIndex);
                    
                    // Remove section from project
                    currentProject.sections.splice(sectionIndex, 1);
                    
                    // Update expanded sections indices (shift down for sections after deleted one)
                    const newExpandedSections = new Set();
                    expandedSections.forEach(index => {
                        if (index > sectionIndex) {
                            newExpandedSections.add(index - 1);
                        } else if (index < sectionIndex) {
                            newExpandedSections.add(index);
                        }
                    });
                    expandedSections = newExpandedSections;
                    
                    saveCurrentProject();
                    updateProjectSections();
                    updateReadyToOrderItems(); // Refresh orders
                    
                    showCustomAlert(`Section "${section.name}" deleted successfully! `);
                }
            );
        }

        function addNewSection() {
            if (!currentProject) return;
            
            showCustomPrompt(
                'Add New Section',
                [
                    { type: 'text', name: 'sectionName', label: 'Section Name', required: true, placeholder: 'e.g., Living Room, Kitchen, Bedroom' }
                ],
                (data) => {
                    if (!currentProject.sections) currentProject.sections = [];
                    
                    currentProject.sections.push({
                        id: Date.now(),
                        name: data.sectionName,
                        items: []
                    });
                    
                    saveCurrentProject();
                    updateProjectSections();
                    showCustomAlert('Section added successfully! ');
                }
            );
        }

        function addItemToSection(sectionIndex) {
            showCustomPrompt(
                'Add New Item',
                [
                    { type: 'text', name: 'itemName', label: 'Item Name', required: true, placeholder: 'e.g. Sofa, Chair, Table...' },
                    { type: 'number', name: 'quantity', label: 'Quantity', required: true, defaultValue: '1' },
                    { type: 'number', name: 'wholesalePrice', label: 'Your Cost (Wholesale Price)', step: '0.01', placeholder: '0.00' },
                    { type: 'number', name: 'customerPrice', label: 'Sell Price (What Customer Pays Per Unit)', step: '0.01', required: true },
                    { type: 'number', name: 'shipping', label: 'Shipping Cost', step: '0.01', placeholder: '0.00' },
                    { type: 'number', name: 'tax', label: 'Tax Amount', step: '0.01', placeholder: '0.00' },
                    { type: 'url', name: 'link', label: 'Product Website Link', placeholder: 'https://store.com/product-page' }
                ],
                (data) => {
                    const customerPrice = parseFloat(data.customerPrice) || 0;
                    currentProject.sections[sectionIndex].items.push({
                        id: Date.now(),
                        name: data.itemName,
                        qty: parseInt(data.quantity) || 1,
                        price: customerPrice, // Keep for backward compatibility
                        customerPrice: customerPrice,
                        wholesalePrice: parseFloat(data.wholesalePrice) || 0,
                        shipping: parseFloat(data.shipping) || 0,
                        tax: parseFloat(data.tax) || 0,
                        link: data.link || '',
                        readyToOrder: false,
                        deliveryStatus: 'pending',
                        shippingInfo: {
                            carrier: '',
                            trackingNumber: '',
                            shippingMethod: '',
                            estimatedDelivery: '',
                            shippingCost: parseFloat(data.shipping) || 0,
                            orderDate: '',
                            notes: ''
                        }
                    });
                    
                    saveCurrentProject();
                    updateProjectSections();
                    showCustomAlert('Item added successfully! ');
                }
            );
        }

        function toggleReadyToOrder(sectionIndex, itemIndex, isReady) {
            currentProject.sections[sectionIndex].items[itemIndex].readyToOrder = isReady;
            saveCurrentProject();
            updateReadyToOrderItems();
            updateProjectSections(); // Refresh to update the "Select All" checkbox state
        }
        
        // New function to toggle all items in a section
        function toggleAllSectionItems(sectionIndex, markAsReady) {
            currentProject.sections[sectionIndex].items.forEach(item => {
                item.readyToOrder = markAsReady;
            });
            saveCurrentProject();
            updateProjectSections();
            updateReadyToOrderItems();
            showCustomAlert(markAsReady ? 'All items in section marked as ready to order!' : 'All items in section unmarked from ready to order!');
        }
        
        // New function to update item quantity inline
        function updateItemQuantity(sectionIndex, itemIndex, newQuantity) {
            const qty = parseInt(newQuantity);
            if (qty > 0) {
                currentProject.sections[sectionIndex].items[itemIndex].qty = qty;
                saveCurrentProject();
                updateProjectSections();
                updateReadyToOrderItems();
            }
        }
        
        // New function to update item name inline
        function updateItemName(sectionIndex, itemIndex, newName) {
            const name = newName.trim();
            if (name.length > 0) {
                currentProject.sections[sectionIndex].items[itemIndex].name = name;
                saveCurrentProject();
                updateProjectSections();
                updateReadyToOrderItems();
            }
        }
        
        // Update functions for item pricing fields
        function updateItemPriceInline(sectionIndex, itemIndex, newPrice) {
            const price = parseFloat(newPrice);
            if (price >= 0) {
                currentProject.sections[sectionIndex].items[itemIndex].price = price;
                // Also update customer price if not set
                if (!currentProject.sections[sectionIndex].items[itemIndex].customerPrice) {
                    currentProject.sections[sectionIndex].items[itemIndex].customerPrice = price;
                }
                saveCurrentProject();
                updateProjectSections();
                updateReadyToOrderItems();
            }
        }
        
        function updateItemWholesalePrice(sectionIndex, itemIndex, newPrice) {
            const price = parseFloat(newPrice) || 0;
            currentProject.sections[sectionIndex].items[itemIndex].wholesalePrice = price;
            saveCurrentProject();
            updateProjectSections();
        }
        
        function updateItemCustomerPrice(sectionIndex, itemIndex, newPrice) {
            const price = parseFloat(newPrice) || 0;
            currentProject.sections[sectionIndex].items[itemIndex].customerPrice = price;
            saveCurrentProject();
            updateProjectSections();
            updateReadyToOrderItems();
        }
        
        function updateItemShipping(sectionIndex, itemIndex, newShipping) {
            const shipping = parseFloat(newShipping) || 0;
            currentProject.sections[sectionIndex].items[itemIndex].shipping = shipping;
            saveCurrentProject();
            updateProjectSections();
        }
        
        function updateItemTax(sectionIndex, itemIndex, newTax) {
            const tax = parseFloat(newTax) || 0;
            currentProject.sections[sectionIndex].items[itemIndex].tax = tax;
            saveCurrentProject();
            updateProjectSections();
        }
        

        
        // Function to edit item link with prompt
        function editItemLink(sectionIndex, itemIndex) {
            const currentLink = currentProject.sections[sectionIndex].items[itemIndex].link || '';
            
            showCustomPrompt(
                'Edit Item Link',
                [
                    { type: 'url', name: 'link', label: 'Link URL', placeholder: 'https://example.com/product', defaultValue: currentLink }
                ],
                (data) => {
                    currentProject.sections[sectionIndex].items[itemIndex].link = data.link;
                    saveCurrentProject();
                    showProjectSection('items'); // Refresh the items view
                    showCustomAlert('Link updated successfully! ');
                }
            );
        }

                // Orders Tab - Complete Rebuild
        let orderItems = [];
        let selectedOrderItems = new Set();
        let expandedOrderSections = new Set();
        let currentOrderFilter = ''; // '' = show all, 'pending', 'ordered', 'shipped', 'delivered'
        
        // Legacy variables for backward compatibility
        let filteredOrderItems = [];
        
        function updateOrdersTab() {
            if (!currentProject || !currentProject.sections) return;
            
            // Clear existing order items
            orderItems = [];
            
            // Collect items from active sections only
            currentProject.sections.forEach((section, sectionIndex) => {
                // Skip deactivated sections
                if (section.isGrayedOut) return;
                
                section.items.forEach((item, itemIndex) => {
                    // Skip deactivated items
                    if (item.isGrayedOut) return;
                    
                    // Only include items marked as ready to order
                    if (item.readyToOrder) {
                        orderItems.push({
                            ...item,
                            sectionIndex,
                            itemIndex,
                            sectionName: section.name,
                            uniqueId: `${sectionIndex}-${itemIndex}`
                        });
                    }
                });
            });
            
            // Update the orders tab display
            renderOrderSections();
            renderDeliveryProgress();
        }

        function updateReadyToOrderItems() {
            updateOrdersTab();
        }

        
        function renderDeliveryProgress() {
            let pending = 0, ordered = 0, shipped = 0, delivered = 0;
            
            orderItems.forEach(item => {
                const status = item.deliveryStatus || 'pending';
                switch(status) {
                    case 'pending': pending++; break;
                    case 'ordered': ordered++; break;
                    case 'shipped': shipped++; break;
                    case 'delivered': delivered++; break;
                }
            });
            
            // Update totals
            document.getElementById('pendingTotal').textContent = pending;
            document.getElementById('orderedTotal').textContent = ordered;
            document.getElementById('shippedTotal').textContent = shipped;
            document.getElementById('deliveredTotal').textContent = delivered;
        }
        
        function setOrderFilter(status) {
            currentOrderFilter = status;
            
            // Update visual feedback on filter buttons
            const filters = ['pending', 'ordered', 'shipped', 'delivered'];
            filters.forEach(filterStatus => {
                const filterElement = document.getElementById(`${filterStatus}Filter`);
                if (filterElement) {
                    if (filterStatus === status) {
                        // Active filter - add border and shadow
                        filterElement.style.border = '3px solid white';
                        filterElement.style.boxShadow = '0 4px 16px rgba(0,0,0,0.3)';
                        filterElement.style.transform = 'translateY(-2px)';
                    } else {
                        // Inactive filter - remove special styling
                        filterElement.style.border = 'none';
                        filterElement.style.boxShadow = 'none';
                        filterElement.style.transform = 'translateY(0)';
                    }
                }
            });
            
            // Show/hide clear filter button
            const clearButton = document.getElementById('clearFilterButton');
            if (clearButton) {
                clearButton.style.display = status ? 'block' : 'none';
            }
            
            // Re-render sections with filter applied
            renderOrderSections();
        }

        function renderOrderSections() {
            const container = document.getElementById('orderSectionsList');
            
            if (orderItems.length === 0) {
                container.innerHTML = `
                    <div style="text-align: center; padding: 60px 20px; color: var(--text-secondary);">
                        <div style="font-size: 64px; margin-bottom: 20px;"></div>
                        <h3 style="margin: 0 0 10px 0; font-weight: 500;">No Items Ready to Order</h3>
                        <p style="margin: 0; font-size: 16px;">Go to the Items tab and mark items as "ready to order" to see them here.</p>
                    </div>
                `;
                return;
            }
            
            // Filter items based on current filter
            let filteredItems = orderItems;
            if (currentOrderFilter) {
                filteredItems = orderItems.filter(item => {
                    const itemStatus = item.deliveryStatus || 'pending';
                    return itemStatus === currentOrderFilter;
                });
            }
            
            // Group filtered items by section
            const itemsBySection = {};
            filteredItems.forEach(item => {
                if (!itemsBySection[item.sectionName]) {
                    itemsBySection[item.sectionName] = [];
                }
                itemsBySection[item.sectionName].push(item);
            });
            
            // Show "no results" message if filter produces no results
            if (filteredItems.length === 0 && currentOrderFilter) {
                container.innerHTML = `
                    <div style="text-align: center; padding: 60px 20px; color: var(--text-secondary);">
                        <div style="font-size: 64px; margin-bottom: 20px;"></div>
                        <h3 style="margin: 0 0 10px 0; font-weight: 500;">No ${currentOrderFilter.toUpperCase()} Items</h3>
                        <p style="margin: 0; font-size: 16px;">Try a different status filter or clear the filter to see all items.</p>
                    </div>
                `;
                return;
            }
            
            // Auto-expand all sections by default
            Object.keys(itemsBySection).forEach(sectionName => {
                const sectionId = `order-section-${sectionName.replace(/\s+/g, '-').toLowerCase()}`;
                expandedOrderSections.add(sectionId);
            });
            
            let sectionsHTML = '';
            
            Object.entries(itemsBySection).forEach(([sectionName, items]) => {
                const sectionId = `order-section-${sectionName.replace(/\s+/g, '-').toLowerCase()}`;
                const isExpanded = expandedOrderSections.has(sectionId);
                
                // Calculate section totals
                let sectionPurchasePrice = 0;
                items.forEach(item => {
                    const quantity = parseInt(item.qty) || 1;
                    const wholesale = parseFloat(item.wholesalePrice) || 0;
                    const shipping = parseFloat(item.shipping) || 0;
                    const tax = parseFloat(item.tax) || 0;
                    sectionPurchasePrice += (wholesale + shipping + tax) * quantity;
                });
                
                // Calculate section stats for status summary
                const pending = items.filter(item => !item.deliveryStatus || item.deliveryStatus === 'pending').length;
                const ordered = items.filter(item => item.deliveryStatus === 'ordered').length;
                const shipped = items.filter(item => item.deliveryStatus === 'shipped').length;
                const delivered = items.filter(item => item.deliveryStatus === 'delivered').length;
                
                const sectionIndexVal = items[0]?.sectionIndex;
                sectionsHTML += `
                    <div style="margin-bottom: 15px;">
                        <div class="section-header" style="cursor: pointer;">
                            <div onclick="toggleOrderSection('${sectionId}')" style="flex-grow: 1; display: flex; align-items: center;">
                                <strong style="color: var(--text-primary); font-size: 18px;">${sectionName}</strong>
                                <span style="color: var(--text-secondary); margin-left: 12px; font-size: 14px;">(${items.length} items  ${formatCurrency(sectionPurchasePrice)})</span>
                            </div>
                            <div style="display: flex; align-items: center; gap: 15px; margin-top: 8px;">
                                <button onclick="event.stopPropagation(); openChangeAllMenu('${sectionId}', ${sectionIndexVal})" 
                                        style="background: var(--secondary-brand); color: white; border: none; padding: 8px 16px; border-radius: 8px; font-size: 13px; cursor: pointer; font-weight: 500; transition: all 0.2s ease;" 
                                        onmouseover="this.style.transform='translateY(-1px)'; this.style.boxShadow='0 4px 12px rgba(0,0,0,0.15)'" 
                                        onmouseout="this.style.transform='translateY(0)'; this.style.boxShadow='none'">
                                    Change All
                                </button>
                                <select id="${sectionId}-bulk-select" onchange="event.stopPropagation(); requestBulkStatusConfirm(${sectionIndexVal}, this.value, '${sectionId}', '${sectionName.replace(/'/g, "\\'")}')" 
                                        style="display: none; padding: 8px 12px; border: 2px solid var(--section-bg); border-radius: 8px; font-size: 13px; font-weight: 500; cursor: pointer; min-width: 160px; background: var(--card-bg); color: var(--text-primary);">
                                    <option value="" selected disabled>Set stage</option>
                                    <option value="pending"> Pending</option>
                                    <option value="ordered"> Ordered</option>
                                    <option value="shipped"> Shipped</option>
                                    <option value="delivered"> Delivered</option>
                                </select>
                            </div>
                        </div>
                        <div class="section-content" id="${sectionId}" style="display: ${isExpanded ? 'block' : 'none'}; padding: 0; background: rgba(255,255,255,0.7); border-radius: 0 0 10px 10px; margin-bottom: 0;">
                            ${renderSectionItemsTable(items)}
                        </div>
                    </div>
                `;
            });
            
            container.innerHTML = sectionsHTML;
            updateOrderBulkButtons();
        }
        
        function renderSectionItemsTable(items) {
            return `
                <div style="padding: 20px; overflow-x: auto;">
                    <table style="width: 100%; border-collapse: collapse; background: white; border-radius: 8px; overflow: hidden; box-shadow: 0 2px 8px rgba(0,0,0,0.1);">
                        <thead>
                            <tr style="background: var(--section-bg); font-weight: 600; font-size: 14px;">
                                <th style="padding: 16px; text-align: left; width: 50px; color: var(--text-primary);">
                                    <input type="checkbox" onchange="toggleSectionSelectAll(this, '${items[0]?.sectionName}')" style="cursor: pointer; transform: scale(1.2); accent-color: var(--primary-brand);">
                                </th>
                                <th style="padding: 16px; text-align: left; color: var(--text-primary);">Item Details</th>
                                <th style="padding: 16px; text-align: center; color: var(--text-primary);">Qty</th>
                                <th style="padding: 16px; text-align: center; color: var(--text-primary);">Purchase Price</th>
                                <th style="padding: 16px; text-align: center; color: var(--text-primary);">Status</th>
                                <th style="padding: 16px; text-align: center; color: var(--text-primary);">Shipping</th>
                            </tr>
                        </thead>
                        <tbody>
                            ${items.map(item => {
                                const quantity = parseInt(item.qty) || 1;
                                const wholesale = parseFloat(item.wholesalePrice) || 0;
                                const shipping = parseFloat(item.shipping) || 0;
                                const tax = parseFloat(item.tax) || 0;
                                const purchasePrice = (wholesale + shipping + tax) * quantity;
                                const hasShippingInfo = item.shippingInfo && (item.shippingInfo.trackingNumber || item.shippingInfo.carrier);
                                
                                const statusColors = {
                                    'pending': 'var(--warning)',
                                    'ordered': 'var(--secondary-brand)', 
                                    'shipped': 'var(--primary-brand)',
                                    'delivered': 'var(--success)'
                                };
                                
                                const statusEmojis = {
                                    'pending': '',
                                    'ordered': '',
                                    'shipped': '', 
                                    'delivered': ''
                                };
                                
                                const currentStatus = item.deliveryStatus || 'pending';
                                
                                return `
                                    <tr style="border-bottom: 1px solid var(--hover-bg); transition: all 0.2s ease;" onmouseover="this.style.background='rgba(248, 250, 252, 0.8)'" onmouseout="this.style.background='transparent'">
                                        <td style="padding: 18px; text-align: center;">
                                            <input type="checkbox" 
                                                   ${selectedOrderItems.has(item.uniqueId) ? 'checked' : ''} 
                                                   onchange="toggleOrderItemSelection('${item.uniqueId}')" 
                                                   style="cursor: pointer; transform: scale(1.3); accent-color: var(--primary-brand);">
                                        </td>
                                        <td style="padding: 18px;">
                                            <div style="display: flex; flex-direction: column; gap: 4px;">
                                                <div style="font-weight: 600; font-size: 16px; color: var(--text-primary);">${item.name || item.item || item.itemName || 'Unnamed Item'}</div>
                                                ${item.description ? `<div style="font-size: 13px; color: var(--text-secondary); line-height: 1.4;">${item.description}</div>` : ''}
                                                ${item.link ? `<a href="${item.link}" target="_blank" style="font-size: 12px; color: var(--secondary-brand); text-decoration: none; font-weight: 500;"> View Product</a>` : ''}
                                            </div>
                                        </td>
                                        <td style="padding: 18px; text-align: center;">
                                            <div style="background: var(--section-bg); color: var(--text-primary); padding: 8px 12px; border-radius: 8px; font-weight: 700; font-size: 16px; display: inline-block; min-width: 40px;">${quantity}</div>
                                        </td>
                                        <td style="padding: 18px; text-align: center;">
                                            <div style="font-weight: 700; font-size: 17px; color: var(--text-primary); margin-bottom: 2px;">${formatCurrency(purchasePrice)}</div>
                                            <div style="font-size: 11px; color: var(--text-secondary); background: rgba(102, 102, 102, 0.1); padding: 2px 8px; border-radius: 12px; display: inline-block;">Wholesale + Ship + Tax</div>
                                        </td>
                                        <td style="padding: 18px; text-align: center;">
                                            <div style="display: flex; flex-direction: column; align-items: center; gap: 8px;">
                                                <div style="background: ${statusColors[currentStatus]}; color: white; padding: 8px 16px; border-radius: 20px; font-size: 12px; font-weight: 600; display: flex; align-items: center; gap: 6px; min-width: 100px; justify-content: center;">
                                                    ${statusEmojis[currentStatus]} ${currentStatus.toUpperCase()}
                                                </div>
                                                <select onchange="updateOrderItemStatus(${item.sectionIndex}, ${item.itemIndex}, this.value)" 
                                                        style="padding: 6px 12px; border: 2px solid var(--section-bg); border-radius: 6px; font-size: 12px; font-weight: 500; cursor: pointer; background: white;">
                                                    <option value="pending" ${(!item.deliveryStatus || item.deliveryStatus === 'pending') ? 'selected' : ''}> PENDING</option>
                                                    <option value="ordered" ${item.deliveryStatus === 'ordered' ? 'selected' : ''}> ORDERED</option>
                                                    <option value="shipped" ${item.deliveryStatus === 'shipped' ? 'selected' : ''}> SHIPPED</option>
                                                    <option value="delivered" ${item.deliveryStatus === 'delivered' ? 'selected' : ''}> DELIVERED</option>
                                                </select>
                                            </div>
                                        </td>
                                        <td style="padding: 18px; text-align: center;">
                                            <div style="display: flex; flex-direction: column; align-items: center; gap: 8px;">
                                                <button onclick="openOrderShippingModal(${item.sectionIndex}, ${item.itemIndex})" 
                                                        style="background: ${hasShippingInfo ? 'var(--success)' : 'var(--secondary-brand)'}; color: white; border: none; padding: 10px 16px; border-radius: 8px; font-size: 12px; cursor: pointer; font-weight: 600; transition: all 0.2s ease; display: flex; align-items: center; gap: 6px;" 
                                                        onmouseover="this.style.transform='translateY(-1px)'; this.style.boxShadow='0 4px 8px rgba(0,0,0,0.2)'" 
                                                        onmouseout="this.style.transform='translateY(0)'; this.style.boxShadow='none'">
                                                    ${hasShippingInfo ? ' INFO' : ' ADD INFO'}
                                                </button>
                                                ${hasShippingInfo && item.shippingInfo.trackingNumber ? `
                                                    <div style="font-size: 10px; color: var(--text-secondary); background: var(--section-bg); padding: 4px 8px; border-radius: 12px; font-weight: 500; max-width: 120px; text-overflow: ellipsis; overflow: hidden;"> ${item.shippingInfo.trackingNumber}</div>
                                                ` : ''}
                                                ${hasShippingInfo && item.shippingInfo.carrier ? `
                                                    <div style="font-size: 10px; color: var(--text-secondary); background: var(--hover-bg); padding: 2px 6px; border-radius: 8px; font-weight: 500;"> ${item.shippingInfo.carrier}</div>
                                                ` : ''}
                                            </div>
                                        </td>
                                    </tr>
                                `;
                            }).join('')}
                        </tbody>
                    </table>
                </div>
            `;
        }
        
        // New Orders Tab Interactive Functions
        function toggleOrderSection(sectionId) {
            const sectionElement = document.getElementById(sectionId);
            if (expandedOrderSections.has(sectionId)) {
                expandedOrderSections.delete(sectionId);
                sectionElement.style.display = 'none';
            } else {
                expandedOrderSections.add(sectionId);
                sectionElement.style.display = 'block';
            }
            // Don't re-render, just toggle display
        }
        
        function selectAllOrderItems() {
            orderItems.forEach(item => selectedOrderItems.add(item.uniqueId));
            renderOrderSections();
        }
        
        function clearOrderSelections() {
            selectedOrderItems.clear();
            renderOrderSections();
        }
        
        function selectSectionItems(sectionName, select) {
            orderItems.forEach(item => {
                if (item.sectionName === sectionName) {
                    if (select) {
                        selectedOrderItems.add(item.uniqueId);
                    } else {
                        selectedOrderItems.delete(item.uniqueId);
                    }
                }
            });
            renderOrderSections();
        }
        
        function toggleSectionSelectAll(checkbox, sectionName) {
            selectSectionItems(sectionName, checkbox.checked);
        }
        
        function toggleOrderItemSelection(uniqueId) {
            if (selectedOrderItems.has(uniqueId)) {
                selectedOrderItems.delete(uniqueId);
            } else {
                selectedOrderItems.add(uniqueId);
            }
            renderOrderSections();
        }
        
        // updateOrderBulkButtons no longer needed; bulk row removed
        function updateOrderBulkButtons() {}
        
        function bulkUpdateOrderStatus(newStatus) {
            if (selectedOrderItems.size === 0) return;
            
            let updatedCount = 0;
            selectedOrderItems.forEach(uniqueId => {
                const item = orderItems.find(item => item.uniqueId === uniqueId);
                if (item) {
                    currentProject.sections[item.sectionIndex].items[item.itemIndex].deliveryStatus = newStatus;
                    
                    // Set order date when status changes to ordered
                    if (newStatus === 'ordered' && !currentProject.sections[item.sectionIndex].items[item.itemIndex].shippingInfo?.orderDate) {
                        if (!currentProject.sections[item.sectionIndex].items[item.itemIndex].shippingInfo) {
                            currentProject.sections[item.sectionIndex].items[item.itemIndex].shippingInfo = {};
                        }
                        currentProject.sections[item.sectionIndex].items[item.itemIndex].shippingInfo.orderDate = new Date().toISOString().split('T')[0];
                    }
                    
                    updatedCount++;
                }
            });
            
            selectedOrderItems.clear();
            saveCurrentProject();
            updateOrdersTab();
            
            showCustomAlert(`${updatedCount} items updated to ${newStatus.toUpperCase()} status!`);
        }
        
        function updateOrderItemStatus(sectionIndex, itemIndex, newStatus) {
            currentProject.sections[sectionIndex].items[itemIndex].deliveryStatus = newStatus;
            
            // Set order date when status changes to ordered
            if (newStatus === 'ordered' && !currentProject.sections[sectionIndex].items[itemIndex].shippingInfo?.orderDate) {
                if (!currentProject.sections[sectionIndex].items[itemIndex].shippingInfo) {
                    currentProject.sections[sectionIndex].items[itemIndex].shippingInfo = {};
                }
                currentProject.sections[sectionIndex].items[itemIndex].shippingInfo.orderDate = new Date().toISOString().split('T')[0];
            }
            
            saveCurrentProject();
            updateOrdersTab();
        }
        
        function openOrderShippingModal(sectionIndex, itemIndex) {
            openShippingInfoModal(sectionIndex, itemIndex);
        }
        
        // Legacy function - can be removed
        function renderOrderItems() {
            const container = document.getElementById('readyToOrderItems');
            
            if (filteredOrderItems.length === 0) {
                const noItemsMessage = allOrderItems.length === 0 
                    ? 'No items ready to order yet. Go to the Items tab and click "Mark Ready" on items you want to order.'
                    : currentStatusFilter ? `No items with status "${currentStatusFilter.toUpperCase()}". Click "Delivery Progress" above to show all items.` : 'No items match your current criteria.';
                    
                container.innerHTML = `
                    <div style="text-align: center; padding: 40px; color: var(--text-secondary);">
                        <div style="font-size: 48px; margin-bottom: 16px;"></div>
                        <p>${noItemsMessage}</p>
                    </div>
                `;
                return;
            }
            
            // Group items by section for better organization
            renderItemsBySection();
            renderSummary();
        }
        
        function renderItemsBySection() {
            const container = document.getElementById('readyToOrderItems');
            
            // Group items by section
            const itemsBySection = {};
            filteredOrderItems.forEach(item => {
                if (!itemsBySection[item.sectionName]) {
                    itemsBySection[item.sectionName] = [];
                }
                itemsBySection[item.sectionName].push(item);
            });
            
            let sectionsHTML = '';
            
            // Default: expand all sections when orders tab is opened
            Object.keys(itemsBySection).forEach(sectionName => {
                const sectionId = `order-section-${sectionName.replace(/\s+/g, '-').toLowerCase()}`;
                if (!expandedOrderSections.has(sectionId)) {
                    expandedOrderSections.add(sectionId);
                }
            });
            
            Object.entries(itemsBySection).forEach(([sectionName, items]) => {
                const sectionId = `order-section-${sectionName.replace(/\s+/g, '-').toLowerCase()}`;
                const isExpanded = expandedOrderSections.has(sectionId);
                const itemCount = items.length;
                
                // Calculate section stats
                const pending = items.filter(item => !item.deliveryStatus || item.deliveryStatus === 'pending').length;
                const ordered = items.filter(item => item.deliveryStatus === 'ordered').length;
                const shipped = items.filter(item => item.deliveryStatus === 'shipped').length;
                const delivered = items.filter(item => item.deliveryStatus === 'delivered').length;

                sectionsHTML += `
                    <div class="card" style="margin-bottom: 20px; overflow: hidden;">
                        <div onclick="toggleOrderSectionExpansion('${sectionId}')" 
                             style="cursor: pointer; padding: 20px; display: flex; justify-content: space-between; align-items: center; background: var(--section-bg); transition: all 0.2s ease;" 
                             onmouseover="this.style.background='var(--hover-bg)'" 
                             onmouseout="this.style.background='var(--section-bg)'">
                            <div>
                                <h4 style="margin: 0 0 8px 0; color: var(--text-primary);">${sectionName}</h4>
                                <div style="display: flex; gap: 15px; font-size: 12px; font-weight: 500;">
                                    <span style="color: var(--warning);"> Pending: ${pending}</span>
                                    <span style="color: var(--secondary-brand);"> Ordered: ${ordered}</span>
                                    <span style="color: var(--primary-brand);"> Shipped: ${shipped}</span>
                                    <span style="color: var(--success);"> Delivered: ${delivered}</span>
                                </div>
                            </div>
                            <div style="display: flex; align-items: center; gap: 10px;">
                                <span style="background: var(--text-primary); color: var(--text-inverse); padding: 4px 8px; border-radius: 12px; font-size: 12px; font-weight: 600;">${itemCount} items</span>
                                <span style="font-size: 20px; transform: rotate(${isExpanded ? '180' : '0'}deg); transition: transform 0.2s ease;"></span>
                            </div>
                        </div>
                        <div id="${sectionId}" style="display: ${isExpanded ? 'block' : 'none'}; padding: 20px; padding-top: 0;">
                            ${renderSectionItemsTable(items)}
                        </div>
                    </div>
                `;
            });

            container.innerHTML = sectionsHTML;
        }
        
        function toggleOrderSectionExpansion(sectionId) {
            const sectionElement = document.getElementById(sectionId);
            const isCurrentlyExpanded = expandedOrderSections.has(sectionId);
            
            if (isCurrentlyExpanded) {
                expandedOrderSections.delete(sectionId);
                sectionElement.style.display = 'none';
            } else {
                expandedOrderSections.add(sectionId);
                sectionElement.style.display = 'block';
            }
            
            // Update the arrow rotation
            renderOrderItems();
        }
        
        function renderSectionItemsTable(items) {
            const isMobile = window.innerWidth < 768;
            
            if (isMobile) {
                return renderSectionItemsMobile(items);
            } else {
                return renderSectionItemsDesktop(items);
            }
        }
        
        function renderSectionItemsDesktop(items) {
            return `
                <div style="overflow-x: auto;">
                    <table style="width: 100%; border-collapse: collapse;">
                        <thead>
                            <tr style="background: var(--hover-bg); font-weight: 600; font-size: 14px;">
                                <th style="padding: 12px; text-align: center; width: 40px;"></th>
                                <th style="padding: 12px; text-align: left;">Item Name</th>
                                <th style="padding: 12px; text-align: center;">Quantity</th>
                                <th style="padding: 12px; text-align: center;">Purchase Price</th>
                                <th style="padding: 12px; text-align: center;">Status</th>
                                <th style="padding: 12px; text-align: center;">Shipping Info</th>
                            </tr>
                        </thead>
                        <tbody>
                            ${items.map(item => {
                                const purchasePrice = calculatePurchasePrice(item);
                                const hasShippingInfo = item.shippingInfo && (item.shippingInfo.trackingNumber || item.shippingInfo.carrier);
                                return `
                                    <tr style="border-bottom: 1px solid var(--section-bg); transition: all 0.2s ease;" onmouseover="this.style.background='var(--hover-bg)'" onmouseout="this.style.background='transparent'">
                                        <td style="padding: 12px; text-align: center;">
                                            <input type="checkbox" ${selectedOrderItems.has(item.uniqueId) ? 'checked' : ''} onchange="toggleItemSelection('${item.uniqueId}')" style="cursor: pointer;">
                                        </td>
                                        <td style="padding: 12px;">
                                            <div style="font-weight: 500; color: var(--text-primary); margin-bottom: 4px;">${item.name || item.item || 'Unnamed Item'}</div>
                                            ${item.description ? `<div style="font-size: 12px; color: var(--text-secondary);">${item.description}</div>` : ''}
                                        </td>
                                        <td style="padding: 12px; text-align: center; font-weight: 500; font-size: 16px;">${item.qty || 1}</td>
                                        <td style="padding: 12px; text-align: center;">
                                            <div style="font-weight: 600; font-size: 16px; color: var(--text-primary);">${formatCurrency(purchasePrice)}</div>
                                            <div style="font-size: 11px; color: var(--text-secondary); margin-top: 2px;">Wholesale + Ship + Tax</div>
                                        </td>
                                        <td style="padding: 12px; text-align: center;">
                                            <select onchange="updateItemDeliveryStatus(${item.sectionIndex}, ${item.itemIndex}, this.value)" 
                                                    style="padding: 8px 12px; border: 2px solid var(--section-bg); border-radius: 6px; font-size: 13px; font-weight: 500; cursor: pointer; min-width: 120px;">
                                                <option value="pending" ${(!item.deliveryStatus || item.deliveryStatus === 'pending') ? 'selected' : ''}> Pending</option>
                                                <option value="ordered" ${item.deliveryStatus === 'ordered' ? 'selected' : ''}> Ordered</option>
                                                <option value="shipped" ${item.deliveryStatus === 'shipped' ? 'selected' : ''}> Shipped</option>
                                                <option value="delivered" ${item.deliveryStatus === 'delivered' ? 'selected' : ''}> Delivered</option>
                                            </select>
                                        </td>
                                        <td style="padding: 12px; text-align: center;">
                                            <button onclick="openShippingInfoModal(${item.sectionIndex}, ${item.itemIndex})" 
                                                    style="background: ${hasShippingInfo ? 'var(--success)' : 'var(--secondary-brand)'}; color: white; border: none; padding: 6px 12px; border-radius: 6px; font-size: 12px; cursor: pointer; font-weight: 500;" 
                                                    onmouseover="this.style.transform='translateY(-1px)'" onmouseout="this.style.transform='translateY(0)'">
                                                ${hasShippingInfo ? ' Info' : '+ Info'}
                                            </button>
                                            ${hasShippingInfo && item.shippingInfo.trackingNumber ? `
                                                <div style="font-size: 10px; color: var(--text-secondary); margin-top: 2px; max-width: 80px; overflow: hidden; text-overflow: ellipsis;">${item.shippingInfo.trackingNumber}</div>
                                            ` : ''}
                                        </td>
                                    </tr>
                                `;
                            }).join('')}
                        </tbody>
                    </table>
                </div>
            `;
        }
        
        function renderSectionItemsMobile(items) {
            return `
                <div style="display: grid; gap: 15px;">
                    ${items.map(item => {
                        const purchasePrice = calculatePurchasePrice(item);
                        const hasShippingInfo = item.shippingInfo && (item.shippingInfo.trackingNumber || item.shippingInfo.carrier);
                        return `
                            <div style="background: var(--card-bg); border-radius: 12px; padding: 20px; border: 2px solid ${selectedOrderItems.has(item.uniqueId) ? 'var(--primary-brand)' : 'var(--section-bg)'}; transition: all 0.2s ease;">
                                <div style="display: flex; align-items: flex-start; gap: 15px; margin-bottom: 15px;">
                                    <input type="checkbox" ${selectedOrderItems.has(item.uniqueId) ? 'checked' : ''} onchange="toggleItemSelection('${item.uniqueId}')" style="transform: scale(1.2); cursor: pointer; margin-top: 4px;">
                                    <div style="flex: 1;">
                                        <h4 style="margin: 0 0 5px 0; font-size: 18px; color: var(--text-primary);">${item.name || item.item || 'Unnamed Item'}</h4>
                                        ${item.description ? `<p style="margin: 0 0 10px 0; color: var(--text-secondary); font-size: 14px;">${item.description}</p>` : ''}
                                    </div>
                                </div>
                                
                                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 15px; margin-bottom: 15px;">
                                    <div style="text-align: center; padding: 12px; background: var(--section-bg); border-radius: 8px;">
                                        <div style="font-size: 24px; font-weight: 700; color: var(--text-primary);">${item.qty || 1}</div>
                                        <div style="font-size: 12px; color: var(--text-secondary); font-weight: 500;">QUANTITY</div>
                                    </div>
                                    <div style="text-align: center; padding: 12px; background: var(--section-bg); border-radius: 8px;">
                                        <div style="font-size: 20px; font-weight: 700; color: var(--text-primary);">${formatCurrency(purchasePrice)}</div>
                                        <div style="font-size: 12px; color: var(--text-secondary); font-weight: 500;">PURCHASE PRICE</div>
                                    </div>
                                </div>
                                
                                <div style="display: grid; grid-template-columns: 1fr auto; gap: 10px; align-items: center;">
                                    <select onchange="updateItemDeliveryStatus(${item.sectionIndex}, ${item.itemIndex}, this.value)" 
                                            style="padding: 10px 15px; border: 2px solid var(--section-bg); border-radius: 8px; font-size: 14px; font-weight: 500; cursor: pointer;">
                                        <option value="pending" ${(!item.deliveryStatus || item.deliveryStatus === 'pending') ? 'selected' : ''}> Pending</option>
                                        <option value="ordered" ${item.deliveryStatus === 'ordered' ? 'selected' : ''}> Ordered</option>
                                        <option value="shipped" ${item.deliveryStatus === 'shipped' ? 'selected' : ''}> Shipped</option>
                                        <option value="delivered" ${item.deliveryStatus === 'delivered' ? 'selected' : ''}> Delivered</option>
                                    </select>
                                    <button onclick="openShippingInfoModal(${item.sectionIndex}, ${item.itemIndex})" 
                                            style="background: ${hasShippingInfo ? 'var(--success)' : 'var(--secondary-brand)'}; color: white; border: none; padding: 10px 15px; border-radius: 8px; font-size: 14px; cursor: pointer; font-weight: 500; white-space: nowrap;" 
                                            onmouseover="this.style.transform='translateY(-1px)'" onmouseout="this.style.transform='translateY(0)'">
                                        ${hasShippingInfo ? ' Shipping' : '+ Shipping'}
                                    </button>
                                </div>
                                
                                ${hasShippingInfo && item.shippingInfo.trackingNumber ? `
                                    <div style="margin-top: 10px; padding: 8px; background: var(--hover-bg); border-radius: 6px; font-size: 12px; color: var(--text-secondary);">
                                        <strong>Tracking:</strong> ${item.shippingInfo.trackingNumber}
                                        ${item.shippingInfo.carrier ? ` (${item.shippingInfo.carrier})` : ''}
                                    </div>
                                ` : ''}
                            </div>
                        `;
                    }).join('')}
                </div>
            `;
        }

        // Show the section-specific bulk status dropdown
        function openChangeAllMenu(sectionId, sectionIndex) {
            // Select all items in this section for context (by index for stability)
            selectSectionItemsByIndex(sectionIndex, true);
            const select = document.getElementById(`${sectionId}-bulk-select`);
            if (select) {
                select.style.display = 'inline-block';
                select.focus();
            }
        }

        // Confirm modal for Change All will be shown before applying

        // Apply the selected status to all items in the given section
        function requestBulkStatusConfirm(sectionIndexTarget, newStatus, sectionId, sectionName) {
            if (!newStatus) return;
            const statusLabel = newStatus.charAt(0).toUpperCase() + newStatus.slice(1);
            showCustomConfirm(
                'Confirm Status Change',
                `Change all items in "${sectionName}" to ${statusLabel}?`,
                'Confirm',
                () => applyBulkStatusToSectionByIndex(sectionIndexTarget, newStatus, sectionId)
            );
        }

        function applyBulkStatusToSectionByIndex(sectionIndexTarget, newStatus, sectionId) {
            if (!newStatus) return;
            let updatedCount = 0;
            currentProject.sections.forEach((section, sectionIndex) => {
                if (sectionIndex === sectionIndexTarget) {
                    section.items.forEach((item, itemIndex) => {
                        // Apply to ALL items in the section, regardless of readyToOrder state
                        if (!item.isGrayedOut) {
                            currentProject.sections[sectionIndex].items[itemIndex].deliveryStatus = newStatus;
                            if (newStatus === 'ordered') {
                                if (!currentProject.sections[sectionIndex].items[itemIndex].shippingInfo) {
                                    currentProject.sections[sectionIndex].items[itemIndex].shippingInfo = {};
                                }
                                if (!currentProject.sections[sectionIndex].items[itemIndex].shippingInfo.orderDate) {
                                    currentProject.sections[sectionIndex].items[itemIndex].shippingInfo.orderDate = new Date().toISOString().split('T')[0];
                                }
                            }
                            updatedCount++;
                        }
                    });
                }
            });
            selectedOrderItems.clear();
            saveCurrentProject();
            updateOrdersTab();
            // No post-confirm toast to avoid duplication
            // Reset and hide the dropdown for this section if still present
            setTimeout(() => {
                if (sectionId) {
                    const select = document.getElementById(`${sectionId}-bulk-select`);
                    if (select) {
                        select.value = '';
                        select.style.display = 'none';
                    }
                }
            }, 0);
        }

        // Helper: select all items in a section by index
        function selectSectionItemsByIndex(sectionIndexTarget, select) {
            orderItems.forEach(item => {
                if (item.sectionIndex === sectionIndexTarget) {
                    if (select) {
                        selectedOrderItems.add(item.uniqueId);
                    } else {
                        selectedOrderItems.delete(item.uniqueId);
                    }
                }
            });
            renderOrderSections();
        }

        function renderDesktopTable() {
            const container = document.getElementById('readyToOrderItems');
            
            container.innerHTML = `
                <div style="background: var(--card-bg); border-radius: 12px; overflow: hidden; box-shadow: 0 4px 12px rgba(0,0,0,0.1); margin-bottom: 20px;">
                    <div style="overflow-x: auto;">
                        <table style="width: 100%; border-collapse: collapse;">
                            <thead>
                                <tr style="background: var(--section-bg); font-weight: 600; font-size: 14px;">
                                    <th style="padding: 16px; text-align: left; border-bottom: 2px solid var(--hover-bg); width: 40px;">
                                        <input type="checkbox" id="selectAllCheckbox" onchange="toggleSelectAll()" style="cursor: pointer;">
                                    </th>
                                    <th style="padding: 16px; text-align: left; border-bottom: 2px solid var(--hover-bg);">Item / Section</th>
                                    <th style="padding: 16px; text-align: center; border-bottom: 2px solid var(--hover-bg); width: 80px;">Qty</th>
                                    <th style="padding: 16px; text-align: right; border-bottom: 2px solid var(--hover-bg); width: 120px;">Wholesale</th>
                                    <th style="padding: 16px; text-align: right; border-bottom: 2px solid var(--hover-bg); width: 120px;">Sell Price</th>
                                    <th style="padding: 16px; text-align: right; border-bottom: 2px solid var(--hover-bg); width: 100px;">Shipping</th>
                                    <th style="padding: 16px; text-align: right; border-bottom: 2px solid var(--hover-bg); width: 80px;">Tax</th>
                                    <th style="padding: 16px; text-align: center; border-bottom: 2px solid var(--hover-bg); width: 140px;">Status</th>
                                    <th style="padding: 16px; text-align: center; border-bottom: 2px solid var(--hover-bg); width: 100px;">Actions</th>
                                </tr>
                            </thead>
                            <tbody>
                                ${filteredOrderItems.map(item => `
                                    <tr style="border-bottom: 1px solid var(--hover-bg); transition: all 0.2s ease;" 
                                        onmouseover="this.style.backgroundColor='var(--hover-bg)'" 
                                        onmouseout="this.style.backgroundColor=''">
                                        <td style="padding: 16px; text-align: center;">
                                            <input type="checkbox" 
                                                   ${selectedOrderItems.has(item.uniqueId) ? 'checked' : ''} 
                                                   onchange="toggleItemSelection('${item.uniqueId}')" 
                                                   style="cursor: pointer;">
                                        </td>
                                        <td style="padding: 16px; vertical-align: top;">
                                            <div style="font-weight: 600; color: var(--text-primary); margin-bottom: 4px; font-size: 15px;">${item.name}</div>
                                            <div style="font-size: 13px; color: var(--text-secondary); margin-bottom: 4px;">${item.sectionName}</div>
                                            ${item.link ? `<a href="${item.link}" target="_blank" style="color: var(--secondary-brand); text-decoration: none; font-size: 12px; display: inline-flex; align-items: center; gap: 4px;"> View Product</a>` : '<span style="font-size: 12px; color: var(--text-tertiary);">No product link</span>'}
                                        </td>
                                        <td style="padding: 16px; text-align: center; font-weight: 600; font-size: 16px;">${item.qty || 1}</td>
                                        <td style="padding: 16px; text-align: right; font-weight: 500; color: var(--text-primary);">${((item.wholesalePrice || 0) * (item.qty || 1)).toLocaleString('en-US', { style: 'currency', currency: 'USD' })}</td>
                                        <td style="padding: 16px; text-align: right; font-weight: 600; color: var(--primary-brand);">${((item.customerPrice || item.price || 0) * (item.qty || 1)).toLocaleString('en-US', { style: 'currency', currency: 'USD' })}</td>
                                        <td style="padding: 16px; text-align: right; font-weight: 500; color: var(--text-primary);">${((item.shipping || 0) * (item.qty || 1)).toLocaleString('en-US', { style: 'currency', currency: 'USD' })}</td>
                                        <td style="padding: 16px; text-align: right; font-weight: 500; color: var(--text-primary);">${((item.tax || 0) * (item.qty || 1)).toLocaleString('en-US', { style: 'currency', currency: 'USD' })}</td>
                                        <td style="padding: 16px; text-align: center;">
                                            <select onchange="updateOrderStatusWithFeedback(${item.sectionIndex}, ${item.itemIndex}, this.value)" 
                                                    style="padding: 8px 12px; border: 2px solid var(--section-bg); border-radius: 8px; background: var(--card-bg); font-size: 13px; width: 100%; font-weight: 500; color: var(--text-primary); cursor: pointer;">
                                                <option value="pending" ${(item.orderStatus || 'pending') === 'pending' ? 'selected' : ''}> Pending</option>
                                                <option value="ordered" ${item.orderStatus === 'ordered' ? 'selected' : ''}> Ordered</option>
                                                <option value="shipped" ${item.orderStatus === 'shipped' ? 'selected' : ''}> Shipped</option>
                                                <option value="delivered" ${item.orderStatus === 'delivered' ? 'selected' : ''}> Delivered</option>
                                            </select>
                                        </td>
                                        <td style="padding: 16px; text-align: center;">
                                            <button onclick="removeFromReadyToOrderWithConfirm(${item.sectionIndex}, ${item.itemIndex})"
                                                    style="padding: 8px 12px; background: var(--error); color: white; border: none; border-radius: 6px; font-size: 12px; cursor: pointer; transition: all 0.2s ease;"
                                                    onmouseover="this.style.transform='translateY(-1px)'; this.style.boxShadow='0 4px 8px rgba(0,0,0,0.15)'"
                                                    onmouseout="this.style.transform='translateY(0)'; this.style.boxShadow='none'"
                                                    title="Remove from orders">
                                                 Remove
                                            </button>
                                        </td>
                                    </tr>
                                `).join('')}
                            </tbody>
                        </table>
                    </div>
                </div>
            `;
        }

        function renderMobileCards() {
            const container = document.getElementById('readyToOrderItems');
            
            container.innerHTML = `
                <div style="display: grid; gap: 16px; margin-bottom: 20px;">
                    ${filteredOrderItems.map(item => `
                        <div style="background: var(--card-bg); border-radius: 12px; padding: 16px; box-shadow: 0 2px 8px rgba(0,0,0,0.1); border: 1px solid var(--hover-bg);">
                            <div style="display: flex; justify-content: space-between; align-items: flex-start; margin-bottom: 12px;">
                                <div style="flex: 1;">
                                    <div style="font-weight: 600; color: var(--text-primary); margin-bottom: 4px; font-size: 16px;">${item.name}</div>
                                    <div style="font-size: 13px; color: var(--text-secondary); margin-bottom: 8px;">${item.sectionName}</div>
                                    ${item.link ? `<a href="${item.link}" target="_blank" style="color: var(--secondary-brand); text-decoration: none; font-size: 12px;"> View Product</a>` : ''}
                                </div>
                                <input type="checkbox" 
                                       ${selectedOrderItems.has(item.uniqueId) ? 'checked' : ''} 
                                       onchange="toggleItemSelection('${item.uniqueId}')" 
                                       style="cursor: pointer; margin-left: 12px;">
                            </div>
                            
                            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 12px; margin-bottom: 16px; font-size: 14px;">
                                <div>
                                    <div style="color: var(--text-secondary); font-size: 12px; margin-bottom: 2px;">Quantity</div>
                                    <div style="font-weight: 600;">${item.qty || 1}</div>
                                </div>
                                <div>
                                    <div style="color: var(--text-secondary); font-size: 12px; margin-bottom: 2px;">Sell Price</div>
                                    <div style="font-weight: 600; color: var(--primary-brand);">${((item.customerPrice || item.price || 0) * (item.qty || 1)).toLocaleString('en-US', { style: 'currency', currency: 'USD' })}</div>
                                </div>
                                <div>
                                    <div style="color: var(--text-secondary); font-size: 12px; margin-bottom: 2px;">Wholesale</div>
                                    <div style="font-weight: 500;">${((item.wholesalePrice || 0) * (item.qty || 1)).toLocaleString('en-US', { style: 'currency', currency: 'USD' })}</div>
                                </div>
                                <div>
                                    <div style="color: var(--text-secondary); font-size: 12px; margin-bottom: 2px;">Ship + Tax</div>
                                    <div style="font-weight: 500;">${(((item.shipping || 0) + (item.tax || 0)) * (item.qty || 1)).toLocaleString('en-US', { style: 'currency', currency: 'USD' })}</div>
                                </div>
                            </div>
                            
                            <div style="display: flex; gap: 8px; align-items: center;">
                                <select onchange="updateOrderStatusWithFeedback(${item.sectionIndex}, ${item.itemIndex}, this.value)" 
                                        style="flex: 1; padding: 10px 12px; border: 2px solid var(--section-bg); border-radius: 8px; background: var(--card-bg); font-size: 14px; font-weight: 500; color: var(--text-primary);">
                                    <option value="pending" ${(item.orderStatus || 'pending') === 'pending' ? 'selected' : ''}> Pending</option>
                                    <option value="ordered" ${item.orderStatus === 'ordered' ? 'selected' : ''}> Ordered</option>
                                    <option value="shipped" ${item.orderStatus === 'shipped' ? 'selected' : ''}> Shipped</option>
                                    <option value="delivered" ${item.orderStatus === 'delivered' ? 'selected' : ''}> Delivered</option>
                                </select>
                                <button onclick="removeFromReadyToOrderWithConfirm(${item.sectionIndex}, ${item.itemIndex})"
                                        style="padding: 10px 12px; background: var(--error); color: white; border: none; border-radius: 8px; font-size: 12px; cursor: pointer;">
                                    
                                </button>
                            </div>
                        </div>
                    `).join('')}
                </div>
            `;
        }

        function renderSummary() {
            const container = document.getElementById('readyToOrderItems');
            const summaryHTML = `
                <div style="margin-top: 20px; background: var(--section-bg); border-radius: 12px; padding: 20px; border: 2px solid var(--hover-bg);">
                    <h4 style="margin: 0 0 16px 0; color: var(--text-primary); text-align: center;">Order Summary</h4>
                    <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 16px; text-align: center; font-size: 14px; font-weight: 500;">
                        <div style="padding: 16px; background: var(--card-bg); border-radius: 10px;">
                            <div style="color: var(--text-secondary); margin-bottom: 6px; font-size: 13px;">Total Items</div>
                            <div style="font-size: 24px; font-weight: 600; color: var(--text-primary);">${filteredOrderItems.length}</div>
                        </div>
                        <div style="padding: 16px; background: var(--card-bg); border-radius: 10px;">
                            <div style="color: var(--text-secondary); margin-bottom: 6px; font-size: 13px;">Total Wholesale</div>
                            <div style="font-size: 20px; font-weight: 600; color: var(--text-primary);">${filteredOrderItems.reduce((total, item) => total + ((item.wholesalePrice || 0) * (item.qty || 1)), 0).toLocaleString('en-US', { style: 'currency', currency: 'USD' })}</div>
                        </div>
                        <div style="padding: 16px; background: var(--card-bg); border-radius: 10px;">
                            <div style="color: var(--text-secondary); margin-bottom: 6px; font-size: 13px;">Total Sell Price</div>
                            <div style="font-size: 20px; font-weight: 600; color: var(--primary-brand);">${filteredOrderItems.reduce((total, item) => total + ((item.customerPrice || item.price || 0) * (item.qty || 1)), 0).toLocaleString('en-US', { style: 'currency', currency: 'USD' })}</div>
                        </div>
                        <div style="padding: 16px; background: var(--card-bg); border-radius: 10px;">
                            <div style="color: var(--text-secondary); margin-bottom: 6px; font-size: 13px;">Potential Profit</div>
                            <div style="font-size: 20px; font-weight: 600; color: var(--success);">${filteredOrderItems.reduce((total, item) => total + (((item.customerPrice || item.price || 0) - (item.wholesalePrice || 0)) * (item.qty || 1)), 0).toLocaleString('en-US', { style: 'currency', currency: 'USD' })}</div>
                        </div>
                    </div>
                </div>
            `;
            
            container.innerHTML += summaryHTML;
        }

        function updateItemPrice(sectionIndex, itemIndex, newPrice) {
            currentProject.sections[sectionIndex].items[itemIndex].price = parseFloat(newPrice);
            saveCurrentProject();
            updateReadyToOrderItems();
            updateProjectSections();
        }

        function updateOrderStatus(sectionIndex, itemIndex, status) {
            currentProject.sections[sectionIndex].items[itemIndex].orderStatus = status;
            saveCurrentProject();
            updateReadyToOrderItems(); // Refresh to update progress
            showCustomAlert(`Order status updated to "${status}"!`);
        }
        
        function updateOrderProgress(readyItems) {
            let pendingCount = 0;
            let orderedCount = 0; 
            let shippedCount = 0;
            let deliveredCount = 0;
            
            readyItems.forEach(item => {
                const status = item.deliveryStatus || 'pending';
                switch(status) {
                    case 'pending': pendingCount++; break;
                    case 'ordered': orderedCount++; break; 
                    case 'shipped': shippedCount++; break;
                    case 'delivered': deliveredCount++; break;
                }
            });
            
            const total = readyItems.length;
            const deliveredPercentage = total > 0 ? (deliveredCount / total) * 100 : 0;
            
            // Update progress bar - show different colors for each stage
            const totalReadyItems = total || 1; // Avoid division by zero
            const pendingPercentage = (pendingCount / totalReadyItems) * 100;
            const orderedPercentage = (orderedCount / totalReadyItems) * 100;
            const shippedPercentage = (shippedCount / totalReadyItems) * 100;
            const deliveredPercentageCalc = (deliveredCount / totalReadyItems) * 100;
            
            // Update progress bar widths
            document.getElementById('pendingProgress').style.width = `${pendingPercentage}%`;
            document.getElementById('orderedProgress').style.width = `${orderedPercentage}%`;
            document.getElementById('shippedProgress').style.width = `${shippedPercentage}%`;
            document.getElementById('deliveredProgress').style.width = `${deliveredPercentageCalc}%`;
            
            // Update percentage text below progress bar
            if (document.getElementById('pendingPercent')) {
                document.getElementById('pendingPercent').textContent = `${pendingPercentage.toFixed(0)}%`;
                document.getElementById('orderedPercent').textContent = `${orderedPercentage.toFixed(0)}%`;
                document.getElementById('shippedPercent').textContent = `${shippedPercentage.toFixed(0)}%`;
                document.getElementById('deliveredPercent').textContent = `${deliveredPercentageCalc.toFixed(0)}%`;
            }
            
            // Update counters
            document.getElementById('pendingCount').textContent = pendingCount;
            document.getElementById('orderedCount').textContent = orderedCount;
            document.getElementById('shippedCount').textContent = shippedCount;
            document.getElementById('deliveredCount').textContent = deliveredCount;
            
            // Update summary text with more detailed info
            const summaryText = total > 0 
                ? `${deliveredCount} delivered  ${shippedCount} shipped  ${orderedCount} ordered  ${pendingCount} pending (${total} total items)`
                : 'No items to track';
            document.getElementById('orderSummaryText').textContent = summaryText;
        }

        function removeFromReadyToOrder(sectionIndex, itemIndex) {
            currentProject.sections[sectionIndex].items[itemIndex].readyToOrder = false;
            saveCurrentProject();
            updateReadyToOrderItems();
            updateProjectSections();
        }

        // Enhanced order management functions
        function removeFromReadyToOrderWithConfirm(sectionIndex, itemIndex) {
            const item = currentProject.sections[sectionIndex].items[itemIndex];
            showCustomPrompt(
                'Remove Item from Orders',
                [
                    { type: 'text', name: 'confirm', label: `Are you sure you want to remove "${item.name}" from your orders?`, required: false, readonly: true }
                ],
                () => {
                    removeFromReadyToOrder(sectionIndex, itemIndex);
                    showSuccessToast('Item removed from orders');
                }
            );
        }

        function updateOrderStatusWithFeedback(sectionIndex, itemIndex, status) {
            const item = currentProject.sections[sectionIndex].items[itemIndex];
            const oldStatus = item.orderStatus || 'pending';
            
            currentProject.sections[sectionIndex].items[itemIndex].orderStatus = status;
            saveCurrentProject();
            updateReadyToOrderItems();
            
            // Show subtle feedback
            showSuccessToast(`${item.name} marked as ${status}`);
        }

        function toggleItemSelection(uniqueId) {
            if (selectedOrderItems.has(uniqueId)) {
                selectedOrderItems.delete(uniqueId);
            } else {
                selectedOrderItems.add(uniqueId);
            }
            updateBulkActionButtons();
            updateSelectAllCheckbox();
        }

        function toggleSelectAll() {
            const selectAllCheckbox = document.getElementById('selectAllCheckbox');
            if (selectAllCheckbox.checked) {
                filteredOrderItems.forEach(item => selectedOrderItems.add(item.uniqueId));
            } else {
                selectedOrderItems.clear();
            }
            renderOrderItems();
            updateBulkActionButtons();
        }

        function selectAllItems() {
            filteredOrderItems.forEach(item => selectedOrderItems.add(item.uniqueId));
            renderOrderItems();
            updateBulkActionButtons();
        }
        
        function toggleSectionSelectAll(checkbox, sectionName) {
            const sectionItems = filteredOrderItems.filter(item => item.sectionName === sectionName);
            
            if (checkbox.checked) {
                sectionItems.forEach(item => selectedOrderItems.add(item.uniqueId));
            } else {
                sectionItems.forEach(item => selectedOrderItems.delete(item.uniqueId));
            }
            
            renderOrderItems();
            updateBulkActionButtons();
        }
        
        function toggleItemSelection(uniqueId) {
            if (selectedOrderItems.has(uniqueId)) {
                selectedOrderItems.delete(uniqueId);
            } else {
                selectedOrderItems.add(uniqueId);
            }
            renderOrderItems();
            updateBulkActionButtons();
        }
        
        function updateItemDeliveryStatus(sectionIndex, itemIndex, newStatus) {
            if (currentProject && currentProject.sections) {
                currentProject.sections[sectionIndex].items[itemIndex].deliveryStatus = newStatus;
                
                // Set order date when item is marked as ordered
                if (newStatus === 'ordered' && !currentProject.sections[sectionIndex].items[itemIndex].shippingInfo.orderDate) {
                    currentProject.sections[sectionIndex].items[itemIndex].shippingInfo.orderDate = new Date().toISOString().split('T')[0];
                }
                
                saveProjects();
                updateReadyToOrderItems();
            }
        }
        
        function calculatePurchasePrice(item) {
            const wholesalePrice = parseFloat(item.wholesalePrice) || 0;
            const shipping = parseFloat(item.shipping) || parseFloat(item.shippingInfo?.shippingCost) || 0;
            const tax = parseFloat(item.tax) || 0;
            const quantity = parseInt(item.qty) || 1;
            
            return (wholesalePrice + shipping + tax) * quantity;
        }
        
        function formatCurrency(amount) {
            return new Intl.NumberFormat('en-US', {
                style: 'currency',
                currency: 'USD'
            }).format(amount);
        }
        
        function openShippingInfoModal(sectionIndex, itemIndex) {
            const item = currentProject.sections[sectionIndex].items[itemIndex];
            const shippingInfo = item.shippingInfo || {};
            
            const modalContent = `
                <div style="background: var(--card-bg); border-radius: 16px; padding: 30px; max-width: 500px; width: 90vw; max-height: 90vh; overflow-y: auto; box-shadow: 0 20px 60px rgba(0,0,0,0.3);">
                    <h3 style="margin: 0 0 20px 0; color: var(--text-primary); text-align: center;">Shipping Information</h3>
                    <p style="margin: 0 0 20px 0; color: var(--text-secondary); text-align: center;"><strong>${item.item || 'Item'}</strong> - ${item.sectionName || 'Section'}</p>
                    
                    <div style="display: grid; gap: 15px;">
                        <div>
                            <label style="display: block; margin-bottom: 5px; color: var(--text-primary); font-weight: 500;">Carrier</label>
                            <select id="shippingCarrier" style="width: 100%; padding: 10px; border: 2px solid var(--section-bg); border-radius: 8px; font-size: 14px;">
                                <option value="">Select Carrier</option>
                                <option value="UPS" ${shippingInfo.carrier === 'UPS' ? 'selected' : ''}>UPS</option>
                                <option value="FedEx" ${shippingInfo.carrier === 'FedEx' ? 'selected' : ''}>FedEx</option>
                                <option value="USPS" ${shippingInfo.carrier === 'USPS' ? 'selected' : ''}>USPS</option>
                                <option value="DHL" ${shippingInfo.carrier === 'DHL' ? 'selected' : ''}>DHL</option>
                                <option value="Other" ${shippingInfo.carrier === 'Other' ? 'selected' : ''}>Other</option>
                            </select>
                        </div>
                        
                        <div>
                            <label style="display: block; margin-bottom: 5px; color: var(--text-primary); font-weight: 500;">Tracking Number</label>
                            <input type="text" id="trackingNumber" value="${shippingInfo.trackingNumber || ''}" placeholder="Enter tracking number" style="width: 100%; padding: 10px; border: 2px solid var(--section-bg); border-radius: 8px; font-size: 14px;">
                        </div>
                        
                        <div>
                            <label style="display: block; margin-bottom: 5px; color: var(--text-primary); font-weight: 500;">Shipping Method</label>
                            <input type="text" id="shippingMethod" value="${shippingInfo.shippingMethod || ''}" placeholder="e.g., Ground, 2-Day Air, Overnight" style="width: 100%; padding: 10px; border: 2px solid var(--section-bg); border-radius: 8px; font-size: 14px;">
                        </div>
                        
                        <div>
                            <label style="display: block; margin-bottom: 5px; color: var(--text-primary); font-weight: 500;">Estimated Delivery</label>
                            <input type="date" id="estimatedDelivery" value="${shippingInfo.estimatedDelivery || ''}" style="width: 100%; padding: 10px; border: 2px solid var(--section-bg); border-radius: 8px; font-size: 14px;">
                        </div>
                        
                        <div>
                            <label style="display: block; margin-bottom: 5px; color: var(--text-primary); font-weight: 500;">Order Date</label>
                            <input type="date" id="orderDate" value="${shippingInfo.orderDate || ''}" style="width: 100%; padding: 10px; border: 2px solid var(--section-bg); border-radius: 8px; font-size: 14px;">
                        </div>
                        
                        <div>
                            <label style="display: block; margin-bottom: 5px; color: var(--text-primary); font-weight: 500;">Notes</label>
                            <textarea id="shippingNotes" rows="3" placeholder="Additional notes..." style="width: 100%; padding: 10px; border: 2px solid var(--section-bg); border-radius: 8px; font-size: 14px; resize: vertical;">${shippingInfo.notes || ''}</textarea>
                        </div>
                    </div>
                    
                    <div style="display: flex; gap: 10px; margin-top: 25px; justify-content: center;">
                        <button onclick="saveShippingInfo(${sectionIndex}, ${itemIndex})" style="background: var(--success); color: white; border: none; padding: 12px 24px; border-radius: 8px; font-weight: 500; cursor: pointer;">Save</button>
                        <button onclick="closeModal()" style="background: var(--hover-bg); color: var(--text-primary); border: none; padding: 12px 24px; border-radius: 8px; font-weight: 500; cursor: pointer;">Cancel</button>
                    </div>
                </div>
            `;
            
            showModal(modalContent);
        }
        
        function saveShippingInfo(sectionIndex, itemIndex) {
            const shippingInfo = {
                carrier: document.getElementById('shippingCarrier').value,
                trackingNumber: document.getElementById('trackingNumber').value,
                shippingMethod: document.getElementById('shippingMethod').value,
                estimatedDelivery: document.getElementById('estimatedDelivery').value,
                orderDate: document.getElementById('orderDate').value,
                notes: document.getElementById('shippingNotes').value,
                shippingCost: currentProject.sections[sectionIndex].items[itemIndex].shipping || 0
            };
            
            currentProject.sections[sectionIndex].items[itemIndex].shippingInfo = shippingInfo;
            saveProjects();
            updateReadyToOrderItems();
            closeModal();
            
            showCustomAlert('Shipping information saved successfully!');
        }

        function updateSelectAllCheckbox() {
            const selectAllCheckbox = document.getElementById('selectAllCheckbox');
            if (selectAllCheckbox) {
                const allSelected = filteredOrderItems.length > 0 && filteredOrderItems.every(item => selectedOrderItems.has(item.uniqueId));
                selectAllCheckbox.checked = allSelected;
            }
        }

        function updateBulkActionButtons() {
            const selectedCount = selectedOrderItems.size;
            const buttons = ['bulkOrderedBtn', 'bulkShippedBtn', 'bulkDeliveredBtn'];
            
            buttons.forEach(btnId => {
                const btn = document.getElementById(btnId);
                if (btn) {
                    btn.disabled = selectedCount === 0;
                    btn.style.opacity = selectedCount === 0 ? '0.5' : '1';
                    btn.style.cursor = selectedCount === 0 ? 'not-allowed' : 'pointer';
                }
            });
        }

        function bulkUpdateStatus(newStatus) {
            if (selectedOrderItems.size === 0) return;
            
            const statusEmoji = {
                'pending': '',
                'ordered': '',
                'shipped': '',
                'delivered': ''
            };
            
            let updatedCount = 0;
            selectedOrderItems.forEach(uniqueId => {
                const item = allOrderItems.find(item => item.uniqueId === uniqueId);
                if (item) {
                    currentProject.sections[item.sectionIndex].items[item.itemIndex].deliveryStatus = newStatus;
                    updatedCount++;
                }
            });
            
            selectedOrderItems.clear();
            saveCurrentProject();
            updateReadyToOrderItems();
            
            showSuccessToast(`${updatedCount} items marked as ${statusEmoji[newStatus]} ${newStatus}`);
        }

        function filterByStatus(status) {
            currentStatusFilter = status;
            applyStatusFilter();
        }
        
        function showAllItems() {
            currentStatusFilter = '';
            applyStatusFilter();
        }

        function clearAllFilters() {
            currentStatusFilter = '';
            selectedOrderItems.clear();
            applyStatusFilter();
        }

        function exportOrdersCSV() {
            if (filteredOrderItems.length === 0) {
                showCustomAlert('No items to export. Add some items to orders first.');
                return;
            }
            
            const headers = [
                'Item Name', 'Section', 'Quantity', 'Wholesale Price', 'Sell Price', 
                'Shipping', 'Tax', 'Status', 'Product Link', 'Total Wholesale', 'Total Sell'
            ];
            
            const csvData = filteredOrderItems.map(item => [
                item.name,
                item.sectionName,
                item.qty || 1,
                (item.wholesalePrice || 0).toFixed(2),
                (item.customerPrice || item.price || 0).toFixed(2),
                (item.shipping || 0).toFixed(2),
                (item.tax || 0).toFixed(2),
                item.orderStatus || 'pending',
                item.link || '',
                ((item.wholesalePrice || 0) * (item.qty || 1)).toFixed(2),
                ((item.customerPrice || item.price || 0) * (item.qty || 1)).toFixed(2)
            ]);
            
            const csvContent = [headers, ...csvData]
                .map(row => row.map(field => `"${field}"`).join(','))
                .join('\n');
            
            const blob = new Blob([csvContent], { type: 'text/csv' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `${currentProject.name}-orders-${new Date().toISOString().split('T')[0]}.csv`;
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            URL.revokeObjectURL(url);
            
            showSuccessToast('Orders exported to CSV successfully!');
        }

        function printOrdersList() {
            if (filteredOrderItems.length === 0) {
                showCustomAlert('No items to print. Add some items to orders first.');
                return;
            }
            
            const printContent = `
                <html>
                <head>
                    <title>Orders - ${currentProject.name}</title>
                    <style>
                        body { font-family: Arial, sans-serif; margin: 20px; }
                        h1 { color: #333; border-bottom: 3px solid #D8A7A7; padding-bottom: 10px; }
                        table { width: 100%; border-collapse: collapse; margin-top: 20px; }
                        th, td { padding: 12px; text-align: left; border-bottom: 1px solid #ddd; }
                        th { background-color: #f5f5f5; font-weight: bold; }
                        .status-pending { color: #D8C690; }
                        .status-ordered { color: #9CAEC2; }
                        .status-shipped { color: #D8A7A7; }
                        .status-delivered { color: #B7C4B2; }
                        .summary { background: #f9f9f9; padding: 15px; margin-top: 20px; border-radius: 8px; }
                    </style>
                </head>
                <body>
                    <h1>Order List - ${currentProject.name}</h1>
                    <p>Generated on ${new Date().toLocaleDateString()}</p>
                    
                    <table>
                        <thead>
                            <tr>
                                <th>Item</th>
                                <th>Section</th>
                                <th>Qty</th>
                                <th>Wholesale</th>
                                <th>Sell Price</th>
                                <th>Status</th>
                            </tr>
                        </thead>
                        <tbody>
                            ${filteredOrderItems.map(item => `
                                <tr>
                                    <td>${item.name}</td>
                                    <td>${item.sectionName}</td>
                                    <td>${item.qty || 1}</td>
                                    <td>$${((item.wholesalePrice || 0) * (item.qty || 1)).toFixed(2)}</td>
                                    <td>$${((item.customerPrice || item.price || 0) * (item.qty || 1)).toFixed(2)}</td>
                                    <td class="status-${item.orderStatus || 'pending'}">${item.orderStatus || 'pending'}</td>
                                </tr>
                            `).join('')}
                        </tbody>
                    </table>
                    
                    <div class="summary">
                        <h3>Summary</h3>
                        <p><strong>Total Items:</strong> ${filteredOrderItems.length}</p>
                        <p><strong>Total Wholesale:</strong> $${filteredOrderItems.reduce((total, item) => total + ((item.wholesalePrice || 0) * (item.qty || 1)), 0).toFixed(2)}</p>
                        <p><strong>Total Sell Price:</strong> $${filteredOrderItems.reduce((total, item) => total + ((item.customerPrice || item.price || 0) * (item.qty || 1)), 0).toFixed(2)}</p>
                        <p><strong>Potential Profit:</strong> $${filteredOrderItems.reduce((total, item) => total + (((item.customerPrice || item.price || 0) - (item.wholesalePrice || 0)) * (item.qty || 1)), 0).toFixed(2)}</p>
                    </div>
                </body>
                </html>
            `;
            
            const printWindow = window.open('', '_blank');
            printWindow.document.write(printContent);
            printWindow.document.close();
            printWindow.print();
        }

        function showSuccessToast(message) {
            // Create a subtle toast notification
            const toast = document.createElement('div');
            toast.style.cssText = `
                position: fixed;
                top: 20px;
                right: 20px;
                background: var(--success);
                color: white;
                padding: 12px 20px;
                border-radius: 8px;
                box-shadow: 0 4px 12px rgba(0,0,0,0.15);
                z-index: 10000;
                font-size: 14px;
                font-weight: 500;
                opacity: 0;
                transform: translateY(-10px);
                transition: all 0.3s ease;
            `;
            toast.textContent = message;
            document.body.appendChild(toast);
            
            // Animate in
            setTimeout(() => {
                toast.style.opacity = '1';
                toast.style.transform = 'translateY(0)';
            }, 10);
            
            // Animate out and remove
            setTimeout(() => {
                toast.style.opacity = '0';
                toast.style.transform = 'translateY(-10px)';
                setTimeout(() => {
                    if (toast.parentNode) {
                        document.body.removeChild(toast);
                    }
                }, 300);
            }, 3000);
        }

        // Add window resize listener for responsive design
        window.addEventListener('resize', () => {
            if (document.getElementById('orders').style.display !== 'none') {
                renderOrderItems();
            }
        });

        function updateProjectHours() {
            if (!currentProject) return;
            
            const hoursWorked = currentProject.hoursWorked || 0;
            const hoursPaid = currentProject.hoursPaid || 0;
            const hoursRemaining = hoursPaid - hoursWorked;
            
            
            // Helper function to format hours consistently
            const formatToHrsMin = (value) => {
                const sign = value < 0 ? -1 : 1;
                const abs = Math.abs(value);
                const h = Math.floor(abs);
                const m = Math.round((abs - h) * 60);
                const txt = `${h} hrs ${m} min`;
                return sign < 0 ? `-${txt}` : txt;
            };
            
            // Helper function to format paid hours (whole numbers only)
            const formatPaidHours = (value) => {
                const h = Math.floor(value);
                return `${h} hrs`;
            };
            
            // Update all hours display elements
            const hoursWorkedDisplay = document.getElementById('detailHoursWorked');
            const hoursPaidDisplay = document.getElementById('detailHoursPaid');
            const hoursRemainingDisplay = document.getElementById('detailHoursRemaining');
            
            if (hoursWorkedDisplay) {
                hoursWorkedDisplay.textContent = formatToHrsMin(hoursWorked);
            }
            if (hoursPaidDisplay) {
                hoursPaidDisplay.textContent = formatPaidHours(hoursPaid);
            }
            if (hoursRemainingDisplay) {
                hoursRemainingDisplay.textContent = formatToHrsMin(hoursRemaining);
            }
        }

        function logProjectHours() {
            if (!currentProject) return;
            
            showCustomPrompt(
                'Log Hours',
                [
                    { type: 'text', name: 'hours', label: 'Hours Worked', required: true, placeholder: 'e.g. 5:45 or 2:30 or 8:00' },
                    { type: 'date', name: 'date', label: 'Date', required: true, defaultValue: new Date().toISOString().split('T')[0] },
                    { type: 'textarea', name: 'description', label: 'Description', required: true, placeholder: 'What did you work on?' }
                ],
                (data) => {
                    const hours = parseHoursMinutes(data.hours);
                    if (isNaN(hours) || hours <= 0) {
                        showCustomAlert('Please enter valid hours in format "5:45" (5 hours 45 minutes) or decimal like "2.5".');
                        return;
                    }
                    
                    if (!currentProject.hoursLog) currentProject.hoursLog = [];
                    
                    currentProject.hoursLog.push({
                        id: Date.now(),
                        date: data.date,
                        hours: hours,
                        description: data.description
                    });
                    
                    currentProject.hoursWorked = (currentProject.hoursWorked || 0) + hours;
                    
                    saveCurrentProject();
                    updateProjectHours();
                    updateDashboard();
                    displayProjects();
                    
                    showCustomAlert(`Logged ${formatHoursMinutes(hours)} successfully! `);
                }
            );
        }
        
        // Function to display project notes
        function updateProjectNotes() {
            if (!currentProject) return;
            
            const container = document.getElementById('projectNotes');
            if (!container) return;
            
            const notes = currentProject.notes || [];
            
            // Sort notes by date (newest first)
            const sortedNotes = [...notes].sort((a, b) => {
                const dateA = new Date(b.createdAt || b.date);
                const dateB = new Date(a.createdAt || a.date);
                return dateA - dateB;
            });
            
            if (sortedNotes.length === 0) {
                container.innerHTML = '<p style="color: var(--text-secondary); padding: 20px; text-align: center;">No notes yet. Add your first note!</p>';
            } else {
                container.innerHTML = sortedNotes.map((note, index) => {
                    const noteDate = new Date(note.date || note.createdAt);
                    const isToday = new Date().toDateString() === noteDate.toDateString();
                    const dateLabel = isToday ? 'Today' : noteDate.toLocaleDateString('en-US', { month: 'short', day: 'numeric', year: 'numeric' });
                    
                    return `
                        <div class="note-item" style="
                            padding: 15px;
                            background: ${isToday ? 'linear-gradient(135deg, rgba(216, 167, 167, 0.1), rgba(216, 167, 167, 0.05))' : 'rgba(255,255,255,0.5)'};
                            border-radius: 10px;
                            margin-bottom: 12px;
                            border: 1px solid ${isToday ? 'var(--primary-brand)' : 'var(--hover-bg)'};
                            position: relative;
                            transition: all 0.2s ease;
                        " onmouseover="this.style.boxShadow='0 3px 10px rgba(0,0,0,0.1)'; this.style.transform='translateY(-1px)'" onmouseout="this.style.boxShadow='none'; this.style.transform='translateY(0)'">
                            <div style="display: flex; justify-content: space-between; align-items: flex-start; margin-bottom: 8px;">
                                <div style="
                                    font-size: 12px;
                                    color: ${isToday ? 'var(--primary-brand)' : 'var(--text-secondary)'};
                                    font-weight: ${isToday ? '600' : '500'};
                                    display: flex;
                                    align-items: center;
                                    gap: 6px;
                                ">
                                     ${dateLabel}
                                    ${isToday ? '<span style="background: var(--primary-brand); color: white; padding: 2px 8px; border-radius: 10px; font-size: 10px; margin-left: 5px;">NEW</span>' : ''}
                                </div>
                                <div style="display: flex; gap: 6px;">
                                    <button onclick="editProjectNote(${note.id})" style="
                                        background: none;
                                        border: none;
                                        color: var(--secondary-brand);
                                        cursor: pointer;
                                        font-size: 16px;
                                        padding: 4px;
                                        border-radius: 4px;
                                        transition: all 0.2s ease;
                                    " onmouseover="this.style.background='var(--hover-bg)'" onmouseout="this.style.background='none'" title="Edit note">
                                        
                                    </button>
                                    <button onclick="deleteProjectNote(${note.id})" style="
                                        background: none;
                                        border: none;
                                        color: var(--error);
                                        cursor: pointer;
                                        font-size: 16px;
                                        padding: 4px;
                                        border-radius: 4px;
                                        transition: all 0.2s ease;
                                    " onmouseover="this.style.background='var(--hover-bg)'" onmouseout="this.style.background='none'" title="Delete note">
                                        
                                    </button>
                                </div>
                            </div>
                            <div style="
                                color: var(--text-primary);
                                font-size: 14px;
                                line-height: 1.6;
                                white-space: pre-wrap;
                                word-wrap: break-word;
                            ">${escapeHtml(note.content)}</div>
                            ${note.updatedAt && note.updatedAt !== note.createdAt ? `
                                <div style="
                                    font-size: 11px;
                                    color: var(--text-tertiary);
                                    margin-top: 8px;
                                    font-style: italic;
                                ">Last edited: ${new Date(note.updatedAt).toLocaleString()}</div>
                            ` : ''}
                        </div>
                    `;
                }).join('');
            }
        }
        
        // Function to add a note from desktop
        function addProjectNote() {
            if (!currentProject) return;
            
            showCustomPrompt(
                'Add Note',
                [
                    { 
                        type: 'textarea', 
                        name: 'noteContent', 
                        label: `Note for ${currentProject.name}`, 
                        required: true, 
                        rows: 6,
                        placeholder: 'Enter your note here...'
                    }
                ],
                (data) => {
                    if (!currentProject.notes) currentProject.notes = [];
                    
                    const newNote = {
                        id: Date.now(),
                        date: new Date().toISOString().split('T')[0],
                        content: data.noteContent,
                        createdAt: new Date().toISOString(),
                        updatedAt: new Date().toISOString()
                    };
                    
                    currentProject.notes.push(newNote);
                    saveCurrentProject();
                    updateProjectNotes();
                    showCustomAlert('Note added successfully! ');
                }
            );
        }
        
        // Function to edit a note
        function editProjectNote(noteId) {
            if (!currentProject || !currentProject.notes) return;
            
            const note = currentProject.notes.find(n => n.id === noteId);
            if (!note) return;
            
            showCustomPrompt(
                'Edit Note',
                [
                    { 
                        type: 'textarea', 
                        name: 'noteContent', 
                        label: 'Note Content', 
                        required: true, 
                        rows: 6,
                        defaultValue: note.content
                    }
                ],
                (data) => {
                    note.content = data.noteContent;
                    note.updatedAt = new Date().toISOString();
                    
                    saveCurrentProject();
                    updateProjectNotes();
                    showCustomAlert('Note updated successfully! ');
                }
            );
        }
        
        // Function to delete a note
        function deleteProjectNote(noteId) {
            if (!currentProject || !currentProject.notes) return;
            
            showCustomConfirm(
                'Delete Note',
                'Are you sure you want to delete this note? This action cannot be undone.',
                () => {
                    currentProject.notes = currentProject.notes.filter(n => n.id !== noteId);
                    saveCurrentProject();
                    updateProjectNotes();
                    showCustomAlert('Note deleted successfully.');
                }
            );
        }
        
        // Helper function to escape HTML
        function escapeHtml(text) {
            const div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML;
        }

        function updateProjectUpcomingEvents() {
            if (!currentProject) return;
            
            const container = document.getElementById('projectUpcomingEvents');
            const upcomingEvents = [];
            
            if (currentProject.events) {
                currentProject.events.forEach((event, index) => {
                    const eventDate = new Date(event.date + 'T00:00:00');
                    const today = new Date();
                    if (eventDate >= today && !event.completed) {
                        upcomingEvents.push({...event, originalIndex: index});
                    }
                });
            }
            
            upcomingEvents.sort((a, b) => new Date(a.date) - new Date(b.date));
            
            if (upcomingEvents.length === 0) {
                container.innerHTML = '<p style="color: var(--text-secondary);">No upcoming events for this project.</p>';
            } else {
                container.innerHTML = upcomingEvents.map(event => `
                    <div class="upcoming-event" style="
                        display: flex;
                        justify-content: space-between;
                        align-items: center;
                        padding: 12px 15px;
                        background: rgba(255,255,255,0.7);
                        border-radius: 8px;
                        margin-bottom: 8px;
                        border: 1px solid var(--hover-bg);
                        transition: all 0.2s ease;
                    " onmouseover="this.style.boxShadow='0 2px 8px rgba(0,0,0,0.1)'; this.style.transform='translateY(-1px)'" onmouseout="this.style.boxShadow='none'; this.style.transform='translateY(0)'">
                        <div style="flex: 1;">
                            <div style="font-weight: 600; color: var(--text-primary); margin-bottom: 4px;">${event.title}</div>
                            <div style="font-size: 13px; color: var(--text-secondary); margin-bottom: 2px;">${event.notes || 'No notes'}</div>
                            <div style="display: flex; gap: 15px; font-size: 12px; color: var(--text-secondary);">
                                <span> ${new Date(event.date + 'T00:00:00').toLocaleDateString()}</span>
                                <span> ${event.time || 'No time set'}</span>
                                ${event.type ? `<span style="background: ${getEventTypeColor(event.type)}; color: white; padding: 2px 6px; border-radius: 10px; font-size: 10px; text-transform: capitalize;">${event.type}</span>` : ''}
                        </div>
                        </div>
                        <div style="display: flex; gap: 6px; align-items: center; margin-left: 15px;">
                            <button onclick="editProjectEvent(${event.originalIndex})" style="
                                background: var(--secondary-brand);
                                color: white;
                                border: none;
                                padding: 6px 10px;
                                border-radius: 4px;
                                font-size: 11px;
                                cursor: pointer;
                                transition: all 0.2s ease;
                            " onmouseover="this.style.background='var(--primary-brand)'" onmouseout="this.style.background='var(--secondary-brand)'" title="Edit Event">
                                 Edit
                            </button>
                            <button onclick="deleteProjectEvent(${event.originalIndex})" style="
                                background: var(--error);
                                color: white;
                                border: none;
                                padding: 6px 10px;
                                border-radius: 4px;
                                font-size: 11px;
                                cursor: pointer;
                                transition: all 0.2s ease;
                            " onmouseover="this.style.background='#c53030'" onmouseout="this.style.background='var(--error)'" title="Delete Event">
                                 Delete
                            </button>
                        </div>
                    </div>
                `).join('');
            }
        }

        function updateSectionInvoiceList() {
            if (!currentProject || !currentProject.sections) return;
            
            const container = document.getElementById('sectionInvoiceList');
            if (!container) return;
            
            // Rebuild the invoice section structure
            const invoiceContainer = document.getElementById('invoice');
            invoiceContainer.innerHTML = `
                <div style="margin-bottom: 30px;">
                    <h3 style="margin: 0 0 15px 0; color: var(--text-primary);">Ready to Order Invoices</h3>
                    <p style="margin: 0 0 20px 0; color: var(--text-secondary); font-size: 14px;">Generate invoices for items that are ready to order. Only sections with items marked as "ready to order" will appear here.</p>
                    
                    <div id="sectionInvoiceList" style="display: grid; gap: 15px;">
                        <!-- Section invoice options will be populated here -->
                    </div>
                </div>
                
                <div class="invoice-preview" id="projectInvoicePreview">
                    <!-- Invoice preview will be populated here -->
                </div>
            `;
            
            const sectionListContainer = document.getElementById('sectionInvoiceList');
            
            if (currentProject.sections.length === 0) {
                sectionListContainer.innerHTML = '<p style="color: var(--text-secondary); text-align: center; padding: 20px;">No sections available. Add items in the Items tab to create invoices.</p>';
                return;
            }
            
            // Filter sections that have items marked as ready to order
            const sectionsWithReadyItems = currentProject.sections.filter(section => 
                section.items && section.items.length > 0 && 
                !section.isGrayedOut &&
                section.items.some(item => item.readyToOrder && !item.isGrayedOut)
            );
            
            if (sectionsWithReadyItems.length === 0) {
                sectionListContainer.innerHTML = '<p style="color: var(--text-secondary); text-align: center; padding: 20px;">No sections with items ready to order. Go to the Items tab and mark items as "ready to order" to create invoices.</p>';
                return;
            }
            
            sectionListContainer.innerHTML = sectionsWithReadyItems.map((section, filteredIndex) => {
                // Only include items that are ready to order and not deactivated
                const readyItems = section.items.filter(item => item.readyToOrder && !item.isGrayedOut);
                const hasReadyItems = readyItems.length > 0;
                
                const sectionTotal = hasReadyItems ? readyItems.reduce((total, item) => {
                    const customerUnitPrice = item.customerPrice || item.price || 0;
                    const quantity = item.qty || 1;
                    const unitTotal = customerUnitPrice * quantity;
                    const totalWithShippingTax = unitTotal + (item.shipping || 0) + (item.tax || 0);
                    return total + totalWithShippingTax;
                }, 0) : 0;
                
                const itemCount = readyItems.length;
                
                // Get the original section index for invoice generation - use the section's original index
                const originalSectionIndex = currentProject.sections.findIndex(s => s === section);
                
                // Add debugging and validation
                console.log('Section mapping:', {
                    sectionName: section.name,
                    filteredIndex,
                    originalSectionIndex,
                    isValid: originalSectionIndex !== -1
                });
                
                return `
                    <div class="card" style="padding: 20px;">
                        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px;">
                            <div>
                                <h4 style="margin: 0; color: var(--text-primary);">${section.name}</h4>
                                <p style="margin: 5px 0 0 0; color: var(--text-secondary); font-size: 13px;">
                                    ${itemCount} ready-to-order item${itemCount === 1 ? '' : 's'}  Total: $${sectionTotal.toLocaleString('en-US', { minimumFractionDigits: 2, maximumFractionDigits: 2 })}
                                </p>
                            </div>
                            <div style="display: flex; gap: 10px;">
                                <button class="btn ${hasReadyItems && originalSectionIndex !== -1 ? '' : 'btn-disabled'}" 
                                        onclick="${hasReadyItems && originalSectionIndex !== -1 ? `showInvoiceConfirmation(${originalSectionIndex})` : `showCustomAlert('This section has no ready-to-order items or section index is invalid. Please refresh and try again.')`}" 
                                        style="padding: 8px 16px; font-size: 14px; ${hasReadyItems && originalSectionIndex !== -1 ? 'background: var(--primary-brand); color: white;' : 'background: #ccc; cursor: not-allowed;'}">
                                     Review Invoice
                                </button>
                            </div>
                        </div>
                        
                        <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 10px; margin-top: 10px;">
                            ${hasReadyItems ? readyItems.map(item => {
                                const customerPrice = item.customerPrice || item.price || 0;
                                const total = (customerPrice * (item.qty || 1)) + (item.shipping || 0) + (item.tax || 0);
                                return `
                                    <div style="padding: 8px 12px; background: var(--section-bg); border-radius: 6px; font-size: 12px;">
                                        <strong>${item.name || item.item || item.itemName || 'Unnamed Item'}</strong><br>
                                        <span style="color: var(--text-secondary);">Qty: ${item.qty || 1}  $${total.toFixed(2)}</span>
                                    </div>
                                `;
                            }).join('') : `
                                <div style="padding: 12px; text-align: center; color: var(--text-secondary); font-style: italic; grid-column: 1 / -1;">
                                    No ready-to-order items in this section. <a href="#" onclick="showProjectSection('items', document.querySelector('.project-tab[onclick*=items]'))" style="color: var(--secondary-brand);">Mark items as ready to order </a>
                                </div>
                            `}
                        </div>
                    </div>
                `;
            }).join('');
        }

        function previewSectionInvoice(sectionIndex, selectedItemIds = null) {
            if (!currentProject || !currentProject.sections || !currentProject.sections[sectionIndex]) {
                showCustomAlert('Error: Section not found. Please refresh and try again.');
                return;
            }
            
            const section = currentProject.sections[sectionIndex];
            
            // Check if there are any ready-to-order items
            const invoiceHTML = generateCleanInvoiceHTML(sectionIndex, selectedItemIds);
            if (!invoiceHTML) {
                showCustomAlert('No ready-to-order items found in this section. Please mark items as ready to order first.');
                return;
            }
            
            // Open preview in new window/tab
            const previewWindow = window.open('', '_blank', 'width=900,height=800,scrollbars=yes,resizable=yes');
            
            if (!previewWindow) {
                showCustomAlert('Pop-up blocked! Please allow pop-ups and try again.');
                return;
            }
            
            // Write the invoice HTML to the new window
            previewWindow.document.write(`
                <!DOCTYPE html>
                <html>
                <head>
                    <meta charset="UTF-8">
                    <title>Invoice Preview - ${currentProject.name} - ${section.name}</title>
                    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
                    <style>
                        :root {
                            --primary-brand: #D8A7A7;
                            --secondary-brand: #B4969A;
                        }
                        
                        body {
                            font-family: 'Inter', Arial, sans-serif;
                            margin: 0;
                            padding: 20px;
                            background: #f9f9f9;
                            color: #333;
                        }
                        
                        .container {
                            max-width: 800px;
                            margin: 0 auto;
                            background: white;
                            padding: 40px;
                            border-radius: 12px;
                            box-shadow: 0 4px 20px rgba(0,0,0,0.1);
                        }
                        
                        .header-section {
                            background: linear-gradient(135deg, var(--primary-brand), var(--secondary-brand));
                            padding: 15px 20px;
                            margin: -20px -20px 20px -20px;
                            display: flex;
                            justify-content: center;
                            align-items: center;
                            color: white;
                            font-size: 24px;
                            font-weight: 600;
                        }
                        
                        .print-btn {
                            background: var(--primary-brand);
                            color: white;
                            border: none;
                            padding: 12px 24px;
                            border-radius: 8px;
                            font-size: 16px;
                            font-weight: 500;
                            cursor: pointer;
                            margin: 20px 0;
                            transition: all 0.2s ease;
                        }
                        
                        .print-btn:hover {
                            transform: translateY(-1px);
                            box-shadow: 0 4px 12px rgba(0,0,0,0.15);
                        }
                        
                        @media print {
                            .print-btn { display: none; }
                            body { background: white; }
                            .container { box-shadow: none; padding: 20px; }
                        }
                        
                        @page {
                            margin: 0.5in;
                        }
                    </style>
                </head>
                <body>
                    <div class="container">
                        <button class="print-btn" onclick="window.print()"> Print Invoice</button>
                        ${invoiceHTML}
                    </div>
                </body>
                </html>
            `);
            
            previewWindow.document.close();
            previewWindow.focus();
        }

        function toggleInvoiceItem(itemId) {
            const itemElement = document.getElementById(`invoice-item-${itemId}`);
            const checkElement = document.getElementById(`check-${itemId}`);
            
            if (selectedInvoiceItems.has(itemId)) {
                // Deselect
                selectedInvoiceItems.delete(itemId);
                itemElement.style.background = 'var(--card-bg)';
                itemElement.style.borderColor = 'var(--section-bg)';
                checkElement.textContent = '';
            } else {
                // Select
                selectedInvoiceItems.add(itemId);
                itemElement.style.background = 'var(--success-light, rgba(40, 167, 69, 0.1))';
                itemElement.style.borderColor = 'var(--success)';
                checkElement.textContent = '';
            }
            
            updateInvoiceSelection();
        }

        function selectAllInvoiceItems(selectAll) {
            const items = window.currentInvoiceItems;
            const sectionIndex = window.currentInvoiceSection;
            
            items.forEach((item, itemIndex) => {
                const itemId = `${sectionIndex}-${itemIndex}`;
                const itemElement = document.getElementById(`invoice-item-${itemId}`);
                const checkElement = document.getElementById(`check-${itemId}`);
                
                if (selectAll) {
                    selectedInvoiceItems.add(itemId);
                    itemElement.style.background = 'var(--success-light, rgba(40, 167, 69, 0.1))';
                    itemElement.style.borderColor = 'var(--success)';
                    checkElement.textContent = '';
                } else {
                    selectedInvoiceItems.delete(itemId);
                    itemElement.style.background = 'var(--card-bg)';
                    itemElement.style.borderColor = 'var(--section-bg)';
                    checkElement.textContent = '';
                }
            });
            
            updateInvoiceSelection();
        }

        function updateInvoiceSelection() {
            const selectedCount = selectedInvoiceItems.size;
            const items = window.currentInvoiceItems;
            const sectionIndex = window.currentInvoiceSection;
            
            // Calculate total
            let total = 0;
            items.forEach((item, itemIndex) => {
                const itemId = `${sectionIndex}-${itemIndex}`;
                if (selectedInvoiceItems.has(itemId)) {
                    const customerPrice = item.customerPrice || item.price || 0;
                    const quantity = item.qty || 1;
                    const unitTotal = customerPrice * quantity;
                    total += unitTotal + (item.shipping || 0) + (item.tax || 0);
                }
            });
            
            // Update displays
            document.getElementById('selectedCount').textContent = selectedCount;
            document.getElementById('selectedTotal').textContent = `$${total.toLocaleString('en-US', { minimumFractionDigits: 2, maximumFractionDigits: 2 })}`;
            
            // Enable/disable generate button
            const generateBtn = document.getElementById('generateInvoiceBtn');
            generateBtn.disabled = selectedCount === 0;
            generateBtn.style.opacity = selectedCount === 0 ? '0.5' : '1';
        }

        function closeInvoiceReview() {
            const modal = document.getElementById('invoiceReviewModal');
            if (modal) {
                modal.remove();
            }
            
            selectedInvoiceItems.clear();
        }

        function generateConfirmedInvoice(sectionIndex) {
            if (selectedInvoiceItems.size === 0) {
                showCustomAlert('Please select at least one item to include in the invoice.');
                return;
            }
            
            // Save selected items before closing modal
            const selectedItems = Array.from(selectedInvoiceItems);
            
            // Close the review modal
            closeInvoiceReview();
            
            // Generate invoice with only selected items
            previewSectionInvoice(sectionIndex, selectedItems);
        }

        function previewSectionInvoice(sectionIndex, selectedItemIds = null) {
            console.log('=== previewSectionInvoice called ===');
            console.log('sectionIndex:', sectionIndex);
            console.log('selectedItemIds:', selectedItemIds);
            console.log('currentProject:', currentProject);
            
            if (!currentProject || !currentProject.sections || !currentProject.sections[sectionIndex]) {
                console.error('Section validation failed:', {
                    currentProject: !!currentProject,
                    sections: currentProject?.sections,
                    sectionExists: currentProject?.sections?.[sectionIndex]
                });
                showCustomAlert('Error: Section not found. Please refresh and try again.');
                return;
            }
            
            const section = currentProject.sections[sectionIndex];
            console.log('section:', section);
            
            // Check if there are any ready-to-order items
            console.log('About to call generateCleanInvoiceHTML...');
            const invoiceHTML = generateCleanInvoiceHTML(sectionIndex, selectedItemIds);
            console.log('generateCleanInvoiceHTML returned:', !!invoiceHTML);
            
            if (!invoiceHTML) {
                console.error('No invoice HTML generated');
                showCustomAlert('No items selected for the invoice.');
                return;
            }
            
            // Open preview in new window/tab
            const previewWindow = window.open('', '_blank', 'width=900,height=800,scrollbars=yes,resizable=yes');
            
            if (!previewWindow) {
                showCustomAlert('Pop-up blocked! Please allow pop-ups and try again.');
                return;
            }
            
            // Write the invoice HTML to the new window
            previewWindow.document.write(`
                <!DOCTYPE html>
                <html>
                <head>
                    <meta charset="UTF-8">
                    <title>Invoice Preview - ${currentProject.name} - ${section.name}</title>
                    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
                    <style>
                        :root {
                            --primary-brand: #D8A7A7;
                            --secondary-brand: #B4969A;
                        }
                        
                        body {
                            font-family: 'Inter', Arial, sans-serif;
                            margin: 0;
                            padding: 20px;
                            background: #f9f9f9;
                            color: #333;
                        }
                        
                        .container {
                            max-width: 800px;
                            margin: 0 auto;
                            background: white;
                            padding: 40px;
                            border-radius: 12px;
                            box-shadow: 0 4px 20px rgba(0,0,0,0.1);
                        }
                        
                        .header-section {
                            background: linear-gradient(135deg, var(--primary-brand), var(--secondary-brand));
                            padding: 15px 20px;
                            margin: -20px -20px 20px -20px;
                            display: flex;
                            justify-content: center;
                            gap: 15px;
                            border-radius: 8px 8px 0 0;
                        }
                        
                        .no-print {
                            background: rgba(255,255,255,0.2);
                            color: white;
                            border: 2px solid rgba(255,255,255,0.3);
                            padding: 8px 16px;
                            border-radius: 6px;
                            font-size: 14px;
                            font-weight: 600;
                            cursor: pointer;
                            transition: all 0.3s ease;
                            text-shadow: 0 1px 2px rgba(0,0,0,0.2);
                        }
                        
                        .no-print:hover {
                            background: rgba(255,255,255,0.3);
                            border-color: rgba(255,255,255,0.5);
                            transform: translateY(-1px);
                        }
                        
                        @media print {
                            @page {
                                margin: 0.5in;
                                size: letter;
                            }
                            body { 
                                background: white; 
                                padding: 0; 
                                margin: 0;
                                -webkit-print-color-adjust: exact;
                                print-color-adjust: exact;
                            }
                            .container { 
                                box-shadow: none; 
                                padding: 20px; 
                                margin: 0; 
                                page-break-inside: avoid;
                            }
                            .no-print { display: none; }
                        }
                    </style>
                </head>
                <body>
                    <div class="header-section">
                        <button class="no-print" onclick="window.print()"> Print Invoice</button>
                        <button class="no-print" onclick="window.close()"> Close Preview</button>
                    </div>
                    
                    <div class="container">
                        ${invoiceHTML}
                    </div>
                </body>
                </html>
            `);
            
            previewWindow.document.close();
            previewWindow.focus();
        }

        function generateAndDownloadSectionInvoice(sectionIndex) {
            if (!currentProject || !currentProject.sections || !currentProject.sections[sectionIndex]) {
                showCustomAlert('Error: Section not found. Please refresh and try again.');
                return;
            }
            
            const section = currentProject.sections[sectionIndex];
            
            // Show loading message with better styling
            const loadingAlert = document.createElement('div');
            loadingAlert.id = 'pdf-loading';
            loadingAlert.style.cssText = `
                position: fixed;
                top: 20px;
                right: 20px;
                background: linear-gradient(135deg, var(--secondary-brand), var(--primary-brand));
                color: white;
                padding: 16px 24px;
                border-radius: 8px;
                box-shadow: 0 4px 20px rgba(0,0,0,0.15);
                z-index: 10000;
                font-weight: 500;
                display: flex;
                align-items: center;
                gap: 10px;
            `;
            loadingAlert.innerHTML = `
                <div style="width: 20px; height: 20px; border: 2px solid rgba(255,255,255,0.3); border-top: 2px solid white; border-radius: 50%; animation: spin 1s linear infinite;"></div>
                Generating PDF... Please wait
            `;
            
            // Add spinner animation
            if (!document.getElementById('spinner-style')) {
                const style = document.createElement('style');
                style.id = 'spinner-style';
                style.textContent = `
                    @keyframes spin {
                        0% { transform: rotate(0deg); }
                        100% { transform: rotate(360deg); }
                    }
                `;
                document.head.appendChild(style);
            }
            
            document.body.appendChild(loadingAlert);
            
            // Generate invoice HTML
            const invoiceHTML = generateCleanInvoiceHTML(sectionIndex);
            
            // Check if there are any ready-to-order items
            if (!invoiceHTML) {
                const loading = document.getElementById('pdf-loading');
                if (loading) document.body.removeChild(loading);
                showCustomAlert('No ready-to-order items found in this section. Please mark items as ready to order first.');
                return;
            }
            
            // Create a temporary element with the invoice HTML
            const tempElement = document.createElement('div');
            tempElement.innerHTML = invoiceHTML;
            tempElement.style.position = 'absolute';
            tempElement.style.left = '-9999px';
            tempElement.style.top = '-9999px';
            document.body.appendChild(tempElement);
            
            // Configure PDF options
            const filename = `Invoice-${currentProject.name.replace(/[^a-z0-9]/gi, '-')}-${section.name.replace(/[^a-z0-9]/gi, '-')}.pdf`;
            const opt = {
                margin: [0.5, 0.5, 0.5, 0.5],
                filename: filename,
                image: { type: 'jpeg', quality: 0.98 },
                html2canvas: { 
                    scale: 2, 
                    useCORS: true,
                    letterRendering: true,
                    logging: false
                },
                jsPDF: { 
                    unit: 'in', 
                    format: 'letter', 
                    orientation: 'portrait',
                    compress: true
                },
                pagebreak: { mode: ['avoid-all', 'css', 'legacy'] }
            };
            
            // Generate and download PDF
            html2pdf()
                .set(opt)
                .from(tempElement)
                .save()
                .then(() => {
                    // Clean up
                    document.body.removeChild(tempElement);
                    const loading = document.getElementById('pdf-loading');
                    if (loading) document.body.removeChild(loading);
                    
                    // Show success message
                    const successAlert = document.createElement('div');
                    successAlert.style.cssText = `
                        position: fixed;
                        top: 20px;
                        right: 20px;
                        background: linear-gradient(135deg, var(--success), var(--highlight));
                        color: white;
                        padding: 16px 24px;
                        border-radius: 8px;
                        box-shadow: 0 4px 20px rgba(0,0,0,0.15);
                        z-index: 10000;
                        font-weight: 500;
                    `;
                    successAlert.innerHTML = ' Invoice PDF downloaded successfully!';
                    document.body.appendChild(successAlert);
                    
                    setTimeout(() => {
                        if (document.body.contains(successAlert)) {
                            document.body.removeChild(successAlert);
                        }
                    }, 4000);
                })
                .catch((error) => {
                    console.error('PDF generation failed:', error);
                    document.body.removeChild(tempElement);
                    const loading = document.getElementById('pdf-loading');
                    if (loading) document.body.removeChild(loading);
                    
                    // Show error message
                    const errorAlert = document.createElement('div');
                    errorAlert.style.cssText = `
                        position: fixed;
                        top: 20px;
                        right: 20px;
                        background: linear-gradient(135deg, var(--error), #E2A39D);
                        color: white;
                        padding: 16px 24px;
                        border-radius: 8px;
                        box-shadow: 0 4px 20px rgba(0,0,0,0.15);
                        z-index: 10000;
                        font-weight: 500;
                    `;
                    errorAlert.innerHTML = ' Error generating PDF. Please try again or use the preview option.';
                    document.body.appendChild(errorAlert);
                    
                    setTimeout(() => {
                        if (document.body.contains(errorAlert)) {
                            document.body.removeChild(errorAlert);
                        }
                    }, 5000);
                });
        }
        
        function generateCleanInvoiceHTML(sectionIndex, selectedItemIds = null) {
            console.log('=== generateCleanInvoiceHTML called ===');
            console.log('sectionIndex:', sectionIndex);
            console.log('selectedItemIds:', selectedItemIds);
            
            const section = currentProject.sections[sectionIndex];
            console.log('section:', section);
            console.log('section.items:', section.items);
            
            let sectionTotal = 0;
            let invoiceItems = [];
            
            // Generate items for this section only
            section.items.forEach((item, itemIndex) => {
                console.log(`Processing item ${itemIndex}:`, item);
                
                // Skip items that are not ready to order or are deactivated
                if (!item.readyToOrder || item.isGrayedOut) {
                    console.log(`Skipping item ${itemIndex}: readyToOrder=${item.readyToOrder}, isGrayedOut=${item.isGrayedOut}`);
                    return;
                }
                
                // If we have selected items, only include those
                if (selectedItemIds) {
                    const itemId = `${sectionIndex}-${itemIndex}`;
                    console.log(`Checking if itemId ${itemId} is in selectedItemIds:`, selectedItemIds.includes(itemId));
                    if (!selectedItemIds.includes(itemId)) {
                        console.log(`Skipping item ${itemIndex}: not in selected items`);
                        return;
                    }
                }
                
                const customerUnitPrice = item.customerPrice || item.price || 0;
                const quantity = item.qty || 1;
                const unitTotal = customerUnitPrice * quantity;
                const totalWithShippingTax = unitTotal + (item.shipping || 0) + (item.tax || 0);
                
                console.log(`Including item ${itemIndex}:`, {
                    customerUnitPrice,
                    quantity,
                    unitTotal,
                    totalWithShippingTax
                });
                
                invoiceItems.push({
                    description: item.name || item.item || item.itemName || 'Unnamed Item',
                    unitPrice: customerUnitPrice,
                    qty: quantity,
                    unitTotal: unitTotal,
                    total: totalWithShippingTax
                });
                sectionTotal += totalWithShippingTax;
            });
            
            console.log('Final invoiceItems:', invoiceItems);
            console.log('Final sectionTotal:', sectionTotal);
            
            // If no items to include, return null to indicate no invoice should be generated
            if (invoiceItems.length === 0) {
                console.log('No items to include, returning null');
                return null;
            }
            
            return `
                <div style="font-family: 'Inter', Arial, sans-serif; max-width: 800px; margin: 0 auto; padding: 20px; background: white; color: #333;">
                    <!-- Header -->
                    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; border-bottom: 2px solid #D8A7A7; padding-bottom: 12px;">
                        <div style="display: flex; align-items: center; gap: 15px;">
                            <div style="width: 45px; height: 45px; background: #F2EFEB; border-radius: 6px; display: flex; align-items: center; justify-content: center;">
                                <svg viewBox="0 0 400 300" xmlns="http://www.w3.org/2000/svg" style="width: 30px; height: 30px;">
                                    <g stroke="#333" stroke-width="6" fill="none">
                                        <path d="M50 250 L50 150 L120 100 L190 150 L190 250 Z"/>
                                        <path d="M210 250 L210 170 L280 120 L350 170 L350 250 Z"/>
                                        <path d="M30 150 L120 90 L210 150"/>
                                        <path d="M190 170 L280 110 L370 170"/>
                                        <line x1="80" y1="130" x2="80" y2="250"/>
                                        <line x1="160" y1="130" x2="160" y2="250"/>
                                        <line x1="240" y1="150" x2="240" y2="250"/>
                                        <line x1="320" y1="150" x2="320" y2="250"/>
                                        <line x1="30" y1="250" x2="370" y2="250"/>
                                    </g>
                                </svg>
                            </div>
                            <div>
                                <h1 style="margin: 0; font-size: 22px; font-weight: 600; color: #333; letter-spacing: 1px;">KELLY RAM DESIGNS</h1>
                                <p style="margin: 2px 0 0 0; color: #666; font-size: 13px; font-weight: 400;">INTERIOR DESIGN</p>
                            </div>
                        </div>
                        <div style="text-align: right;">
                            <h2 style="margin: 0; font-size: 32px; font-weight: 300; color: #333; letter-spacing: 3px;">INVOICE</h2>
                        </div>
                    </div>
                    
                    <!-- Client and Invoice Info -->
                    <div style="display: flex; justify-content: space-between; margin-bottom: 20px;">
                        <div style="width: 45%;">
                            <div style="margin-bottom: 15px;">
                                <h3 style="margin: 0 0 5px 0; font-size: 14px; font-weight: 600; color: #333;">ISSUED TO:</h3>
                                <div style="font-size: 13px; line-height: 1.3; color: #333;">
                                    <strong>${currentProject.client}</strong><br>
                                    ${currentProject.clientEmail ? currentProject.clientEmail + '<br>' : ''}
                                    ${currentProject.clientPhone ? currentProject.clientPhone + '<br>' : ''}
                                    ${currentProject.clientAddress ? currentProject.clientAddress.replace(/\n/g, '<br>') : ''}
                                </div>
                            </div>
                            <div>
                                <h3 style="margin: 0 0 5px 0; font-size: 14px; font-weight: 600; color: #333;">PAY TO:</h3>
                                <div style="font-size: 13px; color: #333;">
                                    <strong>Kelly Ram Designs</strong><br>
                                    kellyramdesigns@gmail.com
                                </div>
                            </div>
                        </div>
                        <div style="width: 45%; text-align: right;">
                                <div style="font-size: 13px; line-height: 1.5;">
                                <div><strong>PROJECT:</strong> ${section.name}</div>
                                <div><strong>INVOICE NO:</strong> ${currentProject.invoiceNumber || 'TBD'}-${sectionIndex + 1}</div>
                                <div><strong>DATE:</strong> ${new Date().toLocaleDateString('en-US', { month: '2-digit', day: '2-digit', year: 'numeric' }).replace(/\//g, '.')}</div>
                            </div>
                        </div>
                    </div>

                    <!-- Items Table -->
                    <table style="width: 100%; border-collapse: collapse; margin: 15px 0;">
                        <thead>
                            <tr style="background: #D3DCE6;">
                                <th style="padding: 8px 10px; text-align: left; font-weight: 600; font-size: 12px; color: #333; border-bottom: 2px solid #9CAEC2;">DESCRIPTION</th>
                                <th style="padding: 8px 10px; text-align: right; font-weight: 600; font-size: 12px; color: #333; border-bottom: 2px solid #9CAEC2;">UNIT PRICE</th>
                                <th style="padding: 8px 10px; text-align: center; font-weight: 600; font-size: 12px; color: #333; border-bottom: 2px solid #9CAEC2;">QTY</th>
                                <th style="padding: 8px 10px; text-align: right; font-weight: 600; font-size: 12px; color: #333; border-bottom: 2px solid #9CAEC2;">SUBTOTAL</th>
                                <th style="padding: 8px 10px; text-align: right; font-weight: 600; font-size: 12px; color: #333; border-bottom: 2px solid #9CAEC2;">TOTAL</th>
                            </tr>
                        </thead>
                        <tbody>
                            ${invoiceItems.map((item, index) => `
                                <tr style="border-bottom: 1px solid #EDEAE6;">
                                    <td style="padding: 8px 10px; font-size: 12px; color: #333;">${item.description}</td>
                                    <td style="padding: 8px 10px; text-align: right; font-size: 12px; color: #333;">$${item.unitPrice.toLocaleString('en-US', { minimumFractionDigits: 2, maximumFractionDigits: 2 })}</td>
                                    <td style="padding: 8px 10px; text-align: center; font-size: 12px; color: #333;">${item.qty}</td>
                                    <td style="padding: 8px 10px; text-align: right; font-size: 12px; color: #333;">$${item.unitTotal.toLocaleString('en-US', { minimumFractionDigits: 2, maximumFractionDigits: 2 })}</td>
                                    <td style="padding: 8px 10px; text-align: right; font-size: 12px; font-weight: 600; color: #333;">$${item.total.toLocaleString('en-US', { minimumFractionDigits: 2, maximumFractionDigits: 2 })}</td>
                                </tr>
                            `).join('')}
                        </tbody>
                    </table>
                    
                    <!-- Tax/Shipping Note -->
                    <div style="text-align: right; margin: 10px 0; padding: 8px 12px; background: #EDEAE6; border-radius: 4px; border-left: 3px solid #9CAEC2;">
                        <p style="margin: 0; font-size: 11px; color: #666; font-style: italic;">
                            * Total prices include applicable shipping and tax charges
                        </p>
                    </div>

                    <!-- Total Section -->
                    <div style="text-align: right; margin: 15px 0; padding: 15px; background: #F0E5D8; border-radius: 6px; border-top: 2px solid #D8A7A7;">
                        <div style="font-size: 18px; font-weight: 700; color: #333;">
                            SECTION TOTAL: $${sectionTotal.toLocaleString('en-US', { minimumFractionDigits: 2, maximumFractionDigits: 2 })}
                        </div>
                    </div>

                    <!-- Payment Info -->
                    <div style="margin-top: 15px; padding-top: 15px; border-top: 1px solid #EDEAE6; font-size: 12px; color: #666; line-height: 1.4;">
                        <p style="margin: 0 0 6px 0;"><strong>Payment Options:</strong></p>
                        <p style="margin: 0 0 4px 0;"> Zelle: kellyramdesigns@gmail.com</p>
                        <p style="margin: 0 0 10px 0;"> Check payable to: Kelly Ram Designs</p>
                        
                        <p style="margin: 0 0 4px 0; font-size: 11px;"><strong>Please note:</strong> Most products are final sale and cannot be returned</p>
                        <p style="margin: 0; font-size: 11px;">*All prices are subject to change</p>
                    </div>
                </div>
            `;
        }

        function generateInvoiceHTML(sectionIndex) {
            const section = currentProject.sections[sectionIndex];
            let sectionTotal = 0;
            let invoiceItems = [];
            
            // Skip if section is deactivated
            if (section.isGrayedOut) {
                return null;
            }
            
            // Generate items for this section only - but only ready-to-order items
            section.items.forEach(item => {
                // Skip items that are not ready to order or are deactivated
                if (!item.readyToOrder || item.isGrayedOut) return;
                
                const customerUnitPrice = item.customerPrice || item.price || 0;
                const quantity = item.qty || 1;
                const unitTotal = customerUnitPrice * quantity;
                const totalWithShippingTax = unitTotal + (item.shipping || 0) + (item.tax || 0);
                
                invoiceItems.push({
                    description: item.name || item.item || item.itemName || 'Unnamed Item',
                    unitPrice: customerUnitPrice,
                    qty: quantity,
                    unitTotal: unitTotal,
                    total: totalWithShippingTax
                });
                sectionTotal += totalWithShippingTax;
            });
            
            // Get uploaded logo or use default house icon
            const companyLogo = localStorage.getItem('companyLogo');
            const logoSection = companyLogo ? 
                `<img src="${companyLogo}" style="width: 60px; height: 60px; border-radius: 8px; object-fit: contain;">` :
                `<div style="width: 60px; height: 60px; background: #F2EFEB; border-radius: 8px; display: flex; align-items: center; justify-content: center; box-shadow: 0 2px 8px rgba(51,51,51,0.1);">
                    <svg viewBox="0 0 400 300" xmlns="http://www.w3.org/2000/svg" style="width: 40px; height: 40px;">
                        <g stroke="#333" stroke-width="6" fill="none">
                            <path d="M50 250 L50 150 L120 100 L190 150 L190 250 Z"/>
                            <path d="M210 250 L210 170 L280 120 L350 170 L350 250 Z"/>
                            <path d="M30 150 L120 90 L210 150"/>
                            <path d="M190 170 L280 110 L370 170"/>
                            <line x1="80" y1="130" x2="80" y2="250"/>
                            <line x1="160" y1="130" x2="160" y2="250"/>
                            <line x1="240" y1="150" x2="240" y2="250"/>
                            <line x1="320" y1="150" x2="320" y2="250"/>
                            <line x1="30" y1="250" x2="370" y2="250"/>
                        </g>
                    </svg>
                </div>`;
            
            return `<!DOCTYPE html>
            <html>
            <head>
                <meta charset="UTF-8">
                <title>Invoice - ${currentProject.name} - ${section.name}</title>
                <style>
                    @import url('https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap');
                    
                    body {
                        font-family: 'Inter', -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
                        margin: 0;
                        padding: 30px;
                        background: white;
                        color: #333;
                        line-height: 1.6;
                    }
                    
                    .invoice-container {
                        max-width: 800px;
                        margin: 0 auto;
                    }
                    
                    table {
                        width: 100%;
                        border-collapse: collapse;
                        margin: 20px 0;
                    }
                    
                    th, td {
                        padding: 15px;
                        text-align: left;
                        border-bottom: 1px solid #EDEAE6;
                    }
                    
                    th {
                        background: #D3DCE6;
                        color: #333;
                        font-weight: 600;
                    }
                    
                    @media print {
                        body { margin: 0; padding: 20px; }
                        .no-print { display: none; }
                    }
                </style>
            </head>
            <body>
                <div class="invoice-container">
                    <div style="display: flex; align-items: center; justify-content: space-between; margin-bottom: 30px; border-bottom: 2px solid #D8A7A7; padding-bottom: 20px;">
                        <div style="display: flex; align-items: center; gap: 20px;">
                            ${logoSection}
                            <div>
                                <h2 style="margin: 0; color: #333;">KELLY RAM DESIGNS</h2>
                                <p style="margin: 5px 0; color: #666;">INTERIOR DESIGN</p>
                            </div>
                        </div>
                        <div style="font-size: 36px; font-weight: 200; color: #333; letter-spacing: 3px;">INVOICE</div>
                    </div>
                    
                    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 40px; margin-bottom: 30px;">
                        <div>
                            <div style="margin-bottom: 20px;">
                                <strong>ISSUED TO:</strong><br>
                                ${currentProject.client}<br>
                                ${currentProject.clientEmail ? currentProject.clientEmail + '<br>' : ''}
                                ${currentProject.clientPhone ? currentProject.clientPhone + '<br>' : ''}
                                ${currentProject.clientAddress ? currentProject.clientAddress.replace(/\n/g, '<br>') : ''}
                            </div>
                            <div>
                                <strong>PAY TO:</strong><br>
                                Kelly Ram Designs
                            </div>
                        </div>
                        <div style="text-align: right;">
                            <div style="margin-bottom: 10px;">
                                <strong>PROJECT:</strong> ${currentProject.name}
                            </div>
                            <div style="margin-bottom: 10px;">
                                <strong>SECTION:</strong> ${section.name}
                            </div>
                            <div style="margin-bottom: 10px;">
                                <strong>INVOICE NO:</strong> ${currentProject.invoiceNumber || 'TBD'}-${sectionIndex + 1}
                            </div>
                            <div>
                                <strong>DATE:</strong> ${new Date().toLocaleDateString('en-US', { month: '2-digit', day: '2-digit', year: 'numeric' }).replace(/\//g, '.')}
                            </div>
                        </div>
                    </div>

                    <table>
                        <thead>
                            <tr>
                                <th>DESCRIPTION</th>
                                <th>UNIT PRICE</th>
                                <th>QTY</th>
                                <th>SUBTOTAL</th>
                                <th>TOTAL</th>
                            </tr>
                        </thead>
                        <tbody>
                            ${invoiceItems.map(item => `
                                <tr>
                                    <td>${item.description}</td>
                                    <td>$${item.unitPrice.toLocaleString('en-US', { minimumFractionDigits: 2, maximumFractionDigits: 2 })}</td>
                                    <td>${item.qty}</td>
                                    <td>$${item.unitTotal.toLocaleString('en-US', { minimumFractionDigits: 2, maximumFractionDigits: 2 })}</td>
                                    <td>$${item.total.toLocaleString('en-US', { minimumFractionDigits: 2, maximumFractionDigits: 2 })}</td>
                                </tr>
                            `).join('')}
                        </tbody>
                    </table>
                    
                    <div style="text-align: right; margin-top: 10px; margin-bottom: 20px; padding: 10px 15px; background: #EDEAE6; border-radius: 8px; border-left: 4px solid #9CAEC2;">
                        <p style="margin: 0; font-size: 13px; color: #666; font-style: italic;">
                            * Total prices include applicable shipping and tax charges
                        </p>
                    </div>

                    <div style="text-align: right; margin-top: 30px; padding: 25px; background: #F0E5D8; border-radius: 12px;">
                        <div style="font-weight: 600; font-size: 24px; color: #333; padding-top: 15px; border-top: 2px solid #D8A7A7;">
                            <strong>SECTION TOTAL: $${sectionTotal.toLocaleString('en-US', { minimumFractionDigits: 2, maximumFractionDigits: 2 })}</strong>
                        </div>
                    </div>

                    <div style="margin-top: 40px; padding-top: 20px; border-top: 1px solid #EDEAE6; color: #666; font-size: 14px;">
                        <p>Payment can be sent via Zelle to kellyramdesigns@gmail.com or check to Kelly Ram Designs</p>
                        <p style="margin-top: 20px;">Please note: Most products are final sale and cannot be returned</p>
                        <p>*All prices are subject to change</p>
                    </div>
                </div>
            </body>
            </html>`;
        }

        // Global variables for invoice confirmation
        let confirmationSectionIndex = null;
        let confirmationItems = [];

        function showInvoiceConfirmation(sectionIndex) {
            if (!currentProject || !currentProject.sections || !currentProject.sections[sectionIndex]) {
                showCustomAlert('Error: Section not found. Please refresh and try again.');
                return;
            }

            confirmationSectionIndex = sectionIndex;
            const section = currentProject.sections[sectionIndex];
            confirmationItems = [];

            // Collect all ready-to-order items for confirmation
            section.items.forEach((item, itemIndex) => {
                if (!item.readyToOrder || item.isGrayedOut) return;
                
                confirmationItems.push({
                    originalIndex: itemIndex,
                    id: `${sectionIndex}-${itemIndex}`,
                    name: item.name || item.item || item.itemName || 'Unnamed Item',
                    price: item.customerPrice || item.price || 0,
                    qty: item.qty || 1,
                    shipping: item.shipping || 0,
                    tax: item.tax || 0,
                    confirmed: false,
                    fieldsConfirmed: {
                        name: false,
                        price: false,
                        qty: false,
                        shipping: false,
                        tax: false
                    }
                });
            });

            if (confirmationItems.length === 0) {
                showCustomAlert('No ready-to-order items found in this section. Please mark items as ready to order first.');
                return;
            }

            // Show the confirmation modal
            renderConfirmationTable();
            document.getElementById('invoiceConfirmModal').style.display = 'block';
        }

        function renderConfirmationTable() {
            const tableContainer = document.getElementById('invoiceConfirmationTable');
            
            let tableHTML = `
                <div class="invoice-review-container">
                    <div class="invoice-review-header">
                        <div class="review-controls">
                            <div class="controls-left">
                                <button class="select-all-btn" id="selectAllBtn" onclick="toggleSelectAll()">
                                    <span>Select All Items</span>
                                </button>
                                <button class="add-item-btn" onclick="addNewItem()">
                                    <span>+</span>
                                    <span>Add Item</span>
                                </button>
                            </div>
                            <div class="item-counter">
                                <span id="confirmedItemsCount">0</span> of <span id="totalItemsCount">0</span> confirmed
                            </div>
                        </div>
                        <div class="table-headers">
                            <div class="header-cell header-select">Select</div>
                            <div class="header-cell header-name">Item Name</div>
                            <div class="header-cell header-price">Price</div>
                            <div class="header-cell header-qty">Qty</div>
                            <div class="header-cell header-shipping">Shipping</div>
                            <div class="header-cell header-tax">Tax</div>
                            <div class="header-cell header-total">Total</div>
                        </div>
                    </div>
                    <div class="invoice-review-body">
                        <table class="invoice-table">
            `;

            confirmationItems.forEach((item, index) => {
                const total = (item.price * item.qty) + item.shipping + item.tax;
                const hasIssues = getItemIssues(item);

                tableHTML += `
                    <tr class="item-row ${item.isNewItem ? 'new-item' : ''}">
                        <td class="cell-select">
                            <input type="checkbox" class="item-checkbox" 
                                   ${item.confirmed ? 'checked' : ''} 
                                   ${hasIssues.length > 0 ? 'disabled' : ''}
                                   onchange="toggleItemConfirmation(${index})"
                                   title="${hasIssues.length > 0 ? 'Fix issues before confirming: ' + hasIssues.join(', ') : 'Confirm this item'}">
                        </td>
                        <td class="cell-name">
                            <div class="name-container">
                                <input type="text" class="field-input ${getFieldClass(item, 'name')}" 
                                       value="${escapeHtml(item.name)}" 
                                       onchange="updateItemField(${index}, 'name', this.value)"
                                       placeholder="Item name required">
                                ${item.isNewItem ? '<div class="new-badge">New</div>' : ''}
                            </div>
                        </td>
                        <td class="cell-price">
                            <input type="number" class="field-input ${getFieldClass(item, 'price')}" 
                                   value="${item.price}" 
                                   min="0" step="0.01"
                                   onchange="updateItemField(${index}, 'price', parseFloat(this.value) || 0)"
                                   placeholder="0.00">
                        </td>
                        <td class="cell-qty">
                            <input type="number" class="field-input ${getFieldClass(item, 'qty')}" 
                                   value="${item.qty}" 
                                   min="1" step="1"
                                   onchange="updateItemField(${index}, 'qty', parseInt(this.value) || 1)"
                                   placeholder="1">
                        </td>
                        <td class="cell-shipping">
                            <input type="number" class="field-input ${getFieldClass(item, 'shipping')}" 
                                   value="${item.shipping}" 
                                   min="0" step="0.01"
                                   onchange="updateItemField(${index}, 'shipping', parseFloat(this.value) || 0)"
                                   placeholder="0.00">
                        </td>
                        <td class="cell-tax">
                            <input type="number" class="field-input ${getFieldClass(item, 'tax')}" 
                                   value="${item.tax}" 
                                   min="0" step="0.01"
                                   onchange="updateItemField(${index}, 'tax', parseFloat(this.value) || 0)"
                                   placeholder="0.00">
                        </td>
                        <td class="cell-total">
                            $${total.toLocaleString('en-US', { minimumFractionDigits: 2, maximumFractionDigits: 2 })}
                        </td>
                    </tr>
                `;
            });

            tableHTML += `
                        </table>
                    </div>
                </div>
            `;

            tableContainer.innerHTML = tableHTML;
            updateConfirmationCounts();
        }

        function getItemIssues(item) {
            const issues = [];
            if (!item.name || item.name.trim() === '' || item.name === 'Unnamed Item') {
                issues.push('Missing item name');
            }
            if (item.price <= 0) {
                issues.push('Price must be greater than 0');
            }
            if (item.qty <= 0) {
                issues.push('Quantity must be greater than 0');
            }
            return issues;
        }

        function getFieldClass(item, fieldName) {
            if (fieldName === 'name' && (!item.name || item.name.trim() === '' || item.name === 'Unnamed Item')) {
                return 'field-error';
            }
            if (fieldName === 'price' && item.price <= 0) {
                return 'field-error';
            }
            if (fieldName === 'qty' && item.qty <= 0) {
                return 'field-error';
            }
            return '';
        }

        function updateItemField(index, field, value) {
            confirmationItems[index][field] = value;
            
            // Recheck item status
            const item = confirmationItems[index];
            const hasIssues = getItemIssues(item);
            
            // If fixing issues, uncheck confirmation so user must re-confirm
            if (item.confirmed && hasIssues.length === 0) {
                // Keep it confirmed if no issues
            } else if (hasIssues.length > 0) {
                item.confirmed = false;
            }
            
            renderConfirmationTable();
        }

        function toggleItemConfirmation(index) {
            const item = confirmationItems[index];
            const hasIssues = getItemIssues(item);
            
            if (hasIssues.length > 0) {
                showCustomAlert(`Please fix the following issues before confirming this item:\n ${hasIssues.join('\n ')}`);
                return;
            }
            
            item.confirmed = !item.confirmed;
            renderConfirmationTable();
        }

        function updateConfirmationCounts() {
            const totalItems = confirmationItems.length;
            const confirmedItems = confirmationItems.filter(item => item.confirmed).length;
            const itemsWithoutIssues = confirmationItems.filter(item => getItemIssues(item).length === 0).length;
            
            // Update top counter
            document.getElementById('totalItemsCount').textContent = totalItems;
            document.getElementById('confirmedItemsCount').textContent = confirmedItems;
            
            // Update bottom counter
            document.getElementById('totalItemsCountBottom').textContent = totalItems;
            document.getElementById('confirmedItemsCountBottom').textContent = confirmedItems;
            
            // Update select all checkbox state
            const selectAllCheckbox = document.getElementById('selectAllItems');
            if (selectAllCheckbox) {
                if (confirmedItems === 0) {
                    selectAllCheckbox.checked = false;
                    selectAllCheckbox.indeterminate = false;
                } else if (confirmedItems === itemsWithoutIssues) {
                    selectAllCheckbox.checked = true;
                    selectAllCheckbox.indeterminate = false;
                } else {
                    selectAllCheckbox.checked = false;
                    selectAllCheckbox.indeterminate = true;
                }
            }
            
            const confirmBtn = document.getElementById('confirmInvoiceBtn');
            confirmBtn.disabled = confirmedItems === 0;
            confirmBtn.style.opacity = confirmedItems === 0 ? '0.5' : '1';
        }

        function toggleSelectAll() {
            const selectAllBtn = document.getElementById('selectAllBtn');
            const isCurrentlyAllSelected = selectAllBtn.classList.contains('active');
            const shouldSelectAll = !isCurrentlyAllSelected;
            
            confirmationItems.forEach((item, index) => {
                const hasIssues = getItemIssues(item);
                // Only toggle items that don't have validation issues
                if (hasIssues.length === 0) {
                    item.confirmed = shouldSelectAll;
                }
            });
            
            // Update button appearance and text
            if (shouldSelectAll) {
                selectAllBtn.classList.add('active');
                selectAllBtn.querySelector('span').textContent = 'Deselect All';
            } else {
                selectAllBtn.classList.remove('active');
                selectAllBtn.querySelector('span').textContent = 'Select All Items';
            }
            
            renderConfirmationTable();
        }

        function addNewItem() {
            // Create a new item with default values
            const newItemId = `new-${Date.now()}-${Math.random().toString(36).substr(2, 9)}`;
            const newItem = {
                originalIndex: -1, // Special flag for new items
                id: newItemId,
                isNewItem: true,
                name: 'New Item',
                price: 0,
                qty: 1,
                shipping: 0,
                tax: 0,
                confirmed: false,
                fieldsConfirmed: {
                    name: false,
                    price: false,
                    qty: false,
                    shipping: false,
                    tax: false
                }
            };
            
            // Add to confirmation items array
            confirmationItems.push(newItem);
            
            // Re-render the table to show the new item
            renderConfirmationTable();
            
            // Auto-focus on the name field of the new item
            setTimeout(() => {
                const newItemRows = document.querySelectorAll('.invoice-confirm-table tbody tr');
                const lastRow = newItemRows[newItemRows.length - 1];
                if (lastRow) {
                    const nameInput = lastRow.querySelector('input[type="text"]');
                    if (nameInput) {
                        nameInput.focus();
                        nameInput.select();
                    }
                }
            }, 100);
        }

        function generateConfirmedInvoice() {
            try {
                console.log('=== Starting generateConfirmedInvoice ===');
                console.log('confirmationItems:', confirmationItems);
                console.log('currentProject:', currentProject);
                console.log('confirmationSectionIndex:', confirmationSectionIndex);
                
                const confirmedItems = confirmationItems.filter(item => item.confirmed);
                console.log('confirmedItems:', confirmedItems);
                
                if (confirmedItems.length === 0) {
                    showCustomAlert('Please confirm at least one item before generating the invoice.');
                    return;
                }

                if (!currentProject || confirmationSectionIndex === null) {
                    showCustomAlert('Error: Project or section data is missing. Please refresh and try again.');
                    return;
                }

                console.log('About to update project data...');

            // Update the original project data with confirmed changes
            confirmedItems.forEach((item, index) => {
                console.log(`Processing item ${index}:`, item);
                
                if (item.isNewItem) {
                    // Handle new items - add them to the project
                    console.log('Adding new item to project:', item);
                    
                    const newProjectItem = {
                        name: item.name,
                        item: item.name, // Backup name field
                        customerPrice: item.price,
                        price: item.price, // Backup price field
                        qty: item.qty,
                        shipping: item.shipping,
                        tax: item.tax,
                        readyToOrder: true, // Auto-mark as ready since it's being invoiced
                        isGrayedOut: false,
                        // Add any other default fields that existing items might have
                        wholesalePrice: 0,
                        orderStatus: 'pending',
                        link: ''
                    };
                    
                    // Add to the current section
                    currentProject.sections[confirmationSectionIndex].items.push(newProjectItem);
                    console.log('New item added to project');
                    
                } else {
                    // Handle existing items - update them
                    const originalItem = currentProject.sections[confirmationSectionIndex].items[item.originalIndex];
                    console.log('originalItem:', originalItem);
                    
                    if (originalItem) {
                        // Update item name (handle different name properties)
                        originalItem.name = item.name;
                        if (!originalItem.name) originalItem.item = item.name;
                        if (!originalItem.name && !originalItem.item) originalItem.itemName = item.name;
                        
                        // Update price fields (maintain both for compatibility)
                        originalItem.customerPrice = item.price;
                        originalItem.price = item.price;
                        
                        // Update other fields
                        originalItem.qty = item.qty;
                        originalItem.shipping = item.shipping;
                        originalItem.tax = item.tax;
                        
                        console.log('Updated originalItem:', originalItem);
                    } else {
                        console.error('originalItem is null/undefined for item:', item);
                    }
                }
            });

            // Save updated project data
            const projectIndex = projects.findIndex(p => p.id === currentProject.id);
            if (projectIndex !== -1) {
                projects[projectIndex] = currentProject;
                saveProjects();
            }

                console.log('About to generate invoice...');
                
                // Generate invoice with confirmed items only BEFORE closing modal
                const confirmedItemIds = confirmedItems.map(item => item.id);
                console.log('confirmedItemIds:', confirmedItemIds);
                console.log('Calling previewSectionInvoice with:', confirmationSectionIndex, confirmedItemIds);
                
                // Store the section index before we lose it
                const sectionIndexForInvoice = confirmationSectionIndex;
                
                // Validate section index before proceeding
                if (sectionIndexForInvoice === null || sectionIndexForInvoice === undefined) {
                    showCustomAlert('Error: Section index is invalid. Please try again.');
                    return;
                }
                
                if (!currentProject.sections[sectionIndexForInvoice]) {
                    showCustomAlert('Error: Section does not exist. Please refresh and try again.');
                    return;
                }
                
                // Close confirmation modal
                closeInvoiceConfirmModal();
                
                console.log('Modal closed, generating invoice...');
                previewSectionInvoice(sectionIndexForInvoice, confirmedItemIds);
                
            } catch (error) {
                console.error('Error generating confirmed invoice:', error);
                console.error('Error stack:', error.stack);
                showCustomAlert('An error occurred while generating the invoice. Please check the console for details and try again.');
            }
        }

        function closeInvoiceConfirmModal() {
            document.getElementById('invoiceConfirmModal').style.display = 'none';
            confirmationSectionIndex = null;
            confirmationItems = [];
        }

        function escapeHtml(text) {
            const div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML;
        }

        function generateProjectInvoice() {
            if (!currentProject) return;
            
            let projectTotal = 0;
            let invoiceItems = [];
            
            if (currentProject.sections) {
                currentProject.sections.forEach(section => {
                    // Skip deactivated sections
                    if (section.isGrayedOut) return;
                    
                    section.items.forEach(item => {
                        // Skip deactivated items
                        if (item.isGrayedOut) return;
                        const customerUnitPrice = item.customerPrice || item.price || 0;
                        const quantity = item.qty || 1;
                        const unitTotal = customerUnitPrice * quantity;
                        const totalWithShippingTax = unitTotal + (item.shipping || 0) + (item.tax || 0);
                        
                        invoiceItems.push({
                            description: `${item.name} (${section.name})`,
                            unitPrice: customerUnitPrice,
                            qty: quantity,
                            unitTotal: unitTotal,
                            total: totalWithShippingTax
                        });
                        projectTotal += totalWithShippingTax;
                    });
                });
            }
            
            const preview = document.getElementById('projectInvoicePreview');
            
            // Get uploaded logo or use default house icon
            const companyLogo = localStorage.getItem('companyLogo');
            const logoSection = companyLogo ? 
                `<img src="${companyLogo}" style="width: 60px; height: 60px; border-radius: 8px; object-fit: contain;">` :
                `<div style="width: 60px; height: 60px; background: var(--card-bg); border-radius: 8px; display: flex; align-items: center; justify-content: center; box-shadow: 0 2px 8px rgba(51,51,51,0.1);">
                    <svg viewBox="0 0 400 300" xmlns="http://www.w3.org/2000/svg" style="width: 40px; height: 40px;">
                        <g stroke="#333" stroke-width="6" fill="none">
                            <path d="M50 250 L50 150 L120 100 L190 150 L190 250 Z"/>
                            <path d="M210 250 L210 170 L280 120 L350 170 L350 250 Z"/>
                            <path d="M30 150 L120 90 L210 150"/>
                            <path d="M190 170 L280 110 L370 170"/>
                            <line x1="80" y1="130" x2="80" y2="250"/>
                            <line x1="160" y1="130" x2="160" y2="250"/>
                            <line x1="240" y1="150" x2="240" y2="250"/>
                            <line x1="320" y1="150" x2="320" y2="250"/>
                            <line x1="30" y1="250" x2="370" y2="250"/>
                        </g>
                    </svg>
                </div>`;
            
            preview.innerHTML = `
                <div style="display: flex; align-items: center; justify-content: space-between; margin-bottom: 30px; border-bottom: 2px solid var(--soft-rose); padding-bottom: 20px;">
                    <div style="display: flex; align-items: center; gap: 20px;">
                        ${logoSection}
                        <div>
                            <h2 style="margin: 0; color: var(--text-primary);">KELLY RAM DESIGNS</h2>
                            <p style="margin: 5px 0; color: var(--text-secondary);">INTERIOR DESIGN</p>
                        </div>
                    </div>
                    <div style="font-size: 36px; font-weight: 200; color: var(--text-primary); letter-spacing: 3px;">INVOICE</div>
                </div>
                
                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 40px; margin-bottom: 30px;">
                    <div>
                        <div style="margin-bottom: 20px;">
                            <strong>ISSUED TO:</strong><br>
                            ${currentProject.client}<br>
                            ${currentProject.clientEmail ? currentProject.clientEmail + '<br>' : ''}
                            ${currentProject.clientPhone ? currentProject.clientPhone + '<br>' : ''}
                            ${currentProject.clientAddress ? currentProject.clientAddress.replace(/\n/g, '<br>') : ''}
                        </div>
                        <div>
                            <strong>PAY TO:</strong><br>
                            Kelly Ram Designs
                        </div>
                    </div>
                    <div style="text-align: right;">
                        <div style="margin-bottom: 10px;">
                            <strong>INVOICE NO:</strong> ${currentProject.invoiceNumber}
                        </div>
                        <div>
                            <strong>DATE:</strong> ${new Date().toLocaleDateString('en-US').replace(/\//g, '.')}
                        </div>
                    </div>
                </div>

                <table style="width: 100%; border-collapse: collapse; margin: 20px 0; border-radius: 12px; overflow: hidden;">
                    <thead>
                        <tr style="background: var(--task-bg);">
                            <th style="padding: 15px; text-align: left; color: var(--text-primary);">DESCRIPTION</th>
                            <th style="padding: 15px; text-align: left; color: var(--text-primary);">UNIT PRICE</th>
                            <th style="padding: 15px; text-align: left; color: var(--text-primary);">QTY</th>
                            <th style="padding: 15px; text-align: left; color: var(--text-primary);">SUBTOTAL</th>
                            <th style="padding: 15px; text-align: left; color: var(--text-primary);">TOTAL</th>
                        </tr>
                    </thead>
                    <tbody>
                        ${invoiceItems.map(item => `
                            <tr>
                                <td style="padding: 15px; border-bottom: 1px solid var(--section-bg);">${item.description}</td>
                                <td style="padding: 15px; border-bottom: 1px solid var(--section-bg);">$${item.unitPrice.toLocaleString('en-US', { minimumFractionDigits: 2, maximumFractionDigits: 2 })}</td>
                                <td style="padding: 15px; border-bottom: 1px solid var(--section-bg);">${item.qty}</td>
                                <td style="padding: 15px; border-bottom: 1px solid var(--section-bg);">$${item.unitTotal.toLocaleString('en-US', { minimumFractionDigits: 2, maximumFractionDigits: 2 })}</td>
                                <td style="padding: 15px; border-bottom: 1px solid var(--section-bg);">$${item.total.toLocaleString('en-US', { minimumFractionDigits: 2, maximumFractionDigits: 2 })}</td>
                            </tr>
                        `).join('')}
                    </tbody>
                </table>
                
                <div style="text-align: right; margin-top: 10px; margin-bottom: 20px; padding: 10px 15px; background: var(--section-bg); border-radius: 8px; border-left: 4px solid var(--info);">
                    <p style="margin: 0; font-size: 13px; color: var(--text-secondary); font-style: italic;">
                        * Total prices include applicable shipping and tax charges
                    </p>
                </div>

                <div style="text-align: right; margin-top: 30px; padding: 25px; background: var(--warm-cream); border-radius: 12px;">
                    <div style="margin: 10px 0; font-size: 16px; color: var(--text-primary);"><strong>PRODUCT TOTAL: $${projectTotal.toLocaleString('en-US', { minimumFractionDigits: 2, maximumFractionDigits: 2 })}</strong></div>
                    <div style="margin: 10px 0; font-size: 16px; color: var(--text-primary);"><strong>AMOUNT PAID: $${(currentProject.amountPaid || 0).toLocaleString('en-US', { minimumFractionDigits: 2, maximumFractionDigits: 2 })}</strong></div>
                    <div style="font-weight: 600; font-size: 24px; color: var(--text-primary); padding-top: 15px; border-top: 2px solid var(--soft-rose);"><strong>TOTAL AMOUNT DUE: $${(projectTotal - (currentProject.amountPaid || 0)).toLocaleString('en-US', { minimumFractionDigits: 2, maximumFractionDigits: 2 })}</strong></div>
                </div>

                <div style="margin-top: 40px; padding-top: 20px; border-top: 1px solid var(--soft-rose);">
                    <p>Payment can be sent via Zelle to kellyramdesigns@gmail.com or check to Kelly Ram Designs</p>
                    <p style="margin-top: 20px; font-size: 14px;">Please note: Most products are final sale and cannot be returned</p>
                    <p style="font-size: 14px;">*All prices are subject to change</p>
                </div>
            `;
        }

        function printInvoice() {
            window.print();
        }

        function saveCurrentProject() {
            if (!currentProject) return;
            
            const index = projects.findIndex(p => p.id === currentProject.id);
            if (index !== -1) {
                projects[index] = currentProject;
                saveProjects();
            }
        }

        // Enhanced event system
        function addEvent() {
            if (!currentProject) return;
              
              const today = new Date();
              const todayStr = `${today.getFullYear()}-${String(today.getMonth() + 1).padStart(2, '0')}-${String(today.getDate()).padStart(2, '0')}`;
            
            showCustomPrompt(
                'Add New Event',
                [
                    { type: 'select', name: 'type', label: 'Event Type', options: [
                        { value: 'consultation', text: 'Consultation' },
                        { value: 'design', text: 'Design' },
                        { value: 'meeting', text: 'Meeting' },
                        { value: 'delivery', text: 'Delivery' }
                    ], defaultValue: 'meeting' },
                    { type: 'text', name: 'title', label: 'Event Title', required: true },
                      { type: 'date', name: 'date', label: 'Date', required: true, defaultValue: todayStr },
                    { type: 'time', name: 'time', label: 'Time' },
                    { type: 'textarea', name: 'notes', label: 'Event Notes' }
                ],
                (data) => {
                    if (!currentProject.events) currentProject.events = [];
                    
                    currentProject.events.push({
                        id: Date.now(),
                        type: data.type,
                        title: data.title,
                        date: data.date,
                        time: data.time || '',
                        notes: data.notes || '',
                        completed: false
                    });
                    
                    saveCurrentProject();
                    updateProjectUpcomingEvents();
                    updateUpcomingEvents();
                    showCustomAlert('Event added successfully! ');
                }
            );
        }

        // Project-specific event management functions
        function addProjectEvent() {
            if (!currentProject) return;
              
              const today = new Date();
              const todayStr = `${today.getFullYear()}-${String(today.getMonth() + 1).padStart(2, '0')}-${String(today.getDate()).padStart(2, '0')}`;
            
            showCustomPrompt(
                'Add New Event',
                [
                    { type: 'select', name: 'type', label: 'Event Type', options: [
                        { value: 'consultation', text: 'Consultation' },
                        { value: 'design', text: 'Design' },
                        { value: 'meeting', text: 'Meeting' },
                        { value: 'delivery', text: 'Delivery' }
                    ], defaultValue: 'meeting', required: true },
                    { type: 'text', name: 'title', label: 'Event Title', required: true },
                      { type: 'date', name: 'date', label: 'Date', required: true, defaultValue: todayStr },
                    { type: 'time', name: 'time', label: 'Time' },
                    { type: 'textarea', name: 'notes', label: 'Notes' }
                ],
                (data) => {
                    if (!currentProject.events) {
                        currentProject.events = [];
                    }
                    
                    currentProject.events.push({
                        id: Date.now() + Math.random(),
                        type: data.type,
                        title: data.title,
                        date: data.date,
                        time: data.time || '',
                        notes: data.notes || '',
                        completed: false
                    });
                    
                    saveCurrentProject();
                    updateProjectUpcomingEvents();
                    updateUpcomingEvents(); // Update main dashboard calendar
                    showCustomAlert('Event added successfully! ');
                }
            );
        }

        function editProjectEvent(eventIndex) {
            if (!currentProject || !currentProject.events || !currentProject.events[eventIndex]) return;
            
            const event = currentProject.events[eventIndex];
            
            showCustomPrompt(
                'Edit Event',
                [
                    { type: 'select', name: 'type', label: 'Event Type', options: [
                        { value: 'consultation', text: 'Consultation' },
                        { value: 'design', text: 'Design' },
                        { value: 'meeting', text: 'Meeting' },
                        { value: 'delivery', text: 'Delivery' }
                    ], defaultValue: event.type || 'meeting', required: true },
                    { type: 'text', name: 'title', label: 'Event Title', defaultValue: event.title, required: true },
                    { type: 'date', name: 'date', label: 'Date', defaultValue: event.date, required: true },
                    { type: 'time', name: 'time', label: 'Time', defaultValue: event.time || '' },
                    { type: 'textarea', name: 'notes', label: 'Notes', defaultValue: event.notes || '' },
                    { type: 'checkbox', name: 'completed', label: 'Mark as completed', defaultValue: event.completed || false }
                ],
                (data) => {
                    currentProject.events[eventIndex] = {
                        ...event,
                        type: data.type,
                        title: data.title,
                        date: data.date,
                        time: data.time || '',
                        notes: data.notes || '',
                        completed: data.completed
                    };
                    
                    saveCurrentProject();
                    updateProjectUpcomingEvents();
                    updateUpcomingEvents(); // Update main dashboard calendar
                    showCustomAlert('Event updated successfully! ');
                }
            );
        }

        function deleteProjectEvent(eventIndex) {
            if (!currentProject || !currentProject.events || !currentProject.events[eventIndex]) return;
            
            const event = currentProject.events[eventIndex];
            
            showCustomPrompt(
                'Delete Event',
                [
                    { type: 'text', name: 'confirmation', label: `Type "delete" to confirm deletion of "${event.title}"\n\nThis action cannot be undone.`, required: true, placeholder: 'Type delete' }
                ],
                (data) => {
                    if (data.confirmation.toLowerCase() !== 'delete') {
                        showCustomAlert('Please type "delete" to confirm. Event deletion cancelled.');
                        return;
                    }
                    
                    currentProject.events.splice(eventIndex, 1);
                    saveCurrentProject();
                    updateProjectUpcomingEvents();
                    updateUpcomingEvents(); // Update main dashboard calendar
                    showCustomAlert(`Event "${event.title}" deleted successfully! `);
                }
            );
        }

        function addQuickEvent() {
              const today = new Date();
              const todayStr = `${today.getFullYear()}-${String(today.getMonth() + 1).padStart(2, '0')}-${String(today.getDate()).padStart(2, '0')}`;
            showCustomPrompt(
                'Quick Add Event',
                [
                    { type: 'select', name: 'projectId', label: 'Project', options: projects.map(p => ({ value: p.id, text: `${p.name} - ${p.client}` })), required: true },
                    { type: 'text', name: 'title', label: 'Event Title', required: true },
                      { type: 'date', name: 'date', label: 'Date', required: true, defaultValue: todayStr },
                    { type: 'time', name: 'time', label: 'Time' }
                ],
                (data) => {
                    const project = projects.find(p => p.id == data.projectId);
                    if (!project) return;
                    
                    if (!project.events) project.events = [];
                    
                    project.events.push({
                        id: Date.now(),
                        type: 'meeting',
                        title: data.title,
                        date: data.date,
                        time: data.time || '',
                        notes: '',
                        completed: false
                    });
                    
                    saveProjects();
                    updateUpcomingEvents();
                    showCustomAlert('Event added successfully! ');
                }
            );
        }

        function addPaidHours() {
            if (!currentProject) return;
            
            showCustomPrompt(
                'Add Paid Hours',
                [
                    { type: 'text', name: 'hours', label: 'Additional Hours', required: true, placeholder: 'e.g. 10:00 or 5:30 or 8:15' }
                ],
                (data) => {
                    const hoursToAdd = parseHoursMinutes(data.hours);
                    if (isNaN(hoursToAdd) || hoursToAdd <= 0) {
                        showCustomAlert('Please enter valid hours in format "10:00" (10 hours) or "5:30" (5 hours 30 minutes).');
                        return;
                    }
                    
                    const oldHoursPaid = currentProject.hoursPaid || 0;
                    currentProject.hoursPaid = oldHoursPaid + hoursToAdd;
                    
                    
                    if (!currentProject.events) currentProject.events = [];
                    currentProject.events.push({
                        id: Date.now(),
                        type: 'meeting',
                        title: 'Additional Hours Purchased',
                        date: new Date().toISOString().split('T')[0],
                        time: '',
                        notes: `Client purchased ${hoursToAdd} additional hours. Total paid hours: ${currentProject.hoursPaid}`,
                        completed: true
                    });
                    
                    saveCurrentProject();
                    updateProjectHours();
                    updateProjectUpcomingEvents();
                    displayProjects();
                    updateDashboard();
                    
                    showCustomAlert(`Added ${Math.floor(hoursToAdd)} hrs successfully! \nTotal paid hours: ${Math.floor(currentProject.hoursPaid)} hrs`);
                }
            );
        }

        // Quick action to change project status
        function changeProjectStatus() {
            if (!currentProject) return;
            
              // Remember which project section/tab is currently active so we can restore it after submit
              let previousSection = null;
              const activeTabButton = document.querySelector('.project-tab.active');
              if (activeTabButton) {
                  const onclickAttr = activeTabButton.getAttribute('onclick') || '';
                  const match = onclickAttr.match(/'([^']+)'/);
                  if (match && match[1]) previousSection = match[1];
              }

            showCustomPrompt(
                'Change Project Status',
                [
                    { type: 'select', name: 'status', label: 'New Status', options: [
                        { value: 'consultation', text: 'Consultation' },
                        { value: 'design', text: 'Design' },
                        { value: 'sourcing', text: 'Sourcing' },
                        { value: 'ordering', text: 'Ordering' },
                        { value: 'delivery', text: 'Delivery' },
                        { value: 'completed', text: 'Completed' }
                    ], defaultValue: currentProject.status, required: true }
                ],
                (data) => {
                    const oldStatus = currentProject.status;
                    currentProject.status = data.status;
                    saveCurrentProject();
                    
                      // Update the detail view (if open) and keep the user on their current section
                      const detailModal = document.getElementById('projectDetailModal');
                      if (detailModal && detailModal.style.display === 'block') {
                          const statusEl = document.getElementById('detailStatus');
                          if (statusEl) statusEl.textContent = currentProject.status;
                          if (typeof updateProjectHours === 'function') updateProjectHours();
                          if (typeof updateProjectUpcomingEvents === 'function') updateProjectUpcomingEvents();
                          if (previousSection) {
                              const tabButton = document.querySelector(`button.project-tab[onclick*="${previousSection}"]`);
                              if (typeof showProjectSection === 'function') showProjectSection(previousSection, tabButton);
                          }
                      }

                      // Refresh lists and stats
                      if (typeof updateProjectsList === 'function') updateProjectsList();
                      if (typeof displayProjects === 'function') displayProjects();
                      if (typeof updateDashboard === 'function') updateDashboard();
                    
                    showCustomAlert(`Project status changed from "${oldStatus}" to "${data.status}"! `);
                }
            );
        }

        // Toggle file management section
        function toggleFileManagement() {
            const section = document.getElementById('fileManagementSection');
            const icon = document.getElementById('fileManagementIcon');
            
            if (section.style.display === 'none' || section.style.display === '') {
                section.style.display = 'block';
                icon.innerHTML = '';
            } else {
                section.style.display = 'none';
                icon.innerHTML = '';
            }
        }

        // Import CSV functionality
        function importItemsCSV() {
            const input = document.createElement('input');
            input.type = 'file';
            input.accept = '.csv';
            
            input.onchange = function(e) {
                const file = e.target.files[0];
                if (!file) return;
                
                const reader = new FileReader();
                reader.onload = function(e) {
                    try {
                        const csv = e.target.result;
                        const lines = csv.split('\n').filter(line => line.trim());
                        
                        if (lines.length < 2) {
                            showCustomAlert('CSV file must have at least a header row and one data row.');
                            return;
                        }
                        
                        // Expected format: Section,Item Name,Quantity,Wholesale Price,Sell Price,Shipping,Tax,Product Link
                        const importedSections = {};
                        
                        for (let i = 1; i < lines.length; i++) {
                            const values = lines[i].split(',');
                            if (values.length >= 8) {
                                const sectionName = values[0].trim();
                                const itemName = values[1].trim();
                                const qty = parseInt(values[2]) || 1;
                                const wholesalePrice = parseFloat(values[3]) || 0;
                                const sellPrice = parseFloat(values[4]) || 0;
                                const shipping = parseFloat(values[5]) || 0;
                                const tax = parseFloat(values[6]) || 0;
                                const link = values[7] ? values[7].trim() : '';
                                
                                if (!importedSections[sectionName]) {
                                    importedSections[sectionName] = [];
                                }
                                
                                importedSections[sectionName].push({
                                    id: Date.now() + Math.random(),
                                    name: itemName,
                                    qty: qty,
                                    wholesalePrice: wholesalePrice,
                                    customerPrice: sellPrice,
                                    price: sellPrice, // Keep for backward compatibility
                                    shipping: shipping,
                                    tax: tax,
                                    link: link,
                                    readyToOrder: false,
                                    deliveryStatus: 'pending',
                                    shippingInfo: {
                                        carrier: '',
                                        trackingNumber: '',
                                        shippingMethod: '',
                                        estimatedDelivery: '',
                                        shippingCost: shipping,
                                        orderDate: '',
                                        notes: ''
                                    },
                                    orderStatus: 'pending'
                                });
                            } else {
                                console.warn(`Skipping row ${i}: insufficient columns (expected 8, got ${values.length})`);
                            }
                        }
                        
                        // Add sections to current project
                        if (!currentProject.sections) currentProject.sections = [];
                        
                        Object.keys(importedSections).forEach(sectionName => {
                            const existingSection = currentProject.sections.find(s => s.name === sectionName);
                            if (existingSection) {
                                existingSection.items.push(...importedSections[sectionName]);
                            } else {
                                currentProject.sections.push({
                                    id: Date.now() + Math.random(),
                                    name: sectionName,
                                    items: importedSections[sectionName]
                                });
                            }
                        });
                        
                        saveCurrentProject();
                        updateProjectSections();
                        showCustomAlert(`CSV imported successfully! Added ${Object.keys(importedSections).length} sections with items. `);
                        
                    } catch (error) {
                        showCustomAlert('Error importing CSV: ' + error.message);
                    }
                };
                reader.readAsText(file);
            };
            
            input.click();
        }
        
        // Download CSV template functionality
        function downloadCSVTemplate() {
            const csvContent = [
                "Section,Item Name,Quantity,Wholesale Price,Sell Price,Shipping,Tax,Product Link",
                "Living Room,Sofa,1,899.99,1299.99,75.00,95.00,https://example.com/sofa",
                "Living Room,Coffee Table,1,399.99,549.99,25.00,40.00,https://example.com/coffee-table",
                "Bedroom,Bed Frame,1,649.99,899.99,100.00,65.00,https://example.com/bed",
                "Bedroom,Nightstand,2,129.99,199.99,15.00,30.00,https://example.com/nightstand"
            ].join('\n');
            
            const blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' });
            const link = document.createElement('a');
            
            if (link.download !== undefined) {
                const url = URL.createObjectURL(blob);
                link.setAttribute('href', url);
                link.setAttribute('download', 'items-import-template.csv');
                link.style.visibility = 'hidden';
                document.body.appendChild(link);
                link.click();
                document.body.removeChild(link);
            }
        }

        // Download project items as CSV
        function downloadProjectItemsCSV() {
            if (!currentProject || !currentProject.sections || currentProject.sections.length === 0) {
                showCustomAlert('No items found in this project to download.');
                return;
            }
            
            // Create CSV content with all project items
            const csvRows = ['Section,Item Name,Quantity,Wholesale Price,Sell Price,Shipping,Tax,Total Wholesale,Total Sell,Product Link,Ready to Order,Order Status'];
            
            currentProject.sections.forEach(section => {
                // Skip deactivated sections
                if (section.isGrayedOut) return;
                
                if (section.items && section.items.length > 0) {
                    section.items.forEach(item => {
                        // Skip deactivated items
                        if (item.isGrayedOut) return;
                        const wholesalePrice = item.wholesalePrice || 0;
                        const sellPrice = item.customerPrice || item.price || 0;
                        const shipping = item.shipping || 0;
                        const tax = item.tax || 0;
                        const qty = item.qty || 1;
                        const totalWholesale = (wholesalePrice * qty) + (shipping * qty) + (tax * qty);
                        const totalSell = (sellPrice * qty) + (shipping * qty) + (tax * qty);
                        
                        csvRows.push([
                            section.name,
                            item.name,
                            qty,
                            wholesalePrice.toFixed(2),
                            sellPrice.toFixed(2),
                            shipping.toFixed(2),
                            tax.toFixed(2),
                            totalWholesale.toFixed(2),
                            totalSell.toFixed(2),
                            item.link || '',
                            item.readyToOrder ? 'Yes' : 'No',
                            item.orderStatus || 'pending'
                        ].join(','));
                    });
                }
            });
            
            if (csvRows.length === 1) {
                showCustomAlert('No items found in this project to download.');
                return;
            }
            
            const csvContent = csvRows.join('\n');
            const blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' });
            const link = document.createElement('a');
            
            if (link.download !== undefined) {
                const url = URL.createObjectURL(blob);
                link.setAttribute('href', url);
                link.setAttribute('download', `${currentProject.name.replace(/[^a-zA-Z0-9]/g, '_')}_items.csv`);
                link.style.visibility = 'hidden';
                document.body.appendChild(link);
                link.click();
                document.body.removeChild(link);
                
                showCustomAlert(`Downloaded ${csvRows.length - 1} items from "${currentProject.name}" successfully! `);
            }
        }

        // Mood board state management
        let expandedRooms = new Set(); // Track which rooms are expanded
        
        function toggleRoom(roomName) {
            if (expandedRooms.has(roomName)) {
                expandedRooms.delete(roomName);
            } else {
                expandedRooms.add(roomName);
            }
            updateMoodBoards();
        }

        // Mood board functionality
        function updateMoodBoards() {
            if (!currentProject) return;
            
            const container = document.getElementById('moodBoardGallery');
            if (!container) return;
            
            // Initialize mood boards structure if it doesn't exist
            if (!currentProject.moodBoardsByRoom) {
                currentProject.moodBoardsByRoom = {};
                // Migrate old moodBoards to new structure if they exist
                if (currentProject.moodBoards && currentProject.moodBoards.length > 0) {
                    currentProject.moodBoardsByRoom['General'] = {};
                    currentProject.moodBoards.forEach((board, index) => {
                        currentProject.moodBoardsByRoom['General'][`Option ${index + 1}`] = board;
                    });
                    delete currentProject.moodBoards; // Clean up old structure
                }
            }
            
            // Rebuild the moodboards section structure
            const moodboardsContainer = document.getElementById('moodboards');
            moodboardsContainer.innerHTML = `
                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
                    <h3 style="margin: 0; color: var(--text-primary);">Mood Boards by Room</h3>
                    <button class="btn btn-success" onclick="addRoom()">+ Add Room</button>
                </div>
                <div id="moodBoardGallery">
                    <!-- Mood boards will be populated here -->
                </div>
            `;
            
            const galleryContainer = document.getElementById('moodBoardGallery');
            
            // Check if there are any rooms
            const rooms = Object.keys(currentProject.moodBoardsByRoom);
            if (rooms.length === 0) {
                galleryContainer.innerHTML = `
                    <div style="text-align: center; padding: 60px; background: var(--section-bg); border-radius: 12px; border: 2px dashed var(--hover-bg);">
                        <h4 style="color: var(--text-primary); margin: 0 0 10px 0; font-size: 18px;"> No Rooms Created Yet</h4>
                        <p style="color: var(--text-secondary); font-size: 16px; margin: 0 0 15px 0;">Get started by creating your first room!</p>
                        <p style="color: var(--text-tertiary); font-size: 14px; margin: 0; font-style: italic;">Click "Add Room" above to begin organizing your mood boards</p>
                    </div>
                `;
                return;
            }
            
            // Display rooms and their mood boards
            galleryContainer.innerHTML = rooms.map(roomName => {
                const roomBoards = currentProject.moodBoardsByRoom[roomName];
                const boardOptions = Object.keys(roomBoards);
                const isExpanded = expandedRooms.has(roomName);
                
                return `
                    <div class="card" style="margin-bottom: 30px; background: var(--card-bg); border: 1px solid var(--hover-bg); border-radius: 12px; overflow: hidden;">
                        <!-- Room Header -->
                        <div onclick="toggleRoom('${roomName.replace(/'/g, "\\'")}'); event.stopPropagation();" 
                             style="padding: 20px 25px; background: var(--primary-brand); border-bottom: 1px solid var(--section-bg); cursor: pointer; transition: all 0.2s ease; position: relative;"
                             onmouseover="this.style.background='var(--secondary-brand)'"
                             onmouseout="this.style.background='var(--primary-brand)'">
                            <!-- Simple accent stripe -->
                            <div style="position: absolute; top: 0; left: 0; right: 0; height: 3px; background: var(--highlight); opacity: 0.9;"></div>
                            
                            <div style="display: flex; justify-content: space-between; align-items: center;">
                                <div>
                                    <h4 style="margin: 0 0 5px 0; color: white; font-size: 18px; font-weight: 600;">${roomName}</h4>
                                    <p style="margin: 0; color: rgba(255,255,255,0.8); font-size: 13px;">${boardOptions.length} mood board concept${boardOptions.length === 1 ? '' : 's'}</p>
                                </div>
                                <div style="display: flex; gap: 8px;">
                                    <button class="btn" onclick="event.stopPropagation(); downloadRoom('${roomName.replace(/'/g, "\\'")}', ${boardOptions.length})" 
                                            style="background: var(--hover-bg); color: var(--text-primary); border: 1px solid var(--section-bg); padding: 8px 12px; font-size: 12px; font-weight: 500; border-radius: 6px; transition: all 0.2s ease;"
                                            onmouseover="this.style.background='var(--section-bg)'"
                                            onmouseout="this.style.background='var(--hover-bg)'"> Download</button>
                                    <button class="btn" onclick="event.stopPropagation(); removeRoom('${roomName}')" 
                                            style="background: var(--error); color: white; border: none; padding: 8px 12px; font-size: 12px; font-weight: 500; border-radius: 6px; transition: all 0.2s ease;"
                                            onmouseover="this.style.opacity='0.9'"
                                            onmouseout="this.style.opacity='1'"> Remove</button>
                                </div>
                            </div>
                        </div>

                        <!-- Content Area -->
                        <div style="padding: 25px; display: ${isExpanded ? 'block' : 'none'}; transition: all 0.3s ease;">
                            ${boardOptions.length === 0 ? 
                                `<div 
                                    onclick="uploadFirstMoodBoard('${roomName.replace(/'/g, "\\'")}')" 
                                    style="
                                        text-align: center; 
                                        padding: 50px; 
                                        background: var(--section-bg); 
                                        border-radius: 8px; 
                                        border: 2px dashed var(--hover-bg); 
                                        cursor: pointer; 
                                        transition: all 0.3s ease;
                                    "
                                    onmouseover="this.style.borderColor = 'var(--primary-brand)'; this.style.background = 'rgba(216, 167, 167, 0.1)';"
                                    onmouseout="this.style.borderColor = 'var(--hover-bg)'; this.style.background = 'var(--section-bg)';"
                                >
                                    <div style="font-size: 48px; margin-bottom: 20px; color: var(--primary-brand);"></div>
                                    <h5 style="color: var(--text-primary); margin: 0 0 10px 0; font-size: 18px;">Click to Create Your First Option</h5>
                                    <p style="color: var(--text-secondary); font-size: 16px; margin: 0 0 8px 0;">Upload your first mood board to get started</p>
                                    <p style="color: var(--primary-brand); font-size: 15px; margin: 0; font-weight: 500;"> Click anywhere in this box to upload Option A</p>
                                </div>` 
                                : 
                                `<!-- Tab Navigation -->
                                <div style="display: flex; gap: 5px; margin-bottom: 20px; border-bottom: 2px solid var(--hover-bg); align-items: flex-end;">
                                    ${boardOptions.map((optionName, index) => `
                                        <button onclick="showMoodBoardOption('${roomName.replace(/'/g, "\\'")}', '${optionName.replace(/'/g, "\\'")}')" 
                                                id="tab-${roomName.replace(/[^a-zA-Z0-9]/g, '-')}-${optionName.replace(/[^a-zA-Z0-9]/g, '-')}" 
                                                style="padding: 12px 20px; border: none; background: ${index === 0 ? 'var(--primary-brand)' : 'transparent'}; 
                                                       color: ${index === 0 ? 'white' : 'var(--text-secondary)'}; border-radius: 8px 8px 0 0; 
                                                       font-weight: 500; cursor: pointer; transition: all 0.3s ease; font-size: 14px;"
                                                onmouseover="if(this.style.background === 'transparent') { this.style.background = 'var(--hover-bg)'; }"
                                                onmouseout="if(this.style.color !== 'white') { this.style.background = 'transparent'; }">
                                            ${optionName}
                                        </button>
                                    `).join('')}
                                    <button onclick="uploadNextOption('${roomName}')" 
                                            style="padding: 8px 16px; border: 2px dashed var(--primary-brand); background: transparent; 
                                                   color: var(--primary-brand); border-radius: 8px; font-weight: 500; cursor: pointer; 
                                                   transition: all 0.3s ease; font-size: 13px; margin-left: 10px; display: flex; 
                                                   align-items: center; gap: 6px;"
                                            onmouseover="this.style.background = 'var(--primary-brand)'; this.style.color = 'white';"
                                            onmouseout="this.style.background = 'transparent'; this.style.color = 'var(--primary-brand)';">
                                         Add Option
                                    </button>
                                </div>

                                <!-- Tab Content -->
                                <div id="mood-board-content-${roomName}">
                                    ${boardOptions.map((optionName, index) => {
                                        const board = roomBoards[optionName];
                                        const isPlaceholder = !board.dataUrl || board.fileType === 'placeholder';
                                        
                                        return `
                                            <div id="content-${roomName.replace(/[^a-zA-Z0-9]/g, '-')}-${optionName.replace(/[^a-zA-Z0-9]/g, '-')}" style="display: ${index === 0 ? 'block' : 'none'};">
                                                <div style="display: flex; gap: 20px; align-items: center;">
                                                    <div style="flex: 1; max-width: 400px;">
                                                        ${isPlaceholder ? 
                                                            `<div style="width: 100%; height: 300px; border: 2px dashed var(--primary-brand); border-radius: 10px; display: flex; flex-direction: column; align-items: center; justify-content: center; background: var(--section-bg); cursor: pointer;" onclick="uploadImageToOption('${roomName.replace(/'/g, "\\'")}', '${optionName.replace(/'/g, "\\'")}')" >
                                                                <div style="font-size: 48px; color: var(--primary-brand); margin-bottom: 10px;"></div>
                                                                <p style="color: var(--text-secondary); font-size: 16px; margin: 0; text-align: center;">Click to upload<br>mood board image</p>
                                                            </div>`
                                                            :
                                                            `<img src="${board.dataUrl}" alt="${board.name || optionName}" 
                                                                 style="width: 100%; height: 300px; object-fit: cover; border-radius: 10px; box-shadow: 0 4px 15px rgba(0,0,0,0.1);">`
                                                        }
                                                    </div>
                                                    <div style="flex: 1; padding: 20px;">
                                                        <h5 style="margin: 0 0 15px 0; color: var(--text-primary); font-size: 24px; font-weight: 600;">${optionName}</h5>
                                                        ${!isPlaceholder ? 
                                                            `<p style="font-size: 14px; color: var(--text-secondary); margin: 0 0 20px 0; background: var(--section-bg); padding: 8px 12px; border-radius: 6px; display: inline-block;">
                                                                 Uploaded ${new Date(board.uploadDate).toLocaleDateString()}
                                                            </p>`
                                                            :
                                                            `<p style="font-size: 14px; color: var(--text-secondary); margin: 0 0 20px 0; background: var(--section-bg); padding: 8px 12px; border-radius: 6px; display: inline-block;">
                                                                 Waiting for image upload
                                                            </p>`
                                                        }
                                                        <div style="display: flex; flex-direction: column; gap: 10px;">
                                                            ${isPlaceholder ?
                                                                `<button class="btn btn-coral" onclick="uploadImageToOption('${roomName.replace(/'/g, "\\'")}', '${optionName.replace(/'/g, "\\'")}')" style="padding: 12px 20px; font-size: 14px; width: 100%;">
                                                                     Upload Image
                                                                </button>`
                                                                :
                                                                `<button class="btn btn-coral" onclick="downloadMoodBoard('${roomName.replace(/'/g, "\\'")}', '${optionName.replace(/'/g, "\\'")}')" style="padding: 12px 20px; font-size: 14px; width: 100%;">
                                                                     Download This Option
                                                                </button>
                                                                <button class="btn" onclick="replaceMoodBoard('${roomName.replace(/'/g, "\\'")}', '${optionName.replace(/'/g, "\\'")}')" style="padding: 12px 20px; font-size: 14px; width: 100%; background: var(--secondary-brand); color: white;">
                                                                     Replace Image
                                                                </button>`
                                                            }
                                                            <button class="btn" onclick="removeMoodBoard('${roomName.replace(/'/g, "\\'")}', '${optionName.replace(/'/g, "\\'")}')" style="background: #e74c3c; color: white; padding: 12px 20px; font-size: 14px; width: 100%;">
                                                                 Remove Option
                                                            </button>
                                                        </div>
                                                    </div>
                                                </div>
                                            </div>
                                        `;
                                    }).join('')}
                                </div>`
                            }
                        </div>
                    </div>
                `;
            }).join('');
        }

        function addRoom() {
            if (!currentProject) return;
            
            showCustomPrompt(
                'Add New Room',
                [
                    { type: 'text', name: 'roomName', label: 'Room Name', placeholder: 'e.g., Living Room, Master Bedroom', required: true }
                ],
                (data) => {
                    const trimmedName = data.roomName.trim();
                    
                    // Check if room already exists
                    if (currentProject.moodBoardsByRoom[trimmedName]) {
                        showCustomAlert('A room with that name already exists!');
                        return;
                    }
                    
                    // Initialize room with Option A ready for upload
                    currentProject.moodBoardsByRoom[trimmedName] = {
                        'Option A': {
                            name: 'Option A',
                            dataUrl: '',
                            fileType: 'placeholder',
                            uploadDate: new Date().toLocaleDateString()
                        }
                    };
                    
                    // Auto-expand the newly created room
                    expandedRooms.add(trimmedName);
                    
                    saveCurrentProject();
                    updateMoodBoards();
                }
            );
        }

        function removeRoom(roomName) {
            if (!currentProject || !currentProject.moodBoardsByRoom[roomName]) return;
            
            const boardCount = Object.keys(currentProject.moodBoardsByRoom[roomName]).length;
            const boardText = boardCount === 0 ? 'no mood boards' : `${boardCount} mood board${boardCount === 1 ? '' : 's'}`;
            
            showCustomConfirm(
                'Remove Room',
                `Are you sure you want to remove "${roomName}" and all its ${boardText}?<br><br>This action cannot be undone.`,
                'Remove Room',
                () => {
                    delete currentProject.moodBoardsByRoom[roomName];
                    saveCurrentProject();
                    updateMoodBoards();
                }
            );
        }

        function addMoodBoardOption(roomName) {
            if (!currentProject || !currentProject.moodBoardsByRoom[roomName]) return;
            
            const existingOptions = Object.keys(currentProject.moodBoardsByRoom[roomName]);
            
            // Auto-generate the next option name (Option A, Option B, Option C, etc.)
            const nextOptionLetter = String.fromCharCode(65 + existingOptions.length); // A=65, B=66, C=67...
            const autoName = `Option ${nextOptionLetter}`;
            
            // Check if auto-generated name already exists (shouldn't happen, but just in case)
            let finalName = autoName;
            let counter = 1;
            while (currentProject.moodBoardsByRoom[roomName][finalName]) {
                finalName = `${autoName} (${counter})`;
                counter++;
            }
            
            // Create placeholder option immediately
            currentProject.moodBoardsByRoom[roomName][finalName] = {
                name: finalName,
                dataUrl: null, // No image yet
                uploadDate: new Date().toISOString(),
                fileSize: 0,
                fileType: 'placeholder'
            };
            
            saveCurrentProject();
            updateMoodBoards();
            
            // Auto-switch to the newly added tab
            setTimeout(() => {
                showMoodBoardOption(roomName, finalName);
            }, 100);
        }

        function uploadImageToOption(roomName, optionName) {
            const input = document.createElement('input');
            input.type = 'file';
            input.accept = 'image/*';
            
            input.onchange = function(e) {
                const file = e.target.files[0];
                if (!file) return;
                
                const reader = new FileReader();
                reader.onload = function(e) {
                    currentProject.moodBoardsByRoom[roomName][optionName] = {
                        name: optionName,
                        dataUrl: e.target.result,
                        uploadDate: new Date().toISOString(),
                        fileSize: file.size,
                        fileType: file.type
                    };
                    
                    saveCurrentProject();
                    updateMoodBoards();
                    
                    // Auto-switch to the updated tab
                    setTimeout(() => {
                        showMoodBoardOption(roomName, optionName);
                    }, 100);
                };
                reader.readAsDataURL(file);
            };
            
            input.click();
        }

        function uploadMoodBoard() {
            if (!currentProject) return;
            
            // First check if we have rooms
            const rooms = Object.keys(currentProject.moodBoardsByRoom || {});
            if (rooms.length === 0) {
                showCustomAlert('Please add a room first before uploading mood boards!');
                return;
            }
            
            // Let user select room
            let roomOptions = rooms.map((room, index) => `${index + 1}. ${room}`).join('\n');
            const roomChoice = prompt(`Select a room by number:\n${roomOptions}`);
            
            if (!roomChoice || isNaN(roomChoice) || roomChoice < 1 || roomChoice > rooms.length) return;
            
            const selectedRoom = rooms[roomChoice - 1];
            addMoodBoardOption(selectedRoom);
        }

        function downloadMoodBoard(roomName, optionName) {
            if (!currentProject || !currentProject.moodBoardsByRoom[roomName] || !currentProject.moodBoardsByRoom[roomName][optionName]) return;
            
            const moodBoard = currentProject.moodBoardsByRoom[roomName][optionName];
            const link = document.createElement('a');
            link.href = moodBoard.dataUrl;
            link.download = `${roomName} - ${optionName}.jpg`;
            link.click();
        }

        function downloadRoom(roomName, boardCount) {
            if (!currentProject || !currentProject.moodBoardsByRoom[roomName]) return;
            
            const roomBoards = currentProject.moodBoardsByRoom[roomName];
            const boardOptions = Object.keys(roomBoards);
            
            // Filter out empty placeholder options
            const validBoards = boardOptions.filter(optionName => {
                const board = roomBoards[optionName];
                return board.dataUrl && board.fileType !== 'placeholder';
            });
            
            if (validBoards.length === 0) {
                showCustomAlert('No mood board images to download in this room. Upload some images first!');
                return;
            }
            
            showCustomAlert(`Creating combined mood board for ${roomName}... `);
            createCombinedMoodBoard(roomName, validBoards, roomBoards);
        }

        function uploadFirstMoodBoard(roomName) {
            // Create Option A and trigger upload
            const nextOption = 'Option A';
            
            // Initialize the room if it doesn't exist
            if (!currentProject.moodBoardsByRoom[roomName]) {
                currentProject.moodBoardsByRoom[roomName] = {};
            }
            
            // Add Option A
            currentProject.moodBoardsByRoom[roomName][nextOption] = {
                name: nextOption,
                dataUrl: '',
                fileType: 'placeholder',
                uploadDate: new Date().toLocaleDateString()
            };
            
            // Save and refresh
            saveCurrentProject();
            updateMoodBoards();
            
            // Trigger file upload for Option A
            uploadImageToOption(roomName, nextOption);
        }

        function uploadNextOption(roomName) {
            if (!currentProject || !currentProject.moodBoardsByRoom[roomName]) return;
            
            const existingOptions = Object.keys(currentProject.moodBoardsByRoom[roomName]);
            
            // Auto-generate the next option name (Option A, Option B, Option C, etc.)
            const nextOptionLetter = String.fromCharCode(65 + existingOptions.length); // A=65, B=66, C=67...
            const nextOption = `Option ${nextOptionLetter}`;
            
            // Check if auto-generated name already exists (shouldn't happen, but just in case)
            let finalName = nextOption;
            let counter = 1;
            while (currentProject.moodBoardsByRoom[roomName][finalName]) {
                finalName = `${nextOption} (${counter})`;
                counter++;
            }
            
            // Create the new option
            currentProject.moodBoardsByRoom[roomName][finalName] = {
                name: finalName,
                dataUrl: '',
                fileType: 'placeholder',
                uploadDate: new Date().toLocaleDateString()
            };
            
            // Save and refresh
            saveCurrentProject();
            updateMoodBoards();
            
            // Auto-switch to the newly added tab
            setTimeout(() => {
                showMoodBoardOption(roomName, finalName);
            }, 100);
        }

        function createCombinedMoodBoard(roomName, validBoards, roomBoards) {
            // Check if jsPDF is available
            if (typeof jsPDF === 'undefined') {
                // Fallback to loading jsPDF dynamically
                const script = document.createElement('script');
                script.src = 'https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js';
                script.onload = () => {
                    createPDFMoodBoard(roomName, validBoards, roomBoards);
                };
                script.onerror = () => {
                    showCustomAlert('Unable to load PDF library. Please try again or check your internet connection.');
                };
                document.head.appendChild(script);
            } else {
                createPDFMoodBoard(roomName, validBoards, roomBoards);
            }
        }

        function createPDFMoodBoard(roomName, validBoards, roomBoards) {
            // Load all images first
            const imagePromises = validBoards.map(optionName => {
                return new Promise((resolve) => {
                    const img = new Image();
                    img.onload = () => resolve({ optionName, img });
                    img.src = roomBoards[optionName].dataUrl;
                });
            });
            
            Promise.all(imagePromises).then(loadedImages => {
                const { jsPDF } = window.jspdf;
                const pdf = new jsPDF({
                    orientation: 'portrait',
                    unit: 'mm',
                    format: 'a4'
                });
                
                const pageWidth = pdf.internal.pageSize.getWidth();
                const pageHeight = pdf.internal.pageSize.getHeight();
                const margin = 20;
                
                loadedImages.forEach((item, index) => {
                    // Add new page for each option (except the first one)
                    if (index > 0) {
                        pdf.addPage();
                    }
                    
                    // Calculate image dimensions to fit full page
                    const availableWidth = pageWidth - (2 * margin);
                    const availableHeight = pageHeight - (2 * margin);
                    
                    const imgAspectRatio = item.img.width / item.img.height;
                    let imgWidth, imgHeight;
                    
                    if (availableWidth / availableHeight > imgAspectRatio) {
                        // Fit to height
                        imgHeight = availableHeight;
                        imgWidth = imgHeight * imgAspectRatio;
                    } else {
                        // Fit to width
                        imgWidth = availableWidth;
                        imgHeight = imgWidth / imgAspectRatio;
                    }
                    
                    // Center the image
                    const imgX = (pageWidth - imgWidth) / 2;
                    const imgY = margin + (availableHeight - imgHeight) / 2;
                    
                    // Add image to PDF
                    pdf.addImage(item.img, 'JPEG', imgX, imgY, imgWidth, imgHeight);
                });
                
                // Save the PDF
                pdf.save(`${roomName} - Mood Board Options.pdf`);
                showCustomAlert(`PDF with ${validBoards.length} mood board options for ${roomName} downloaded successfully! `);
            }).catch(error => {
                console.error('Error creating PDF:', error);
                showCustomAlert('Error creating PDF. Please try again.');
            });
        }

        function downloadMultipleBoardsSequentially(roomName, validBoards, roomBoards) {
            validBoards.forEach((optionName, index) => {
                setTimeout(() => {
                    const moodBoard = roomBoards[optionName];
                    const link = document.createElement('a');
                    link.href = moodBoard.dataUrl;
                    link.download = `${roomName} - ${optionName}.jpg`;
                    link.click();
                    
                    // Show completion message after last download
                    if (index === validBoards.length - 1) {
                        setTimeout(() => {
                            showCustomAlert(`Downloaded all ${validBoards.length} mood boards from ${roomName}! `);
                        }, 500);
                    }
                }, index * 1000); // 1 second delay between downloads
            });
        }

        function createZipDownload(roomName, validBoards, roomBoards) {
            const zip = new JSZip();
            const folder = zip.folder(roomName);
            
            let processedCount = 0;
            
            validBoards.forEach((optionName) => {
                const moodBoard = roomBoards[optionName];
                // Convert data URL to blob
                const base64Data = moodBoard.dataUrl.split(',')[1];
                const byteCharacters = atob(base64Data);
                const byteNumbers = new Array(byteCharacters.length);
                
                for (let i = 0; i < byteCharacters.length; i++) {
                    byteNumbers[i] = byteCharacters.charCodeAt(i);
                }
                
                const byteArray = new Uint8Array(byteNumbers);
                const blob = new Blob([byteArray], { type: moodBoard.fileType || 'image/jpeg' });
                
                folder.file(`${optionName}.jpg`, blob);
                processedCount++;
                
                // Generate zip when all files are processed
                if (processedCount === validBoards.length) {
                    zip.generateAsync({ type: 'blob' }).then((content) => {
                        const link = document.createElement('a');
                        link.href = URL.createObjectURL(content);
                        link.download = `${roomName} - Mood Boards.zip`;
                        link.click();
                        
                        showCustomAlert(`Downloaded ${roomName} mood boards as ZIP file! `);
                        
                        // Clean up object URL
                        setTimeout(() => URL.revokeObjectURL(link.href), 1000);
                    });
                }
            });
        }

        function replaceMoodBoard(roomName, optionName) {
            if (!currentProject || !currentProject.moodBoardsByRoom[roomName] || !currentProject.moodBoardsByRoom[roomName][optionName]) return;
            
            const input = document.createElement('input');
            input.type = 'file';
            input.accept = 'image/*';
            
            input.onchange = function(e) {
                const file = e.target.files[0];
                if (!file) return;
                
                const reader = new FileReader();
                reader.onload = function(e) {
                    currentProject.moodBoardsByRoom[roomName][optionName] = {
                        name: optionName,
                        dataUrl: e.target.result,
                        uploadDate: new Date().toISOString(),
                        fileSize: file.size,
                        fileType: file.type
                    };
                    
                    saveCurrentProject();
                    updateMoodBoards();
                    showCustomAlert(`${optionName} replaced successfully! `);
                };
                reader.readAsDataURL(file);
            };
            
            input.click();
        }

        function renumberRoomOptions(roomName) {
            if (!currentProject || !currentProject.moodBoardsByRoom[roomName]) return;
            
            const roomBoards = currentProject.moodBoardsByRoom[roomName];
            const existingOptions = Object.keys(roomBoards);
            
            // Only renumber if we have options that follow the "Option X" pattern
            const standardOptions = existingOptions.filter(name => /^Option [A-Z]$/.test(name));
            
            if (standardOptions.length === 0) return;
            
            // Sort existing options to maintain order
            standardOptions.sort();
            
            // Create new structure with renumbered options
            const newRoomBoards = {};
            
            standardOptions.forEach((oldName, index) => {
                const newLetter = String.fromCharCode(65 + index); // A=65, B=66, C=67...
                const newName = `Option ${newLetter}`;
                
                // Copy the board data with updated name
                newRoomBoards[newName] = {
                    ...roomBoards[oldName],
                    name: newName
                };
            });
            
            // Add any non-standard options back
            existingOptions.forEach(name => {
                if (!/^Option [A-Z]$/.test(name)) {
                    newRoomBoards[name] = roomBoards[name];
                }
            });
            
            // Replace the room's options with renumbered ones
            currentProject.moodBoardsByRoom[roomName] = newRoomBoards;
        }

        function removeMoodBoard(roomName, optionName) {
            if (!currentProject || !currentProject.moodBoardsByRoom[roomName] || !currentProject.moodBoardsByRoom[roomName][optionName]) return;
            
            const board = currentProject.moodBoardsByRoom[roomName][optionName];
            const hasImage = board.dataUrl && board.fileType !== 'placeholder';
            const description = hasImage ? 'mood board image' : 'empty option';
            
            showCustomConfirm(
                'Remove Option',
                `Are you sure you want to remove "${optionName}" from ${roomName}?<br><br>This will delete the ${description} permanently.`,
                'Remove Option',
                () => {
                    delete currentProject.moodBoardsByRoom[roomName][optionName];
                    
                    // Renumber remaining options to maintain A, B, C sequence
                    renumberRoomOptions(roomName);
                    
                    saveCurrentProject();
                    updateMoodBoards();
                }
            );
        }

        function showMoodBoardOption(roomName, optionName) {
            const escapedRoomName = roomName.replace(/[^a-zA-Z0-9]/g, '-');
            const escapedOptionName = optionName.replace(/[^a-zA-Z0-9]/g, '-');
            
            // Hide all content panels for this room
            const allPanels = document.querySelectorAll(`[id^="content-${escapedRoomName}-"]`);
            allPanels.forEach(panel => panel.style.display = 'none');
            
            // Show selected panel
            const selectedPanel = document.getElementById(`content-${escapedRoomName}-${escapedOptionName}`);
            if (selectedPanel) selectedPanel.style.display = 'block';
            
            // Update tab appearance
            const allTabs = document.querySelectorAll(`[id^="tab-${escapedRoomName}-"]`);
            allTabs.forEach(tab => {
                tab.style.background = 'transparent';
                tab.style.color = 'var(--text-secondary)';
            });
            
            // Highlight selected tab
            const selectedTab = document.getElementById(`tab-${escapedRoomName}-${escapedOptionName}`);
            if (selectedTab) {
                selectedTab.style.background = 'var(--primary-brand)';
                selectedTab.style.color = 'white';
            }
        }

        function showCustomConfirm(title, message, confirmText, onConfirm, onCancel = null) {
            // Remove any existing confirmation modals
            const existingConfirm = document.querySelector('.custom-confirm-modal');
            const existingOverlay = document.querySelector('.custom-confirm-overlay');
            if (existingConfirm) existingConfirm.remove();
            if (existingOverlay) existingOverlay.remove();

            // Create overlay
            const overlay = document.createElement('div');
            overlay.className = 'custom-confirm-overlay';
            overlay.style.cssText = `
                position: fixed;
                top: 0;
                left: 0;
                width: 100%;
                height: 100%;
                background: rgba(45, 43, 40, 0.8);
                backdrop-filter: blur(8px);
                z-index: 9999;
                display: flex;
                align-items: center;
                justify-content: center;
                animation: fadeIn 0.2s ease;
            `;

            // Create modal
            const modal = document.createElement('div');
            modal.className = 'custom-confirm-modal';
            modal.style.cssText = `
                background: var(--card-bg);
                border: 2px solid var(--primary-brand);
                border-radius: 16px;
                padding: 30px;
                max-width: 400px;
                width: 90%;
                box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3);
                animation: slideIn 0.3s ease;
                text-align: center;
            `;

            modal.innerHTML = `
                <div style="margin-bottom: 20px;">
                    <h3 style="margin: 0 0 15px 0; color: var(--text-primary); font-size: 20px; font-weight: 600;">${title}</h3>
                    <p style="margin: 0; color: var(--text-secondary); font-size: 16px; line-height: 1.5;">${message}</p>
                </div>
                <div style="display: flex; gap: 12px; justify-content: center; margin-top: 25px;">
                    <button id="confirmCancel" class="btn" style="padding: 12px 24px; font-size: 14px; background: var(--hover-bg); color: var(--text-primary); border: 1px solid var(--hover-bg);">
                        Cancel
                    </button>
                    <button id="confirmAction" class="btn" style="padding: 12px 24px; font-size: 14px; background: #e74c3c; color: white; font-weight: 500;">
                        ${confirmText}
                    </button>
                </div>
            `;

            // Add animation styles if they don't exist
            if (!document.getElementById('confirm-modal-styles')) {
                const styles = document.createElement('style');
                styles.id = 'confirm-modal-styles';
                styles.textContent = `
                    @keyframes fadeIn {
                        from { opacity: 0; }
                        to { opacity: 1; }
                    }
                    @keyframes slideIn {
                        from { transform: scale(0.9) translateY(-10px); opacity: 0; }
                        to { transform: scale(1) translateY(0); opacity: 1; }
                    }
                `;
                document.head.appendChild(styles);
            }

            overlay.appendChild(modal);
            document.body.appendChild(overlay);

            // Handle button clicks
            const cancelBtn = document.getElementById('confirmCancel');
            const confirmBtn = document.getElementById('confirmAction');

            const closeModal = () => {
                overlay.style.animation = 'fadeIn 0.2s ease reverse';
                setTimeout(() => {
                    if (overlay.parentNode) overlay.remove();
                }, 200);
            };

            cancelBtn.onclick = () => {
                closeModal();
                if (onCancel) onCancel();
            };

            confirmBtn.onclick = () => {
                closeModal();
                onConfirm();
            };

            // Close on overlay click
            overlay.onclick = (e) => {
                if (e.target === overlay) {
                    closeModal();
                    if (onCancel) onCancel();
                }
            };

            // Prevent modal content click from closing
            modal.onclick = (e) => {
                e.stopPropagation();
            };

            // Focus the confirm button
            setTimeout(() => confirmBtn.focus(), 100);
        }

        // Reporting functions


        // Utility functions
        function duplicateProject() {
            if (projects.length === 0) {
                showCustomAlert('No projects to duplicate. Create your first project!');
                return;
            }
            
            const lastProject = projects[projects.length - 1];
            const duplicatedProject = {
                ...lastProject,
                id: Date.now(),
                name: lastProject.name + ' (Copy)',
                startDate: new Date().toISOString().split('T')[0],
                hoursWorked: 0,
                hoursLog: [],
                events: [],
                moodBoards: [],
                moodBoardsByRoom: {},
                invoiceNumber: (++invoiceCounter).toString().padStart(6, '0'),
                amountPaid: 0
            };
            
            projects.push(duplicatedProject);
            saveProjects();
            saveInvoiceCounter();
            
            displayProjects();
            updateDashboard();
            
            showCustomAlert(`Project "${duplicatedProject.name}" created successfully! `);
        }

        // Custom modal functions
        function showCustomAlert(message) {
            const existingAlert = document.querySelector('.custom-alert');
            const existingOverlay = document.querySelector('.custom-alert-overlay');
            if (existingAlert) existingAlert.remove();
            if (existingOverlay) existingOverlay.remove();
            
            const overlay = document.createElement('div');
            overlay.className = 'custom-alert-overlay';
            
            const alertBox = document.createElement('div');
            alertBox.className = 'custom-alert';
            alertBox.innerHTML = `
                <div style="margin-bottom: 20px; color: var(--text-primary); font-size: 16px; line-height: 1.5;">${message}</div>
                <button class="btn btn-success" onclick="closeCustomAlert()">OK</button>
            `;
            
            document.body.appendChild(overlay);
            document.body.appendChild(alertBox);
            
            setTimeout(() => {
                if (document.querySelector('.custom-alert')) {
                    closeCustomAlert();
                }
            }, 3000);
        }

        function closeCustomAlert() {
            const alertBox = document.querySelector('.custom-alert');
            const overlay = document.querySelector('.custom-alert-overlay');
            if (alertBox) alertBox.remove();
            if (overlay) overlay.remove();
        }

        function showCustomPrompt(title, fields, callback) {
            const existingPrompt = document.querySelector('.custom-prompt');
            const existingOverlay = document.querySelector('.custom-prompt-overlay');
            if (existingPrompt) existingPrompt.remove();
            if (existingOverlay) existingOverlay.remove();
            
            const overlay = document.createElement('div');
            overlay.style.cssText = 'position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(45, 43, 40, 0.7); backdrop-filter: blur(5px); z-index: 1999; cursor: pointer;';
            overlay.onclick = function() {
                closeCustomPrompt();
            };
            
            const promptBox = document.createElement('div');
            promptBox.style.cssText = 'position: fixed; top: 50%; left: 50%; transform: translate(-50%, -50%); background: var(--card-bg); border: 2px solid var(--gentle-blue); border-radius: 16px; padding: 30px; box-shadow: 0 20px 60px rgba(45, 43, 40, 0.3); z-index: 2000; max-width: 500px; width: 90%; max-height: 80vh; overflow-y: auto;';
            promptBox.onclick = function(e) {
                e.stopPropagation(); // Prevent closing when clicking inside the popup
            };
            
            let fieldsHtml = '';
            fields.forEach(field => {
                if (field.type === 'select') {
                    fieldsHtml += `
                        <label style="display: block; margin-bottom: 8px; font-weight: 500; color: var(--text-primary);">${field.label}:</label>
                        <select id="prompt-${field.name}" style="width: 100%; padding: 12px; border: 2px solid var(--section-bg); border-radius: 8px; margin-bottom: 15px; font-size: 15px;">
                    `;
                    field.options.forEach(option => {
                        const selected = option.value === field.defaultValue ? 'selected' : '';
                        fieldsHtml += `<option value="${option.value}" ${selected}>${option.text}</option>`;
                    });
                    fieldsHtml += '</select>';
                } else if (field.type === 'textarea') {
                    fieldsHtml += `
                        <label style="display: block; margin-bottom: 8px; font-weight: 500; color: var(--text-primary);">${field.label}:</label>
                        <textarea id="prompt-${field.name}" rows="3" placeholder="${field.placeholder || ''}" style="width: 100%; padding: 12px; border: 2px solid var(--section-bg); border-radius: 8px; margin-bottom: 15px; font-size: 15px; font-family: inherit;">${field.defaultValue || ''}</textarea>
                    `;
                } else {
                    fieldsHtml += `
                        <label style="display: block; margin-bottom: 8px; font-weight: 500; color: var(--text-primary);">${field.label}:</label>
                        <input type="${field.type}" id="prompt-${field.name}" ${field.step ? 'step="' + field.step + '"' : ''} ${field.required ? 'required' : ''} placeholder="${field.placeholder || ''}" value="${field.defaultValue || ''}" style="width: 100%; padding: 12px; border: 2px solid var(--section-bg); border-radius: 8px; margin-bottom: 8px; font-size: 15px;">
                    `;
                    if (field.type === 'date') {
                        fieldsHtml += `
                            <div style="display: flex; gap: 8px; flex-wrap: wrap; margin-bottom: 15px;">
                                <button type="button" data-role="date-quick" data-kind="today" data-target="prompt-${field.name}" class="btn" style="padding: 6px 10px; border-radius: 12px; background: var(--section-bg); color: var(--text-secondary); box-shadow: none; text-transform: none; letter-spacing: 0; font-size: 12px;">Today</button>
                                <button type="button" data-role="date-quick" data-kind="tomorrow" data-target="prompt-${field.name}" class="btn" style="padding: 6px 10px; border-radius: 12px; background: var(--section-bg); color: var(--text-secondary); box-shadow: none; text-transform: none; letter-spacing: 0; font-size: 12px;">Tomorrow</button>
                                <button type="button" data-role="date-quick" data-kind="next-day" data-target="prompt-${field.name}" class="btn" style="padding: 6px 10px; border-radius: 12px; background: var(--section-bg); color: var(--text-secondary); box-shadow: none; text-transform: none; letter-spacing: 0; font-size: 12px;">Next Day </button>
                            </div>
                        `;
                    } else if (field.type === 'text' && field.name.toLowerCase().includes('hours')) {
                        // Check if this is for adding paid hours (different increments needed)
                        const isPaidHoursField = field.label && field.label.toLowerCase().includes('additional');
                        
                        if (isPaidHoursField) {
                            // For Add Paid Hours: +1hr, +5hr, +10hr
                            fieldsHtml += `
                                <div style="display: flex; gap: 6px; flex-wrap: wrap; margin-bottom: 15px; justify-content: flex-start;">
                                    <button type="button" data-role="hours-increment" data-increment="60" data-target="prompt-${field.name}" class="btn" style="padding: 8px 12px; border-radius: 8px; background: var(--highlight); color: white; border: none; box-shadow: none; text-transform: none; letter-spacing: 0; font-size: 13px; font-weight: 500; transition: all 0.2s ease;">+1hr</button>
                                    <button type="button" data-role="hours-increment" data-increment="300" data-target="prompt-${field.name}" class="btn" style="padding: 8px 12px; border-radius: 8px; background: var(--highlight); color: white; border: none; box-shadow: none; text-transform: none; letter-spacing: 0; font-size: 13px; font-weight: 500; transition: all 0.2s ease;">+5hr</button>
                                    <button type="button" data-role="hours-increment" data-increment="600" data-target="prompt-${field.name}" class="btn" style="padding: 8px 12px; border-radius: 8px; background: var(--highlight); color: white; border: none; box-shadow: none; text-transform: none; letter-spacing: 0; font-size: 13px; font-weight: 500; transition: all 0.2s ease;">+10hr</button>
                                </div>
                            `;
                        } else {
                            // For Log Hours: +15min, +30min, +1hr  
                            fieldsHtml += `
                                <div style="display: flex; gap: 6px; flex-wrap: wrap; margin-bottom: 15px; justify-content: flex-start;">
                                    <button type="button" data-role="hours-increment" data-increment="15" data-target="prompt-${field.name}" class="btn" style="padding: 8px 12px; border-radius: 8px; background: var(--highlight); color: white; border: none; box-shadow: none; text-transform: none; letter-spacing: 0; font-size: 13px; font-weight: 500; transition: all 0.2s ease;">+15min</button>
                                    <button type="button" data-role="hours-increment" data-increment="30" data-target="prompt-${field.name}" class="btn" style="padding: 8px 12px; border-radius: 8px; background: var(--highlight); color: white; border: none; box-shadow: none; text-transform: none; letter-spacing: 0; font-size: 13px; font-weight: 500; transition: all 0.2s ease;">+30min</button>
                                    <button type="button" data-role="hours-increment" data-increment="60" data-target="prompt-${field.name}" class="btn" style="padding: 8px 12px; border-radius: 8px; background: var(--highlight); color: white; border: none; box-shadow: none; text-transform: none; letter-spacing: 0; font-size: 13px; font-weight: 500; transition: all 0.2s ease;">+1hr</button>
                                </div>
                            `;
                        }
                    } else if (field.type === 'time') {
                        fieldsHtml += `
                            <div style="display: flex; gap: 8px; flex-wrap: wrap; margin-bottom: 15px;">
                                <button type="button" data-role="time-quick" data-time="11:00" data-target="prompt-${field.name}" class="btn" style="padding: 6px 10px; border-radius: 12px; background: var(--section-bg); color: var(--text-secondary); box-shadow: none; text-transform: none; letter-spacing: 0; font-size: 12px;">11:00 AM</button>
                                <button type="button" data-role="time-quick" data-time="14:00" data-target="prompt-${field.name}" class="btn" style="padding: 6px 10px; border-radius: 12px; background: var(--section-bg); color: var(--text-secondary); box-shadow: none; text-transform: none; letter-spacing: 0; font-size: 12px;">2:00 PM</button>
                                <button type="button" data-role="time-quick" data-time="+30" data-target="prompt-${field.name}" class="btn" style="padding: 6px 10px; border-radius: 12px; background: var(--section-bg); color: var(--text-secondary); box-shadow: none; text-transform: none; letter-spacing: 0; font-size: 12px;">+30 min </button>
                            </div>
                        `;
                    }
                }
            });
            
            promptBox.innerHTML = `
                <h3 style="margin-top: 0; color: var(--text-primary); text-align: center; margin-bottom: 20px;">${title}</h3>
                ${fieldsHtml}
                <div style="display: flex; gap: 15px; justify-content: center; margin-top: 20px;">
                    <button class="btn btn-success" onclick="submitCustomPrompt()">Submit</button>
                    <button class="btn" onclick="closeCustomPrompt()">Cancel</button>
                </div>
            `;
            
            window.currentPromptCallback = callback;
            
            // Quick-pick chip handlers
            const formatDate = (d) => {
                const y = d.getFullYear();
                const m = String(d.getMonth() + 1).padStart(2, '0');
                const day = String(d.getDate()).padStart(2, '0');
                return `${y}-${m}-${day}`;
            };
            const parseDateInput = (str) => {
                if (!str || !/^\d{4}-\d{2}-\d{2}$/.test(str)) return null;
                const [yy, mm, dd] = str.split('-').map(Number);
                return new Date(yy, mm - 1, dd);
            };
            const getNextDay = (d) => {
                const result = new Date(d.getFullYear(), d.getMonth(), d.getDate());
                result.setDate(result.getDate() + 1);
                return result;
            };
            promptBox.addEventListener('click', function(e) {
                const target = e.target;
                if (!(target instanceof Element)) return;
                const role = target.getAttribute('data-role');
                if (role === 'date-quick') {
                    const kind = target.getAttribute('data-kind');
                    const inputId = target.getAttribute('data-target');
                    const input = document.getElementById(inputId);
                    if (!input) return;
                    const todayNow = new Date();
                    const base = parseDateInput(input.value) || new Date();
                    let d = base;
                    if (kind === 'today') {
                        d = todayNow;
                    } else if (kind === 'tomorrow') {
                        d = getNextDay(todayNow);
                    } else if (kind === 'next-day') {
                        d = getNextDay(base);
                    }
                    input.value = formatDate(d);
                } else if (role === 'time-quick') {
                    const inputId = target.getAttribute('data-target');
                    const input = document.getElementById(inputId);
                    if (!input) return;
                    const val = target.getAttribute('data-time');
                    if (val === '+30') {
                        // Increment existing time by 30 minutes, or start from current time if empty
                        let h = 0, m = 0;
                        if (input.value && /^\d{2}:\d{2}$/.test(input.value)) {
                            h = parseInt(input.value.slice(0, 2), 10);
                            m = parseInt(input.value.slice(3, 5), 10);
                        } else {
                            const now = new Date();
                            h = now.getHours();
                            m = now.getMinutes();
                        }
                        m += 30;
                        h += Math.floor(m / 60);
                        m = m % 60;
                        h = h % 24;
                        input.value = `${String(h).padStart(2, '0')}:${String(m).padStart(2, '0')}`;
                    } else if (val) {
                        input.value = val;
                    }
                } else if (role === 'hours-quick') {
                    const inputId = target.getAttribute('data-target');
                    const input = document.getElementById(inputId);
                    if (!input) return;
                    const hoursValue = target.getAttribute('data-hours');
                    input.value = hoursValue;
                } else if (role === 'hours-increment') {
                    const inputId = target.getAttribute('data-target');
                    const input = document.getElementById(inputId);
                    if (!input) return;
                    const incrementMinutes = parseInt(target.getAttribute('data-increment'));
                    
                    // Parse current value or start from 0:00
                    let currentHours = parseHoursMinutes(input.value) || 0;
                    
                    // Add the increment (convert minutes to decimal hours)
                    currentHours += incrementMinutes / 60;
                    
                    // Update the input with the new value
                    input.value = formatHoursMinutes(currentHours);
                }
            });
            
            document.body.appendChild(overlay);
            document.body.appendChild(promptBox);
            
            const firstInput = promptBox.querySelector('input, select, textarea');
            if (firstInput) {
                setTimeout(() => firstInput.focus(), 100);
            }
        }

        function submitCustomPrompt() {
            const promptBox = document.querySelector('[style*="position: fixed"][style*="z-index: 2000"]');
            const data = {};
            
            const inputs = promptBox.querySelectorAll('input, select, textarea');
            inputs.forEach(input => {
                const fieldName = input.id.replace('prompt-', '');
                data[fieldName] = input.value;
            });
            
            let hasError = false;
            inputs.forEach(input => {
                if (input.hasAttribute('required') && !input.value.trim()) {
                    input.style.borderColor = '#e74c3c';
                    hasError = true;
                } else {
                    input.style.borderColor = 'var(--soft-rose)';
                }
            });
            
            if (hasError) {
                showCustomAlert('Please fill in all required fields.');
                return;
            }
            
            if (window.currentPromptCallback) {
                window.currentPromptCallback(data);
                window.currentPromptCallback = null;
            }
            
            closeCustomPrompt();
        }

        function closeCustomPrompt() {
            const promptBox = document.querySelector('[style*="position: fixed"][style*="z-index: 2000"]');
            const overlay = document.querySelector('[style*="position: fixed"][style*="z-index: 1999"]');
            if (promptBox) promptBox.remove();
            if (overlay) overlay.remove();
            window.currentPromptCallback = null;
        }

        // Initialize
          document.addEventListener('DOMContentLoaded', function() {
              // Close modals when clicking outside modal content
              document.addEventListener('click', function(e) {
                  const openModals = Array.from(document.querySelectorAll('.modal')).filter(m => m.style.display === 'block');
                  if (openModals.length === 0) return;
                  const clickedInsideContent = openModals.some(modal => modal.querySelector('.modal-content') && modal.querySelector('.modal-content').contains(e.target));
                  const clickedInsideAnyModal = openModals.some(modal => modal.contains(e.target));
                  if (clickedInsideAnyModal && !clickedInsideContent) {
                      openModals.forEach(modal => { modal.style.display = 'none'; });
                      currentProject = null;
                  }
              }, true);
              // Theme init
              try {
                  const savedTheme = localStorage.getItem('krd-theme');
                  if (savedTheme === 'dark') {
                      document.body.classList.add('theme-dark');
                  }
                  const btn = document.getElementById('themeSwitchBtn');
                  const syncIcon = () => {
                      if (!btn) return;
                      btn.textContent = document.body.classList.contains('theme-dark') ? '' : '';
                  };
                  syncIcon();
                  if (btn) {
                      btn.addEventListener('click', function() {
                          const isDark = document.body.classList.toggle('theme-dark');
                          localStorage.setItem('krd-theme', isDark ? 'dark' : 'light');
                          syncIcon();
                      });
                  }
              } catch (e) {}
              
            // Migrate old project data format
            migrateOldProjects();
            
              // Compute header height and apply offset if needed for sticky elements
              const headerElement = document.querySelector('.header');
              const tabsElement = document.querySelector('.tabs');
              if (headerElement) {
                  const headerRect = headerElement.getBoundingClientRect();
                  const headerComputedHeight = Math.ceil(headerRect.height);
                  document.documentElement.style.setProperty('--header-height', headerComputedHeight + 'px');
                  if (tabsElement) {
                      tabsElement.style.top = 'var(--header-height)';
                  }
              }
              window.addEventListener('resize', function() {
                  if (headerElement) {
                      const newHeight = Math.ceil(headerElement.getBoundingClientRect().height);
                      document.documentElement.style.setProperty('--header-height', newHeight + 'px');
                  }
              });

            document.getElementById('startDate').valueAsDate = new Date();
            // Removed hours form initialization since Hours section was removed
            
            displayProjects();
            updateDashboard();
            updateUpcomingEvents();
        });
        
        // Logo upload functionality
        function uploadCompanyLogo() {
            const input = document.createElement('input');
            input.type = 'file';
            input.accept = 'image/*';
            
            input.onchange = function(e) {
                const file = e.target.files[0];
                if (!file) return;
                
                // Check file size (limit to 2MB)
                if (file.size > 2 * 1024 * 1024) {
                    showCustomAlert('Logo file size must be less than 2MB.');
                    return;
                }
                
                const reader = new FileReader();
                reader.onload = function(e) {
                    const logoData = e.target.result;
                    localStorage.setItem('companyLogo', logoData);
                    showCustomAlert('Logo uploaded successfully! It will appear on all future invoices. ');
                };
                reader.readAsDataURL(file);
            };
            
            input.click();
        }
        
        // Setup mobile button event listeners as fallback
        function setupMobileButtonListeners() {
            try {
                console.log('Setting up mobile button listeners...');
                
                // Wait for DOM to be ready
                setTimeout(() => {
                    const notesBtn = document.querySelector('.notes-btn');
                    const eventBtn = document.querySelector('.event-btn');
                    const projectsBtn = document.querySelector('.projects-btn');
                    
                    if (notesBtn) {
                        console.log('Adding listener to notes button');
                        notesBtn.addEventListener('click', function(e) {
                            console.log('Notes button clicked via event listener');
                            e.preventDefault();
                            e.stopPropagation();
                            showAddNotesModal();
                        });
                        notesBtn.addEventListener('touchend', function(e) {
                            console.log('Notes button touched via event listener');
                            e.preventDefault();
                            e.stopPropagation();
                            showAddNotesModal();
                        });
                    } else {
                        console.log('Notes button not found');
                    }
                    
                    if (eventBtn) {
                        console.log('Adding listener to event button');
                        eventBtn.addEventListener('click', function(e) {
                            console.log('Event button clicked via event listener');
                            e.preventDefault();
                            e.stopPropagation();
                            showMobileAddEventModal();
                        });
                    }
                    
                    if (projectsBtn) {
                        console.log('Adding listener to projects button');
                        projectsBtn.addEventListener('click', function(e) {
                            console.log('Projects button clicked via event listener');
                            e.preventDefault();
                            e.stopPropagation();
                            showMobileProjectsView();
                        });
                    }
                    
                    console.log('Mobile button listeners setup complete');
                }, 500); // Wait 500ms for DOM to be ready
                
            } catch (error) {
                console.error('Error setting up mobile button listeners:', error);
            }
        }

        // Mobile-specific functions
        let notesAutoSaveTimer = null;
        let currentNoteId = null;
        
        function showAddNotesModal() {
            // Ultra-simple test - just show an alert to confirm function runs
            alert('Add Notes function is working! Building modal...');
            
            try {
                console.log('showAddNotesModal called - working version');
                console.log('Projects available:', Array.isArray(projects) ? projects.length : 'none');
                
                // Create the simplest possible modal
                const modal = document.createElement('div');
                modal.style.position = 'fixed';
                modal.style.top = '0';
                modal.style.left = '0';
                modal.style.right = '0';
                modal.style.bottom = '0';
                modal.style.backgroundColor = 'rgba(0,0,0,0.5)';
                modal.style.zIndex = '9999';
                modal.style.display = 'flex';
                modal.style.alignItems = 'center';
                modal.style.justifyContent = 'center';
                
                const content = document.createElement('div');
                content.style.backgroundColor = 'white';
                content.style.padding = '30px';
                content.style.borderRadius = '20px';
                content.style.maxWidth = '90%';
                content.style.boxShadow = '0 10px 30px rgba(0,0,0,0.3)';
                
                content.innerHTML = `
                    <h2 style="margin:0 0 20px 0;color:#333;">Quick Notes</h2>
                    <p style="color:#666;margin-bottom:20px;">Add your client notes:</p>
                    <textarea placeholder="Type your notes here..." style="width:100%;height:120px;padding:12px;border:2px solid #ddd;border-radius:8px;font-size:16px;"></textarea>
                    <div style="margin-top:20px;text-align:right;">
                        <button onclick="this.closest('div[style*=\"position:fixed\"]').remove()" style="padding:12px 20px;background:#ddd;border:none;border-radius:8px;cursor:pointer;margin-right:10px;">Cancel</button>
                        <button onclick="alert('Note saved!'); this.closest('div[style*=\"position:fixed\"]').remove()" style="padding:12px 20px;background:#007bff;color:white;border:none;border-radius:8px;cursor:pointer;">Save</button>
                    </div>
                `;
                
                modal.appendChild(content);
                document.body.appendChild(modal);
                
                console.log('Modal added to document body');
                
            } catch (error) {
                console.error('Error creating modal:', error);
                alert('Error creating modal: ' + error.message);
            }
                
                // Ensure projects is available and is an array
                if (!projects || !Array.isArray(projects)) {
                    // Try to reload from localStorage
                    projects = JSON.parse(localStorage.getItem('projects') || '[]');
                    window.projects = projects;
                    console.log('Reloaded projects from localStorage:', projects.length);
                }
                
                if (!projects || !Array.isArray(projects) || projects.length === 0) {
                    console.error('No projects available');
                    showCustomAlert('No projects found. Please create a project first, then try adding notes.');
                    return;
                }
                
                const modal = document.createElement('div');
                modal.className = 'modal-overlay';
                
                // Get active projects (all projects that aren't completed)
                const activeProjects = projects.filter(p => !p.status || p.status !== 'completed');
                console.log('Active projects found:', activeProjects.length);
                
                if (activeProjects.length === 0) {
                    showCustomAlert('All projects are completed. Please create a new project first.');
                    return;
                }
                
                modal.innerHTML = `
                    <div class="modal">
                        <div class="modal-header">
                            <h3>Quick Note</h3>
                            <button class="close-modal" onclick="closeNotesModal()"></button>
                        </div>
                        <div class="modal-body">
                            <div class="form-group">
                                <label>Project</label>
                                <select id="notesProjectSelect" onchange="handleProjectSelection()" required>
                                    <option value="">Select project...</option>
                                    ${activeProjects.map(project => 
                                        `<option value="${project.id}">${project.name} - ${project.client}</option>`
                                    ).join('')}
                                </select>
                            </div>
                            <div class="form-group">
                                <label>Notes <span id="autoSaveStatus" style="font-size: 12px; color: var(--text-secondary); margin-left: 10px;"></span></label>
                                <textarea id="notesContent" 
                                          rows="8" 
                                          placeholder="Start typing your notes..." 
                                          oninput="autoSaveNote()"
                                          disabled></textarea>
                            </div>
                            <div style="font-size: 12px; color: var(--text-secondary); margin-top: 10px;">
                                 Today: ${new Date().toLocaleDateString('en-US', { weekday: 'long', year: 'numeric', month: 'long', day: 'numeric' })}
                            </div>
                        </div>
                    </div>
                `;
                document.body.appendChild(modal);
                
                // Focus on project select
                setTimeout(() => {
                    document.getElementById('notesProjectSelect')?.focus();
                }, 100);
                
                console.log('Notes modal created successfully');
            } catch (error) {
                console.error('Error in showAddNotesModal:', error);
                alert('Error opening notes. Please refresh the page and try again.');
            }
        }
        
        function handleProjectSelection() {
            const projectId = document.getElementById('notesProjectSelect').value;
            const notesTextarea = document.getElementById('notesContent');
            
            if (projectId) {
                notesTextarea.disabled = false;
                notesTextarea.focus();
                
                // Create a new note ID for this session
                currentNoteId = Date.now();
            } else {
                notesTextarea.disabled = true;
                currentNoteId = null;
            }
        }
        
        function autoSaveNote() {
            const projectId = document.getElementById('notesProjectSelect').value;
            const content = document.getElementById('notesContent').value;
            const statusElement = document.getElementById('autoSaveStatus');
            
            if (!projectId || !content.trim()) return;
            
            // Show saving status
            statusElement.textContent = ' Saving...';
            statusElement.style.color = 'var(--warning)';
            
            // Clear existing timer
            if (notesAutoSaveTimer) {
                clearTimeout(notesAutoSaveTimer);
            }
            
            // Set new timer for auto-save (save after 1 second of no typing)
            notesAutoSaveTimer = setTimeout(() => {
                saveNoteToProject(projectId, content, false);
            }, 1000);
        }
        
        function saveNoteToProject(projectId, content, showAlert = true) {
            const project = projects.find(p => p.id == projectId);
            if (!project) return;
            
            // Initialize notes array if it doesn't exist
            if (!project.notes) project.notes = [];
            
            // Find existing note with currentNoteId or create new one
            let note = project.notes.find(n => n.id === currentNoteId);
            
            if (note) {
                // Update existing note
                note.content = content;
                note.updatedAt = new Date().toISOString();
            } else {
                // Create new note
                note = {
                    id: currentNoteId,
                    date: new Date().toISOString().split('T')[0],
                    content: content,
                    createdAt: new Date().toISOString(),
                    updatedAt: new Date().toISOString()
                };
                project.notes.push(note);
            }
            
            // Save to storage
            saveProjects();
            
            // Update status
            const statusElement = document.getElementById('autoSaveStatus');
            if (statusElement) {
                statusElement.textContent = ' Saved';
                statusElement.style.color = 'var(--success)';
                
                // Clear status after 2 seconds
                setTimeout(() => {
                    if (statusElement) {
                        statusElement.textContent = '';
                    }
                }, 2000);
            }
            
            if (showAlert) {
                showCustomAlert('Note saved successfully! ');
            }
        }
        
        function closeNotesModal() {
            // Auto-save any pending changes
            const projectId = document.getElementById('notesProjectSelect')?.value;
            const content = document.getElementById('notesContent')?.value;
            
            if (projectId && content && content.trim()) {
                saveNoteToProject(projectId, content, false);
            }
            
            // Clear timer
            if (notesAutoSaveTimer) {
                clearTimeout(notesAutoSaveTimer);
            }
            
            // Reset current note ID
            currentNoteId = null;
            
            // Remove modal
            document.querySelector('.modal-overlay')?.remove();
        }

        // Legacy function for backward compatibility
        function saveProjectNotes() {
            const projectId = document.getElementById('notesProjectSelect').value;
            const content = document.getElementById('notesContent').value;
            
            if (!projectId || !content || !content.trim()) {
                showCustomAlert('Please select a project and enter notes.');
                return;
            }
            
            saveNoteToProject(projectId, content, true);
            closeNotesModal();
        }

        function showMobileAddEventModal() {
            const modal = document.createElement('div');
            modal.className = 'modal-overlay';
            modal.innerHTML = `
                <div class="modal">
                    <div class="modal-header">
                        <h3>Add Event</h3>
                        <button class="close-modal" onclick="this.closest('.modal-overlay').remove()"></button>
                    </div>
                    <div class="modal-body">
                        <div class="form-group">
                            <label>Select Project</label>
                            <select id="eventProjectSelect" required>
                                <option value="">Choose a project...</option>
                                ${projects.map(project => `<option value="${project.id}">${project.name} - ${project.client}</option>`).join('')}
                            </select>
                        </div>
                        <div class="form-group">
                            <label>Event Title</label>
                            <input type="text" id="eventTitle" placeholder="Enter event title" required>
                        </div>
                        <div class="form-group">
                            <label>Date</label>
                            <input type="date" id="eventDate" value="${new Date().toISOString().split('T')[0]}" required>
                        </div>
                        <div class="form-group">
                            <label>Time</label>
                            <input type="time" id="eventTime" value="09:00">
                        </div>
                        <div class="form-group">
                            <label>Event Type</label>
                            <select id="eventType">
                                <option value="meeting">Meeting</option>
                                <option value="consultation">Consultation</option>
                                <option value="design">Design Session</option>
                                <option value="delivery">Delivery</option>
                                <option value="other">Other</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label>Notes (Optional)</label>
                            <textarea id="eventNotes" rows="3" placeholder="Additional notes..."></textarea>
                        </div>
                    </div>
                    <div class="modal-footer">
                        <button class="btn btn-secondary" onclick="this.closest('.modal-overlay').remove()">Cancel</button>
                        <button class="btn btn-primary" onclick="saveMobileEvent()">Create Event</button>
                    </div>
                </div>
            `;
            document.body.appendChild(modal);
        }

        function saveMobileEvent() {
            const projectId = document.getElementById('eventProjectSelect').value;
            const title = document.getElementById('eventTitle').value;
            const date = document.getElementById('eventDate').value;
            const time = document.getElementById('eventTime').value;
            const type = document.getElementById('eventType').value;
            const notes = document.getElementById('eventNotes').value;

            if (!projectId || !title || !date) {
                showCustomAlert('Please fill in all required fields.');
                return;
            }

            const project = projects.find(p => p.id == projectId);
            if (!project) {
                showCustomAlert('Project not found.');
                return;
            }

            if (!project.events) project.events = [];
            
            project.events.push({
                id: Date.now(),
                type: type,
                title: title,
                date: date,
                time: time || '',
                notes: notes || '',
                completed: false
            });

            saveProjects();
            updateEventsCalendar();
            document.querySelector('.modal-overlay').remove();
            showCustomAlert('Event created successfully! ');
        }

        function showMobileProjectsView() {
            const modal = document.createElement('div');
            modal.className = 'modal-overlay mobile-projects-modal';
            modal.innerHTML = `
                <div class="modal mobile-projects-view">
                    <div class="modal-header">
                        <h3>All Projects</h3>
                        <button class="close-modal" onclick="this.closest('.modal-overlay').remove()"></button>
                    </div>
                    <div class="modal-body">
                        <div class="mobile-projects-grid">
                            ${projects.map(project => `
                                <div class="mobile-project-card" onclick="selectMobileProject('${project.id}')">
                                    <h4>${project.name}</h4>
                                    <p>Client: ${project.client}</p>
                                    <div class="status-badge ${project.status || 'active'}">${(project.status || 'active').toUpperCase()}</div>
                                    <div class="project-meta">
                                        <span>Budget: $${project.budget || 0}</span>
                                        <span>Hours: ${project.hoursLogged || 0}</span>
                                    </div>
                                </div>
                            `).join('')}
                        </div>
                    </div>
                </div>
            `;
            document.body.appendChild(modal);
        }

        function selectMobileProject(projectId) {
            // Close the projects modal
            document.querySelector('.modal-overlay').remove();
            
            // Show the selected project (this would open the project details)
            const project = projects.find(p => p.id == projectId);
            if (project) {
                showProjectDetails(project);
            }
        }

        // Other mobile functions
        window.showMobileAddEventModal = function() { alert('Add Event feature coming soon!'); };
        window.showMobileProjectsView = function() { alert('Open Projects feature coming soon!'); };
        
        // Add Notes modal function - defined with other mobile functions
        window.openNotesModal = function() {
            console.log('openNotesModal called');
            alert('Creating notes modal...');
            
            const modal = document.createElement('div');
            modal.style.cssText = 'position:fixed;top:0;left:0;width:100%;height:100%;background:rgba(0,0,0,0.7);z-index:9999;display:flex;align-items:center;justify-content:center;';
            
            modal.innerHTML = `
                <div style="background:white;padding:30px;border-radius:15px;max-width:90%;box-shadow:0 10px 30px rgba(0,0,0,0.3);">
                    <h2 style="margin:0 0 15px 0;color:#333;">Quick Notes</h2>
                    <p style="color:#666;margin-bottom:15px;">Add your notes for this client visit:</p>
                    <textarea placeholder="Type your notes here..." 
                              style="width:100%;height:120px;padding:15px;border:2px solid #ddd;border-radius:8px;font-size:16px;box-sizing:border-box;resize:none;"
                              id="clientNotes"></textarea>
                    <div style="margin-top:20px;text-align:right;">
                        <button onclick="this.closest('div[style*=position]').remove()" 
                                style="padding:12px 20px;background:#999;color:white;border:none;border-radius:8px;cursor:pointer;margin-right:10px;">
                            Cancel
                        </button>
                        <button onclick="alert('Note saved for client visit!'); this.closest('div[style*=position]').remove()" 
                                style="padding:12px 20px;background:#007bff;color:white;border:none;border-radius:8px;cursor:pointer;">
                            Save Note
                        </button>
                    </div>
                </div>
            `;
            
            document.body.appendChild(modal);
            
            // Focus textarea
            setTimeout(() => {
                const textarea = document.getElementById('clientNotes');
                if (textarea) textarea.focus();
            }, 100);
        };
        
        console.log('Kelly Ram Designs - Mobile functions loaded at script start');
        
        // Initialize the app when DOM is loaded
        document.addEventListener('DOMContentLoaded', initializeApp);
        
        // Also call immediately in case DOM is already loaded
        if (document.readyState === 'loading') {
            document.addEventListener('DOMContentLoaded', initializeApp);
        } else {
            initializeApp();
        }
    </script>
</body>
</html>