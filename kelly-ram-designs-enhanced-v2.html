<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Kelly Ram Designs - Enhanced Project Management System v2</title>
    <!-- html2pdf library for PDF generation -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.10.1/html2pdf.bundle.min.js"></script>
    <style>
        /* Import Inter font */
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap');
        
        :root {
            /* Backgrounds */
            --main-bg: #F5F5F4;           /* Soft Warm Gray */
            --section-bg: #EDEAE6;        /* Pale Pebble */
            --card-bg: #F2EFEB;           /* Mist Linen */
            --hover-bg: #E8E4DF;          /* Whisper Beige */
            
            /* Primary & Secondary Branding */
            --primary-brand: #D8A7A7;     /* Dusty Rose */
            --secondary-brand: #9CAEC2;   /* Slate Blue */
            --highlight: #B7C4B2;         /* Sage Green */
            
            /* Section-Specific Colors */
            --dashboard-bg: #EAE0D5;      /* Pale Sandstone */
            --task-bg: #D3DCE6;           /* Powder Blue */
            --calendar-bg: #CBBEDC;       /* Misty Lilac */
            --client-bg: #EED3D3;         /* Blush Nude */
            --media-bg: #D1C9D6;          /* Ash Lavender */
            --finance-bg: #F0E5D8;        /* Champagne Beige */
            
            /* Text & Icons */
            --text-primary: #333333;      /* Charcoal Gray */
            --text-secondary: #666666;    /* Slate Gray */
            --text-tertiary: #A3A3A3;     /* Stone Gray */
            --text-inverse: #FAFAFA;      /* Soft White */
            
            /* Feedback & States */
            --success: #B7C4B2;           /* Sage Green */
            --warning: #D8C690;           /* Muted Gold */
            --error: #E2A39D;             /* Soft Terracotta */
            --info: #9CAEC2;              /* Slate Blue */
            
            /* Additional Variables */
            --dusty-blue: #9CAEC2;        /* Same as secondary-brand */
            --lavender-mist: #CBBEDC;     /* Same as calendar-bg */
            --soft-rose: #D8A7A7;         /* Same as primary-brand */
        }

        body {
            font-family: 'Inter', -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            margin: 0;
            padding: 20px;
            background: var(--main-bg);
            min-height: 100vh;
            color: var(--text-primary);
            font-weight: 400;
            line-height: 1.6;
        }
        
        .container {
            max-width: 1400px;
            margin: 0 auto;
            background: var(--card-bg);
            border-radius: 20px;
            box-shadow: 0 10px 40px rgba(51, 51, 51, 0.06);
            overflow: hidden;
            border: 1px solid var(--section-bg);
        }
        
        .header {
            background: linear-gradient(135deg, var(--primary-brand), var(--secondary-brand));
            color: var(--text-inverse);
            padding: 30px;
            text-align: center;
            position: relative;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 20px;
        }
        
        .logo {
            width: 60px;
            height: 60px;
            background: var(--card-bg);
            border-radius: 8px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: 700;
            color: var(--text-primary);
            font-size: 24px;
            box-shadow: 0 4px 15px rgba(51, 51, 51, 0.15);
        }
        
        .logo svg {
            width: 40px;
            height: 40px;
            fill: var(--text-primary);
        }
        
        .header-text {
            text-align: left;
        }
        
        .header h1 {
            margin: 0 0 5px 0;
            font-size: 2.2em;
            font-weight: 500;
            letter-spacing: 2px;
            color: var(--text-primary);
        }
        
        .header p {
            margin: 0;
            opacity: 0.8;
            font-size: 1.1em;
            font-weight: 300;
        }
        
        .tabs {
            display: flex;
            background: var(--section-bg);
        }
        
        .tab {
            flex: 1;
            padding: 18px 15px;
            text-align: center;
            cursor: pointer;
            transition: all 0.3s ease;
            border: none;
            background: transparent;
            font-size: 15px;
            font-weight: 500;
            color: var(--text-secondary);
        }
        
        .tab.active {
            background: var(--card-bg);
            color: var(--text-primary);
            border-radius: 15px 15px 0 0;
            transform: translateY(-2px);
            box-shadow: 0 -4px 20px rgba(51, 51, 51, 0.12);
            font-weight: 600;
        }
        
        .tab:hover:not(.active) {
            background: var(--hover-bg);
            transform: translateY(-1px);
        }
        
        .tab-content {
            display: none;
            padding: 40px;
            background: var(--card-bg);
        }
        
        .tab-content.active {
            display: block;
        }
        
        .btn {
            background: linear-gradient(135deg, var(--secondary-brand), var(--info));
            color: var(--text-inverse);
            padding: 12px 25px;
            border: none;
            border-radius: 25px;
            cursor: pointer;
            font-size: 14px;
            font-weight: 500;
            font-family: 'Inter', sans-serif;
            transition: all 0.3s ease;
            box-shadow: 0 4px 15px rgba(156, 174, 194, 0.25);
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }
        
        .btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 25px rgba(168, 200, 216, 0.4);
        }
        
        .btn-success {
            background: linear-gradient(135deg, var(--success), var(--highlight));
        }
        
        .btn-coral {
            background: linear-gradient(135deg, var(--primary-brand), var(--client-bg));
        }
        
        .btn-small {
            padding: 8px 16px;
            font-size: 12px;
        }
        
        .card {
            background: var(--card-bg);
            border-radius: 16px;
            padding: 25px;
            box-shadow: 0 4px 20px rgba(51, 51, 51, 0.06);
            margin-bottom: 25px;
            border: 1px solid var(--section-bg);
        }
        
        .card p {
            font-size: 16px;
            margin-bottom: 14px;
            line-height: 1.5;
        }
        
        .card strong {
            font-size: 18px;
            font-weight: 600;
            color: var(--text-primary);
            letter-spacing: 0.3px;
        }
        
        .two-column {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 30px;
        }
        
        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(180px, 1fr));
            gap: 15px;
            margin-bottom: 25px;
        }
        
        .stat-card {
            background: linear-gradient(135deg, var(--dashboard-bg), var(--card-bg));
            border-radius: 12px;
            padding: 18px;
            text-align: center;
            box-shadow: 0 2px 12px rgba(51, 51, 51, 0.06);
            border: 1px solid var(--section-bg);
        }
        
        .stat-value {
            font-size: 2em;
            font-weight: 700;
            color: var(--text-primary);
            margin-bottom: 6px;
        }
        
        .stat-label {
            font-size: 12px;
            color: var(--text-secondary);
            text-transform: uppercase;
            letter-spacing: 1px;
            font-weight: 600;
        }
        
        .project-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(350px, 1fr));
            gap: 25px;
            margin-bottom: 30px;
        }
        
        .project-card {
            background: linear-gradient(135deg, var(--client-bg), var(--card-bg));
            border-radius: 16px;
            padding: 25px;
            box-shadow: 0 4px 20px rgba(51, 51, 51, 0.08);
            border: 1px solid var(--section-bg);
            cursor: pointer;
            transition: all 0.3s ease;
        }
        
        .project-card:hover {
            transform: translateY(-3px);
            box-shadow: 0 8px 30px rgba(51, 51, 51, 0.12);
        }
        
        /* Section-Specific Tab Content Styling */
        #dashboard .tab-content {
            background: linear-gradient(135deg, var(--dashboard-bg), var(--main-bg));
        }
        
        #projects .tab-content {
            background: linear-gradient(135deg, var(--task-bg), var(--main-bg));
        }
        
        #reports .tab-content {
            background: linear-gradient(135deg, var(--finance-bg), var(--main-bg));
        }
        
        /* Typography Improvements */
        h1, h2, h3, h4, h5, h6 {
            font-family: 'Inter', sans-serif;
            font-weight: 600;
            line-height: 1.4;
        }
        
        input, textarea, select, button {
            font-family: 'Inter', sans-serif;
        }
        
        .custom-alert {
            font-family: 'Inter', sans-serif;
        }
        
        .project-header {
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
            margin-bottom: 15px;
        }
        
        .project-title {
            font-size: 18px;
            font-weight: 700;
            color: var(--text-primary);
            margin: 0;
        }
        
        .project-status {
            padding: 6px 12px;
            border-radius: 20px;
            font-size: 11px;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }
        
        .status-consultation { background: linear-gradient(135deg, #e67e22, #d35400); color: white; }
        .status-design { background: linear-gradient(135deg, #3498db, #2980b9); color: white; }
        .status-sourcing { background: linear-gradient(135deg, #9b59b6, #8e44ad); color: white; }
        .status-ordering { background: linear-gradient(135deg, #f39c12, #e67e22); color: white; }
        .status-delivery { background: linear-gradient(135deg, #16a085, #1abc9c); color: white; }
        .status-completed { background: linear-gradient(135deg, #27ae60, #2ecc71); color: white; }
        
        .project-client {
            margin-bottom: 15px;
            font-size: 15px;
            color: var(--text-secondary);
        }
        
        .project-meta {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-top: 15px;
            font-size: 13px;
            color: var(--text-secondary);
        }
        
        .project-value {
            font-weight: 700;
            color: var(--text-primary);
            font-size: 14px;
        }
        
        .form-group {
            margin-bottom: 20px;
        }
        
        label {
            display: block;
            margin-bottom: 8px;
            font-weight: 500;
            color: var(--text-primary);
            font-size: 14px;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }
        
        input, textarea, select {
            width: 100%;
            padding: 12px;
            border: 2px solid var(--section-bg);
            border-radius: 12px;
            font-size: 15px;
            transition: all 0.3s ease;
            background: var(--card-bg);
            color: var(--text-primary);
        }
        
        input:focus, textarea:focus, select:focus {
            border-color: var(--secondary-brand);
            outline: none;
            box-shadow: 0 0 0 3px rgba(168, 200, 216, 0.2);
        }
        
        .modal {
            display: none;
            position: fixed;
            z-index: 1000;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            background: rgba(45, 43, 40, 0.8);
            backdrop-filter: blur(5px);
        }
        
        .modal-content {
            background: var(--card-bg);
            margin: 2% auto;
            padding: 0;
            border-radius: 20px;
            width: 95%;
            max-width: 1200px;
            max-height: 90vh;
            overflow-y: auto;
            box-shadow: 0 20px 60px rgba(45, 43, 40, 0.3);
        }
        
        .modal-header {
            background: linear-gradient(135deg, var(--dusty-blue), var(--lavender-mist));
            padding: 30px;
            border-radius: 20px 20px 0 0;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        
        .modal-body {
            padding: 40px;
        }
        
        .close {
            color: var(--text-primary);
            font-size: 28px;
            font-weight: bold;
            cursor: pointer;
            transition: color 0.3s;
        }
        
        .close:hover {
            color: var(--text-secondary);
        }
        
        .project-tabs {
            display: flex;
            margin-bottom: 30px;
            border-bottom: 2px solid var(--soft-rose);
            width: 100%;
        }
        
        .project-tab {
            flex: 1;
            padding: 18px 24px;
            cursor: pointer;
            border: none;
            background: none;
            color: var(--text-secondary);
            font-size: 18px;
            font-weight: 600;
            border-bottom: 3px solid transparent;
            text-align: center;
            transition: all 0.3s ease;
            white-space: nowrap;
        }
        
        .project-tab.active {
            color: var(--text-primary);
            border-bottom-color: var(--secondary-brand);
        }
        
        .project-section {
            display: none;
        }
        
        .project-section.active {
            display: block;
        }
        
        .section-header {
            background: var(--task-bg);
            padding: 15px 20px;
            border-radius: 10px;
            margin: 10px 0;
            cursor: pointer;
            display: flex;
            justify-content: space-between;
            align-items: center;
            transition: all 0.3s ease;
        }
        
        .section-header:hover {
            background: var(--lavender-mist);
        }
        
        .section-content {
            display: none;
            padding: 20px;
            background: rgba(255,255,255,0.5);
            border-radius: 0 0 10px 10px;
            margin-bottom: 15px;
        }
        
        .section-content.expanded {
            display: block;
        }
        
        .item-grid {
            display: grid;
            grid-template-columns: 2fr 0.8fr 1fr 1fr 0.8fr 0.8fr 1fr 1fr auto;
            gap: 12px;
            align-items: center;
            padding: 12px;
            background: var(--card-bg);
            border-radius: 8px;
            margin-bottom: 10px;
            border: 1px solid var(--section-bg);
            font-size: 14px;
        }
        
        .item-grid.header {
            background: var(--task-bg);
            font-weight: 600;
            color: var(--text-primary);
            margin-bottom: 15px;
        }
        
        .custom-alert {
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background: var(--card-bg);
            border: 2px solid var(--gentle-blue);
            border-radius: 16px;
            padding: 30px;
            box-shadow: 0 20px 60px rgba(45, 43, 40, 0.3);
            z-index: 2000;
            max-width: 400px;
            width: 90%;
            max-height: 70vh;
            overflow-y: auto;
            text-align: center;
        }
        
        .custom-alert-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(45, 43, 40, 0.7);
            backdrop-filter: blur(5px);
            z-index: 1999;
        }
        
        .upcoming-event {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 12px 15px;
            background: rgba(255,255,255,0.7);
            border-radius: 8px;
            margin-bottom: 10px;
            border-left: 4px solid var(--gentle-blue);
        }
        
        @media print {
            body * { visibility: hidden; }
            .invoice-preview, .invoice-preview * { visibility: visible; }
            .invoice-preview { position: absolute; left: 0; top: 0; width: 100%; }
            .btn { display: none !important; }
        }
        
        @media (max-width: 768px) {
            .project-grid, .two-column, .stats-grid {
                grid-template-columns: 1fr;
            }
            .item-grid {
                grid-template-columns: 1fr;
                gap: 10px;
            }
            .project-tabs {
                flex-wrap: wrap;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <div class="logo">
                <svg viewBox="0 0 400 300" xmlns="http://www.w3.org/2000/svg">
                    <!-- House/Building Icon inspired by the logo -->
                    <g stroke="currentColor" stroke-width="6" fill="none">
                        <!-- Main building structure -->
                        <path d="M50 250 L50 150 L120 100 L190 150 L190 250 Z"/>
                        <path d="M210 250 L210 170 L280 120 L350 170 L350 250 Z"/>
                        <!-- Rooflines -->
                        <path d="M30 150 L120 90 L210 150"/>
                        <path d="M190 170 L280 110 L370 170"/>
                        <!-- Vertical support lines -->
                        <line x1="80" y1="130" x2="80" y2="250"/>
                        <line x1="160" y1="130" x2="160" y2="250"/>
                        <line x1="240" y1="150" x2="240" y2="250"/>
                        <line x1="320" y1="150" x2="320" y2="250"/>
                        <!-- Horizontal foundation lines -->
                        <line x1="30" y1="250" x2="370" y2="250"/>
                    </g>
                </svg>
            </div>
            <div class="header-text">
                <h1>Kelly Ram Designs</h1>
                <p>Professional Project Management System</p>
            </div>
        </div>
        
        <div class="tabs">
            <button class="tab active" onclick="showTab('dashboard')">Dashboard</button>
            <button class="tab" onclick="showTab('projects')">Projects</button>
            <button class="tab" onclick="showTab('reports')">Reports</button>
        </div>

        <!-- Dashboard Tab -->
        <div id="dashboard" class="tab-content active">
            <h2 style="margin-bottom: 30px; color: var(--text-primary); font-weight: 300;">Business Overview</h2>
            
            <div class="stats-grid">
                <div class="stat-card">
                    <div class="stat-value" id="activeProjectsStat">0</div>
                    <div class="stat-label">Active Projects</div>
                </div>
                <div class="stat-card">
                    <div class="stat-value" id="totalRevenueStat">$0</div>
                    <div class="stat-label">Total Profit</div>
                </div>
                <div class="stat-card">
                    <div class="stat-value" id="totalPaidHoursStat">0</div>
                    <div class="stat-label">Total Paid Hours</div>
                </div>
                <div class="stat-card">
                    <div class="stat-value" id="totalProjectsStat">0</div>
                    <div class="stat-label">Total Projects</div>
                </div>
            </div>

            <div class="two-column">
                <div class="card">
                    <h3 style="margin-top: 0; color: var(--text-primary);">Upcoming Events</h3>
                    <div id="upcomingEvents">
                        <p style="color: var(--text-secondary);">No upcoming events.</p>
                    </div>
                </div>
                <div class="card">
                    <h3 style="margin-top: 0; color: var(--text-primary);">Quick Actions</h3>
                    <button class="btn btn-success" onclick="openNewProjectModal()" style="width: 100%; margin-bottom: 15px;">New Project</button>
                    <button class="btn btn-coral" onclick="showTab('projects')" style="width: 100%; margin-bottom: 15px;">View All Projects</button>
                    <button class="btn" onclick="addQuickEvent()" style="width: 100%; margin-bottom: 15px;">Quick Add Event</button>
                </div>
            </div>
        </div>

        <!-- Projects Tab -->
        <div id="projects" class="tab-content">
            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 30px;">
                <div>
                    <h2 style="margin: 0; color: var(--text-primary); font-weight: 300;">Projects</h2>
                    <div style="margin-top: 10px; display: flex; gap: 10px; align-items: center;">
                        <input type="text" id="projectSearch" placeholder="Search projects..." style="padding: 8px 12px; border: 2px solid var(--section-bg); border-radius: 20px; width: 250px; font-size: 14px;" onkeyup="filterProjects()">
                        <select id="statusFilter" onchange="filterProjects()" style="padding: 8px 12px; border: 2px solid var(--section-bg); border-radius: 12px;">
                            <option value="active">Active Only</option>
                            <option value="">All Status</option>
                            <option value="consultation">Consultation</option>
                            <option value="design">Design</option>
                            <option value="sourcing">Sourcing</option>
                            <option value="ordering">Ordering</option>
                            <option value="delivery">Delivery</option>
                            <option value="completed">Completed</option>
                        </select>
                    </div>
                </div>
                <div>
                    <button class="btn" onclick="duplicateProject()" style="margin-right: 10px;">Duplicate Last</button>
                    <button class="btn btn-success" onclick="openNewProjectModal()">Create New Project</button>
                </div>
            </div>
            
            <div class="project-grid" id="projectGrid">
                <!-- Projects will be populated here -->
            </div>
        </div>

        <!-- Reports Tab -->
        <div id="reports" class="tab-content">
            <h2 style="color: var(--text-primary); font-weight: 300; margin-bottom: 30px;">Business Reports</h2>
            
            <div class="two-column" style="margin-bottom: 30px;">
                <div class="card">
                    <h3 style="margin-top: 0; color: var(--text-primary);">Client Reports</h3>
                    <button class="btn btn-success" onclick="generateClientListReport()" style="width: 100%; margin-bottom: 10px;">Client List</button>
                    <button class="btn" onclick="generateClientContactReport()" style="width: 100%; margin-bottom: 10px;">Client Contacts</button>
                    <button class="btn" onclick="generateProjectsByClientReport()" style="width: 100%;">Projects by Client</button>
                </div>
                <div class="card">
                    <h3 style="margin-top: 0; color: var(--text-primary);">Item Reports</h3>
                    <button class="btn btn-coral" onclick="generateAllItemsReport()" style="width: 100%; margin-bottom: 10px;">All Items</button>
                    <button class="btn" onclick="generateOrderedItemsReport()" style="width: 100%; margin-bottom: 10px;">Items Ordered</button>
                    <button class="btn" onclick="generatePendingItemsReport()" style="width: 100%;">Pending Orders</button>
                </div>
            </div>
            
            <div class="two-column">
                <div class="card">
                    <h3 style="margin-top: 0; color: var(--text-primary);">Time Reports</h3>
                    <button class="btn" onclick="generateHoursWorkedReport()" style="width: 100%; margin-bottom: 10px;">Hours Worked</button>
                    <button class="btn" onclick="generateTimelineReport()" style="width: 100%; margin-bottom: 10px;">Project Timeline</button>
                    <button class="btn" onclick="generateProductivityReport()" style="width: 100%;">Productivity Summary</button>
                </div>
                <div class="card">
                    <h3 style="margin-top: 0; color: var(--text-primary);">Financial Reports</h3>
                    <button class="btn" onclick="generateRevenueReport()" style="width: 100%; margin-bottom: 10px;">Revenue Summary</button>
                    <button class="btn" onclick="generateOutstandingReport()" style="width: 100%; margin-bottom: 10px;">Outstanding Payments</button>
                    <button class="btn" onclick="generateProfitabilityReport()" style="width: 100%;">Project Profitability</button>
                </div>
            </div>
            
            <div class="card" style="margin-top: 30px;">
                <h3 style="margin-top: 0; color: var(--text-primary);">Generated Report</h3>
                <div id="reportDisplay">
                    <p style="color: var(--text-secondary); text-align: center; padding: 40px;">Select a report type above to generate and view results.</p>
                </div>
            </div>
        </div>
    </div>

    <!-- New/Edit Project Modal -->
    <div id="projectModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2 id="modalTitle" style="margin: 0; color: var(--text-primary);">Create New Project</h2>
                <span class="close" onclick="closeProjectModal()">&times;</span>
            </div>
            <div class="modal-body">
                <div class="two-column">
                    <div>
                        <div class="form-group">
                            <label for="projectName">Project Name:</label>
                            <input type="text" id="projectName" required>
                        </div>
                        <div class="form-group">
                            <label for="clientName">Client Name:</label>
                            <input type="text" id="clientName" required>
                        </div>
                        <div class="form-group">
                            <label for="clientEmail">Client Email:</label>
                            <input type="email" id="clientEmail" placeholder="client@example.com">
                        </div>
                        <div class="form-group">
                            <label for="clientPhone">Client Phone:</label>
                            <input type="tel" id="clientPhone" placeholder="(555) 123-4567">
                        </div>
                        <div class="form-group">
                            <label for="clientAddress">Client Address:</label>
                            <textarea id="clientAddress" rows="2" placeholder="Full address"></textarea>
                        </div>
                    </div>
                    <div>
                        <div class="form-group">
                            <label for="projectStatus">Project Status:</label>
                            <select id="projectStatus">
                                <option value="consultation">Consultation</option>
                                <option value="design">Design Phase</option>
                                <option value="sourcing">Sourcing</option>
                                <option value="ordering">Ordering</option>
                                <option value="delivery">Delivery</option>
                                <option value="completed">Completed</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label for="startDate">Start Date:</label>
                            <input type="date" id="startDate">
                        </div>
                        <div class="form-group">
                            <label for="budget">Budget (Optional):</label>
                            <input type="number" id="budget" step="0.01" placeholder="Leave blank if no budget">
                        </div>
                        <div class="form-group">
                            <label for="hourlyRate">Hourly Rate:</label>
                            <input type="number" id="hourlyRate" step="0.01" value="75" placeholder="75.00">
                        </div>
                        <div class="form-group">
                            <label for="hoursPaid">Hours Paid:</label>
                            <input type="number" id="hoursPaid" step="0.25" value="10" placeholder="Hours client paid for">
                        </div>
                        <div class="form-group">
                            <label for="projectNotes">Notes:</label>
                            <textarea id="projectNotes" rows="3"></textarea>
                        </div>
                    </div>
                </div>
                
                <div style="margin-top: 30px;">
                    <button class="btn btn-success" onclick="saveProject()">Save Project</button>
                    <button class="btn" onclick="closeProjectModal()" style="margin-left: 15px;">Cancel</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Project Detail Modal -->
    <div id="projectDetailModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <div>
                    <h2 id="projectDetailTitle" style="margin: 0; color: var(--text-primary);">Project Details</h2>
                    <span id="projectDetailClient" style="color: var(--text-secondary); font-size: 16px;"></span>
                </div>
                <span class="close" onclick="closeProjectDetailModal()">&times;</span>
            </div>
            <div class="modal-body">
                <div class="project-tabs">
                    <button class="project-tab active" onclick="showProjectSection('overview', this)">Details</button>
                    <button class="project-tab" onclick="showProjectSection('items', this)">Items</button>
                    <button class="project-tab" onclick="showProjectSection('orders', this)">Orders</button>
                    <button class="project-tab" onclick="showProjectSection('moodboards', this)">Mood Boards</button>
                    <button class="project-tab" onclick="showProjectSection('invoice', this)">Invoice</button>
                </div>

                <!-- Project Details Section -->
                <div id="overview" class="project-section active">
                    <!-- Top Priority: Client Info, Hours & Quick Actions in compact layout -->
                    <div style="display: grid; grid-template-columns: 2fr 1fr 1.5fr; gap: 20px; margin-bottom: 20px;">
                        <div class="card">
                            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px;">
                                <h4 style="margin: 0; font-size: 16px;">Client Info</h4>
                                <button class="btn btn-small btn-coral" onclick="editProjectInfo()">✏️ Edit</button>
                            </div>
                            <p style="margin: 8px 0; font-size: 14px;"><strong>Client:</strong> <span id="detailClientName"></span></p>
                            <p style="margin: 8px 0; font-size: 14px;"><strong>Email:</strong> <span id="detailClientEmail"></span></p>
                            <p style="margin: 8px 0; font-size: 14px;"><strong>Phone:</strong> <span id="detailClientPhone"></span></p>
                            <p style="margin: 8px 0; font-size: 14px;"><strong>Address:</strong> <span id="detailClientAddress"></span></p>
                            <p style="margin: 8px 0; font-size: 14px;"><strong>Status:</strong> <span id="detailStatus"></span></p>
                            <p style="margin: 8px 0; font-size: 14px;"><strong>Start Date:</strong> <span id="detailStartDate"></span></p>
                            <p style="margin: 8px 0; font-size: 14px;"><strong>Budget:</strong> <span id="detailBudget"></span></p>
                        </div>
                        
                        <div class="card">
                            <h4 style="margin: 0 0 10px 0; font-size: 16px;">Hours</h4>
                            <div style="text-align: center; padding: 12px; background: var(--task-bg); border-radius: 8px; margin-bottom: 10px;">
                                <div style="font-size: 20px; font-weight: 700; color: var(--text-primary);" id="detailHoursWorked">0</div>
                                <div style="font-size: 11px; color: var(--text-secondary);">Worked</div>
                            </div>
                            <div style="text-align: center; padding: 12px; background: var(--info); border-radius: 8px; margin-bottom: 10px;">
                                <div style="font-size: 20px; font-weight: 700; color: var(--text-primary);" id="detailHoursPaid">0</div>
                                <div style="font-size: 11px; color: var(--text-secondary);">Paid Hours</div>
                            </div>
                            <div style="text-align: center; padding: 12px; background: var(--success); border-radius: 8px;">
                                <div style="font-size: 20px; font-weight: 700; color: var(--text-primary);" id="detailHoursRemaining">0</div>
                                <div style="font-size: 11px; color: var(--text-secondary);">Remaining</div>
                            </div>
                        </div>

                        <div class="card">
                            <h4 style="margin: 0 0 10px 0; font-size: 16px;">Quick Actions</h4>
                            <button class="btn btn-success" onclick="addEvent()" style="margin: 4px 0; width: 100%; padding: 10px 15px; font-size: 14px;">📅 Add Event</button>
                            <button class="btn btn-coral" onclick="showProjectSection('invoice', this)" style="margin: 4px 0; width: 100%; padding: 10px 15px; font-size: 14px;">📄 Generate Invoice</button>
                            <button class="btn" onclick="logProjectHours()" style="margin: 4px 0; width: 100%; padding: 10px 15px; font-size: 14px;">⏰ Log Hours</button>
                            <button class="btn" onclick="addPaidHours()" style="margin: 4px 0; width: 100%; padding: 10px 15px; font-size: 14px; background: linear-gradient(135deg, var(--primary-brand), var(--client-bg)); color: white;">💰 Add Paid Hours</button>
                        </div>
                    </div>

                    <!-- Upcoming Events only -->
                    <div class="card" style="margin-top: 20px;">
                        <h4 style="margin-top: 0; font-size: 16px;">Upcoming Events</h4>
                        <div id="projectUpcomingEvents"></div>
                    </div>
                    
                    <!-- Project Notes -->
                    <div class="card" style="margin-top: 20px;">
                        <h4 style="margin: 0 0 10px 0; font-size: 16px;">Project Notes</h4>
                        <p id="detailNotes" style="font-size: 14px; line-height: 1.5; color: var(--text-secondary);"></p>
                    </div>
                </div>

                <!-- Items Section -->
                <div id="items" class="project-section">
                    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
                        <h3 style="margin: 0; color: var(--text-primary);">Project Items</h3>
                        <div>
                            <button class="btn btn-success" onclick="addNewSection()">Add Section</button>
                            <button class="btn btn-coral" onclick="importItemsCSV()">Import CSV</button>
                            <button class="btn" onclick="downloadCSVTemplate()" style="background: var(--secondary-brand); color: white;">Download Template</button>
                        </div>
                    </div>
                    
                    <div id="projectSections">
                        <!-- Sections will be populated here -->
                    </div>
                </div>

                <!-- Orders Section -->
                <div id="orders" class="project-section">
                    <h3 style="margin-bottom: 20px; color: var(--text-primary);">Orders & Delivery Tracking</h3>
                    
                    <!-- Order Summary with Progress Bar -->
                    <div class="card" style="margin-bottom: 20px;">
                        <h4 style="margin-top: 0;">Delivery Progress</h4>
                        <div id="orderProgressBar" style="background: var(--section-bg); border-radius: 10px; height: 20px; margin: 10px 0; overflow: hidden;">
                            <div id="deliveryProgress" style="height: 100%; background: linear-gradient(90deg, var(--success), var(--highlight)); border-radius: 10px; transition: width 0.3s ease; width: 0%;"></div>
                        </div>
                        <div id="orderSummaryText" style="text-align: center; font-size: 14px; color: var(--text-secondary);"></div>
                        
                        <div style="display: grid; grid-template-columns: repeat(4, 1fr); gap: 10px; margin-top: 15px;">
                            <div style="text-align: center; padding: 10px; background: var(--warning); border-radius: 8px;">
                                <div style="font-weight: bold; font-size: 18px;" id="pendingCount">0</div>
                                <div style="font-size: 12px;">Pending</div>
                            </div>
                            <div style="text-align: center; padding: 10px; background: var(--info); border-radius: 8px;">
                                <div style="font-weight: bold; font-size: 18px;" id="orderedCount">0</div>
                                <div style="font-size: 12px;">Ordered</div>
                            </div>
                            <div style="text-align: center; padding: 10px; background: var(--secondary-brand); border-radius: 8px;">
                                <div style="font-weight: bold; font-size: 18px;" id="shippedCount">0</div>
                                <div style="font-size: 12px;">Shipped</div>
                            </div>
                            <div style="text-align: center; padding: 10px; background: var(--success); border-radius: 8px;">
                                <div style="font-weight: bold; font-size: 18px;" id="deliveredCount">0</div>
                                <div style="font-size: 12px;">Delivered</div>
                            </div>
                        </div>
                    </div>
                    
                    <div id="readyToOrderItems">
                        <!-- Ready to order items will be populated here -->
                    </div>
                </div>

                <!-- Mood Boards Section -->
                <div id="moodboards" class="project-section">
                    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
                        <h3 style="margin: 0; color: var(--text-primary);">Mood Boards</h3>
                        <button class="btn btn-success" onclick="uploadMoodBoard()">Upload Mood Board</button>
                    </div>
                    <div id="moodBoardGallery">
                        <!-- Mood boards will be populated here -->
                    </div>
                </div>

                <!-- Invoice Section -->
                <div id="invoice" class="project-section">
                    <div style="margin-bottom: 30px;">
                        <h3 style="margin: 0 0 15px 0; color: var(--text-primary);">Generate Invoices by Section</h3>
                        <p style="margin: 0 0 20px 0; color: var(--text-secondary); font-size: 14px;">Create separate invoices for each project section/category. This allows for flexible billing and payment tracking.</p>
                        
                        <div id="sectionInvoiceList" style="display: grid; gap: 15px;">
                            <!-- Section invoice options will be populated here -->
                        </div>
                    </div>
                    
                    <div class="invoice-preview" id="projectInvoicePreview">
                        <!-- Invoice preview will be populated here -->
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        // Sample data with enhanced structure
        let projects = JSON.parse(localStorage.getItem('projects') || '[]');
        let currentProject = null;
        let invoiceCounter = parseInt(localStorage.getItem('invoiceCounter') || '1204');
        
        // Migrate old project format to new pricing structure
        function migrateOldProjects() {
            let needsSaving = false;
            projects.forEach(project => {
                if (project.sections) {
                    project.sections.forEach(section => {
                        section.items.forEach(item => {
                            // If item has old 'price' field but no 'customerPrice', migrate it
                            if (item.price && !item.customerPrice) {
                                item.customerPrice = item.price;
                                item.wholesalePrice = item.price * 0.7; // Estimate 30% markup
                                item.shipping = 0;
                                item.tax = 0;
                                needsSaving = true;
                            }
                        });
                    });
                }
            });
            if (needsSaving) {
                localStorage.setItem('projects', JSON.stringify(projects));
            }
        }

        // Add sample project with enhanced data if none exist
        if (projects.length === 0) {
            projects = [{
                id: 1,
                name: "Modern Office Redesign",
                client: "Mitchel Pisarz",
                clientEmail: "mitchel@example.com",
                clientPhone: "(555) 123-4567",
                clientAddress: "123 Business Ave, Suite 100\nNew York, NY 10001",
                status: "ordering",
                startDate: "2025-01-01",
                budget: 2500,
                hoursPaid: 20,
                hoursWorked: 12.5,
                notes: "Complete office transformation with modern aesthetic",
                sections: [
                    {
                        id: 1,
                        name: "Reception Area",
                        items: [
                            { id: 1, name: "Reception Desk", qty: 1, customerPrice: 899.00, wholesalePrice: 650.00, shipping: 75.00, tax: 67.43, link: "https://example.com/desk", readyToOrder: true, orderStatus: "pending" },
                            { id: 2, name: "Waiting Chairs", qty: 4, customerPrice: 249.00, wholesalePrice: 175.00, shipping: 25.00, tax: 79.84, link: "https://example.com/chairs", readyToOrder: false, orderStatus: "pending" }
                        ]
                    },
                    {
                        id: 2,
                        name: "Conference Room",
                        items: [
                            { id: 3, name: "Conference Table", qty: 1, customerPrice: 1299.00, wholesalePrice: 950.00, shipping: 125.00, tax: 113.99, link: "https://example.com/table", readyToOrder: true, orderStatus: "pending" },
                            { id: 4, name: "Conference Chairs", qty: 8, customerPrice: 189.00, wholesalePrice: 135.00, shipping: 15.00, tax: 12.32, link: "https://example.com/conf-chairs", readyToOrder: true, orderStatus: "pending" }
                        ]
                    }
                ],
                events: [
                    { id: 1, type: "consultation", title: "Initial Consultation", date: "2025-01-01", time: "10:00", notes: "Discussed client needs", completed: true },
                    { id: 2, type: "design", title: "Design Presentation", date: "2025-01-15", time: "14:00", notes: "Presented concepts", completed: true },
                    { id: 3, type: "meeting", title: "Final Review", date: "2025-01-30", time: "11:00", notes: "Final design approval", completed: false }
                ],
                hoursLog: [
                    { id: 1, date: "2025-01-01", hours: 2, description: "Initial consultation and space assessment" },
                    { id: 2, date: "2025-01-10", hours: 4, description: "Research and design development" },
                    { id: 3, date: "2025-01-15", hours: 3, description: "Design presentation preparation" },
                    { id: 4, date: "2025-01-20", hours: 2.5, description: "Client feedback and revisions" },
                    { id: 5, date: "2025-01-25", hours: 1, description: "Vendor coordination" }
                ],
                moodBoards: [],
                invoiceNumber: "011204",
                amountPaid: 0
            }];
            localStorage.setItem('projects', JSON.stringify(projects));
        }

        function showTab(tabName) {
            document.querySelectorAll('.tab-content').forEach(tab => {
                tab.classList.remove('active');
            });
            document.querySelectorAll('.tab').forEach(tab => {
                tab.classList.remove('active');
            });

            document.getElementById(tabName).classList.add('active');
            event.target.classList.add('active');

            if (tabName === 'dashboard') {
                updateDashboard();
                updateUpcomingEvents();
            } else if (tabName === 'projects') {
                displayProjects();
            }
        }

        function updateDashboard() {
            const totalProjects = projects.length;
            const activeProjects = projects.filter(p => p.status !== 'completed').length;
            
            let totalProfit = 0;
            let totalPaidHours = 0;
            
            projects.forEach(project => {
                const hourlyRate = project.hourlyRate || 75;
                const hoursWorked = project.hoursWorked || 0;
                const hoursPaid = project.hoursPaid || 0;
                
                // Profit from hours: paid hours * hourly rate
                const hourProfit = hoursPaid * hourlyRate;
                totalProfit += hourProfit;
                
                // Profit from items: (customer price - wholesale price) * quantity
                if (project.sections) {
                    project.sections.forEach(section => {
                        section.items.forEach(item => {
                            const customerPrice = item.customerPrice || item.price || 0;
                            const wholesalePrice = item.wholesalePrice || 0;
                            const markup = (customerPrice - wholesalePrice) * (item.qty || 1);
                            totalProfit += markup;
                        });
                    });
                }
                
                totalPaidHours += hoursPaid;
            });

            document.getElementById('totalProjectsStat').textContent = totalProjects;
            document.getElementById('totalRevenueStat').textContent = `$${totalProfit.toLocaleString('en-US', { minimumFractionDigits: 0, maximumFractionDigits: 0 })}`;
            document.getElementById('totalPaidHoursStat').textContent = `${totalPaidHours.toFixed(1)}h`;
            document.getElementById('activeProjectsStat').textContent = activeProjects;
        }

        function updateUpcomingEvents() {
            const upcomingDiv = document.getElementById('upcomingEvents');
            const upcomingEvents = [];
            
            projects.forEach(project => {
                if (project.events) {
                    project.events.forEach(event => {
                        const eventDate = new Date(event.date);
                        const today = new Date();
                        if (eventDate >= today && !event.completed) {
                            upcomingEvents.push({...event, projectName: project.name, clientName: project.client});
                        }
                    });
                }
            });
            
            upcomingEvents.sort((a, b) => new Date(a.date) - new Date(b.date));
            
            if (upcomingEvents.length === 0) {
                upcomingDiv.innerHTML = '<p style="color: var(--text-secondary);">No upcoming events.</p>';
            } else {
                upcomingDiv.innerHTML = upcomingEvents.slice(0, 5).map(event => `
                    <div class="upcoming-event">
                        <div>
                            <div style="font-weight: 600; color: var(--text-primary);">${event.title}</div>
                            <div style="font-size: 13px; color: var(--text-secondary);">${event.projectName} - ${event.clientName}</div>
                        </div>
                        <div style="text-align: right;">
                            <div style="font-size: 13px; color: var(--text-primary);">${new Date(event.date).toLocaleDateString()}</div>
                            <div style="font-size: 12px; color: var(--text-secondary);">${event.time || 'No time set'}</div>
                        </div>
                    </div>
                `).join('');
            }
        }

        function displayProjects() {
            // Set default filter to active projects only
            document.getElementById('statusFilter').value = 'active';
            filterProjects();
        }

        function filterProjects() {
            const searchTerm = document.getElementById('projectSearch').value.toLowerCase();
            const statusFilter = document.getElementById('statusFilter').value;
            
            const grid = document.getElementById('projectGrid');
            grid.innerHTML = '';
            
            const filteredProjects = projects.filter(project => {
                const matchesSearch = !searchTerm || 
                    project.name.toLowerCase().includes(searchTerm) || 
                    project.client.toLowerCase().includes(searchTerm);
                    
                let matchesStatus = true;
                if (statusFilter === 'active') {
                    matchesStatus = project.status !== 'completed';
                } else if (statusFilter) {
                    matchesStatus = project.status === statusFilter;
                }
                
                return matchesSearch && matchesStatus;
            });
            
            filteredProjects.forEach(project => {
                let projectTotal = 0;
                if (project.sections) {
                    project.sections.forEach(section => {
                        section.items.forEach(item => {
                            projectTotal += item.price * item.qty;
                        });
                    });
                }
                
                const card = document.createElement('div');
                card.className = 'project-card';
                
                // Set innerHTML FIRST, then add event listeners
                card.innerHTML = `
                    <div class="project-header" style="position: relative;">
                        <h3 class="project-title">${project.name}</h3>
                        <div style="display: flex; align-items: center; gap: 10px;">
                            <span class="project-status status-${project.status}">${project.status}</span>
                            <button class="project-open-btn" data-project-id="${project.id}"
                                    style="background: var(--primary-brand); color: white; border: none; border-radius: 6px; padding: 6px 12px; font-size: 12px; cursor: pointer; font-weight: 500;"
                                    title="Open Project">Open</button>
                            <button class="project-delete-btn" data-project-id="${project.id}"
                                    style="background: var(--error); color: white; border: none; border-radius: 50%; width: 24px; height: 24px; font-size: 12px; cursor: pointer; display: flex; align-items: center; justify-content: center;"
                                    title="Delete Project">×</button>
                        </div>
                    </div>
                    <div class="project-client" style="margin-bottom: 15px; font-size: 15px; color: var(--text-secondary);">Client: ${project.client}</div>
                    
                    <div style="background: rgba(255,255,255,0.7); padding: 15px; border-radius: 10px; margin-bottom: 15px;">
                        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 8px;">
                            <span style="color: var(--text-secondary); font-size: 14px;">Hours Progress</span>
                            <span style="font-weight: 700; font-size: 16px; color: ${(project.hoursPaid || 0) - (project.hoursWorked || 0) > 0 ? '#27ae60' : '#e74c3c'};">Remaining: ${((project.hoursPaid || 0) - (project.hoursWorked || 0)).toFixed(1)}h</span>
                        </div>
                        <div style="display: flex; justify-content: space-between; font-size: 15px; margin-bottom: 10px;">
                            <span style="color: var(--text-primary);"><strong>Worked:</strong> ${(project.hoursWorked || 0).toFixed(1)}h</span>
                            <span style="color: var(--text-secondary);"><strong>Paid:</strong> ${(project.hoursPaid || 0).toFixed(1)}h</span>
                        </div>
                        
                        <!-- Delivery Progress Section -->
                        ${(() => {
                            const readyItems = [];
                            let deliveredCount = 0;
                            if (project.sections) {
                                project.sections.forEach(section => {
                                    section.items.forEach(item => {
                                        if (item.readyToOrder) {
                                            readyItems.push(item);
                                            if (item.orderStatus === 'delivered') deliveredCount++;
                                        }
                                    });
                                });
                            }
                            const deliveryPercentage = readyItems.length > 0 ? (deliveredCount / readyItems.length) * 100 : 0;
                            return readyItems.length > 0 ? `
                                <div style="margin-top: 8px;">
                                    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 4px;">
                                        <span style="color: var(--text-secondary); font-size: 12px;">Delivery Progress</span>
                                        <span style="color: var(--text-secondary); font-size: 12px;">${deliveredCount}/${readyItems.length} delivered</span>
                                    </div>
                                    <div style="background: #e0e0e0; border-radius: 6px; height: 6px; overflow: hidden;">
                                        <div style="height: 100%; background: linear-gradient(90deg, #27ae60, #2ecc71); border-radius: 6px; width: ${deliveryPercentage}%; transition: width 0.3s ease;"></div>
                                    </div>
                                </div>
                            ` : '';
                        })()}
                    </div>
                    
                    <div class="project-meta">
                        <span style="color: var(--text-secondary); font-size: 13px;">Started: ${new Date(project.startDate).toLocaleDateString()}</span>
                        <span class="project-value">$${projectTotal.toLocaleString('en-US', { minimumFractionDigits: 2, maximumFractionDigits: 2 })}</span>
                    </div>
                `;
                
                // Add event listeners AFTER innerHTML is set
                const openBtn = card.querySelector('.project-open-btn');
                const deleteBtn = card.querySelector('.project-delete-btn');
                
                openBtn.addEventListener('click', (e) => {
                    e.stopPropagation();
                    openProjectDetail(project.id);
                });
                
                deleteBtn.addEventListener('click', (e) => {
                    e.stopPropagation();
                    deleteProject(project.id);
                });
                
                // Also allow clicking anywhere on the card (except buttons)
                card.addEventListener('click', (e) => {
                    if (!e.target.closest('button')) {
                        openProjectDetail(project.id);
                    }
                });
                
                grid.appendChild(card);
            });
            
            if (filteredProjects.length === 0) {
                grid.innerHTML = '<p style="text-align: center; color: var(--text-secondary); grid-column: 1 / -1; padding: 40px;">No projects found matching your criteria.</p>';
            }
        }

        function openNewProjectModal() {
            document.getElementById('modalTitle').textContent = 'Create New Project';
            document.getElementById('projectModal').style.display = 'block';
            currentProject = null;
            
            // Reset form with smart defaults
            document.getElementById('projectName').value = '';
            document.getElementById('clientName').value = '';
            document.getElementById('clientEmail').value = '';
            document.getElementById('clientPhone').value = '';
            document.getElementById('clientAddress').value = '';
            document.getElementById('projectStatus').value = 'consultation';
            document.getElementById('startDate').valueAsDate = new Date();
            document.getElementById('budget').value = '';
            document.getElementById('hoursPaid').value = '10';
            document.getElementById('projectNotes').value = '';
        }

        function closeProjectModal() {
            document.getElementById('projectModal').style.display = 'none';
        }

        function saveProject() {
            const project = {
                id: currentProject ? currentProject.id : Date.now(),
                name: document.getElementById('projectName').value,
                client: document.getElementById('clientName').value,
                clientEmail: document.getElementById('clientEmail').value,
                clientPhone: document.getElementById('clientPhone').value,
                clientAddress: document.getElementById('clientAddress').value,
                status: document.getElementById('projectStatus').value,
                startDate: document.getElementById('startDate').value,
                budget: parseFloat(document.getElementById('budget').value) || null,
                hourlyRate: parseFloat(document.getElementById('hourlyRate').value) || 75,
                hoursPaid: parseFloat(document.getElementById('hoursPaid').value) || 0,
                hoursWorked: currentProject ? (currentProject.hoursWorked || 0) : 0,
                notes: document.getElementById('projectNotes').value,
                sections: currentProject ? (currentProject.sections || []) : [],
                events: currentProject ? (currentProject.events || []) : [],
                hoursLog: currentProject ? (currentProject.hoursLog || []) : [],
                moodBoards: currentProject ? (currentProject.moodBoards || []) : [],
                invoiceNumber: currentProject ? currentProject.invoiceNumber : (++invoiceCounter).toString().padStart(6, '0'),
                amountPaid: currentProject ? currentProject.amountPaid : 0
            };
            
            const isNewProject = !currentProject;

            if (currentProject) {
                const index = projects.findIndex(p => p.id === currentProject.id);
                projects[index] = project;
            } else {
                projects.push(project);
            }

            localStorage.setItem('projects', JSON.stringify(projects));
            localStorage.setItem('invoiceCounter', invoiceCounter.toString());
            
            closeProjectModal();
            displayProjects();
            updateDashboard();
            
            // If this is a new project, automatically open it for the user
            if (isNewProject) {
                // Ensure projects list is updated first
                displayProjects();
                
                // Use requestAnimationFrame for better timing
                requestAnimationFrame(() => {
                    setTimeout(() => {
                        try {
                            openProjectDetail(project.id);
                        } catch (error) {
                            console.error('Error auto-opening project:', error);
                            showCustomAlert('Project saved! Click on the project card to open it.');
                        }
                    }, 150);
                });
            }
            
            showCustomAlert('Project saved successfully! ✨');
        }

        function deleteProject(projectId) {
            const project = projects.find(p => p.id === projectId);
            if (!project) return;
            
            showCustomPrompt(
                'Delete Project',
                [
                    { type: 'text', name: 'confirmation', label: `Type "delete" to confirm deletion of "${project.name}"`, required: true, placeholder: 'Type delete' }
                ],
                (data) => {
                    if (data.confirmation.toLowerCase() !== 'delete') {
                        showCustomAlert('Please type "delete" to confirm. Deletion cancelled.');
                        return;
                    }
                    
                    const index = projects.findIndex(p => p.id === projectId);
                    if (index !== -1) {
                        projects.splice(index, 1);
                        localStorage.setItem('projects', JSON.stringify(projects));
                        
                        displayProjects();
                        updateDashboard();
                        
                        showCustomAlert(`Project "${project.name}" deleted successfully.`);
                    }
                }
            );
        }

        function openProjectDetail(projectId) {
            try {
                const project = projects.find(p => p.id === projectId);
                if (!project) {
                    showCustomAlert('Project not found. Please refresh the page and try again.');
                    return;
                }
                
                currentProject = project;
                
                // Check if required elements exist before accessing them
                const titleElement = document.getElementById('projectDetailTitle');
                const clientElement = document.getElementById('projectDetailClient');
                
                if (titleElement) titleElement.textContent = project.name;
                if (clientElement) clientElement.textContent = `Client: ${project.client}`;
                
                // Populate project details with safety checks
                const safeSetText = (id, value) => {
                    const element = document.getElementById(id);
                    if (element) element.textContent = value;
                };
                
                safeSetText('detailClientName', project.client);
                safeSetText('detailClientEmail', project.clientEmail || 'Not provided');
                safeSetText('detailClientPhone', project.clientPhone || 'Not provided');
                safeSetText('detailClientAddress', project.clientAddress || 'Not provided');
                safeSetText('detailStatus', project.status);
                safeSetText('detailStartDate', new Date(project.startDate).toLocaleDateString());
                safeSetText('detailBudget', project.budget ? `$${project.budget.toLocaleString('en-US', { minimumFractionDigits: 2, maximumFractionDigits: 2 })}` : 'No budget set');
                safeSetText('detailHoursWorked', `${(project.hoursWorked || 0).toFixed(1)}h`);
                safeSetText('detailHoursPaid', `${(project.hoursPaid || 0).toFixed(1)}h`);
                safeSetText('detailHoursRemaining', `${((project.hoursPaid || 0) - (project.hoursWorked || 0)).toFixed(1)}h`);
                safeSetText('detailNotes', project.notes || 'No notes available.');
            
                showProjectSection('overview');
                updateProjectSections();
                updateProjectHours();
                updateProjectUpcomingEvents();
                
                const modal = document.getElementById('projectDetailModal');
                if (modal) {
                    modal.style.display = 'block';
                } else {
                    throw new Error('Project detail modal not found');
                }
                
            } catch (error) {
                console.error('Error opening project detail:', error);
                showCustomAlert('Error opening project details. Please try again.');
            }
        }
        
        // Function to edit project information
        function editProjectInfo() {
            if (!currentProject) return;
            
            showCustomPrompt(
                'Edit Project Information',
                [
                    { type: 'text', name: 'client', label: 'Client Name', required: true, defaultValue: currentProject.client },
                    { type: 'email', name: 'clientEmail', label: 'Client Email', defaultValue: currentProject.clientEmail || '' },
                    { type: 'tel', name: 'clientPhone', label: 'Client Phone', defaultValue: currentProject.clientPhone || '' },
                    { type: 'textarea', name: 'clientAddress', label: 'Client Address', defaultValue: currentProject.clientAddress || '' },
                    { type: 'number', name: 'hourlyRate', label: 'Hourly Rate ($)', step: '0.01', defaultValue: currentProject.hourlyRate || '75', placeholder: '75.00' },
                    { type: 'select', name: 'status', label: 'Project Status', options: [
                        { value: 'consultation', text: 'Consultation' },
                        { value: 'planning', text: 'Planning' },
                        { value: 'design', text: 'Design' },
                        { value: 'ordering', text: 'Ordering' },
                        { value: 'delivery', text: 'Delivery' },
                        { value: 'completed', text: 'Completed' }
                    ], defaultValue: currentProject.status },
                    { type: 'date', name: 'startDate', label: 'Start Date', defaultValue: currentProject.startDate },
                    { type: 'number', name: 'budget', label: 'Budget (Optional)', step: '0.01', defaultValue: currentProject.budget || '' }
                ],
                (data) => {
                    // Update the current project
                    currentProject.client = data.client;
                    currentProject.clientEmail = data.clientEmail;
                    currentProject.clientPhone = data.clientPhone;
                    currentProject.clientAddress = data.clientAddress;
                    currentProject.hourlyRate = data.hourlyRate ? parseFloat(data.hourlyRate) : 75;
                    currentProject.status = data.status;
                    currentProject.startDate = data.startDate;
                    currentProject.budget = data.budget ? parseFloat(data.budget) : null;
                    
                    saveCurrentProject();
                    
                    // Refresh the project detail view with updated information
                    document.getElementById('detailClientName').textContent = currentProject.client;
                    document.getElementById('detailClientEmail').textContent = currentProject.clientEmail || 'Not provided';
                    document.getElementById('detailClientPhone').textContent = currentProject.clientPhone || 'Not provided';
                    document.getElementById('detailStatus').textContent = currentProject.status;
                    document.getElementById('detailBudget').textContent = currentProject.budget ? `$${currentProject.budget.toLocaleString('en-US', { minimumFractionDigits: 2, maximumFractionDigits: 2 })}` : 'No budget set';
                    
                    displayProjects(); // Refresh the projects list
                    showCustomAlert('Project information updated successfully! ✨');
                }
            );
        }

        function closeProjectDetailModal() {
            document.getElementById('projectDetailModal').style.display = 'none';
            currentProject = null;
        }

        function showProjectSection(sectionName, element) {
            document.querySelectorAll('.project-section').forEach(section => {
                section.classList.remove('active');
            });
            document.querySelectorAll('.project-tab').forEach(tab => {
                tab.classList.remove('active');
            });
            
            document.getElementById(sectionName).classList.add('active');
            
            // Use the passed element or find the clicked tab
            if (element) {
                element.classList.add('active');
            } else {
                // Fallback: find the tab by section name
                const tabButton = document.querySelector(`button.project-tab[onclick*="${sectionName}"]`);
                if (tabButton) tabButton.classList.add('active');
            }
            
            if (sectionName === 'items') {
                updateProjectSections();
            } else if (sectionName === 'orders') {
                updateReadyToOrderItems();
            } else if (sectionName === 'moodboards') {
                updateMoodBoards();
            } else if (sectionName === 'invoice') {
                updateSectionInvoiceList();
            }
        }

        function updateProjectSections() {
            if (!currentProject) return;
            
            const container = document.getElementById('projectSections');
            container.innerHTML = '';
            
            if (!currentProject.sections || currentProject.sections.length === 0) {
                container.innerHTML = '<p style="color: var(--text-secondary); text-align: center; padding: 20px;">No sections yet. Add your first section above!</p>';
                return;
            }
            
            currentProject.sections.forEach((section, sectionIndex) => {
                const sectionDiv = document.createElement('div');
                sectionDiv.innerHTML = `
                    <div class="section-header">
                        <div onclick="toggleSection(${sectionIndex})" style="cursor: pointer; flex-grow: 1; display: flex; align-items: center;">
                            <strong>${section.name}</strong>
                            <span style="color: var(--text-secondary); margin-left: 10px;">(${section.items.length} items)</span>
                        </div>
                        <div style="display: flex; align-items: center; gap: 20px;">
                            <div style="display: flex; align-items: center; gap: 10px; padding: 8px 16px; background: rgba(255,255,255,0.7); border-radius: 20px; cursor: pointer; font-size: 13px; font-weight: 500; color: var(--text-primary); border: 1px solid var(--section-bg);" onclick="event.stopPropagation(); toggleAllSectionItems(${sectionIndex}, ${!section.items.every(item => item.readyToOrder)})">
                                <div style="width: 18px; height: 18px; border-radius: 50%; border: 2px solid var(--success); background: ${section.items.every(item => item.readyToOrder) ? 'var(--success)' : 'transparent'}; display: flex; align-items: center; justify-content: center; color: white; font-size: 12px; font-weight: bold;">
                                    ${section.items.every(item => item.readyToOrder) ? '✓' : ''}
                                </div>
                                <span style="text-transform: uppercase; letter-spacing: 0.5px;">
                                    ${section.items.every(item => item.readyToOrder) ? 'All Ready ✨' : 'Mark All Ready'}
                                </span>
                            </div>
                            <div onclick="toggleSection(${sectionIndex})" style="cursor: pointer; font-weight: 600; color: var(--text-primary);">
                                $${section.items.reduce((sum, item) => sum + (item.price * item.qty), 0).toLocaleString('en-US', { minimumFractionDigits: 2, maximumFractionDigits: 2 })}
                            </div>
                        </div>
                    </div>
                    <div class="section-content" id="section-${sectionIndex}">
                        <div class="item-grid header">
                            <div>Item Name</div>
                            <div>Qty</div>
                            <div>Cost<br><small style="opacity: 0.7;">(Wholesale)</small></div>
                            <div>Sell Price<br><small style="opacity: 0.7;">(Per Unit)</small></div>
                            <div>Shipping<br><small style="opacity: 0.7;">($)</small></div>
                            <div>Tax<br><small style="opacity: 0.7;">($)</small></div>
                            <div>Customer Total<br><small style="opacity: 0.7;">(Final Price)</small></div>
                            <div>Product Link</div>
                            <div>Order Status</div>
                        </div>
                        ${section.items.map((item, itemIndex) => `
                            <div class="item-grid">
                                <div>
                                    <div style="font-weight: 600; color: var(--text-primary);">${item.name}</div>
                                </div>
                                <div>
                                    <input type="number" value="${item.qty}" min="1" 
                                           onchange="updateItemQuantity(${sectionIndex}, ${itemIndex}, this.value)"
                                           style="width: 50px; padding: 4px 6px; border: 1px solid var(--section-bg); border-radius: 4px; text-align: center; font-size: 13px;">
                                </div>
                                <div>
                                    <input type="number" value="${item.wholesalePrice || 0}" step="0.01" min="0"
                                           onchange="updateItemWholesalePrice(${sectionIndex}, ${itemIndex}, this.value)"
                                           style="width: 70px; padding: 4px 6px; border: 1px solid var(--section-bg); border-radius: 4px; text-align: right; font-size: 13px;"
                                           placeholder="$0.00">
                                </div>
                                <div>
                                    <input type="number" value="${item.customerPrice || item.price || 0}" step="0.01" min="0"
                                           onchange="updateItemCustomerPrice(${sectionIndex}, ${itemIndex}, this.value)"
                                           style="width: 70px; padding: 4px 6px; border: 1px solid var(--section-bg); border-radius: 4px; text-align: right; font-size: 13px;"
                                           placeholder="$0.00">
                                </div>
                                <div>
                                    <input type="number" value="${item.shipping || 0}" step="0.01" min="0"
                                           onchange="updateItemShipping(${sectionIndex}, ${itemIndex}, this.value)"
                                           style="width: 50px; padding: 4px 6px; border: 1px solid var(--section-bg); border-radius: 4px; text-align: right; font-size: 13px;"
                                           placeholder="$0.00">
                                </div>
                                <div>
                                    <input type="number" value="${item.tax || 0}" step="0.01" min="0"
                                           onchange="updateItemTax(${sectionIndex}, ${itemIndex}, this.value)"
                                           style="width: 50px; padding: 4px 6px; border: 1px solid var(--section-bg); border-radius: 4px; text-align: right; font-size: 13px;"
                                           placeholder="$0.00">
                                </div>
                                <div>
                                    <span style="font-weight: 600; color: var(--text-primary);">
                                        $${(((item.customerPrice || item.price || 0) * item.qty) + (item.shipping || 0) + (item.tax || 0)).toFixed(2)}
                                    </span>
                                </div>
                                <div>
                                    ${item.link ? 
                                        `<div style="display: flex; align-items: center; gap: 4px;">
                                            <a href="${item.link}" target="_blank" style="color: var(--secondary-brand); text-decoration: none; font-weight: 500; font-size: 12px;">🔗 View</a>
                                            <button onclick="editItemLink(${sectionIndex}, ${itemIndex})" style="background: none; border: 1px solid var(--section-bg); border-radius: 3px; padding: 1px 4px; font-size: 10px; cursor: pointer;" title="Edit Link">✏️</button>
                                        </div>` :
                                        `<button onclick="editItemLink(${sectionIndex}, ${itemIndex})" style="background: var(--section-bg); border: 1px solid var(--section-bg); border-radius: 4px; padding: 4px 8px; font-size: 11px; cursor: pointer; color: var(--text-secondary);">+ Add Link</button>`
                                    }
                                </div>
                                <div>
                                    <button onclick="toggleReadyToOrder(${sectionIndex}, ${itemIndex}, ${!item.readyToOrder})" 
                                            style="
                                                background: ${item.readyToOrder ? 'linear-gradient(135deg, var(--success), var(--highlight))' : 'linear-gradient(135deg, #f8f9fa, #e9ecef)'};
                                                border: 2px solid ${item.readyToOrder ? 'var(--success)' : 'var(--section-bg)'};
                                                color: ${item.readyToOrder ? 'white' : 'var(--text-secondary)'};
                                                padding: 4px 8px;
                                                border-radius: 12px;
                                                font-size: 11px;
                                                font-weight: 600;
                                                cursor: pointer;
                                                transition: all 0.3s ease;
                                                text-transform: uppercase;
                                                letter-spacing: 0.3px;
                                                box-shadow: 0 1px 4px rgba(0,0,0,0.1);
                                            "
                                            onmouseover="this.style.transform='translateY(-1px)'; this.style.boxShadow='0 2px 8px rgba(0,0,0,0.2)'"
                                            onmouseout="this.style.transform='translateY(0px)'; this.style.boxShadow='0 1px 4px rgba(0,0,0,0.1)'">
                                        ${item.readyToOrder ? '✓ READY' : 'Mark Ready'}
                                    </button>
                                </div>
                            </div>
                        `).join('')}
                        <div style="margin-top: 15px;">
                            <button class="btn btn-success" onclick="addItemToSection(${sectionIndex})">Add Item to ${section.name}</button>
                        </div>
                    </div>
                `;
                container.appendChild(sectionDiv);
            });
        }

        function toggleSection(sectionIndex) {
            const content = document.getElementById(`section-${sectionIndex}`);
            content.classList.toggle('expanded');
        }

        function addNewSection() {
            if (!currentProject) return;
            
            showCustomPrompt(
                'Add New Section',
                [
                    { type: 'text', name: 'sectionName', label: 'Section Name', required: true, placeholder: 'e.g., Living Room, Kitchen, Bedroom' }
                ],
                (data) => {
                    if (!currentProject.sections) currentProject.sections = [];
                    
                    currentProject.sections.push({
                        id: Date.now(),
                        name: data.sectionName,
                        items: []
                    });
                    
                    saveCurrentProject();
                    updateProjectSections();
                    showCustomAlert('Section added successfully! ✨');
                }
            );
        }

        function addItemToSection(sectionIndex) {
            showCustomPrompt(
                'Add New Item',
                [
                    { type: 'text', name: 'itemName', label: 'Item Name', required: true, placeholder: 'e.g. Sofa, Chair, Table...' },
                    { type: 'number', name: 'quantity', label: 'Quantity', required: true, defaultValue: '1' },
                    { type: 'number', name: 'wholesalePrice', label: 'Your Cost (Wholesale Price)', step: '0.01', placeholder: '0.00' },
                    { type: 'number', name: 'customerPrice', label: 'Sell Price (What Customer Pays Per Unit)', step: '0.01', required: true },
                    { type: 'number', name: 'shipping', label: 'Shipping Cost', step: '0.01', placeholder: '0.00' },
                    { type: 'number', name: 'tax', label: 'Tax Amount', step: '0.01', placeholder: '0.00' },
                    { type: 'url', name: 'link', label: 'Product Website Link', placeholder: 'https://store.com/product-page' }
                ],
                (data) => {
                    const customerPrice = parseFloat(data.customerPrice) || 0;
                    currentProject.sections[sectionIndex].items.push({
                        id: Date.now(),
                        name: data.itemName,
                        qty: parseInt(data.quantity) || 1,
                        price: customerPrice, // Keep for backward compatibility
                        customerPrice: customerPrice,
                        wholesalePrice: parseFloat(data.wholesalePrice) || 0,
                        shipping: parseFloat(data.shipping) || 0,
                        tax: parseFloat(data.tax) || 0,
                        link: data.link || '',
                        readyToOrder: false,
                        orderStatus: 'pending'
                    });
                    
                    saveCurrentProject();
                    updateProjectSections();
                    showCustomAlert('Item added successfully! ✨');
                }
            );
        }

        function toggleReadyToOrder(sectionIndex, itemIndex, isReady) {
            currentProject.sections[sectionIndex].items[itemIndex].readyToOrder = isReady;
            saveCurrentProject();
            updateReadyToOrderItems();
            updateProjectSections(); // Refresh to update the "Select All" checkbox state
        }
        
        // New function to toggle all items in a section
        function toggleAllSectionItems(sectionIndex, markAsReady) {
            currentProject.sections[sectionIndex].items.forEach(item => {
                item.readyToOrder = markAsReady;
            });
            saveCurrentProject();
            updateProjectSections();
            updateReadyToOrderItems();
            showCustomAlert(markAsReady ? 'All items in section marked as ready to order!' : 'All items in section unmarked from ready to order!');
        }
        
        // New function to update item quantity inline
        function updateItemQuantity(sectionIndex, itemIndex, newQuantity) {
            const qty = parseInt(newQuantity);
            if (qty > 0) {
                currentProject.sections[sectionIndex].items[itemIndex].qty = qty;
                saveCurrentProject();
                updateProjectSections();
                updateReadyToOrderItems();
            }
        }
        
        // Update functions for item pricing fields
        function updateItemPriceInline(sectionIndex, itemIndex, newPrice) {
            const price = parseFloat(newPrice);
            if (price >= 0) {
                currentProject.sections[sectionIndex].items[itemIndex].price = price;
                // Also update customer price if not set
                if (!currentProject.sections[sectionIndex].items[itemIndex].customerPrice) {
                    currentProject.sections[sectionIndex].items[itemIndex].customerPrice = price;
                }
                saveCurrentProject();
                updateProjectSections();
                updateReadyToOrderItems();
            }
        }
        
        function updateItemWholesalePrice(sectionIndex, itemIndex, newPrice) {
            const price = parseFloat(newPrice) || 0;
            currentProject.sections[sectionIndex].items[itemIndex].wholesalePrice = price;
            saveCurrentProject();
            updateProjectSections();
        }
        
        function updateItemCustomerPrice(sectionIndex, itemIndex, newPrice) {
            const price = parseFloat(newPrice) || 0;
            currentProject.sections[sectionIndex].items[itemIndex].customerPrice = price;
            saveCurrentProject();
            updateProjectSections();
            updateReadyToOrderItems();
        }
        
        function updateItemShipping(sectionIndex, itemIndex, newShipping) {
            const shipping = parseFloat(newShipping) || 0;
            currentProject.sections[sectionIndex].items[itemIndex].shipping = shipping;
            saveCurrentProject();
            updateProjectSections();
        }
        
        function updateItemTax(sectionIndex, itemIndex, newTax) {
            const tax = parseFloat(newTax) || 0;
            currentProject.sections[sectionIndex].items[itemIndex].tax = tax;
            saveCurrentProject();
            updateProjectSections();
        }
        
        // Function to edit item link with prompt
        function editItemLink(sectionIndex, itemIndex) {
            const currentLink = currentProject.sections[sectionIndex].items[itemIndex].link || '';
            
            showCustomPrompt(
                'Edit Item Link',
                [
                    { type: 'url', name: 'link', label: 'Link URL', placeholder: 'https://example.com/product', defaultValue: currentLink }
                ],
                (data) => {
                    currentProject.sections[sectionIndex].items[itemIndex].link = data.link;
                    saveCurrentProject();
                    showProjectSection('items'); // Refresh the items view
                    showCustomAlert('Link updated successfully! ✨');
                }
            );
        }

        function updateReadyToOrderItems() {
            if (!currentProject) return;
            
            const container = document.getElementById('readyToOrderItems');
            const readyItems = [];
            
            // Collect all ready to order items
            if (currentProject.sections) {
                currentProject.sections.forEach((section, sectionIndex) => {
                    section.items.forEach((item, itemIndex) => {
                        if (item.readyToOrder) {
                            readyItems.push({...item, sectionIndex, itemIndex, sectionName: section.name});
                        }
                    });
                });
            }
            
            // Update progress bar and counters
            updateOrderProgress(readyItems);
            
            if (readyItems.length === 0) {
                container.innerHTML = '<p style="color: var(--text-secondary); text-align: center; padding: 20px;">No items ready to order yet. Go to the Items tab and click "Mark Ready" on items you want to order.</p>';
                return;
            }
            
            container.innerHTML = `
                <div class="item-grid header">
                    <div>Item / Section</div>
                    <div>Quantity</div>
                    <div>Price</div>
                    <div>Status</div>
                    <div>Actions</div>
                </div>
                ${readyItems.map((item, index) => `
                    <div class="item-grid">
                        <div>
                            <strong>${item.name}</strong>
                            <div style="font-size: 12px; color: var(--text-secondary);">${item.sectionName}</div>
                            <div style="font-size: 12px;">
                                <a href="${item.link}" target="_blank" style="color: var(--secondary-brand);">View Link</a>
                            </div>
                        </div>
                        <div>${item.qty}</div>
                        <div>
                            <input type="number" value="${item.price}" step="0.01" 
                                   onchange="updateItemPrice(${item.sectionIndex}, ${item.itemIndex}, this.value)"
                                   style="width: 80px; padding: 4px;">
                        </div>
                        <div>
                            <select onchange="updateOrderStatus(${item.sectionIndex}, ${item.itemIndex}, this.value)"
                                    style="padding: 4px;">
                                <option value="pending" ${item.orderStatus === 'pending' ? 'selected' : ''}>Pending</option>
                                <option value="ordered" ${item.orderStatus === 'ordered' ? 'selected' : ''}>Ordered</option>
                                <option value="shipped" ${item.orderStatus === 'shipped' ? 'selected' : ''}>Shipped</option>
                                <option value="delivered" ${item.orderStatus === 'delivered' ? 'selected' : ''}>Delivered</option>
                            </select>
                        </div>
                        <div>
                            <button class="btn btn-small" onclick="removeFromReadyToOrder(${item.sectionIndex}, ${item.itemIndex})">Remove from Orders</button>
                        </div>
                    </div>
                `).join('')}
                <div style="margin-top: 30px; padding: 20px; background: var(--warm-cream); border-radius: 12px; border: 2px solid var(--section-bg);">
                    <div style="text-align: right; font-size: 20px; font-weight: 600; color: var(--text-primary);">
                        Total Amount to Order: $${readyItems.reduce((total, item) => total + (item.price * item.qty), 0).toLocaleString('en-US', { minimumFractionDigits: 2, maximumFractionDigits: 2 })}
                    </div>
                </div>
            `;
        }

        function updateItemPrice(sectionIndex, itemIndex, newPrice) {
            currentProject.sections[sectionIndex].items[itemIndex].price = parseFloat(newPrice);
            saveCurrentProject();
            updateReadyToOrderItems();
            updateProjectSections();
        }

        function updateOrderStatus(sectionIndex, itemIndex, status) {
            currentProject.sections[sectionIndex].items[itemIndex].orderStatus = status;
            saveCurrentProject();
            updateReadyToOrderItems(); // Refresh to update progress
            showCustomAlert(`Order status updated to "${status}"!`);
        }
        
        function updateOrderProgress(readyItems) {
            let pendingCount = 0;
            let orderedCount = 0; 
            let shippedCount = 0;
            let deliveredCount = 0;
            
            readyItems.forEach(item => {
                const status = item.orderStatus || 'pending';
                switch(status) {
                    case 'pending': pendingCount++; break;
                    case 'ordered': orderedCount++; break; 
                    case 'shipped': shippedCount++; break;
                    case 'delivered': deliveredCount++; break;
                }
            });
            
            const total = readyItems.length;
            const deliveredPercentage = total > 0 ? (deliveredCount / total) * 100 : 0;
            
            // Update progress bar
            document.getElementById('deliveryProgress').style.width = `${deliveredPercentage}%`;
            
            // Update counters
            document.getElementById('pendingCount').textContent = pendingCount;
            document.getElementById('orderedCount').textContent = orderedCount;
            document.getElementById('shippedCount').textContent = shippedCount;
            document.getElementById('deliveredCount').textContent = deliveredCount;
            
            // Update summary text
            const summaryText = total > 0 
                ? `${deliveredCount} of ${total} items delivered (${deliveredPercentage.toFixed(0)}%)`
                : 'No items to track';
            document.getElementById('orderSummaryText').textContent = summaryText;
        }

        function removeFromReadyToOrder(sectionIndex, itemIndex) {
            currentProject.sections[sectionIndex].items[itemIndex].readyToOrder = false;
            saveCurrentProject();
            updateReadyToOrderItems();
            updateProjectSections();
            showCustomAlert('Item removed from orders.');
        }

        function updateProjectHours() {
            if (!currentProject) return;
            
            const hoursWorked = currentProject.hoursWorked || 0;
            const hoursRemaining = (currentProject.hoursPaid || 0) - hoursWorked;
            
            // Update only the elements that exist in the current UI (detailHoursWorked and detailHoursRemaining)
            const hoursWorkedDisplay = document.getElementById('detailHoursWorked');
            const hoursRemainingDisplay = document.getElementById('detailHoursRemaining');
            
            if (hoursWorkedDisplay) {
                hoursWorkedDisplay.textContent = `${hoursWorked.toFixed(1)}h`;
            }
            if (hoursRemainingDisplay) {
                hoursRemainingDisplay.textContent = `${hoursRemaining.toFixed(1)}h`;
            }
        }

        function logProjectHours() {
            if (!currentProject) return;
            
            showCustomPrompt(
                'Log Hours',
                [
                    { type: 'number', name: 'hours', label: 'Hours Worked', step: '0.25', required: true, placeholder: 'e.g. 2.5' },
                    { type: 'date', name: 'date', label: 'Date', required: true, defaultValue: new Date().toISOString().split('T')[0] },
                    { type: 'textarea', name: 'description', label: 'Description', required: true, placeholder: 'What did you work on?' }
                ],
                (data) => {
                    const hours = parseFloat(data.hours);
                    if (isNaN(hours) || hours <= 0) {
                        showCustomAlert('Please enter valid hours.');
                        return;
                    }
                    
                    if (!currentProject.hoursLog) currentProject.hoursLog = [];
                    
                    currentProject.hoursLog.push({
                        id: Date.now(),
                        date: data.date,
                        hours: hours,
                        description: data.description
                    });
                    
                    currentProject.hoursWorked = (currentProject.hoursWorked || 0) + hours;
                    
                    saveCurrentProject();
                    updateProjectHours();
                    updateDashboard();
                    displayProjects();
                    
                    showCustomAlert(`Logged ${hours} hours successfully! ✨`);
                }
            );
        }

        function updateProjectUpcomingEvents() {
            if (!currentProject) return;
            
            const container = document.getElementById('projectUpcomingEvents');
            const upcomingEvents = [];
            
            if (currentProject.events) {
                currentProject.events.forEach(event => {
                    const eventDate = new Date(event.date);
                    const today = new Date();
                    if (eventDate >= today && !event.completed) {
                        upcomingEvents.push(event);
                    }
                });
            }
            
            upcomingEvents.sort((a, b) => new Date(a.date) - new Date(b.date));
            
            if (upcomingEvents.length === 0) {
                container.innerHTML = '<p style="color: var(--text-secondary);">No upcoming events for this project.</p>';
            } else {
                container.innerHTML = upcomingEvents.map(event => `
                    <div class="upcoming-event">
                        <div>
                            <div style="font-weight: 600; color: var(--text-primary);">${event.title}</div>
                            <div style="font-size: 13px; color: var(--text-secondary);">${event.notes}</div>
                        </div>
                        <div style="text-align: right;">
                            <div style="font-size: 13px; color: var(--text-primary);">${new Date(event.date).toLocaleDateString()}</div>
                            <div style="font-size: 12px; color: var(--text-secondary);">${event.time || 'No time set'}</div>
                        </div>
                    </div>
                `).join('');
            }
        }

        function updateSectionInvoiceList() {
            if (!currentProject || !currentProject.sections) return;
            
            const container = document.getElementById('sectionInvoiceList');
            
            if (currentProject.sections.length === 0) {
                container.innerHTML = '<p style="color: var(--text-secondary); text-align: center; padding: 20px;">No sections available. Add items in the Items tab to create invoices.</p>';
                return;
            }
            
            // Filter sections that have items
            const sectionsWithItems = currentProject.sections.filter(section => 
                section.items && section.items.length > 0
            );
            
            if (sectionsWithItems.length === 0) {
                container.innerHTML = '<p style="color: var(--text-secondary); text-align: center; padding: 20px;">No sections with items available. Add items to your sections in the Items tab to create invoices.</p>';
                return;
            }
            
            container.innerHTML = currentProject.sections.map((section, sectionIndex) => {
                const hasItems = section.items && section.items.length > 0;
                const sectionTotal = hasItems ? section.items.reduce((total, item) => {
                    const customerUnitPrice = item.customerPrice || item.price || 0;
                    const quantity = item.qty || 1;
                    const unitTotal = customerUnitPrice * quantity;
                    const totalWithShippingTax = unitTotal + (item.shipping || 0) + (item.tax || 0);
                    return total + totalWithShippingTax;
                }, 0) : 0;
                
                const itemCount = hasItems ? section.items.length : 0;
                
                return `
                    <div class="card" style="padding: 20px; ${!hasItems ? 'opacity: 0.6; border: 2px dashed var(--section-bg);' : ''}">
                        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px;">
                            <div>
                                <h4 style="margin: 0; color: var(--text-primary);">${section.name}</h4>
                                <p style="margin: 5px 0 0 0; color: var(--text-secondary); font-size: 13px;">
                                    ${hasItems 
                                        ? `${itemCount} item${itemCount === 1 ? '' : 's'} • Total: $${sectionTotal.toLocaleString('en-US', { minimumFractionDigits: 2, maximumFractionDigits: 2 })}` 
                                        : '⚠️ No items - cannot generate invoice'
                                    }
                                </p>
                            </div>
                            <div style="display: flex; gap: 10px;">
                                <button class="btn ${hasItems ? 'btn-success' : 'btn-disabled'}" 
                                        onclick="${hasItems ? `generateAndDownloadSectionInvoice(${sectionIndex})` : `showCustomAlert('This section has no items. Please add items in the Items tab before generating an invoice.')`}" 
                                        style="padding: 8px 16px; font-size: 14px; ${!hasItems ? 'background: #ccc; cursor: not-allowed;' : ''}">
                                    📄 Download PDF
                                </button>
                                <button class="btn ${hasItems ? 'btn-coral' : 'btn-disabled'}" 
                                        onclick="${hasItems ? `previewSectionInvoice(${sectionIndex})` : `showCustomAlert('This section has no items. Please add items in the Items tab before previewing an invoice.')`}" 
                                        style="padding: 8px 16px; font-size: 14px; ${!hasItems ? 'background: #ccc; cursor: not-allowed;' : ''}">
                                    👁️ Preview
                                </button>
                            </div>
                        </div>
                        
                        <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 10px; margin-top: 10px;">
                            ${hasItems ? section.items.map(item => {
                                const customerPrice = item.customerPrice || item.price || 0;
                                const total = (customerPrice * (item.qty || 1)) + (item.shipping || 0) + (item.tax || 0);
                                return `
                                    <div style="padding: 8px 12px; background: var(--section-bg); border-radius: 6px; font-size: 12px;">
                                        <strong>${item.name}</strong><br>
                                        <span style="color: var(--text-secondary);">Qty: ${item.qty || 1} • $${total.toFixed(2)}</span>
                                    </div>
                                `;
                            }).join('') : `
                                <div style="padding: 12px; text-align: center; color: var(--text-secondary); font-style: italic; grid-column: 1 / -1;">
                                    No items in this section. <a href="#" onclick="showProjectSection('items', document.querySelector('.project-tab[onclick*=items]'))" style="color: var(--secondary-brand);">Add items here →</a>
                                </div>
                            `}
                        </div>
                    </div>
                `;
            }).join('');
        }

        function previewSectionInvoice(sectionIndex) {
            if (!currentProject || !currentProject.sections || !currentProject.sections[sectionIndex]) {
                showCustomAlert('Error: Section not found. Please refresh and try again.');
                return;
            }
            
            const section = currentProject.sections[sectionIndex];
            
            // Open preview in new window/tab
            const previewWindow = window.open('', '_blank', 'width=900,height=800,scrollbars=yes,resizable=yes');
            
            if (!previewWindow) {
                showCustomAlert('Pop-up blocked! Please allow pop-ups and try again.');
                return;
            }
            
            // Write the invoice HTML to the new window
            previewWindow.document.write(`
                <!DOCTYPE html>
                <html>
                <head>
                    <meta charset="UTF-8">
                    <title>Invoice Preview - ${currentProject.name} - ${section.name}</title>
                    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
                    <style>
                        body {
                            font-family: 'Inter', Arial, sans-serif;
                            margin: 0;
                            padding: 20px;
                            background: #f9f9f9;
                            color: #333;
                        }
                        
                        .container {
                            max-width: 800px;
                            margin: 0 auto;
                            background: white;
                            padding: 40px;
                            border-radius: 12px;
                            box-shadow: 0 4px 20px rgba(0,0,0,0.1);
                        }
                        
                        .no-print {
                            background: #007bff;
                            color: white;
                            border: none;
                            padding: 12px 24px;
                            border-radius: 6px;
                            font-size: 16px;
                            cursor: pointer;
                            margin: 0 10px 20px 0;
                        }
                        
                        .no-print:hover {
                            background: #0056b3;
                        }
                        
                        @media print {
                            body { background: white; padding: 0; }
                            .container { box-shadow: none; padding: 20px; margin: 0; }
                            .no-print { display: none; }
                        }
                    </style>
                </head>
                <body>
                    <div class="no-print" style="text-align: center; margin-bottom: 30px;">
                        <button class="no-print" onclick="window.print()">🖨️ Print Invoice</button>
                        <button class="no-print" onclick="window.close()">✕ Close Preview</button>
                    </div>
                    
                    <div class="container">
                        ${generateCleanInvoiceHTML(sectionIndex)}
                    </div>
                </body>
                </html>
            `);
            
            previewWindow.document.close();
            previewWindow.focus();
        }

        function generateAndDownloadSectionInvoice(sectionIndex) {
            if (!currentProject || !currentProject.sections || !currentProject.sections[sectionIndex]) {
                showCustomAlert('Error: Section not found. Please refresh and try again.');
                return;
            }
            
            const section = currentProject.sections[sectionIndex];
            
            // Show loading message with better styling
            const loadingAlert = document.createElement('div');
            loadingAlert.id = 'pdf-loading';
            loadingAlert.style.cssText = `
                position: fixed;
                top: 20px;
                right: 20px;
                background: linear-gradient(135deg, var(--secondary-brand), var(--primary-brand));
                color: white;
                padding: 16px 24px;
                border-radius: 8px;
                box-shadow: 0 4px 20px rgba(0,0,0,0.15);
                z-index: 10000;
                font-weight: 500;
                display: flex;
                align-items: center;
                gap: 10px;
            `;
            loadingAlert.innerHTML = `
                <div style="width: 20px; height: 20px; border: 2px solid rgba(255,255,255,0.3); border-top: 2px solid white; border-radius: 50%; animation: spin 1s linear infinite;"></div>
                Generating PDF... Please wait
            `;
            
            // Add spinner animation
            if (!document.getElementById('spinner-style')) {
                const style = document.createElement('style');
                style.id = 'spinner-style';
                style.textContent = `
                    @keyframes spin {
                        0% { transform: rotate(0deg); }
                        100% { transform: rotate(360deg); }
                    }
                `;
                document.head.appendChild(style);
            }
            
            document.body.appendChild(loadingAlert);
            
            // Create a temporary element with the invoice HTML
            const tempElement = document.createElement('div');
            tempElement.innerHTML = generateCleanInvoiceHTML(sectionIndex);
            tempElement.style.position = 'absolute';
            tempElement.style.left = '-9999px';
            tempElement.style.top = '-9999px';
            document.body.appendChild(tempElement);
            
            // Configure PDF options
            const filename = `Invoice-${currentProject.name.replace(/[^a-z0-9]/gi, '-')}-${section.name.replace(/[^a-z0-9]/gi, '-')}.pdf`;
            const opt = {
                margin: [0.5, 0.5, 0.5, 0.5],
                filename: filename,
                image: { type: 'jpeg', quality: 0.98 },
                html2canvas: { 
                    scale: 2, 
                    useCORS: true,
                    letterRendering: true,
                    logging: false
                },
                jsPDF: { 
                    unit: 'in', 
                    format: 'letter', 
                    orientation: 'portrait',
                    compress: true
                },
                pagebreak: { mode: ['avoid-all', 'css', 'legacy'] }
            };
            
            // Generate and download PDF
            html2pdf()
                .set(opt)
                .from(tempElement)
                .save()
                .then(() => {
                    // Clean up
                    document.body.removeChild(tempElement);
                    const loading = document.getElementById('pdf-loading');
                    if (loading) document.body.removeChild(loading);
                    
                    // Show success message
                    const successAlert = document.createElement('div');
                    successAlert.style.cssText = `
                        position: fixed;
                        top: 20px;
                        right: 20px;
                        background: linear-gradient(135deg, var(--success), var(--highlight));
                        color: white;
                        padding: 16px 24px;
                        border-radius: 8px;
                        box-shadow: 0 4px 20px rgba(0,0,0,0.15);
                        z-index: 10000;
                        font-weight: 500;
                    `;
                    successAlert.innerHTML = '✅ Invoice PDF downloaded successfully!';
                    document.body.appendChild(successAlert);
                    
                    setTimeout(() => {
                        if (document.body.contains(successAlert)) {
                            document.body.removeChild(successAlert);
                        }
                    }, 4000);
                })
                .catch((error) => {
                    console.error('PDF generation failed:', error);
                    document.body.removeChild(tempElement);
                    const loading = document.getElementById('pdf-loading');
                    if (loading) document.body.removeChild(loading);
                    
                    // Show error message
                    const errorAlert = document.createElement('div');
                    errorAlert.style.cssText = `
                        position: fixed;
                        top: 20px;
                        right: 20px;
                        background: linear-gradient(135deg, var(--error), #E2A39D);
                        color: white;
                        padding: 16px 24px;
                        border-radius: 8px;
                        box-shadow: 0 4px 20px rgba(0,0,0,0.15);
                        z-index: 10000;
                        font-weight: 500;
                    `;
                    errorAlert.innerHTML = '❌ Error generating PDF. Please try again or use the preview option.';
                    document.body.appendChild(errorAlert);
                    
                    setTimeout(() => {
                        if (document.body.contains(errorAlert)) {
                            document.body.removeChild(errorAlert);
                        }
                    }, 5000);
                });
        }
        
        function generateCleanInvoiceHTML(sectionIndex) {
            const section = currentProject.sections[sectionIndex];
            let sectionTotal = 0;
            let invoiceItems = [];
            
            // Generate items for this section only
            section.items.forEach(item => {
                const customerUnitPrice = item.customerPrice || item.price || 0;
                const quantity = item.qty || 1;
                const unitTotal = customerUnitPrice * quantity;
                const totalWithShippingTax = unitTotal + (item.shipping || 0) + (item.tax || 0);
                
                invoiceItems.push({
                    description: item.name,
                    unitPrice: customerUnitPrice,
                    qty: quantity,
                    unitTotal: unitTotal,
                    total: totalWithShippingTax
                });
                sectionTotal += totalWithShippingTax;
            });
            
            return `
                <div style="font-family: 'Inter', Arial, sans-serif; max-width: 800px; margin: 0 auto; padding: 40px; background: white; color: #333;">
                    <!-- Header -->
                    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 40px; border-bottom: 3px solid #D8A7A7; padding-bottom: 20px;">
                        <div style="display: flex; align-items: center; gap: 20px;">
                            <div style="width: 60px; height: 60px; background: #F2EFEB; border-radius: 8px; display: flex; align-items: center; justify-content: center;">
                                <svg viewBox="0 0 400 300" xmlns="http://www.w3.org/2000/svg" style="width: 40px; height: 40px;">
                                    <g stroke="#333" stroke-width="6" fill="none">
                                        <path d="M50 250 L50 150 L120 100 L190 150 L190 250 Z"/>
                                        <path d="M210 250 L210 170 L280 120 L350 170 L350 250 Z"/>
                                        <path d="M30 150 L120 90 L210 150"/>
                                        <path d="M190 170 L280 110 L370 170"/>
                                        <line x1="80" y1="130" x2="80" y2="250"/>
                                        <line x1="160" y1="130" x2="160" y2="250"/>
                                        <line x1="240" y1="150" x2="240" y2="250"/>
                                        <line x1="320" y1="150" x2="320" y2="250"/>
                                        <line x1="30" y1="250" x2="370" y2="250"/>
                                    </g>
                                </svg>
                            </div>
                            <div>
                                <h1 style="margin: 0; font-size: 28px; font-weight: 600; color: #333; letter-spacing: 1px;">KELLY RAM DESIGNS</h1>
                                <p style="margin: 5px 0 0 0; color: #666; font-size: 16px; font-weight: 400;">INTERIOR DESIGN</p>
                            </div>
                        </div>
                        <div style="text-align: right;">
                            <h2 style="margin: 0; font-size: 42px; font-weight: 300; color: #333; letter-spacing: 4px;">INVOICE</h2>
                        </div>
                    </div>
                    
                    <!-- Client and Invoice Info -->
                    <div style="display: flex; justify-content: space-between; margin-bottom: 40px;">
                        <div style="width: 45%;">
                            <div style="margin-bottom: 25px;">
                                <h3 style="margin: 0 0 8px 0; font-size: 16px; font-weight: 600; color: #333;">ISSUED TO:</h3>
                                <div style="font-size: 15px; line-height: 1.5; color: #333;">
                                    <strong>${currentProject.client}</strong><br>
                                    ${currentProject.clientEmail ? currentProject.clientEmail + '<br>' : ''}
                                    ${currentProject.clientPhone ? currentProject.clientPhone + '<br>' : ''}
                                    ${currentProject.clientAddress ? currentProject.clientAddress.replace(/\n/g, '<br>') : ''}
                                </div>
                            </div>
                            <div>
                                <h3 style="margin: 0 0 8px 0; font-size: 16px; font-weight: 600; color: #333;">PAY TO:</h3>
                                <div style="font-size: 15px; color: #333;">
                                    <strong>Kelly Ram Designs</strong><br>
                                    kellyramdesigns@gmail.com
                                </div>
                            </div>
                        </div>
                        <div style="width: 45%; text-align: right;">
                            <div style="font-size: 15px; line-height: 1.8;">
                                <div><strong>PROJECT:</strong> ${currentProject.name}</div>
                                <div><strong>SECTION:</strong> ${section.name}</div>
                                <div><strong>INVOICE NO:</strong> ${currentProject.invoiceNumber || 'TBD'}-${sectionIndex + 1}</div>
                                <div><strong>DATE:</strong> ${new Date().toLocaleDateString('en-US', { month: '2-digit', day: '2-digit', year: 'numeric' }).replace(/\//g, '.')}</div>
                            </div>
                        </div>
                    </div>

                    <!-- Items Table -->
                    <table style="width: 100%; border-collapse: collapse; margin: 30px 0;">
                        <thead>
                            <tr style="background: #D3DCE6;">
                                <th style="padding: 15px 12px; text-align: left; font-weight: 600; font-size: 14px; color: #333; border-bottom: 2px solid #9CAEC2;">DESCRIPTION</th>
                                <th style="padding: 15px 12px; text-align: right; font-weight: 600; font-size: 14px; color: #333; border-bottom: 2px solid #9CAEC2;">UNIT PRICE</th>
                                <th style="padding: 15px 12px; text-align: center; font-weight: 600; font-size: 14px; color: #333; border-bottom: 2px solid #9CAEC2;">QTY</th>
                                <th style="padding: 15px 12px; text-align: right; font-weight: 600; font-size: 14px; color: #333; border-bottom: 2px solid #9CAEC2;">SUBTOTAL</th>
                                <th style="padding: 15px 12px; text-align: right; font-weight: 600; font-size: 14px; color: #333; border-bottom: 2px solid #9CAEC2;">TOTAL</th>
                            </tr>
                        </thead>
                        <tbody>
                            ${invoiceItems.map((item, index) => `
                                <tr style="border-bottom: 1px solid #EDEAE6;">
                                    <td style="padding: 15px 12px; font-size: 14px; color: #333;">${item.description}</td>
                                    <td style="padding: 15px 12px; text-align: right; font-size: 14px; color: #333;">$${item.unitPrice.toLocaleString('en-US', { minimumFractionDigits: 2, maximumFractionDigits: 2 })}</td>
                                    <td style="padding: 15px 12px; text-align: center; font-size: 14px; color: #333;">${item.qty}</td>
                                    <td style="padding: 15px 12px; text-align: right; font-size: 14px; color: #333;">$${item.unitTotal.toLocaleString('en-US', { minimumFractionDigits: 2, maximumFractionDigits: 2 })}</td>
                                    <td style="padding: 15px 12px; text-align: right; font-size: 14px; font-weight: 600; color: #333;">$${item.total.toLocaleString('en-US', { minimumFractionDigits: 2, maximumFractionDigits: 2 })}</td>
                                </tr>
                            `).join('')}
                        </tbody>
                    </table>
                    
                    <!-- Tax/Shipping Note -->
                    <div style="text-align: right; margin: 20px 0; padding: 12px 16px; background: #EDEAE6; border-radius: 6px; border-left: 4px solid #9CAEC2;">
                        <p style="margin: 0; font-size: 13px; color: #666; font-style: italic;">
                            * Total prices include applicable shipping and tax charges
                        </p>
                    </div>

                    <!-- Total Section -->
                    <div style="text-align: right; margin: 30px 0; padding: 25px; background: #F0E5D8; border-radius: 8px; border-top: 3px solid #D8A7A7;">
                        <div style="font-size: 24px; font-weight: 700; color: #333;">
                            SECTION TOTAL: $${sectionTotal.toLocaleString('en-US', { minimumFractionDigits: 2, maximumFractionDigits: 2 })}
                        </div>
                    </div>

                    <!-- Payment Info -->
                    <div style="margin-top: 50px; padding-top: 20px; border-top: 1px solid #EDEAE6; font-size: 14px; color: #666; line-height: 1.6;">
                        <p style="margin: 0 0 12px 0;"><strong>Payment Options:</strong></p>
                        <p style="margin: 0 0 8px 0;">• Zelle: kellyramdesigns@gmail.com</p>
                        <p style="margin: 0 0 20px 0;">• Check payable to: Kelly Ram Designs</p>
                        
                        <p style="margin: 0 0 8px 0; font-size: 13px;"><strong>Please note:</strong> Most products are final sale and cannot be returned</p>
                        <p style="margin: 0; font-size: 13px;">*All prices are subject to change</p>
                    </div>
                </div>
            `;
        }

        function generateInvoiceHTML(sectionIndex) {
            const section = currentProject.sections[sectionIndex];
            let sectionTotal = 0;
            let invoiceItems = [];
            
            // Generate items for this section only
            section.items.forEach(item => {
                const customerUnitPrice = item.customerPrice || item.price || 0;
                const quantity = item.qty || 1;
                const unitTotal = customerUnitPrice * quantity;
                const totalWithShippingTax = unitTotal + (item.shipping || 0) + (item.tax || 0);
                
                invoiceItems.push({
                    description: item.name,
                    unitPrice: customerUnitPrice,
                    qty: quantity,
                    unitTotal: unitTotal,
                    total: totalWithShippingTax
                });
                sectionTotal += totalWithShippingTax;
            });
            
            // Get uploaded logo or use default house icon
            const companyLogo = localStorage.getItem('companyLogo');
            const logoSection = companyLogo ? 
                `<img src="${companyLogo}" style="width: 60px; height: 60px; border-radius: 8px; object-fit: contain;">` :
                `<div style="width: 60px; height: 60px; background: #F2EFEB; border-radius: 8px; display: flex; align-items: center; justify-content: center; box-shadow: 0 2px 8px rgba(51,51,51,0.1);">
                    <svg viewBox="0 0 400 300" xmlns="http://www.w3.org/2000/svg" style="width: 40px; height: 40px;">
                        <g stroke="#333" stroke-width="6" fill="none">
                            <path d="M50 250 L50 150 L120 100 L190 150 L190 250 Z"/>
                            <path d="M210 250 L210 170 L280 120 L350 170 L350 250 Z"/>
                            <path d="M30 150 L120 90 L210 150"/>
                            <path d="M190 170 L280 110 L370 170"/>
                            <line x1="80" y1="130" x2="80" y2="250"/>
                            <line x1="160" y1="130" x2="160" y2="250"/>
                            <line x1="240" y1="150" x2="240" y2="250"/>
                            <line x1="320" y1="150" x2="320" y2="250"/>
                            <line x1="30" y1="250" x2="370" y2="250"/>
                        </g>
                    </svg>
                </div>`;
            
            return `<!DOCTYPE html>
            <html>
            <head>
                <meta charset="UTF-8">
                <title>Invoice - ${currentProject.name} - ${section.name}</title>
                <style>
                    @import url('https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap');
                    
                    body {
                        font-family: 'Inter', -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
                        margin: 0;
                        padding: 30px;
                        background: white;
                        color: #333;
                        line-height: 1.6;
                    }
                    
                    .invoice-container {
                        max-width: 800px;
                        margin: 0 auto;
                    }
                    
                    table {
                        width: 100%;
                        border-collapse: collapse;
                        margin: 20px 0;
                    }
                    
                    th, td {
                        padding: 15px;
                        text-align: left;
                        border-bottom: 1px solid #EDEAE6;
                    }
                    
                    th {
                        background: #D3DCE6;
                        color: #333;
                        font-weight: 600;
                    }
                    
                    @media print {
                        body { margin: 0; padding: 20px; }
                        .no-print { display: none; }
                    }
                </style>
            </head>
            <body>
                <div class="invoice-container">
                    <div style="display: flex; align-items: center; justify-content: space-between; margin-bottom: 30px; border-bottom: 2px solid #D8A7A7; padding-bottom: 20px;">
                        <div style="display: flex; align-items: center; gap: 20px;">
                            ${logoSection}
                            <div>
                                <h2 style="margin: 0; color: #333;">KELLY RAM DESIGNS</h2>
                                <p style="margin: 5px 0; color: #666;">INTERIOR DESIGN</p>
                            </div>
                        </div>
                        <div style="font-size: 36px; font-weight: 200; color: #333; letter-spacing: 3px;">INVOICE</div>
                    </div>
                    
                    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 40px; margin-bottom: 30px;">
                        <div>
                            <div style="margin-bottom: 20px;">
                                <strong>ISSUED TO:</strong><br>
                                ${currentProject.client}<br>
                                ${currentProject.clientEmail ? currentProject.clientEmail + '<br>' : ''}
                                ${currentProject.clientPhone ? currentProject.clientPhone + '<br>' : ''}
                                ${currentProject.clientAddress ? currentProject.clientAddress.replace(/\n/g, '<br>') : ''}
                            </div>
                            <div>
                                <strong>PAY TO:</strong><br>
                                Kelly Ram Designs
                            </div>
                        </div>
                        <div style="text-align: right;">
                            <div style="margin-bottom: 10px;">
                                <strong>PROJECT:</strong> ${currentProject.name}
                            </div>
                            <div style="margin-bottom: 10px;">
                                <strong>SECTION:</strong> ${section.name}
                            </div>
                            <div style="margin-bottom: 10px;">
                                <strong>INVOICE NO:</strong> ${currentProject.invoiceNumber || 'TBD'}-${sectionIndex + 1}
                            </div>
                            <div>
                                <strong>DATE:</strong> ${new Date().toLocaleDateString('en-US', { month: '2-digit', day: '2-digit', year: 'numeric' }).replace(/\//g, '.')}
                            </div>
                        </div>
                    </div>

                    <table>
                        <thead>
                            <tr>
                                <th>DESCRIPTION</th>
                                <th>UNIT PRICE</th>
                                <th>QTY</th>
                                <th>SUBTOTAL</th>
                                <th>TOTAL</th>
                            </tr>
                        </thead>
                        <tbody>
                            ${invoiceItems.map(item => `
                                <tr>
                                    <td>${item.description}</td>
                                    <td>$${item.unitPrice.toLocaleString('en-US', { minimumFractionDigits: 2, maximumFractionDigits: 2 })}</td>
                                    <td>${item.qty}</td>
                                    <td>$${item.unitTotal.toLocaleString('en-US', { minimumFractionDigits: 2, maximumFractionDigits: 2 })}</td>
                                    <td>$${item.total.toLocaleString('en-US', { minimumFractionDigits: 2, maximumFractionDigits: 2 })}</td>
                                </tr>
                            `).join('')}
                        </tbody>
                    </table>
                    
                    <div style="text-align: right; margin-top: 10px; margin-bottom: 20px; padding: 10px 15px; background: #EDEAE6; border-radius: 8px; border-left: 4px solid #9CAEC2;">
                        <p style="margin: 0; font-size: 13px; color: #666; font-style: italic;">
                            * Total prices include applicable shipping and tax charges
                        </p>
                    </div>

                    <div style="text-align: right; margin-top: 30px; padding: 25px; background: #F0E5D8; border-radius: 12px;">
                        <div style="font-weight: 600; font-size: 24px; color: #333; padding-top: 15px; border-top: 2px solid #D8A7A7;">
                            <strong>SECTION TOTAL: $${sectionTotal.toLocaleString('en-US', { minimumFractionDigits: 2, maximumFractionDigits: 2 })}</strong>
                        </div>
                    </div>

                    <div style="margin-top: 40px; padding-top: 20px; border-top: 1px solid #EDEAE6; color: #666; font-size: 14px;">
                        <p>Payment can be sent via Zelle to kellyramdesigns@gmail.com or check to Kelly Ram Designs</p>
                        <p style="margin-top: 20px;">Please note: Most products are final sale and cannot be returned</p>
                        <p>*All prices are subject to change</p>
                    </div>
                </div>
            </body>
            </html>`;
        }

        function generateProjectInvoice() {
            if (!currentProject) return;
            
            let projectTotal = 0;
            let invoiceItems = [];
            
            if (currentProject.sections) {
                currentProject.sections.forEach(section => {
                    section.items.forEach(item => {
                        const customerUnitPrice = item.customerPrice || item.price || 0;
                        const quantity = item.qty || 1;
                        const unitTotal = customerUnitPrice * quantity;
                        const totalWithShippingTax = unitTotal + (item.shipping || 0) + (item.tax || 0);
                        
                        invoiceItems.push({
                            description: `${item.name} (${section.name})`,
                            unitPrice: customerUnitPrice,
                            qty: quantity,
                            unitTotal: unitTotal,
                            total: totalWithShippingTax
                        });
                        projectTotal += totalWithShippingTax;
                    });
                });
            }
            
            const preview = document.getElementById('projectInvoicePreview');
            
            // Get uploaded logo or use default house icon
            const companyLogo = localStorage.getItem('companyLogo');
            const logoSection = companyLogo ? 
                `<img src="${companyLogo}" style="width: 60px; height: 60px; border-radius: 8px; object-fit: contain;">` :
                `<div style="width: 60px; height: 60px; background: var(--card-bg); border-radius: 8px; display: flex; align-items: center; justify-content: center; box-shadow: 0 2px 8px rgba(51,51,51,0.1);">
                    <svg viewBox="0 0 400 300" xmlns="http://www.w3.org/2000/svg" style="width: 40px; height: 40px;">
                        <g stroke="#333" stroke-width="6" fill="none">
                            <path d="M50 250 L50 150 L120 100 L190 150 L190 250 Z"/>
                            <path d="M210 250 L210 170 L280 120 L350 170 L350 250 Z"/>
                            <path d="M30 150 L120 90 L210 150"/>
                            <path d="M190 170 L280 110 L370 170"/>
                            <line x1="80" y1="130" x2="80" y2="250"/>
                            <line x1="160" y1="130" x2="160" y2="250"/>
                            <line x1="240" y1="150" x2="240" y2="250"/>
                            <line x1="320" y1="150" x2="320" y2="250"/>
                            <line x1="30" y1="250" x2="370" y2="250"/>
                        </g>
                    </svg>
                </div>`;
            
            preview.innerHTML = `
                <div style="display: flex; align-items: center; justify-content: space-between; margin-bottom: 30px; border-bottom: 2px solid var(--soft-rose); padding-bottom: 20px;">
                    <div style="display: flex; align-items: center; gap: 20px;">
                        ${logoSection}
                        <div>
                            <h2 style="margin: 0; color: var(--text-primary);">KELLY RAM DESIGNS</h2>
                            <p style="margin: 5px 0; color: var(--text-secondary);">INTERIOR DESIGN</p>
                        </div>
                    </div>
                    <div style="font-size: 36px; font-weight: 200; color: var(--text-primary); letter-spacing: 3px;">INVOICE</div>
                </div>
                
                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 40px; margin-bottom: 30px;">
                    <div>
                        <div style="margin-bottom: 20px;">
                            <strong>ISSUED TO:</strong><br>
                            ${currentProject.client}<br>
                            ${currentProject.clientEmail ? currentProject.clientEmail + '<br>' : ''}
                            ${currentProject.clientPhone ? currentProject.clientPhone + '<br>' : ''}
                            ${currentProject.clientAddress ? currentProject.clientAddress.replace(/\n/g, '<br>') : ''}
                        </div>
                        <div>
                            <strong>PAY TO:</strong><br>
                            Kelly Ram Designs
                        </div>
                    </div>
                    <div style="text-align: right;">
                        <div style="margin-bottom: 10px;">
                            <strong>INVOICE NO:</strong> ${currentProject.invoiceNumber}
                        </div>
                        <div>
                            <strong>DATE:</strong> ${new Date().toLocaleDateString('en-US').replace(/\//g, '.')}
                        </div>
                    </div>
                </div>

                <table style="width: 100%; border-collapse: collapse; margin: 20px 0; border-radius: 12px; overflow: hidden;">
                    <thead>
                        <tr style="background: var(--task-bg);">
                            <th style="padding: 15px; text-align: left; color: var(--text-primary);">DESCRIPTION</th>
                            <th style="padding: 15px; text-align: left; color: var(--text-primary);">UNIT PRICE</th>
                            <th style="padding: 15px; text-align: left; color: var(--text-primary);">QTY</th>
                            <th style="padding: 15px; text-align: left; color: var(--text-primary);">SUBTOTAL</th>
                            <th style="padding: 15px; text-align: left; color: var(--text-primary);">TOTAL</th>
                        </tr>
                    </thead>
                    <tbody>
                        ${invoiceItems.map(item => `
                            <tr>
                                <td style="padding: 15px; border-bottom: 1px solid var(--section-bg);">${item.description}</td>
                                <td style="padding: 15px; border-bottom: 1px solid var(--section-bg);">$${item.unitPrice.toLocaleString('en-US', { minimumFractionDigits: 2, maximumFractionDigits: 2 })}</td>
                                <td style="padding: 15px; border-bottom: 1px solid var(--section-bg);">${item.qty}</td>
                                <td style="padding: 15px; border-bottom: 1px solid var(--section-bg);">$${item.unitTotal.toLocaleString('en-US', { minimumFractionDigits: 2, maximumFractionDigits: 2 })}</td>
                                <td style="padding: 15px; border-bottom: 1px solid var(--section-bg);">$${item.total.toLocaleString('en-US', { minimumFractionDigits: 2, maximumFractionDigits: 2 })}</td>
                            </tr>
                        `).join('')}
                    </tbody>
                </table>
                
                <div style="text-align: right; margin-top: 10px; margin-bottom: 20px; padding: 10px 15px; background: var(--section-bg); border-radius: 8px; border-left: 4px solid var(--info);">
                    <p style="margin: 0; font-size: 13px; color: var(--text-secondary); font-style: italic;">
                        * Total prices include applicable shipping and tax charges
                    </p>
                </div>

                <div style="text-align: right; margin-top: 30px; padding: 25px; background: var(--warm-cream); border-radius: 12px;">
                    <div style="margin: 10px 0; font-size: 16px; color: var(--text-primary);"><strong>PRODUCT TOTAL: $${projectTotal.toLocaleString('en-US', { minimumFractionDigits: 2, maximumFractionDigits: 2 })}</strong></div>
                    <div style="margin: 10px 0; font-size: 16px; color: var(--text-primary);"><strong>AMOUNT PAID: $${(currentProject.amountPaid || 0).toLocaleString('en-US', { minimumFractionDigits: 2, maximumFractionDigits: 2 })}</strong></div>
                    <div style="font-weight: 600; font-size: 24px; color: var(--text-primary); padding-top: 15px; border-top: 2px solid var(--soft-rose);"><strong>TOTAL AMOUNT DUE: $${(projectTotal - (currentProject.amountPaid || 0)).toLocaleString('en-US', { minimumFractionDigits: 2, maximumFractionDigits: 2 })}</strong></div>
                </div>

                <div style="margin-top: 40px; padding-top: 20px; border-top: 1px solid var(--soft-rose);">
                    <p>Payment can be sent via Zelle to kellyramdesigns@gmail.com or check to Kelly Ram Designs</p>
                    <p style="margin-top: 20px; font-size: 14px;">Please note: Most products are final sale and cannot be returned</p>
                    <p style="font-size: 14px;">*All prices are subject to change</p>
                </div>
            `;
        }

        function printInvoice() {
            window.print();
        }

        function saveCurrentProject() {
            if (!currentProject) return;
            
            const index = projects.findIndex(p => p.id === currentProject.id);
            if (index !== -1) {
                projects[index] = currentProject;
                localStorage.setItem('projects', JSON.stringify(projects));
            }
        }

        // Enhanced event system
        function addEvent() {
            if (!currentProject) return;
            
            showCustomPrompt(
                'Add New Event',
                [
                    { type: 'select', name: 'type', label: 'Event Type', options: [
                        { value: 'consultation', text: 'Consultation' },
                        { value: 'design', text: 'Design' },
                        { value: 'meeting', text: 'Meeting' },
                        { value: 'delivery', text: 'Delivery' }
                    ], defaultValue: 'meeting' },
                    { type: 'text', name: 'title', label: 'Event Title', required: true },
                    { type: 'date', name: 'date', label: 'Date', required: true },
                    { type: 'time', name: 'time', label: 'Time' },
                    { type: 'textarea', name: 'notes', label: 'Event Notes' }
                ],
                (data) => {
                    if (!currentProject.events) currentProject.events = [];
                    
                    currentProject.events.push({
                        id: Date.now(),
                        type: data.type,
                        title: data.title,
                        date: data.date,
                        time: data.time || '',
                        notes: data.notes || '',
                        completed: false
                    });
                    
                    saveCurrentProject();
                    updateProjectUpcomingEvents();
                    updateUpcomingEvents();
                    showCustomAlert('Event added successfully! ✨');
                }
            );
        }

        function addQuickEvent() {
            showCustomPrompt(
                'Quick Add Event',
                [
                    { type: 'select', name: 'projectId', label: 'Project', options: projects.map(p => ({ value: p.id, text: `${p.name} - ${p.client}` })), required: true },
                    { type: 'text', name: 'title', label: 'Event Title', required: true },
                    { type: 'date', name: 'date', label: 'Date', required: true },
                    { type: 'time', name: 'time', label: 'Time' }
                ],
                (data) => {
                    const project = projects.find(p => p.id == data.projectId);
                    if (!project) return;
                    
                    if (!project.events) project.events = [];
                    
                    project.events.push({
                        id: Date.now(),
                        type: 'meeting',
                        title: data.title,
                        date: data.date,
                        time: data.time || '',
                        notes: '',
                        completed: false
                    });
                    
                    localStorage.setItem('projects', JSON.stringify(projects));
                    updateUpcomingEvents();
                    showCustomAlert('Event added successfully! ✨');
                }
            );
        }

        function addPaidHours() {
            if (!currentProject) return;
            
            showCustomPrompt(
                'Add Paid Hours',
                [
                    { type: 'number', name: 'hours', label: 'Additional Hours', step: '0.25', required: true, placeholder: 'e.g. 5.5' }
                ],
                (data) => {
                    const hoursToAdd = parseFloat(data.hours);
                    if (isNaN(hoursToAdd) || hoursToAdd <= 0) {
                        showCustomAlert('Please enter a valid number of hours.');
                        return;
                    }
                    
                    currentProject.hoursPaid = (currentProject.hoursPaid || 0) + hoursToAdd;
                    
                    if (!currentProject.events) currentProject.events = [];
                    currentProject.events.push({
                        id: Date.now(),
                        type: 'meeting',
                        title: 'Additional Hours Purchased',
                        date: new Date().toISOString().split('T')[0],
                        time: '',
                        notes: `Client purchased ${hoursToAdd} additional hours. Total paid hours: ${currentProject.hoursPaid}`,
                        completed: true
                    });
                    
                    saveCurrentProject();
                    updateProjectHours();
                    updateProjectUpcomingEvents();
                    displayProjects();
                    updateDashboard();
                    
                    showCustomAlert(`Added ${hoursToAdd} hours successfully! ✨\nTotal paid hours: ${currentProject.hoursPaid}`);
                }
            );
        }

        // Import CSV functionality
        function importItemsCSV() {
            const input = document.createElement('input');
            input.type = 'file';
            input.accept = '.csv';
            
            input.onchange = function(e) {
                const file = e.target.files[0];
                if (!file) return;
                
                const reader = new FileReader();
                reader.onload = function(e) {
                    try {
                        const csv = e.target.result;
                        const lines = csv.split('\n').filter(line => line.trim());
                        
                        if (lines.length < 2) {
                            showCustomAlert('CSV file must have at least a header row and one data row.');
                            return;
                        }
                        
                        // Expected format: Section,Item Name,Quantity,Price,Link
                        const importedSections = {};
                        
                        for (let i = 1; i < lines.length; i++) {
                            const values = lines[i].split(',');
                            if (values.length >= 4) {
                                const sectionName = values[0].trim();
                                const itemName = values[1].trim();
                                const qty = parseInt(values[2]) || 1;
                                const price = parseFloat(values[3]) || 0;
                                const link = values[4] ? values[4].trim() : '';
                                
                                if (!importedSections[sectionName]) {
                                    importedSections[sectionName] = [];
                                }
                                
                                importedSections[sectionName].push({
                                    id: Date.now() + Math.random(),
                                    name: itemName,
                                    qty: qty,
                                    price: price,
                                    link: link,
                                    readyToOrder: false,
                                    orderStatus: 'pending'
                                });
                            }
                        }
                        
                        // Add sections to current project
                        if (!currentProject.sections) currentProject.sections = [];
                        
                        Object.keys(importedSections).forEach(sectionName => {
                            const existingSection = currentProject.sections.find(s => s.name === sectionName);
                            if (existingSection) {
                                existingSection.items.push(...importedSections[sectionName]);
                            } else {
                                currentProject.sections.push({
                                    id: Date.now() + Math.random(),
                                    name: sectionName,
                                    items: importedSections[sectionName]
                                });
                            }
                        });
                        
                        saveCurrentProject();
                        updateProjectSections();
                        showCustomAlert(`CSV imported successfully! Added ${Object.keys(importedSections).length} sections with items. ✨`);
                        
                    } catch (error) {
                        showCustomAlert('Error importing CSV: ' + error.message);
                    }
                };
                reader.readAsText(file);
            };
            
            input.click();
        }
        
        // Download CSV template functionality
        function downloadCSVTemplate() {
            const csvContent = [
                "Section,Item Name,Quantity,Price,Link",
                "Living Room,Sofa,1,1299.99,https://example.com/sofa",
                "Living Room,Coffee Table,1,549.99,https://example.com/coffee-table",
                "Bedroom,Bed Frame,1,899.99,https://example.com/bed",
                "Bedroom,Nightstand,2,199.99,https://example.com/nightstand"
            ].join('\n');
            
            const blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' });
            const link = document.createElement('a');
            
            if (link.download !== undefined) {
                const url = URL.createObjectURL(blob);
                link.setAttribute('href', url);
                link.setAttribute('download', 'items-import-template.csv');
                link.style.visibility = 'hidden';
                document.body.appendChild(link);
                link.click();
                document.body.removeChild(link);
            }
        }

        // Mood board functionality
        function updateMoodBoards() {
            if (!currentProject) return;
            
            const container = document.getElementById('moodBoardGallery');
            
            if (!currentProject.moodBoards || currentProject.moodBoards.length === 0) {
                container.innerHTML = '<p style="color: var(--text-secondary); text-align: center; padding: 40px;">No mood boards uploaded yet. Upload your first mood board above!</p>';
                return;
            }
            
            container.innerHTML = currentProject.moodBoards.map((moodBoard, index) => `
                <div class="card" style="margin: 15px; display: inline-block; width: 250px;">
                    <img src="${moodBoard.dataUrl}" alt="${moodBoard.name}" style="width: 100%; height: 200px; object-fit: cover; border-radius: 10px;">
                    <h4 style="margin: 10px 0 5px 0;">${moodBoard.name}</h4>
                    <p style="font-size: 12px; color: var(--text-secondary); margin: 0;">Uploaded: ${new Date(moodBoard.uploadDate).toLocaleDateString()}</p>
                    <div style="margin-top: 10px;">
                        <button class="btn btn-small btn-coral" onclick="downloadMoodBoard(${index})">Download</button>
                        <button class="btn btn-small" onclick="removeMoodBoard(${index})" style="background: #e74c3c; margin-left: 5px;">Remove</button>
                    </div>
                </div>
            `).join('');
        }

        function uploadMoodBoard() {
            if (!currentProject) return;
            
            const input = document.createElement('input');
            input.type = 'file';
            input.accept = 'image/*';
            
            input.onchange = function(e) {
                const file = e.target.files[0];
                if (!file) return;
                
                const reader = new FileReader();
                reader.onload = function(e) {
                    if (!currentProject.moodBoards) currentProject.moodBoards = [];
                    
                    currentProject.moodBoards.push({
                        id: Date.now(),
                        name: file.name,
                        dataUrl: e.target.result,
                        uploadDate: new Date().toISOString()
                    });
                    
                    saveCurrentProject();
                    updateMoodBoards();
                    showCustomAlert('Mood board uploaded successfully! ✨');
                };
                reader.readAsDataURL(file);
            };
            
            input.click();
        }

        function downloadMoodBoard(index) {
            if (!currentProject || !currentProject.moodBoards[index]) return;
            
            const moodBoard = currentProject.moodBoards[index];
            const link = document.createElement('a');
            link.href = moodBoard.dataUrl;
            link.download = moodBoard.name;
            link.click();
        }

        function removeMoodBoard(index) {
            if (!currentProject || !currentProject.moodBoards[index]) return;
            
            currentProject.moodBoards.splice(index, 1);
            saveCurrentProject();
            updateMoodBoards();
            showCustomAlert('Mood board removed.');
        }

        // Reporting functions
        function generateClientListReport() {
            const clients = [...new Set(projects.map(p => p.client))];
            
            const reportHtml = `
                <h4>Client List Report</h4>
                <p>Total unique clients: ${clients.length}</p>
                <table style="width: 100%; border-collapse: collapse;">
                    <thead>
                        <tr style="background: var(--task-bg);">
                            <th style="padding: 10px; text-align: left;">Client Name</th>
                            <th style="padding: 10px; text-align: left;">Projects</th>
                            <th style="padding: 10px; text-align: left;">Total Value</th>
                        </tr>
                    </thead>
                    <tbody>
                        ${clients.map(client => {
                            const clientProjects = projects.filter(p => p.client === client);
                            const totalValue = clientProjects.reduce((sum, project) => {
                                if (project.sections) {
                                    return sum + project.sections.reduce((sectionSum, section) => {
                                        return sectionSum + section.items.reduce((itemSum, item) => itemSum + (item.price * item.qty), 0);
                                    }, 0);
                                }
                                return sum;
                            }, 0);
                            
                            return `
                                <tr>
                                    <td style="padding: 10px; border-bottom: 1px solid var(--section-bg);">${client}</td>
                                    <td style="padding: 10px; border-bottom: 1px solid var(--section-bg);">${clientProjects.length}</td>
                                    <td style="padding: 10px; border-bottom: 1px solid var(--section-bg);">$${totalValue.toLocaleString('en-US', { minimumFractionDigits: 2, maximumFractionDigits: 2 })}</td>
                                </tr>
                            `;
                        }).join('')}
                    </tbody>
                </table>
            `;
            
            document.getElementById('reportDisplay').innerHTML = reportHtml;
        }

        function generateHoursWorkedReport() {
            const allHours = [];
            
            projects.forEach(project => {
                if (project.hoursLog) {
                    project.hoursLog.forEach(entry => {
                        allHours.push({
                            ...entry,
                            projectName: project.name,
                            client: project.client
                        });
                    });
                }
            });
            
            allHours.sort((a, b) => new Date(b.date) - new Date(a.date));
            
            const reportHtml = `
                <h4>Hours Worked Report</h4>
                <p>Total hours entries: ${allHours.length}</p>
                <p>Total hours worked: ${allHours.reduce((sum, entry) => sum + entry.hours, 0).toFixed(1)} hours</p>
                <table style="width: 100%; border-collapse: collapse;">
                    <thead>
                        <tr style="background: var(--task-bg);">
                            <th style="padding: 10px; text-align: left;">Date</th>
                            <th style="padding: 10px; text-align: left;">Project</th>
                            <th style="padding: 10px; text-align: left;">Client</th>
                            <th style="padding: 10px; text-align: left;">Hours</th>
                            <th style="padding: 10px; text-align: left;">Description</th>
                        </tr>
                    </thead>
                    <tbody>
                        ${allHours.map(entry => `
                            <tr>
                                <td style="padding: 10px; border-bottom: 1px solid var(--section-bg);">${new Date(entry.date).toLocaleDateString()}</td>
                                <td style="padding: 10px; border-bottom: 1px solid var(--section-bg);">${entry.projectName}</td>
                                <td style="padding: 10px; border-bottom: 1px solid var(--section-bg);">${entry.client}</td>
                                <td style="padding: 10px; border-bottom: 1px solid var(--section-bg);">${entry.hours}</td>
                                <td style="padding: 10px; border-bottom: 1px solid var(--section-bg);">${entry.description}</td>
                            </tr>
                        `).join('')}
                    </tbody>
                </table>
            `;
            
            document.getElementById('reportDisplay').innerHTML = reportHtml;
        }

        function generateAllItemsReport() {
            const allItems = [];
            
            projects.forEach(project => {
                if (project.sections) {
                    project.sections.forEach(section => {
                        section.items.forEach(item => {
                            allItems.push({
                                ...item,
                                projectName: project.name,
                                client: project.client,
                                sectionName: section.name
                            });
                        });
                    });
                }
            });
            
            const reportHtml = `
                <h4>All Items Report</h4>
                <p>Total items: ${allItems.length}</p>
                <p>Total value: $${allItems.reduce((sum, item) => sum + (item.price * item.qty), 0).toLocaleString('en-US', { minimumFractionDigits: 2, maximumFractionDigits: 2 })}</p>
                <table style="width: 100%; border-collapse: collapse;">
                    <thead>
                        <tr style="background: var(--task-bg);">
                            <th style="padding: 10px; text-align: left;">Item</th>
                            <th style="padding: 10px; text-align: left;">Project</th>
                            <th style="padding: 10px; text-align: left;">Section</th>
                            <th style="padding: 10px; text-align: left;">Qty</th>
                            <th style="padding: 10px; text-align: left;">Price</th>
                            <th style="padding: 10px; text-align: left;">Total</th>
                            <th style="padding: 10px; text-align: left;">Status</th>
                        </tr>
                    </thead>
                    <tbody>
                        ${allItems.map(item => `
                            <tr>
                                <td style="padding: 10px; border-bottom: 1px solid var(--section-bg);">${item.name}</td>
                                <td style="padding: 10px; border-bottom: 1px solid var(--section-bg);">${item.projectName}</td>
                                <td style="padding: 10px; border-bottom: 1px solid var(--section-bg);">${item.sectionName}</td>
                                <td style="padding: 10px; border-bottom: 1px solid var(--section-bg);">${item.qty}</td>
                                <td style="padding: 10px; border-bottom: 1px solid var(--section-bg);">$${item.price.toLocaleString('en-US', { minimumFractionDigits: 2, maximumFractionDigits: 2 })}</td>
                                <td style="padding: 10px; border-bottom: 1px solid var(--section-bg);">$${(item.price * item.qty).toLocaleString('en-US', { minimumFractionDigits: 2, maximumFractionDigits: 2 })}</td>
                                <td style="padding: 10px; border-bottom: 1px solid var(--section-bg);">${item.orderStatus || 'pending'}</td>
                            </tr>
                        `).join('')}
                    </tbody>
                </table>
            `;
            
            document.getElementById('reportDisplay').innerHTML = reportHtml;
        }

        // Placeholder functions for other reports
        function generateClientContactReport() { showCustomAlert('Client Contact Report - Coming Soon'); }
        function generateProjectsByClientReport() { showCustomAlert('Projects by Client Report - Coming Soon'); }
        function generateOrderedItemsReport() { showCustomAlert('Ordered Items Report - Coming Soon'); }
        function generatePendingItemsReport() { showCustomAlert('Pending Items Report - Coming Soon'); }
        function generateTimelineReport() { showCustomAlert('Timeline Report - Coming Soon'); }
        function generateProductivityReport() { showCustomAlert('Productivity Report - Coming Soon'); }
        function generateRevenueReport() { showCustomAlert('Revenue Report - Coming Soon'); }
        function generateOutstandingReport() { showCustomAlert('Outstanding Payments Report - Coming Soon'); }
        function generateProfitabilityReport() { showCustomAlert('Profitability Report - Coming Soon'); }

        // Utility functions
        function duplicateProject() {
            if (projects.length === 0) {
                showCustomAlert('No projects to duplicate. Create your first project!');
                return;
            }
            
            const lastProject = projects[projects.length - 1];
            const duplicatedProject = {
                ...lastProject,
                id: Date.now(),
                name: lastProject.name + ' (Copy)',
                startDate: new Date().toISOString().split('T')[0],
                hoursWorked: 0,
                hoursLog: [],
                events: [],
                moodBoards: [],
                invoiceNumber: (++invoiceCounter).toString().padStart(6, '0'),
                amountPaid: 0
            };
            
            projects.push(duplicatedProject);
            localStorage.setItem('projects', JSON.stringify(projects));
            localStorage.setItem('invoiceCounter', invoiceCounter.toString());
            
            displayProjects();
            updateDashboard();
            
            showCustomAlert(`Project "${duplicatedProject.name}" created successfully! ✨`);
        }

        // Custom modal functions
        function showCustomAlert(message) {
            const existingAlert = document.querySelector('.custom-alert');
            const existingOverlay = document.querySelector('.custom-alert-overlay');
            if (existingAlert) existingAlert.remove();
            if (existingOverlay) existingOverlay.remove();
            
            const overlay = document.createElement('div');
            overlay.className = 'custom-alert-overlay';
            
            const alertBox = document.createElement('div');
            alertBox.className = 'custom-alert';
            alertBox.innerHTML = `
                <div style="margin-bottom: 20px; color: var(--text-primary); font-size: 16px; line-height: 1.5;">${message}</div>
                <button class="btn btn-success" onclick="closeCustomAlert()">OK</button>
            `;
            
            document.body.appendChild(overlay);
            document.body.appendChild(alertBox);
            
            setTimeout(() => {
                if (document.querySelector('.custom-alert')) {
                    closeCustomAlert();
                }
            }, 3000);
        }

        function closeCustomAlert() {
            const alertBox = document.querySelector('.custom-alert');
            const overlay = document.querySelector('.custom-alert-overlay');
            if (alertBox) alertBox.remove();
            if (overlay) overlay.remove();
        }

        function showCustomPrompt(title, fields, callback) {
            const existingPrompt = document.querySelector('.custom-prompt');
            const existingOverlay = document.querySelector('.custom-prompt-overlay');
            if (existingPrompt) existingPrompt.remove();
            if (existingOverlay) existingOverlay.remove();
            
            const overlay = document.createElement('div');
            overlay.style.cssText = 'position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(45, 43, 40, 0.7); backdrop-filter: blur(5px); z-index: 1999; cursor: pointer;';
            overlay.onclick = function() {
                closeCustomPrompt();
            };
            
            const promptBox = document.createElement('div');
            promptBox.style.cssText = 'position: fixed; top: 50%; left: 50%; transform: translate(-50%, -50%); background: var(--card-bg); border: 2px solid var(--gentle-blue); border-radius: 16px; padding: 30px; box-shadow: 0 20px 60px rgba(45, 43, 40, 0.3); z-index: 2000; max-width: 500px; width: 90%; max-height: 80vh; overflow-y: auto;';
            promptBox.onclick = function(e) {
                e.stopPropagation(); // Prevent closing when clicking inside the popup
            };
            
            let fieldsHtml = '';
            fields.forEach(field => {
                if (field.type === 'select') {
                    fieldsHtml += `
                        <label style="display: block; margin-bottom: 8px; font-weight: 500; color: var(--text-primary);">${field.label}:</label>
                        <select id="prompt-${field.name}" style="width: 100%; padding: 12px; border: 2px solid var(--section-bg); border-radius: 8px; margin-bottom: 15px; font-size: 15px;">
                    `;
                    field.options.forEach(option => {
                        const selected = option.value === field.defaultValue ? 'selected' : '';
                        fieldsHtml += `<option value="${option.value}" ${selected}>${option.text}</option>`;
                    });
                    fieldsHtml += '</select>';
                } else if (field.type === 'textarea') {
                    fieldsHtml += `
                        <label style="display: block; margin-bottom: 8px; font-weight: 500; color: var(--text-primary);">${field.label}:</label>
                        <textarea id="prompt-${field.name}" rows="3" placeholder="${field.placeholder || ''}" style="width: 100%; padding: 12px; border: 2px solid var(--section-bg); border-radius: 8px; margin-bottom: 15px; font-size: 15px; font-family: inherit;">${field.defaultValue || ''}</textarea>
                    `;
                } else {
                    fieldsHtml += `
                        <label style="display: block; margin-bottom: 8px; font-weight: 500; color: var(--text-primary);">${field.label}:</label>
                        <input type="${field.type}" id="prompt-${field.name}" ${field.step ? 'step="' + field.step + '"' : ''} ${field.required ? 'required' : ''} placeholder="${field.placeholder || ''}" value="${field.defaultValue || ''}" style="width: 100%; padding: 12px; border: 2px solid var(--section-bg); border-radius: 8px; margin-bottom: 15px; font-size: 15px;">
                    `;
                }
            });
            
            promptBox.innerHTML = `
                <h3 style="margin-top: 0; color: var(--text-primary); text-align: center; margin-bottom: 20px;">${title}</h3>
                ${fieldsHtml}
                <div style="display: flex; gap: 15px; justify-content: center; margin-top: 20px;">
                    <button class="btn btn-success" onclick="submitCustomPrompt()">Submit</button>
                    <button class="btn" onclick="closeCustomPrompt()">Cancel</button>
                </div>
            `;
            
            window.currentPromptCallback = callback;
            
            document.body.appendChild(overlay);
            document.body.appendChild(promptBox);
            
            const firstInput = promptBox.querySelector('input, select, textarea');
            if (firstInput) {
                setTimeout(() => firstInput.focus(), 100);
            }
        }

        function submitCustomPrompt() {
            const promptBox = document.querySelector('[style*="position: fixed"][style*="z-index: 2000"]');
            const data = {};
            
            const inputs = promptBox.querySelectorAll('input, select, textarea');
            inputs.forEach(input => {
                const fieldName = input.id.replace('prompt-', '');
                data[fieldName] = input.value;
            });
            
            let hasError = false;
            inputs.forEach(input => {
                if (input.hasAttribute('required') && !input.value.trim()) {
                    input.style.borderColor = '#e74c3c';
                    hasError = true;
                } else {
                    input.style.borderColor = 'var(--soft-rose)';
                }
            });
            
            if (hasError) {
                showCustomAlert('Please fill in all required fields.');
                return;
            }
            
            if (window.currentPromptCallback) {
                window.currentPromptCallback(data);
                window.currentPromptCallback = null;
            }
            
            closeCustomPrompt();
        }

        function closeCustomPrompt() {
            const promptBox = document.querySelector('[style*="position: fixed"][style*="z-index: 2000"]');
            const overlay = document.querySelector('[style*="position: fixed"][style*="z-index: 1999"]');
            if (promptBox) promptBox.remove();
            if (overlay) overlay.remove();
            window.currentPromptCallback = null;
        }

        // Initialize
        document.addEventListener('DOMContentLoaded', function() {
            // Migrate old project data format
            migrateOldProjects();
            
            document.getElementById('startDate').valueAsDate = new Date();
            // Removed hours form initialization since Hours section was removed
            
            displayProjects();
            updateDashboard();
            updateUpcomingEvents();
        });
        
        // Logo upload functionality
        function uploadCompanyLogo() {
            const input = document.createElement('input');
            input.type = 'file';
            input.accept = 'image/*';
            
            input.onchange = function(e) {
                const file = e.target.files[0];
                if (!file) return;
                
                // Check file size (limit to 2MB)
                if (file.size > 2 * 1024 * 1024) {
                    showCustomAlert('Logo file size must be less than 2MB.');
                    return;
                }
                
                const reader = new FileReader();
                reader.onload = function(e) {
                    const logoData = e.target.result;
                    localStorage.setItem('companyLogo', logoData);
                    showCustomAlert('Logo uploaded successfully! It will appear on all future invoices. ✨');
                };
                reader.readAsDataURL(file);
            };
            
            input.click();
        }
    </script>
</body>
</html>