<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Kelly Ram Designs - Enhanced Project Management System v2</title>
    <!-- html2pdf library for PDF generation -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.10.1/html2pdf.bundle.min.js"></script>
    <style>
        /* Import Inter font */
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap');
        
        :root {
            /* Backgrounds */
            --main-bg: #F5F5F4;           /* Soft Warm Gray */
            --section-bg: #EDEAE6;        /* Pale Pebble */
            --card-bg: #F2EFEB;           /* Mist Linen */
            --hover-bg: #E8E4DF;          /* Whisper Beige */
            
            /* Primary & Secondary Branding */
            --primary-brand: #D8A7A7;     /* Dusty Rose */
            --secondary-brand: #9CAEC2;   /* Slate Blue */
            --highlight: #B7C4B2;         /* Sage Green */
            
            /* Section-Specific Colors */
            --dashboard-bg: #EAE0D5;      /* Pale Sandstone */
            --task-bg: #D3DCE6;           /* Powder Blue */
            --calendar-bg: #CBBEDC;       /* Misty Lilac */
            --client-bg: #EED3D3;         /* Blush Nude */
            --media-bg: #D1C9D6;          /* Ash Lavender */
            --finance-bg: #F0E5D8;        /* Champagne Beige */
            
            /* Text & Icons */
            --text-primary: #333333;      /* Charcoal Gray */
            --text-secondary: #666666;    /* Slate Gray */
            --text-tertiary: #A3A3A3;     /* Stone Gray */
            --text-inverse: #FAFAFA;      /* Soft White */
            
            /* Feedback & States */
            --success: #B7C4B2;           /* Sage Green */
            --warning: #D8C690;           /* Muted Gold */
            --error: #E2A39D;             /* Soft Terracotta */
            --info: #9CAEC2;              /* Slate Blue */
            
            /* Additional Variables */
            --dusty-blue: #9CAEC2;        /* Same as secondary-brand */
            --lavender-mist: #CBBEDC;     /* Same as calendar-bg */
            --soft-rose: #D8A7A7;         /* Same as primary-brand */
        }

        body {
            font-family: 'Inter', -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            margin: 0;
            padding: 20px;
            background: var(--main-bg);
            min-height: 100vh;
            color: var(--text-primary);
            font-weight: 400;
            line-height: 1.6;
        }
        
        .container {
            max-width: 1400px;
            margin: 0 auto;
            background: var(--card-bg);
            border-radius: 20px;
            box-shadow: 0 10px 40px rgba(51, 51, 51, 0.06);
            overflow: hidden;
            border: 1px solid var(--section-bg);
        }
        
        .header {
            background: linear-gradient(135deg, var(--primary-brand), var(--secondary-brand));
            color: var(--text-inverse);
            padding: 30px;
            text-align: center;
            position: relative;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 20px;
        }
        
        .logo {
            width: 60px;
            height: 60px;
            background: var(--card-bg);
            border-radius: 8px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: 700;
            color: var(--text-primary);
            font-size: 24px;
            box-shadow: 0 4px 15px rgba(51, 51, 51, 0.15);
        }
        
        .logo svg {
            width: 40px;
            height: 40px;
            fill: var(--text-primary);
        }
        
        .header-text {
            text-align: left;
        }
        
        .header h1 {
            margin: 0 0 5px 0;
            font-size: 2.2em;
            font-weight: 500;
            letter-spacing: 2px;
            color: var(--text-primary);
        }
        
        .header p {
            margin: 0;
            opacity: 0.8;
            font-size: 1.1em;
            font-weight: 300;
        }
        
        .tabs {
            display: flex;
            background: var(--section-bg);
        }
        
        .tab {
            flex: 1;
            padding: 18px 15px;
            text-align: center;
            cursor: pointer;
            transition: all 0.3s ease;
            border: none;
            background: transparent;
            font-size: 15px;
            font-weight: 500;
            color: var(--text-secondary);
        }
        
        .tab.active {
            background: var(--card-bg);
            color: var(--text-primary);
            border-radius: 15px 15px 0 0;
            transform: translateY(-2px);
            box-shadow: 0 -4px 20px rgba(51, 51, 51, 0.12);
            font-weight: 600;
        }
        
        .tab:hover:not(.active) {
            background: var(--hover-bg);
            transform: translateY(-1px);
        }
        
        .tab-content {
            display: none;
            padding: 40px;
            background: var(--card-bg);
        }
        
        .tab-content.active {
            display: block;
        }
        
        .btn {
            background: linear-gradient(135deg, var(--secondary-brand), var(--info));
            color: var(--text-inverse);
            padding: 12px 25px;
            border: none;
            border-radius: 25px;
            cursor: pointer;
            font-size: 14px;
            font-weight: 500;
            font-family: 'Inter', sans-serif;
            transition: all 0.3s ease;
            box-shadow: 0 4px 15px rgba(156, 174, 194, 0.25);
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }
        
        .btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 25px rgba(168, 200, 216, 0.4);
        }
        
        .btn-success {
            background: linear-gradient(135deg, var(--success), var(--highlight));
        }
        
        .btn-coral {
            background: linear-gradient(135deg, var(--primary-brand), var(--client-bg));
        }
        
        .btn-small {
            padding: 8px 16px;
            font-size: 12px;
        }
        
        .card {
            background: var(--card-bg);
            border-radius: 16px;
            padding: 25px;
            box-shadow: 0 4px 20px rgba(51, 51, 51, 0.06);
            margin-bottom: 25px;
            border: 1px solid var(--section-bg);
        }
        
        .card p {
            font-size: 16px;
            margin-bottom: 14px;
            line-height: 1.5;
        }
        
        .card strong {
            font-size: 18px;
            font-weight: 600;
            color: var(--text-primary);
            letter-spacing: 0.3px;
        }
        
        .two-column {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 30px;
        }
        
        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(180px, 1fr));
            gap: 15px;
            margin-bottom: 25px;
        }
        
        .stat-card {
            background: linear-gradient(135deg, var(--dashboard-bg), var(--card-bg));
            border-radius: 12px;
            padding: 18px;
            text-align: center;
            box-shadow: 0 2px 12px rgba(51, 51, 51, 0.06);
            border: 1px solid var(--section-bg);
        }
        
        .stat-value {
            font-size: 2em;
            font-weight: 700;
            color: var(--text-primary);
            margin-bottom: 6px;
        }
        
        .stat-label {
            font-size: 12px;
            color: var(--text-secondary);
            text-transform: uppercase;
            letter-spacing: 1px;
            font-weight: 600;
        }
        
        .project-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(350px, 1fr));
            gap: 25px;
            margin-bottom: 30px;
        }
        
        .project-card {
            background: linear-gradient(135deg, var(--client-bg), var(--card-bg));
            border-radius: 16px;
            padding: 25px;
            box-shadow: 0 4px 20px rgba(51, 51, 51, 0.08);
            border: 1px solid var(--section-bg);
            cursor: pointer;
            transition: all 0.3s ease;
        }
        
        .project-card:hover {
            transform: translateY(-3px);
            box-shadow: 0 8px 30px rgba(51, 51, 51, 0.12);
        }
        
        /* Section-Specific Tab Content Styling */
        #dashboard .tab-content {
            background: linear-gradient(135deg, var(--dashboard-bg), var(--main-bg));
        }
        
        #projects .tab-content {
            background: linear-gradient(135deg, var(--task-bg), var(--main-bg));
        }
        

        
        /* Typography Improvements */
        h1, h2, h3, h4, h5, h6 {
            font-family: 'Inter', sans-serif;
            font-weight: 600;
            line-height: 1.4;
        }
        
        input, textarea, select, button {
            font-family: 'Inter', sans-serif;
        }
        
        .custom-alert {
            font-family: 'Inter', sans-serif;
        }
        
        .project-header {
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
            margin-bottom: 15px;
        }
        
        .project-title {
            font-size: 18px;
            font-weight: 700;
            color: var(--text-primary);
            margin: 0;
        }
        
        .project-status {
            padding: 6px 12px;
            border-radius: 20px;
            font-size: 11px;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }
        
        .status-consultation { background: linear-gradient(135deg, #e67e22, #d35400); color: white; }
        .status-design { background: linear-gradient(135deg, #3498db, #2980b9); color: white; }
        .status-sourcing { background: linear-gradient(135deg, #9b59b6, #8e44ad); color: white; }
        .status-ordering { background: linear-gradient(135deg, #f39c12, #e67e22); color: white; }
        .status-delivery { background: linear-gradient(135deg, #16a085, #1abc9c); color: white; }
        .status-completed { background: linear-gradient(135deg, #27ae60, #2ecc71); color: white; }
        
        .project-client {
            margin-bottom: 15px;
            font-size: 15px;
            color: var(--text-secondary);
        }
        
        .project-meta {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-top: 15px;
            font-size: 13px;
            color: var(--text-secondary);
        }
        
        .project-value {
            font-weight: 700;
            color: var(--text-primary);
            font-size: 14px;
        }
        
        .form-group {
            margin-bottom: 20px;
        }
        
        label {
            display: block;
            margin-bottom: 8px;
            font-weight: 500;
            color: var(--text-primary);
            font-size: 14px;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }
        
        input, textarea, select {
            width: 100%;
            padding: 12px;
            border: 2px solid var(--section-bg);
            border-radius: 12px;
            font-size: 15px;
            transition: all 0.3s ease;
            background: var(--card-bg);
            color: var(--text-primary);
        }
        
        input:focus, textarea:focus, select:focus {
            border-color: var(--secondary-brand);
            outline: none;
            box-shadow: 0 0 0 3px rgba(168, 200, 216, 0.2);
        }
        
        .modal {
            display: none;
            position: fixed;
            z-index: 1000;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            background: rgba(45, 43, 40, 0.8);
            backdrop-filter: blur(5px);
        }
        
        .modal-content {
            background: var(--card-bg);
            margin: 2% auto;
            padding: 0;
            border-radius: 20px;
            width: 95%;
            max-width: 1200px;
            max-height: 90vh;
            overflow: hidden;
            box-shadow: 0 20px 60px rgba(45, 43, 40, 0.3);
            display: flex;
            flex-direction: column;
        }
        
        .modal-header {
            background: linear-gradient(135deg, var(--dusty-blue), var(--lavender-mist));
            padding: 30px;
            border-radius: 20px 20px 0 0;
            display: flex;
            justify-content: space-between;
            align-items: center;
            position: sticky;
            top: 0;
            z-index: 100;
        }
        
        .modal-body {
            padding: 0;
            flex: 1;
            overflow-y: auto;
            display: flex;
            flex-direction: column;
        }
        
        .project-tabs {
            position: sticky;
            top: 0;
            background: white;
            z-index: 99;
            border-bottom: 1px solid var(--hover-bg);
            padding: 0 40px;
            margin: 0;
        }
        
        .project-sections-container {
            flex: 1;
            overflow-y: auto;
        }
        
        
        .close {
            color: var(--text-primary);
            font-size: 28px;
            font-weight: bold;
            cursor: pointer;
            transition: color 0.3s;
        }
        
        .close:hover {
            color: var(--text-secondary);
        }
        
        .project-tabs {
            display: flex;
            margin-bottom: 30px;
            border-bottom: 2px solid var(--soft-rose);
            width: 100%;
        }
        
        .project-tab {
            flex: 1;
            padding: 18px 24px;
            cursor: pointer;
            border: none;
            background: none;
            color: var(--text-secondary);
            font-size: 18px;
            font-weight: 600;
            border-bottom: 3px solid transparent;
            text-align: center;
            transition: all 0.3s ease;
            white-space: nowrap;
        }
        
        .project-tab.active {
            color: var(--text-primary);
            border-bottom-color: var(--secondary-brand);
        }
        
        .project-section {
            display: none;
            padding: 20px 40px;
        }
        
        .project-section.active {
            display: block;
        }
        
        .section-header {
            background: var(--task-bg);
            padding: 15px 20px;
            border-radius: 10px;
            margin: 10px 0;
            cursor: pointer;
            display: flex;
            justify-content: space-between;
            align-items: center;
            transition: all 0.3s ease;
        }
        
        .section-header:hover {
            background: var(--lavender-mist);
        }
        
        .section-content {
            display: none;
            padding: 20px;
            background: rgba(255,255,255,0.5);
            border-radius: 0 0 10px 10px;
            margin-bottom: 15px;
        }
        
        .section-content.expanded {
            display: block;
        }
        
        .item-grid {
            display: grid;
            grid-template-columns: 2fr 0.8fr 1fr 1fr 0.8fr 0.8fr 1fr 1fr auto;
            gap: 12px;
            align-items: center;
            padding: 12px;
            background: var(--card-bg);
            border-radius: 8px;
            margin-bottom: 10px;
            border: 1px solid var(--section-bg);
            font-size: 14px;
        }
        
        .item-grid.header {
            background: var(--task-bg);
            font-weight: 600;
            color: var(--text-primary);
            margin-bottom: 15px;
        }
        
        .custom-alert {
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background: var(--card-bg);
            border: 2px solid var(--gentle-blue);
            border-radius: 16px;
            padding: 30px;
            box-shadow: 0 20px 60px rgba(45, 43, 40, 0.3);
            z-index: 2000;
            max-width: 400px;
            width: 90%;
            max-height: 70vh;
            overflow-y: auto;
            text-align: center;
        }
        
        .custom-alert-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(45, 43, 40, 0.7);
            backdrop-filter: blur(5px);
            z-index: 1999;
        }
        
        .upcoming-event {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 12px 15px;
            background: rgba(255,255,255,0.7);
            border-radius: 8px;
            margin-bottom: 10px;
            border-left: 4px solid var(--gentle-blue);
        }
        
        @media print {
            body * { visibility: hidden; }
            .invoice-preview, .invoice-preview * { visibility: visible; }
            .invoice-preview { position: absolute; left: 0; top: 0; width: 100%; }
            .btn { display: none !important; }
        }
        
        @media (max-width: 768px) {
            .project-grid, .two-column, .stats-grid {
                grid-template-columns: 1fr;
            }
            .item-grid {
                grid-template-columns: 1fr;
                gap: 10px;
            }
            .project-tabs {
                flex-wrap: wrap;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <div class="logo">
                <svg viewBox="0 0 400 300" xmlns="http://www.w3.org/2000/svg">
                    <!-- House/Building Icon inspired by the logo -->
                    <g stroke="currentColor" stroke-width="6" fill="none">
                        <!-- Main building structure -->
                        <path d="M50 250 L50 150 L120 100 L190 150 L190 250 Z"/>
                        <path d="M210 250 L210 170 L280 120 L350 170 L350 250 Z"/>
                        <!-- Rooflines -->
                        <path d="M30 150 L120 90 L210 150"/>
                        <path d="M190 170 L280 110 L370 170"/>
                        <!-- Vertical support lines -->
                        <line x1="80" y1="130" x2="80" y2="250"/>
                        <line x1="160" y1="130" x2="160" y2="250"/>
                        <line x1="240" y1="150" x2="240" y2="250"/>
                        <line x1="320" y1="150" x2="320" y2="250"/>
                        <!-- Horizontal foundation lines -->
                        <line x1="30" y1="250" x2="370" y2="250"/>
                    </g>
                </svg>
            </div>
            <div class="header-text">
                <h1>Kelly Ram Designs</h1>
                <p>Professional Project Management System</p>
            </div>
        </div>
        
        <div class="tabs">
            <button class="tab active" onclick="showTab('dashboard', event)">Dashboard</button>
            <button class="tab" onclick="showTab('projects', event)">Projects</button>
        </div>

        <!-- Dashboard Tab -->
        <div id="dashboard" class="tab-content active">
            <h2 style="margin-bottom: 30px; color: var(--text-primary); font-weight: 300;">Business Overview</h2>
            
            <div class="stats-grid">
                <div class="stat-card">
                    <div class="stat-value" id="activeProjectsStat">0</div>
                    <div class="stat-label">Active Projects</div>
                </div>
                <div class="stat-card">
                    <div class="stat-value" id="totalRevenueStat">$0</div>
                    <div class="stat-label">Total Profit</div>
                </div>
                <div class="stat-card">
                    <div class="stat-value" id="totalPaidHoursStat">0</div>
                    <div class="stat-label">Total Paid Hours</div>
                </div>
                <div class="stat-card">
                    <div class="stat-value" id="totalProjectsStat">0</div>
                    <div class="stat-label">Total Projects</div>
                </div>
            </div>

            <div class="two-column">
                <div class="card">
                    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px;">
                        <h3 style="margin: 0; color: var(--text-primary);">Events Calendar</h3>
                        <div style="display: flex; gap: 8px; align-items: center;">
                            <button onclick="changeCalendarMonth(-1)" style="background: var(--section-bg); border: none; border-radius: 50%; width: 30px; height: 30px; cursor: pointer; display: flex; align-items: center; justify-content: center; color: var(--text-primary);" title="Previous Month">‚Äπ</button>
                            <span id="calendarMonthYear" style="font-weight: 600; min-width: 120px; text-align: center; color: var(--text-primary); font-size: 14px;"></span>
                            <button onclick="changeCalendarMonth(1)" style="background: var(--section-bg); border: none; border-radius: 50%; width: 30px; height: 30px; cursor: pointer; display: flex; align-items: center; justify-content: center; color: var(--text-primary);" title="Next Month">‚Ä∫</button>
                    </div>
                    </div>
                    
                    <!-- Calendar Grid -->
                    <div id="eventsCalendar" style="display: grid; grid-template-columns: repeat(7, 1fr); gap: 2px; margin-bottom: 15px;">
                        <!-- Days of week header -->
                        <div style="padding: 8px 4px; text-align: center; font-weight: 600; font-size: 12px; color: var(--text-secondary);">Sun</div>
                        <div style="padding: 8px 4px; text-align: center; font-weight: 600; font-size: 12px; color: var(--text-secondary);">Mon</div>
                        <div style="padding: 8px 4px; text-align: center; font-weight: 600; font-size: 12px; color: var(--text-secondary);">Tue</div>
                        <div style="padding: 8px 4px; text-align: center; font-weight: 600; font-size: 12px; color: var(--text-secondary);">Wed</div>
                        <div style="padding: 8px 4px; text-align: center; font-weight: 600; font-size: 12px; color: var(--text-secondary);">Thu</div>
                        <div style="padding: 8px 4px; text-align: center; font-weight: 600; font-size: 12px; color: var(--text-secondary);">Fri</div>
                        <div style="padding: 8px 4px; text-align: center; font-weight: 600; font-size: 12px; color: var(--text-secondary);">Sat</div>
                        <!-- Calendar days will be populated here -->
                    </div>
                    

                </div>
                <div class="card">
                    <h3 style="margin-top: 0; color: var(--text-primary);">Quick Actions</h3>
                    <button class="btn btn-success" onclick="openNewProjectModal()" style="width: 100%; margin-bottom: 15px;">New Project</button>
                    <button class="btn btn-coral" onclick="showTab('projects', event)" style="width: 100%; margin-bottom: 15px;">View All Projects</button>
                    <button class="btn" onclick="addQuickEvent()" style="width: 100%; margin-bottom: 15px;">Quick Add Event</button>
                </div>
            </div>
        </div>

        <!-- Projects Tab -->
        <div id="projects" class="tab-content">
            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 30px;">
                <div>
                    <h2 style="margin: 0; color: var(--text-primary); font-weight: 300;">Projects</h2>
                    <div style="margin-top: 10px; display: flex; gap: 10px; align-items: center;">
                        <input type="text" id="projectSearch" placeholder="Search projects..." style="padding: 8px 12px; border: 2px solid var(--section-bg); border-radius: 20px; width: 250px; font-size: 14px;" onkeyup="filterProjects()">
                        <select id="statusFilter" onchange="filterProjects()" style="padding: 8px 12px; border: 2px solid var(--section-bg); border-radius: 12px;">
                            <option value="active">Active Only</option>
                            <option value="">All Status</option>
                            <option value="consultation">Consultation</option>
                            <option value="design">Design</option>
                            <option value="sourcing">Sourcing</option>
                            <option value="ordering">Ordering</option>
                            <option value="delivery">Delivery</option>
                            <option value="completed">Completed</option>
                        </select>
                    </div>
                </div>
                <div>
                    <button class="btn" onclick="duplicateProject()" style="margin-right: 10px;">Duplicate Last</button>
                    <button class="btn btn-success" onclick="openNewProjectModal()">Create New Project</button>
                </div>
            </div>
            
            <div class="project-grid" id="projectGrid">
                <!-- Projects will be populated here -->
            </div>
        </div>


    </div>

    <!-- New/Edit Project Modal -->
    <div id="projectModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2 id="modalTitle" style="margin: 0; color: var(--text-primary);">Create New Project</h2>
                <span class="close" onclick="closeProjectModal()">&times;</span>
            </div>
            <div class="modal-body">
                <div class="two-column">
                    <div>
                        <div class="form-group">
                            <label for="projectName">Project Name:</label>
                            <input type="text" id="projectName" required>
                        </div>
                        <div class="form-group">
                            <label for="clientName">Client Name:</label>
                            <input type="text" id="clientName" required>
                        </div>
                        <div class="form-group">
                            <label for="clientEmail">Client Email:</label>
                            <input type="email" id="clientEmail" placeholder="client@example.com">
                        </div>
                        <div class="form-group">
                            <label for="clientPhone">Client Phone:</label>
                            <input type="tel" id="clientPhone" placeholder="(555) 123-4567">
                        </div>
                        <div class="form-group">
                            <label for="clientAddress">Client Address:</label>
                            <textarea id="clientAddress" rows="2" placeholder="Full address"></textarea>
                        </div>
                    </div>
                    <div>
                        <div class="form-group">
                            <label for="projectStatus">Project Status:</label>
                            <select id="projectStatus">
                                <option value="consultation">Consultation</option>
                                <option value="design">Design Phase</option>
                                <option value="sourcing">Sourcing</option>
                                <option value="ordering">Ordering</option>
                                <option value="delivery">Delivery</option>
                                <option value="completed">Completed</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label for="startDate">Start Date:</label>
                            <input type="date" id="startDate">
                        </div>
                        <div class="form-group">
                            <label for="budget">Budget (Optional):</label>
                            <input type="number" id="budget" step="0.01" placeholder="Leave blank if no budget">
                        </div>
                        <div class="form-group">
                            <label for="hourlyRate">Hourly Rate:</label>
                            <input type="number" id="hourlyRate" step="0.01" value="75" placeholder="75.00">
                        </div>
                        <div class="form-group">
                            <label for="hoursPaid">Hours Paid:</label>
                            <input type="number" id="hoursPaid" step="0.25" value="10" placeholder="Hours client paid for">
                        </div>
                        <div class="form-group">
                            <label for="projectNotes">Notes:</label>
                            <textarea id="projectNotes" rows="3"></textarea>
                        </div>
                    </div>
                </div>
                
                <div style="margin-top: 30px;">
                    <button class="btn btn-success" onclick="saveProject()">Save Project</button>
                    <button class="btn" onclick="closeProjectModal()" style="margin-left: 15px;">Cancel</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Project Detail Modal -->
    <div id="projectDetailModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <div>
                    <h2 id="projectDetailTitle" style="margin: 0; color: var(--text-primary);">Project Details</h2>
                    <span id="projectDetailClient" style="color: var(--text-secondary); font-size: 16px;"></span>
                </div>
                <span class="close" onclick="closeProjectDetailModal()">&times;</span>
            </div>
            <div class="modal-body">
                <div class="project-tabs">
                    <button class="project-tab active" onclick="showProjectSection('overview', this)">Details</button>
                    <button class="project-tab" onclick="showProjectSection('items', this)">Items</button>
                    <button class="project-tab" onclick="showProjectSection('orders', this)">Orders</button>
                    <button class="project-tab" onclick="showProjectSection('moodboards', this)">Mood Boards</button>
                    <button class="project-tab" onclick="showProjectSection('invoice', this)">Invoice</button>
                </div>

                <div class="project-sections-container">
                    <!-- Project Details Section -->
                    <div id="overview" class="project-section active">
                    <!-- Top Priority: Client Info, Hours & Quick Actions in compact layout -->
                    <div style="display: grid; grid-template-columns: 2fr 1fr 1.5fr; gap: 20px; margin-bottom: 20px;">
                        <div class="card">
                            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px;">
                                <h4 style="margin: 0; font-size: 16px;">Client Info</h4>
                                <button class="btn btn-small btn-coral" onclick="editProjectInfo()">‚úèÔ∏è Edit</button>
                            </div>
                            <p style="margin: 8px 0; font-size: 14px;"><strong>Client:</strong> <span id="detailClientName"></span></p>
                            <p style="margin: 8px 0; font-size: 14px;"><strong>Email:</strong> <span id="detailClientEmail"></span></p>
                            <p style="margin: 8px 0; font-size: 14px;"><strong>Phone:</strong> <span id="detailClientPhone"></span></p>
                            <p style="margin: 8px 0; font-size: 14px;"><strong>Address:</strong> <span id="detailClientAddress"></span></p>
                            <p style="margin: 8px 0; font-size: 14px;"><strong>Status:</strong> <span id="detailStatus"></span></p>
                            <p style="margin: 8px 0; font-size: 14px;"><strong>Start Date:</strong> <span id="detailStartDate"></span></p>
                            <p style="margin: 8px 0; font-size: 14px;"><strong>Budget:</strong> <span id="detailBudget"></span></p>
                        </div>
                        
                        <div class="card">
                            <h4 style="margin: 0 0 10px 0; font-size: 16px;">Hours</h4>
                            <div style="text-align: center; padding: 12px; background: var(--task-bg); border-radius: 8px; margin-bottom: 10px;">
                                <div style="font-size: 20px; font-weight: 700; color: var(--text-primary);" id="detailHoursWorked">0</div>
                                <div style="font-size: 11px; color: var(--text-secondary);">Worked</div>
                            </div>
                            <div style="text-align: center; padding: 12px; background: var(--info); border-radius: 8px; margin-bottom: 10px;">
                                <div style="font-size: 20px; font-weight: 700; color: var(--text-primary);" id="detailHoursPaid">0</div>
                                <div style="font-size: 11px; color: var(--text-secondary);">Paid Hours</div>
                            </div>
                            <div style="text-align: center; padding: 12px; background: var(--success); border-radius: 8px;">
                                <div style="font-size: 20px; font-weight: 700; color: var(--text-primary);" id="detailHoursRemaining">0</div>
                                <div style="font-size: 11px; color: var(--text-secondary);">Remaining</div>
                            </div>
                        </div>

                        <div class="card">
                            <h4 style="margin: 0 0 10px 0; font-size: 16px;">Quick Actions</h4>
                            <button class="btn" onclick="changeProjectStatus()" style="margin: 4px 0; width: 100%; padding: 10px 15px; font-size: 14px; background: var(--secondary-brand); color: white;">üîÑ Change Status</button>
                            <button class="btn" onclick="addEvent()" style="margin: 4px 0; width: 100%; padding: 10px 15px; font-size: 14px; background: var(--highlight); color: white;">üìÖ Add Event</button>
                            <button class="btn" onclick="logProjectHours()" style="margin: 4px 0; width: 100%; padding: 10px 15px; font-size: 14px; background: var(--warning); color: var(--text-primary);">‚è∞ Log Hours</button>                                          
                            <button class="btn" onclick="addPaidHours()" style="margin: 4px 0; width: 100%; padding: 10px 15px; font-size: 14px; background: var(--success); color: white;">üí∞ Add Paid Hours</button>
                        </div>
                    </div>

                    <!-- Upcoming Events only -->
                    <div class="card" style="margin-top: 20px;">
                        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px;">
                            <h4 style="margin: 0; font-size: 16px;">Upcoming Events</h4>
                            <button onclick="addProjectEvent()" style="background: var(--primary-brand); color: white; border: none; padding: 8px 16px; border-radius: 6px; font-size: 13px; cursor: pointer; display: flex; align-items: center; gap: 6px; transition: all 0.2s ease;" onmouseover="this.style.transform='translateY(-1px)'; this.style.boxShadow='0 4px 8px rgba(0,0,0,0.15)'" onmouseout="this.style.transform='translateY(0)'; this.style.boxShadow='none'">
                                <span style="font-size: 14px;">+</span>
                                Add Event
                            </button>
                        </div>
                        <div id="projectUpcomingEvents"></div>
                    </div>
                    

                </div>

                <!-- Items Section -->
                <div id="items" class="project-section">
                    <div style="margin-bottom: 30px;">
                    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
                        <h3 style="margin: 0; color: var(--text-primary);">Project Items</h3>
                            <div style="display: flex; gap: 12px; align-items: center;">
                                <button onclick="toggleFileManagement()" style="padding: 12px 20px; background: var(--secondary-brand); color: white; border-radius: 10px; font-weight: 500; border: none; cursor: pointer; transition: all 0.2s ease; display: flex; align-items: center; gap: 8px;" onmouseover="this.style.transform='translateY(-2px)'; this.style.boxShadow='0 6px 20px rgba(156, 174, 194, 0.3)'" onmouseout="this.style.transform='translateY(0)'; this.style.boxShadow='none'">
                                    <span id="fileManagementIcon" style="transition: transform 0.2s ease;">‚öôÔ∏è</span>
                                    <span>File Tools</span>
                                </button>
                                <button class="btn" onclick="addNewSection()" style="background: var(--success); color: white; padding: 12px 24px; border-radius: 10px; font-weight: 600; border: none; cursor: pointer; transition: all 0.2s ease; display: flex; align-items: center; gap: 8px;" onmouseover="this.style.transform='translateY(-2px)'; this.style.boxShadow='0 6px 20px rgba(183, 196, 178, 0.3)'" onmouseout="this.style.transform='translateY(0)'; this.style.boxShadow='none'">
                                    <span style="font-size: 16px;">+</span>
                                    Add New Section
                                </button>
                            </div>
                        </div>
                        
                        <!-- Collapsible File Management Actions -->
                        <div id="fileManagementSection" style="display: none; margin-bottom: 20px; overflow: hidden; transition: all 0.3s ease;">
                                <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 15px; padding: 20px; background: var(--section-bg); border-radius: 12px; border: 1px solid var(--hover-bg);">
                                    <div style="text-align: center;">
                                        <div style="width: 50px; height: 50px; background: var(--primary-brand); border-radius: 12px; display: flex; align-items: center; justify-content: center; margin: 0 auto 12px; color: white; font-size: 20px;">üì§</div>
                                        <h4 style="margin: 0 0 8px 0; font-size: 16px; color: var(--text-primary);">Import Items</h4>
                                        <p style="margin: 0 0 15px 0; font-size: 13px; color: var(--text-secondary); line-height: 1.4;">Upload a CSV file with your project items</p>
                                        <button class="btn" onclick="importItemsCSV()" style="background: var(--primary-brand); color: white; padding: 10px 20px; border-radius: 8px; font-weight: 500; border: none; cursor: pointer; transition: all 0.2s ease; width: 100%;" onmouseover="this.style.background='#c49999'" onmouseout="this.style.background='var(--primary-brand)'">
                                            Import CSV
                                        </button>
                                    </div>
                                    
                                    <div style="text-align: center;">
                                        <div style="width: 50px; height: 50px; background: var(--secondary-brand); border-radius: 12px; display: flex; align-items: center; justify-content: center; margin: 0 auto 12px; color: white; font-size: 20px;">üìã</div>
                                        <h4 style="margin: 0 0 8px 0; font-size: 16px; color: var(--text-primary);">Get Template</h4>
                                        <p style="margin: 0 0 15px 0; font-size: 13px; color: var(--text-secondary); line-height: 1.4;">Download the CSV template with proper formatting</p>
                                        <button class="btn" onclick="downloadCSVTemplate()" style="background: var(--secondary-brand); color: white; padding: 10px 20px; border-radius: 8px; font-weight: 500; border: none; cursor: pointer; transition: all 0.2s ease; width: 100%;" onmouseover="this.style.background='#8a9bb0'" onmouseout="this.style.background='var(--secondary-brand)'">
                                            Download Template
                                        </button>
                                    </div>
                                    
                                    <div style="text-align: center;">
                                        <div style="width: 50px; height: 50px; background: var(--highlight); border-radius: 12px; display: flex; align-items: center; justify-content: center; margin: 0 auto 12px; color: white; font-size: 20px;">üì•</div>
                                        <h4 style="margin: 0 0 8px 0; font-size: 16px; color: var(--text-primary);">Export Items</h4>
                                        <p style="margin: 0 0 15px 0; font-size: 13px; color: var(--text-secondary); line-height: 1.4;">Download all project items as CSV file</p>
                                        <button class="btn" onclick="downloadProjectItemsCSV()" style="background: var(--highlight); color: white; padding: 10px 20px; border-radius: 8px; font-weight: 500; border: none; cursor: pointer; transition: all 0.2s ease; width: 100%;" onmouseover="this.style.background='#a5b29f'" onmouseout="this.style.background='var(--highlight)'">
                                            Export Items
                                        </button>
                                    </div>
                                </div>
                            </div>
                        </div>
                    
                    <div id="projectSections">
                        <!-- Sections will be populated here -->
                    </div>
                    </div>
                </div>

                <!-- Orders Section -->
                <div id="orders" class="project-section">
                    <!-- Delivery Progress -->
                    <div class="card" style="margin-bottom: 25px;">
                        <h3 style="margin: 0 0 20px 0; text-align: center; color: var(--text-primary); font-weight: 600;">Delivery Progress</h3>
                        
                        <!-- Progress Bar -->
                        <div style="margin-bottom: 20px;">
                            <div id="deliveryProgressBar" style="background: var(--section-bg); border-radius: 8px; height: 30px; display: flex; overflow: hidden; box-shadow: inset 0 2px 4px rgba(0,0,0,0.1);">
                                <div id="pendingBar" style="background: var(--warning); height: 100%; width: 0%; transition: width 0.5s ease; display: flex; align-items: center; justify-content: center; color: white; font-weight: 600; font-size: 12px;"></div>
                                <div id="orderedBar" style="background: var(--secondary-brand); height: 100%; width: 0%; transition: width 0.5s ease; display: flex; align-items: center; justify-content: center; color: white; font-weight: 600; font-size: 12px;"></div>
                                <div id="shippedBar" style="background: var(--primary-brand); height: 100%; width: 0%; transition: width 0.5s ease; display: flex; align-items: center; justify-content: center; color: white; font-weight: 600; font-size: 12px;"></div>
                                <div id="deliveredBar" style="background: var(--success); height: 100%; width: 0%; transition: width 0.5s ease; display: flex; align-items: center; justify-content: center; color: white; font-weight: 600; font-size: 12px;"></div>
                            </div>
                        </div>
                        
                        <!-- Status Legend -->
                        <div style="display: grid; grid-template-columns: repeat(4, 1fr); gap: 15px;">
                            <div onclick="setOrderFilter('pending')" id="pendingFilter" style="text-align: center; padding: 15px; background: var(--warning); color: white; border-radius: 8px; cursor: pointer; transition: all 0.2s ease; position: relative;" 
                                 onmouseover="this.style.transform='translateY(-2px)'; this.style.boxShadow='0 4px 12px rgba(0,0,0,0.2)'" 
                                 onmouseout="this.style.transform='translateY(0)'; this.style.boxShadow='none'">
                                <div style="font-size: 24px; font-weight: 700; margin-bottom: 5px;" id="pendingTotal">0</div>
                                <div style="font-size: 14px; font-weight: 500;">PENDING</div>
                            </div>
                            <div onclick="setOrderFilter('ordered')" id="orderedFilter" style="text-align: center; padding: 15px; background: var(--secondary-brand); color: white; border-radius: 8px; cursor: pointer; transition: all 0.2s ease; position: relative;" 
                                 onmouseover="this.style.transform='translateY(-2px)'; this.style.boxShadow='0 4px 12px rgba(0,0,0,0.2)'" 
                                 onmouseout="this.style.transform='translateY(0)'; this.style.boxShadow='none'">
                                <div style="font-size: 24px; font-weight: 700; margin-bottom: 5px;" id="orderedTotal">0</div>
                                <div style="font-size: 14px; font-weight: 500;">ORDERED</div>
                            </div>
                            <div onclick="setOrderFilter('shipped')" id="shippedFilter" style="text-align: center; padding: 15px; background: var(--primary-brand); color: white; border-radius: 8px; cursor: pointer; transition: all 0.2s ease; position: relative;" 
                                 onmouseover="this.style.transform='translateY(-2px)'; this.style.boxShadow='0 4px 12px rgba(0,0,0,0.2)'" 
                                 onmouseout="this.style.transform='translateY(0)'; this.style.boxShadow='none'">
                                <div style="font-size: 24px; font-weight: 700; margin-bottom: 5px;" id="shippedTotal">0</div>
                                <div style="font-size: 14px; font-weight: 500;">SHIPPED</div>
                            </div>
                            <div onclick="setOrderFilter('delivered')" id="deliveredFilter" style="text-align: center; padding: 15px; background: var(--success); color: white; border-radius: 8px; cursor: pointer; transition: all 0.2s ease; position: relative;" 
                                 onmouseover="this.style.transform='translateY(-2px)'; this.style.boxShadow='0 4px 12px rgba(0,0,0,0.2)'" 
                                 onmouseout="this.style.transform='translateY(0)'; this.style.boxShadow='none'">
                                <div style="font-size: 24px; font-weight: 700; margin-bottom: 5px;" id="deliveredTotal">0</div>
                                <div style="font-size: 14px; font-weight: 500;">DELIVERED</div>
                            </div>
                        </div>
                        
                        <!-- Clear Filter Button -->
                        <div id="clearFilterButton" style="text-align: center; margin-top: 15px; display: none;">
                            <button onclick="setOrderFilter('')" style="background: var(--hover-bg); color: var(--text-primary); border: none; padding: 8px 16px; border-radius: 6px; font-size: 13px; cursor: pointer; font-weight: 500; transition: all 0.2s ease;" 
                                    onmouseover="this.style.background='var(--section-bg)'" 
                                    onmouseout="this.style.background='var(--hover-bg)'">
                                üîÑ Show All Items
                            </button>
                        </div>
                    </div>
                    
                    <!-- Bulk Actions -->
                    <div class="card" style="margin-bottom: 25px;">
                        <div style="display: flex; justify-content: space-between; align-items: center; flex-wrap: wrap; gap: 15px;">
                            <div style="display: flex; gap: 10px; align-items: center; flex-wrap: wrap;">
                                <button onclick="selectAllOrderItems()" style="padding: 10px 16px; background: var(--section-bg); color: var(--text-primary); border: none; border-radius: 6px; font-size: 14px; cursor: pointer; font-weight: 500;">
                                    Select All
                                </button>
                                <button onclick="clearOrderSelections()" style="padding: 10px 16px; background: var(--hover-bg); color: var(--text-secondary); border: none; border-radius: 6px; font-size: 14px; cursor: pointer; font-weight: 500;">
                                    Clear All
                                </button>
                            </div>
                            <div style="display: flex; gap: 8px; align-items: center; flex-wrap: wrap;">
                                <button onclick="bulkUpdateOrderStatus('pending')" style="padding: 8px 14px; background: var(--warning); color: white; border: none; border-radius: 6px; font-size: 13px; cursor: pointer; font-weight: 500;" disabled id="bulkPendingBtn">
                                    ‚Üí Pending
                                </button>
                                <button onclick="bulkUpdateOrderStatus('ordered')" style="padding: 8px 14px; background: var(--secondary-brand); color: white; border: none; border-radius: 6px; font-size: 13px; cursor: pointer; font-weight: 500;" disabled id="bulkOrderedBtn">
                                    ‚Üí Ordered
                                </button>
                                <button onclick="bulkUpdateOrderStatus('shipped')" style="padding: 8px 14px; background: var(--primary-brand); color: white; border: none; border-radius: 6px; font-size: 13px; cursor: pointer; font-weight: 500;" disabled id="bulkShippedBtn">
                                    ‚Üí Shipped
                                </button>
                                <button onclick="bulkUpdateOrderStatus('delivered')" style="padding: 8px 14px; background: var(--success); color: white; border: none; border-radius: 6px; font-size: 13px; cursor: pointer; font-weight: 500;" disabled id="bulkDeliveredBtn">
                                    ‚Üí Delivered
                                </button>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Order Sections -->
                    <div id="orderSectionsList">
                        <!-- Order sections will be populated here -->
                    </div>
                </div>

                <!-- Mood Boards Section -->
                <div id="moodboards" class="project-section">
                    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
                        <h3 style="margin: 0; color: var(--text-primary);">Mood Boards</h3>
                        <button class="btn btn-success" onclick="uploadMoodBoard()">Upload Mood Board</button>
                    </div>
                    <div id="moodBoardGallery">
                        <!-- Mood boards will be populated here -->
                    </div>
                </div>

                <!-- Invoice Section -->
                <div id="invoice" class="project-section">
                    <div style="margin-bottom: 30px;">
                        <h3 style="margin: 0 0 15px 0; color: var(--text-primary);">Generate Invoices by Section</h3>
                        <p style="margin: 0 0 20px 0; color: var(--text-secondary); font-size: 14px;">Create separate invoices for each project section/category. This allows for flexible billing and payment tracking.</p>
                        
                        <div id="sectionInvoiceList" style="display: grid; gap: 15px;">
                            <!-- Section invoice options will be populated here -->
                        </div>
                    </div>
                    
                    <div class="invoice-preview" id="projectInvoicePreview">
                        <!-- Invoice preview will be populated here -->
                    </div>
                </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        // Sample data with enhanced structure
        let projects = JSON.parse(localStorage.getItem('projects') || '[]');
        let currentProject = null;
        let invoiceCounter = parseInt(localStorage.getItem('invoiceCounter') || '1204');
        let expandedSections = new Set(); // Track which sections are expanded
        
        // Migrate old project format to new pricing structure
        function migrateOldProjects() {
            let needsSaving = false;
            projects.forEach(project => {
                if (project.sections) {
                    project.sections.forEach(section => {
                        section.items.forEach(item => {
                            // If item has old 'price' field but no 'customerPrice', migrate it
                            if (item.price && !item.customerPrice) {
                                item.customerPrice = item.price;
                                item.wholesalePrice = item.price * 0.7; // Estimate 30% markup
                                item.shipping = 0;
                                item.tax = 0;
                                needsSaving = true;
                            }
                            
                            // Migrate old item property to name property
                            if (item.item && !item.name) {
                                item.name = item.item;
                                delete item.item;
                                needsSaving = true;
                            }
                            
                            // Migrate orderStatus to deliveryStatus
                            if (item.orderStatus && !item.deliveryStatus) {
                                item.deliveryStatus = item.orderStatus;
                                delete item.orderStatus;
                                needsSaving = true;
                            }
                            
                            // Ensure deliveryStatus exists
                            if (!item.deliveryStatus) {
                                item.deliveryStatus = 'pending';
                                needsSaving = true;
                            }
                            
                            // Ensure shippingInfo exists
                            if (!item.shippingInfo) {
                                item.shippingInfo = {
                                    carrier: '',
                                    trackingNumber: '',
                                    shippingMethod: '',
                                    estimatedDelivery: '',
                                    shippingCost: parseFloat(item.shipping) || 0,
                                    orderDate: '',
                                    notes: ''
                                };
                                needsSaving = true;
                            }
                            
                            // Ensure readyToOrder exists
                            if (item.readyToOrder === undefined) {
                                item.readyToOrder = false;
                                needsSaving = true;
                            }
                        });
                    });
                }
            });
            if (needsSaving) {
                localStorage.setItem('projects', JSON.stringify(projects));
            }
        }

        // Add sample project with enhanced data if none exist
        if (projects.length === 0) {
            projects = [{
                id: 1,
                name: "Modern Office Redesign",
                client: "Mitchel Pisarz",
                clientEmail: "mitchel@example.com",
                clientPhone: "(555) 123-4567",
                clientAddress: "123 Business Ave, Suite 100\nNew York, NY 10001",
                status: "ordering",
                startDate: "2025-01-01",
                budget: 2500,
                hoursPaid: 20,
                hoursWorked: 12.5,
                notes: "Complete office transformation with modern aesthetic",
                sections: [
                    {
                        id: 1,
                        name: "Reception Area",
                        items: [
                            { id: 1, name: "Reception Desk", qty: 1, customerPrice: 899.00, wholesalePrice: 650.00, shipping: 75.00, tax: 67.43, link: "https://example.com/desk", readyToOrder: true, deliveryStatus: "pending", shippingInfo: { carrier: '', trackingNumber: '', shippingMethod: '', estimatedDelivery: '', shippingCost: 75.00, orderDate: '', notes: '' } },
                            { id: 2, name: "Waiting Chairs", qty: 4, customerPrice: 249.00, wholesalePrice: 175.00, shipping: 25.00, tax: 79.84, link: "https://example.com/chairs", readyToOrder: false, deliveryStatus: "pending", shippingInfo: { carrier: '', trackingNumber: '', shippingMethod: '', estimatedDelivery: '', shippingCost: 25.00, orderDate: '', notes: '' } }
                        ]
                    },
                    {
                        id: 2,
                        name: "Conference Room",
                        items: [
                            { id: 3, name: "Conference Table", qty: 1, customerPrice: 1299.00, wholesalePrice: 950.00, shipping: 125.00, tax: 113.99, link: "https://example.com/table", readyToOrder: true, deliveryStatus: "pending", shippingInfo: { carrier: '', trackingNumber: '', shippingMethod: '', estimatedDelivery: '', shippingCost: 125.00, orderDate: '', notes: '' } },
                            { id: 4, name: "Conference Chairs", qty: 8, customerPrice: 189.00, wholesalePrice: 135.00, shipping: 15.00, tax: 12.32, link: "https://example.com/conf-chairs", readyToOrder: true, deliveryStatus: "pending", shippingInfo: { carrier: '', trackingNumber: '', shippingMethod: '', estimatedDelivery: '', shippingCost: 15.00, orderDate: '', notes: '' } }
                        ]
                    }
                ],
                events: [
                    { id: 1, type: "consultation", title: "Initial Consultation", date: "2025-01-01", time: "10:00", notes: "Discussed client needs", completed: true },
                    { id: 2, type: "design", title: "Design Presentation", date: "2025-01-15", time: "14:00", notes: "Presented concepts", completed: true },
                    { id: 3, type: "meeting", title: "Final Review", date: "2025-01-30", time: "11:00", notes: "Final design approval", completed: false }
                ],
                hoursLog: [
                    { id: 1, date: "2025-01-01", hours: 2, description: "Initial consultation and space assessment" },
                    { id: 2, date: "2025-01-10", hours: 4, description: "Research and design development" },
                    { id: 3, date: "2025-01-15", hours: 3, description: "Design presentation preparation" },
                    { id: 4, date: "2025-01-20", hours: 2.5, description: "Client feedback and revisions" },
                    { id: 5, date: "2025-01-25", hours: 1, description: "Vendor coordination" }
                ],
                moodBoards: [],
                invoiceNumber: "011204",
                amountPaid: 0
            }];
            localStorage.setItem('projects', JSON.stringify(projects));
        }

        function showTab(tabName, event) {
            document.querySelectorAll('.tab-content').forEach(tab => {
                tab.classList.remove('active');
            });
            document.querySelectorAll('.tab').forEach(tab => {
                tab.classList.remove('active');
            });

            document.getElementById(tabName).classList.add('active');
            if (event && event.target) {
                event.target.classList.add('active');
            }

            if (tabName === 'dashboard') {
                updateDashboard();
                updateUpcomingEvents();
            } else if (tabName === 'projects') {
                displayProjects();
            }
        }

        function updateDashboard() {
            const totalProjects = projects.length;
            const activeProjects = projects.filter(p => p.status !== 'completed').length;
            
            let totalProfit = 0;
            let totalPaidHours = 0;
            
            projects.forEach(project => {
                const hourlyRate = project.hourlyRate || 75;
                const hoursPaid = project.hoursPaid || 0;
                
                // 1. Hourly income (hours paid √ó rate)
                const hourlyIncome = hoursPaid * hourlyRate;
                
                // 2. Item profit (only from ordered items, excluding grayed out sections)
                let itemProfit = 0;
                if (project.sections) {
                    project.sections.forEach(section => {
                        // Skip grayed out sections
                        if (section.isGrayedOut) return;
                        
                        section.items.forEach(item => {
                            // Only include profit from items that have been ordered
                            if (item.readyToOrder && item.orderStatus && item.orderStatus !== 'pending') {
                                const sellPrice = (item.customerPrice || item.price || 0) * (item.qty || 1);
                                const wholesalePrice = (item.wholesalePrice || 0) * (item.qty || 1);
                                const profit = sellPrice - wholesalePrice;
                                itemProfit += profit > 0 ? profit : 0; // Only positive profit
                            }
                        });
                    });
                }
                
                totalProfit += hourlyIncome + itemProfit;
                totalPaidHours += hoursPaid;
            });

            document.getElementById('totalProjectsStat').textContent = totalProjects;
            document.getElementById('totalRevenueStat').textContent = `$${totalProfit.toLocaleString('en-US', { minimumFractionDigits: 0, maximumFractionDigits: 0 })}`;
            document.getElementById('totalPaidHoursStat').textContent = `${totalPaidHours.toFixed(1)}h`;
            document.getElementById('activeProjectsStat').textContent = activeProjects;
        }

        // Calendar state
        let currentCalendarDate = new Date();
        let calendarEvents = {};

        function updateEventsCalendar() {
            // Collect all events by date
            calendarEvents = {};
            
            projects.forEach(project => {
                if (project.events) {
                    project.events.forEach(event => {
                        if (!event.completed) {
                            const dateKey = new Date(event.date).toDateString();
                            if (!calendarEvents[dateKey]) {
                                calendarEvents[dateKey] = [];
                            }
                            calendarEvents[dateKey].push({
                                ...event, 
                                projectName: project.name, 
                                clientName: project.client,
                                projectId: project.id
                            });
                        }
                    });
                }
            });
            
            renderCalendar();
        }

        function renderCalendar() {
            const calendar = document.getElementById('eventsCalendar');
            const monthYear = document.getElementById('calendarMonthYear');
            
            // Update month/year display
            const monthNames = ['January', 'February', 'March', 'April', 'May', 'June',
                'July', 'August', 'September', 'October', 'November', 'December'];
            monthYear.textContent = `${monthNames[currentCalendarDate.getMonth()]} ${currentCalendarDate.getFullYear()}`;
            
            // Clear existing days (keep header)
            const existingDays = calendar.querySelectorAll('.calendar-day');
            existingDays.forEach(day => day.remove());
            
            // Get first day of month and number of days
            const firstDay = new Date(currentCalendarDate.getFullYear(), currentCalendarDate.getMonth(), 1);
            const lastDay = new Date(currentCalendarDate.getFullYear(), currentCalendarDate.getMonth() + 1, 0);
            const startDate = new Date(firstDay);
            startDate.setDate(startDate.getDate() - firstDay.getDay()); // Start on Sunday
            
            const today = new Date();
            today.setHours(0, 0, 0, 0);
            
            // Generate 42 days (6 weeks)
            for (let i = 0; i < 42; i++) {
                const cellDate = new Date(startDate);
                cellDate.setDate(startDate.getDate() + i);
                
                const isCurrentMonth = cellDate.getMonth() === currentCalendarDate.getMonth();
                const isToday = cellDate.toDateString() === today.toDateString();
                const dateKey = cellDate.toDateString();
                const dayEvents = calendarEvents[dateKey] || [];
                
                const dayCell = document.createElement('div');
                dayCell.className = 'calendar-day';
                dayCell.style.cssText = `
                    padding: 6px 4px;
                    text-align: center;
                    cursor: pointer;
                    border-radius: 6px;
                    transition: all 0.2s ease;
                    font-size: 13px;
                    font-weight: ${isToday ? '600' : '400'};
                    color: ${isCurrentMonth ? 'var(--text-primary)' : 'var(--text-tertiary)'};
                    background: ${isToday ? 'var(--primary-brand)' : 'transparent'};
                    position: relative;
                    min-height: 32px;
                    display: flex;
                    flex-direction: column;
                    align-items: center;
                    justify-content: center;
                `;
                
                if (isToday) {
                    dayCell.style.color = 'white';
                }
                
                // Day number
                const dayNumber = document.createElement('div');
                dayNumber.textContent = cellDate.getDate();
                dayNumber.style.cssText = 'line-height: 1;';
                dayCell.appendChild(dayNumber);
                
                // Event indicators
                if (dayEvents.length > 0 && isCurrentMonth) {
                    const eventIndicator = document.createElement('div');
                    eventIndicator.style.cssText = `
                        font-size: 14px;
                        line-height: 1;
                        margin-top: 2px;
                        display: flex;
                        justify-content: center;
                        filter: drop-shadow(0 1px 2px rgba(0,0,0,0.3));
                    `;
                    
                    // Choose star color based on whether it's today or not
                    const starColor = isToday ? 'white' : 'var(--primary-brand)';
                    const shadowFilter = isToday ? 'drop-shadow(0 1px 3px rgba(0,0,0,0.5))' : 'drop-shadow(0 1px 2px rgba(0,0,0,0.3))';
                    eventIndicator.style.filter = shadowFilter;
                    
                    // Simple star indicator - more legible and consistent
                    if (dayEvents.length === 1) {
                        eventIndicator.innerHTML = `<span style="color: ${starColor};">‚òÖ</span>`;
                    } else if (dayEvents.length <= 3) {
                        eventIndicator.innerHTML = `<span style="color: ${starColor};">‚òÖ‚òÖ</span>`;
            } else {
                        eventIndicator.innerHTML = `<span style="color: ${starColor};">‚òÖ‚òÖ‚òÖ</span>`;
                    }
                    
                    dayCell.appendChild(eventIndicator);
                }
                
                // Hover effects
                if (isCurrentMonth) {
                    dayCell.onmouseover = () => {
                        if (!isToday) {
                            dayCell.style.background = 'var(--hover-bg)';
                        }
                    };
                    dayCell.onmouseout = () => {
                        if (!isToday) {
                            dayCell.style.background = 'transparent';
                        }
                    };
                    
                    // Click handler
                    dayCell.onclick = () => showDayEvents(cellDate, dayEvents);
                }
                
                calendar.appendChild(dayCell);
            }
        }

        function getEventTypeColor(type) {
            const colors = {
                'consultation': 'var(--secondary-brand)',
                'design': 'var(--success)',
                'meeting': 'var(--warning)',
                'delivery': 'var(--error)'
            };
            return colors[type] || 'var(--warning)';
        }

        function changeCalendarMonth(direction) {
            currentCalendarDate.setMonth(currentCalendarDate.getMonth() + direction);
            renderCalendar();
        }

        function showDayEvents(date, events) {
            showDayViewModal(date, events);
        }

        function showDayViewModal(selectedDate, events) {
            // Create modal overlay
            const overlay = document.createElement('div');
            overlay.style.cssText = `
                position: fixed;
                top: 0;
                left: 0;
                width: 100%;
                height: 100%;
                background: rgba(0, 0, 0, 0.7);
                backdrop-filter: blur(5px);
                z-index: 2000;
                display: flex;
                align-items: center;
                justify-content: center;
                padding: 20px;
            `;

            // Create modal content
            const modal = document.createElement('div');
            modal.style.cssText = `
                background: var(--card-bg);
                border-radius: 12px;
                box-shadow: 0 20px 40px rgba(0, 0, 0, 0.3);
                width: 100%;
                max-width: 800px;
                height: 90vh;
                display: flex;
                flex-direction: column;
                overflow: hidden;
            `;

            // Header
            const header = document.createElement('div');
            header.style.cssText = `
                padding: 20px 24px;
                border-bottom: 1px solid var(--hover-bg);
                display: flex;
                justify-content: space-between;
                align-items: center;
                background: var(--section-bg);
            `;

            const dateOptions = { 
                weekday: 'long', 
                year: 'numeric', 
                month: 'long', 
                day: 'numeric' 
            };
            
            header.innerHTML = `
                        <div>
                    <h3 style="margin: 0; color: var(--text-primary); font-size: 20px;">${selectedDate.toLocaleDateString('en-US', dateOptions)}</h3>
                    <p style="margin: 4px 0 0 0; color: var(--text-secondary); font-size: 14px;">${events.length} event${events.length === 1 ? '' : 's'} scheduled</p>
                        </div>
                <button onclick="closeDayViewModal()" style="background: none; border: none; font-size: 24px; color: var(--text-secondary); cursor: pointer; padding: 8px; border-radius: 50%; transition: all 0.2s ease;" onmouseover="this.style.background='var(--hover-bg)'" onmouseout="this.style.background='none'">&times;</button>
            `;

            // Body with hourly grid
            const body = document.createElement('div');
            body.style.cssText = `
                flex: 1;
                overflow-y: auto;
                padding: 0;
                position: relative;
            `;

            // Create hourly grid
            body.innerHTML = createHourlyGrid(selectedDate, events);

            // Footer with quick add
            const footer = document.createElement('div');
            footer.style.cssText = `
                padding: 16px 24px;
                border-top: 1px solid var(--hover-bg);
                background: var(--section-bg);
                display: flex;
                gap: 12px;
                align-items: center;
            `;

            footer.innerHTML = `
                <button onclick="addEventToDay('${selectedDate.toISOString()}')" style="
                    background: var(--primary-brand);
                    color: white;
                    border: none;
                    padding: 10px 20px;
                    border-radius: 8px;
                    font-weight: 500;
                    cursor: pointer;
                    display: flex;
                    align-items: center;
                    gap: 8px;
                    transition: all 0.2s ease;
                " onmouseover="this.style.transform='translateY(-1px)'; this.style.boxShadow='0 4px 12px rgba(0,0,0,0.15)'" onmouseout="this.style.transform='translateY(0)'; this.style.boxShadow='none'">
                    <span style="font-size: 16px;">+</span>
                    Add Event
                </button>
                <span style="color: var(--text-secondary); font-size: 13px;">Click on any time slot to quickly add an event</span>
            `;

            modal.appendChild(header);
            modal.appendChild(body);
            modal.appendChild(footer);
            overlay.appendChild(modal);
            document.body.appendChild(overlay);

            // Store reference for closing
            window.currentDayViewModal = overlay;
            
            // Close on overlay click
            overlay.addEventListener('click', (e) => {
                if (e.target === overlay) {
                    closeDayViewModal();
                }
            });
        }

        function createHourlyGrid(selectedDate, events) {
            const hours = [];
            
            // Generate 24 hours
            for (let hour = 0; hour < 24; hour++) {
                const timeString = formatHour(hour);
                const hourEvents = filterEventsForHour(events, hour);
                
                hours.push(`
                    <div class="hour-slot" style="
                        display: flex;
                        border-bottom: 1px solid var(--hover-bg);
                        min-height: 60px;
                        position: relative;
                    ">
                        <div style="
                            width: 80px;
                            padding: 12px 16px;
                            background: var(--section-bg);
                            color: var(--text-secondary);
                            font-size: 12px;
                            font-weight: 500;
                            display: flex;
                            align-items: flex-start;
                            justify-content: flex-end;
                            border-right: 1px solid var(--hover-bg);
                        ">${timeString}</div>
                        <div style="
                            flex: 1;
                            padding: 8px 16px;
                            cursor: pointer;
                            transition: background 0.2s ease;
                            position: relative;
                        " 
                        onmouseover="this.style.background='var(--hover-bg)'" 
                        onmouseout="this.style.background='transparent'"
                        onclick="addEventAtTime('${selectedDate.toISOString()}', ${hour})"
                        data-hour="${hour}">
                            ${hourEvents.map(event => createEventBlock(event)).join('')}
                            ${hourEvents.length === 0 ? '<div style="height: 44px; display: flex; align-items: center; color: var(--text-tertiary); font-size: 13px; font-style: italic;">Click to add event</div>' : ''}
                        </div>
                    </div>
                `);
            }

            return hours.join('');
        }

        function formatHour(hour) {
            if (hour === 0) return '12:00 AM';
            if (hour < 12) return `${hour}:00 AM`;
            if (hour === 12) return '12:00 PM';
            return `${hour - 12}:00 PM`;
        }

        function filterEventsForHour(events, targetHour) {
            return events.filter(event => {
                if (!event.time) return targetHour === 9; // Default to 9 AM for events without time
                
                const timeMatch = event.time.match(/(\d{1,2}):(\d{2})\s*(AM|PM)?/i);
                if (!timeMatch) return targetHour === 9;
                
                let hour = parseInt(timeMatch[1]);
                const ampm = timeMatch[3]?.toLowerCase();
                
                if (ampm === 'pm' && hour !== 12) hour += 12;
                if (ampm === 'am' && hour === 12) hour = 0;
                
                return hour === targetHour;
            });
        }

        function createEventBlock(event) {
            const color = getEventTypeColor(event.type || 'meeting');
            return `
                <div style="
                    background: ${color};
                    color: white;
                    padding: 8px 12px;
                    border-radius: 6px;
                    margin-bottom: 4px;
                    font-size: 13px;
                    line-height: 1.3;
                    box-shadow: 0 2px 4px rgba(0,0,0,0.1);
                    cursor: pointer;
                    transition: all 0.2s ease;
                " 
                onmouseover="this.style.transform='translateY(-1px)'; this.style.boxShadow='0 4px 8px rgba(0,0,0,0.2)'" 
                onmouseout="this.style.transform='translateY(0)'; this.style.boxShadow='0 2px 4px rgba(0,0,0,0.1)'"
                onclick="event.stopPropagation(); editEventInline('${event.projectId}', '${event.id}')">
                    <div style="font-weight: 600; margin-bottom: 2px;">${event.title}</div>
                    <div style="font-size: 11px; opacity: 0.9;">${event.projectName}</div>
                    ${event.time ? `<div style="font-size: 11px; opacity: 0.8;">üïê ${event.time}</div>` : ''}
                </div>
            `;
        }

        function addEventAtTime(dateString, hour) {
            const selectedDate = new Date(dateString);
            const timeString = formatHour(hour);
            
            showCustomPrompt(
                `Add Event - ${timeString}`,
                [
                    { type: 'select', name: 'projectId', label: 'Project', options: projects.map(p => ({ value: p.id, text: `${p.name} - ${p.client}` })), required: true },
                    { type: 'text', name: 'title', label: 'Event Title', required: true },
                    { type: 'select', name: 'type', label: 'Event Type', options: [
                        { value: 'consultation', text: 'Consultation' },
                        { value: 'design', text: 'Design' },
                        { value: 'meeting', text: 'Meeting' },
                        { value: 'delivery', text: 'Delivery' }
                    ], defaultValue: 'meeting', required: true },
                    { type: 'time', name: 'time', label: 'Time', defaultValue: `${hour.toString().padStart(2, '0')}:00`, required: true },
                    { type: 'textarea', name: 'notes', label: 'Notes' }
                ],
                (data) => {
                    const project = projects.find(p => p.id == data.projectId);
                    if (!project) return;

                    if (!project.events) project.events = [];
                    
                    const newEvent = {
                        id: Date.now() + Math.random(),
                        title: data.title,
                        type: data.type,
                        date: selectedDate.toISOString().split('T')[0],
                        time: data.time,
                        notes: data.notes,
                        completed: false
                    };

                    project.events.push(newEvent);
                    saveProjects();
                    
                    // Refresh the day view
                    closeDayViewModal();
                    updateEventsCalendar();
                    
                    // Reopen the day view to show the new event
                    setTimeout(() => {
                        showDayViewModal(selectedDate, getEventsForDate(selectedDate));
                    }, 100);
                    
                    showCustomAlert('Event added successfully! ‚ú®');
                }
            );
        }

        function addEventToDay(dateString) {
            const selectedDate = new Date(dateString);
            addEventAtTime(dateString, 9); // Default to 9 AM
        }

        function getEventsForDate(date) {
            const dateKey = date.toDateString();
            return calendarEvents[dateKey] || [];
        }

        function editEventInline(projectId, eventId) {
            const project = projects.find(p => p.id == projectId);
            if (!project || !project.events) return;
            
            const event = project.events.find(e => e.id == eventId);
            if (!event) return;

            showCustomPrompt(
                'Edit Event',
                [
                    { type: 'text', name: 'title', label: 'Event Title', defaultValue: event.title, required: true },
                    { type: 'select', name: 'type', label: 'Event Type', options: [
                        { value: 'consultation', text: 'Consultation' },
                        { value: 'design', text: 'Design' },
                        { value: 'meeting', text: 'Meeting' },
                        { value: 'delivery', text: 'Delivery' }
                    ], defaultValue: event.type || 'meeting', required: true },
                    { type: 'time', name: 'time', label: 'Time', defaultValue: event.time || '09:00', required: true },
                    { type: 'textarea', name: 'notes', label: 'Notes', defaultValue: event.notes || '' },
                    { type: 'checkbox', name: 'completed', label: 'Mark as completed', defaultValue: event.completed || false }
                ],
                (data) => {
                    event.title = data.title;
                    event.type = data.type;
                    event.time = data.time;
                    event.notes = data.notes;
                    event.completed = data.completed;
                    
                    saveProjects();
                    
                    // Refresh the day view
                    const selectedDate = new Date(event.date);
                    closeDayViewModal();
                    updateEventsCalendar();
                    
                    setTimeout(() => {
                        showDayViewModal(selectedDate, getEventsForDate(selectedDate));
                    }, 100);
                    
                    showCustomAlert('Event updated successfully! ‚ú®');
                }
            );
        }

        function closeDayViewModal() {
            if (window.currentDayViewModal) {
                window.currentDayViewModal.remove();
                window.currentDayViewModal = null;
            }
        }

        // Update the main function call
        function updateUpcomingEvents() {
            updateEventsCalendar();
        }

        function displayProjects() {
            // Set default filter to active projects only
            document.getElementById('statusFilter').value = 'active';
            filterProjects();
        }

        function filterProjects() {
            const searchTerm = document.getElementById('projectSearch').value.toLowerCase();
            const statusFilter = document.getElementById('statusFilter').value;
            
            const grid = document.getElementById('projectGrid');
            grid.innerHTML = '';
            
            const filteredProjects = projects.filter(project => {
                const matchesSearch = !searchTerm || 
                    project.name.toLowerCase().includes(searchTerm) || 
                    project.client.toLowerCase().includes(searchTerm);
                    
                let matchesStatus = true;
                if (statusFilter === 'active') {
                    matchesStatus = project.status !== 'completed';
                } else if (statusFilter) {
                    matchesStatus = project.status === statusFilter;
                }
                
                return matchesSearch && matchesStatus;
            });
            
            filteredProjects.forEach(project => {
                // Calculate total profit = hourly income + item profit from ordered items
                let totalProfit = 0;
                
                // 1. Hourly income (hours paid √ó rate)
                const hourlyRate = project.hourlyRate || 75; // Default to $75/hour if not set
                const hoursPaid = project.hoursPaid || 0;
                const hourlyIncome = hoursPaid * hourlyRate;
                
                // 2. Item profit (only from ordered items)
                let itemProfit = 0;
                if (project.sections) {
                    project.sections.forEach(section => {
                        // Skip grayed out sections
                        if (section.isGrayedOut) return;
                        
                        section.items.forEach(item => {
                            // Only include profit from items that have been ordered
                            if (item.readyToOrder && item.orderStatus && item.orderStatus !== 'pending') {
                                const sellPrice = (item.customerPrice || item.price || 0) * (item.qty || 1);
                                const wholesalePrice = (item.wholesalePrice || 0) * (item.qty || 1);
                                const profit = sellPrice - wholesalePrice;
                                itemProfit += profit > 0 ? profit : 0; // Only positive profit
                            }
                        });
                    });
                }
                
                totalProfit = hourlyIncome + itemProfit;
                
                const card = document.createElement('div');
                card.className = 'project-card';
                
                // Set innerHTML FIRST, then add event listeners
                card.innerHTML = `
                    <div class="project-header" style="position: relative;">
                        <h3 class="project-title">${project.name}</h3>
                        <div style="display: flex; align-items: center; gap: 10px;">
                            <span class="project-status status-${project.status}">${project.status}</span>
                            <button class="project-delete-btn" data-project-id="${project.id}"
                                    style="background: var(--error); color: white; border: none; border-radius: 50%; width: 24px; height: 24px; font-size: 12px; cursor: pointer; display: flex; align-items: center; justify-content: center;"
                                    title="Delete Project">√ó</button>
                        </div>
                    </div>
                    <div class="project-client" style="margin-bottom: 15px; font-size: 15px; color: var(--text-secondary);">Client: ${project.client}</div>
                    
                    <div style="background: rgba(255,255,255,0.7); padding: 15px; border-radius: 10px; margin-bottom: 15px;">
                        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 8px;">
                            <span style="color: var(--text-secondary); font-size: 14px;">Hours Progress</span>
                            <span style="font-weight: 700; font-size: 16px; color: ${(project.hoursPaid || 0) - (project.hoursWorked || 0) > 0 ? '#27ae60' : '#e74c3c'};">Remaining: ${((project.hoursPaid || 0) - (project.hoursWorked || 0)).toFixed(1)}h</span>
                        </div>
                        <div style="display: flex; justify-content: space-between; font-size: 15px; margin-bottom: 10px;">
                            <span style="color: var(--text-primary);"><strong>Worked:</strong> ${(project.hoursWorked || 0).toFixed(1)}h</span>
                            <span style="color: var(--text-secondary);"><strong>Paid:</strong> ${(project.hoursPaid || 0).toFixed(1)}h</span>
                        </div>
                        
                        <!-- Delivery Progress Section -->
                        ${(() => {
                            const readyItems = [];
                            let deliveredCount = 0;
                            if (project.sections) {
                                project.sections.forEach(section => {
                                    section.items.forEach(item => {
                                        if (item.readyToOrder) {
                                            readyItems.push(item);
                                            if (item.orderStatus === 'delivered') deliveredCount++;
                                        }
                                    });
                                });
                            }
                            const deliveryPercentage = readyItems.length > 0 ? (deliveredCount / readyItems.length) * 100 : 0;
                            return readyItems.length > 0 ? `
                                <div style="margin-top: 8px;">
                                    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 4px;">
                                        <span style="color: var(--text-secondary); font-size: 12px;">Delivery Progress</span>
                                        <span style="color: var(--text-secondary); font-size: 12px;">${deliveredCount}/${readyItems.length} delivered</span>
                                    </div>
                                    <div style="background: #e0e0e0; border-radius: 6px; height: 6px; overflow: hidden;">
                                        <div style="height: 100%; background: linear-gradient(90deg, #27ae60, #2ecc71); border-radius: 6px; width: ${deliveryPercentage}%; transition: width 0.3s ease;"></div>
                                    </div>
                                </div>
                            ` : '';
                        })()}
                    </div>
                    
                    <div class="project-meta">
                        <span style="color: var(--text-secondary); font-size: 13px;">Started: ${new Date(project.startDate).toLocaleDateString()}</span>
                        <span class="project-value">${totalProfit.toLocaleString('en-US', { style: 'currency', currency: 'USD' })}</span>
                    </div>
                `;
                
                // Add event listeners AFTER innerHTML is set
                const deleteBtn = card.querySelector('.project-delete-btn');
                
                deleteBtn.addEventListener('click', (e) => {
                    e.stopPropagation();
                    deleteProject(project.id);
                });
                
                // Also allow clicking anywhere on the card (except buttons)
                card.addEventListener('click', (e) => {
                    if (!e.target.closest('button')) {
                        openProjectDetail(project.id);
                    }
                });
                
                grid.appendChild(card);
            });
            
            if (filteredProjects.length === 0) {
                grid.innerHTML = '<p style="text-align: center; color: var(--text-secondary); grid-column: 1 / -1; padding: 40px;">No projects found matching your criteria.</p>';
            }
        }

        function openNewProjectModal() {
            document.getElementById('modalTitle').textContent = 'Create New Project';
            document.getElementById('projectModal').style.display = 'block';
            currentProject = null;
            
            // Reset form with smart defaults
            document.getElementById('projectName').value = '';
            document.getElementById('clientName').value = '';
            document.getElementById('clientEmail').value = '';
            document.getElementById('clientPhone').value = '';
            document.getElementById('clientAddress').value = '';
            document.getElementById('projectStatus').value = 'consultation';
            document.getElementById('startDate').valueAsDate = new Date();
            document.getElementById('budget').value = '';
            document.getElementById('hoursPaid').value = '10';
            document.getElementById('projectNotes').value = '';
        }

        function closeProjectModal() {
            document.getElementById('projectModal').style.display = 'none';
        }

        function saveProject() {
            const project = {
                id: currentProject ? currentProject.id : Date.now(),
                name: document.getElementById('projectName').value,
                client: document.getElementById('clientName').value,
                clientEmail: document.getElementById('clientEmail').value,
                clientPhone: document.getElementById('clientPhone').value,
                clientAddress: document.getElementById('clientAddress').value,
                status: document.getElementById('projectStatus').value,
                startDate: document.getElementById('startDate').value,
                budget: parseFloat(document.getElementById('budget').value) || null,
                hourlyRate: parseFloat(document.getElementById('hourlyRate').value) || 75,
                hoursPaid: parseFloat(document.getElementById('hoursPaid').value) || 0,
                hoursWorked: currentProject ? (currentProject.hoursWorked || 0) : 0,
                notes: document.getElementById('projectNotes').value,
                sections: currentProject ? (currentProject.sections || []) : [],
                events: currentProject ? (currentProject.events || []) : [],
                hoursLog: currentProject ? (currentProject.hoursLog || []) : [],
                moodBoards: currentProject ? (currentProject.moodBoards || []) : [],
                invoiceNumber: currentProject ? currentProject.invoiceNumber : (++invoiceCounter).toString().padStart(6, '0'),
                amountPaid: currentProject ? currentProject.amountPaid : 0
            };
            
            const isNewProject = !currentProject;

            if (currentProject) {
                const index = projects.findIndex(p => p.id === currentProject.id);
                projects[index] = project;
            } else {
                projects.push(project);
            }

            localStorage.setItem('projects', JSON.stringify(projects));
            localStorage.setItem('invoiceCounter', invoiceCounter.toString());
            
            closeProjectModal();
            displayProjects();
            updateDashboard();
            
            // If this is a new project, automatically open it for the user
            if (isNewProject) {
                // Ensure projects list is updated first
                displayProjects();
                
                // Use requestAnimationFrame for better timing
                requestAnimationFrame(() => {
                    setTimeout(() => {
                        try {
                            openProjectDetail(project.id);
                        } catch (error) {
                            console.error('Error auto-opening project:', error);
                            showCustomAlert('Project saved! Click on the project card to open it.');
                        }
                    }, 150);
                });
            }
            
            showCustomAlert('Project saved successfully! ‚ú®');
        }

        function deleteProject(projectId) {
            const project = projects.find(p => p.id === projectId);
            if (!project) return;
            
            showCustomPrompt(
                'Delete Project',
                [
                    { type: 'text', name: 'confirmation', label: `Type "delete" to confirm deletion of "${project.name}"`, required: true, placeholder: 'Type delete' }
                ],
                (data) => {
                    if (data.confirmation.toLowerCase() !== 'delete') {
                        showCustomAlert('Please type "delete" to confirm. Deletion cancelled.');
                        return;
                    }
                    
                    const index = projects.findIndex(p => p.id === projectId);
                    if (index !== -1) {
                        projects.splice(index, 1);
                        localStorage.setItem('projects', JSON.stringify(projects));
                        
                        displayProjects();
                        updateDashboard();
                        
                        showCustomAlert(`Project "${project.name}" deleted successfully.`);
                    }
                }
            );
        }

        function openProjectDetail(projectId) {
            try {
                const project = projects.find(p => p.id === projectId);
                if (!project) {
                    showCustomAlert('Project not found. Please refresh the page and try again.');
                    return;
                }
                
                currentProject = project;
                
                // Check if required elements exist before accessing them
                const titleElement = document.getElementById('projectDetailTitle');
                const clientElement = document.getElementById('projectDetailClient');
                
                if (titleElement) titleElement.textContent = project.name;
                if (clientElement) clientElement.textContent = `Client: ${project.client}`;
                
                // Populate project details with safety checks
                const safeSetText = (id, value) => {
                    const element = document.getElementById(id);
                    if (element) element.textContent = value;
                };
                
                safeSetText('detailClientName', project.client);
                safeSetText('detailClientEmail', project.clientEmail || 'Not provided');
                safeSetText('detailClientPhone', project.clientPhone || 'Not provided');
                safeSetText('detailClientAddress', project.clientAddress || 'Not provided');
                safeSetText('detailStatus', project.status);
                safeSetText('detailStartDate', new Date(project.startDate).toLocaleDateString());
                safeSetText('detailBudget', project.budget ? `$${project.budget.toLocaleString('en-US', { minimumFractionDigits: 2, maximumFractionDigits: 2 })}` : 'No budget set');
                safeSetText('detailHoursWorked', `${(project.hoursWorked || 0).toFixed(1)}h`);
                safeSetText('detailHoursPaid', `${(project.hoursPaid || 0).toFixed(1)}h`);
                safeSetText('detailHoursRemaining', `${((project.hoursPaid || 0) - (project.hoursWorked || 0)).toFixed(1)}h`);

            
                showProjectSection('overview');
                updateProjectHours();
                updateProjectUpcomingEvents();
                
                const modal = document.getElementById('projectDetailModal');
                if (modal) {
                    modal.style.display = 'block';
                } else {
                    throw new Error('Project detail modal not found');
                }
                
            } catch (error) {
                console.error('Error opening project detail:', error);
                showCustomAlert('Error opening project details. Please try again.');
            }
        }
        
        // Function to edit project information
        function editProjectInfo() {
            if (!currentProject) return;
            
            showCustomPrompt(
                'Edit Project Information',
                [
                    { type: 'text', name: 'client', label: 'Client Name', required: true, defaultValue: currentProject.client },
                    { type: 'email', name: 'clientEmail', label: 'Client Email', defaultValue: currentProject.clientEmail || '' },
                    { type: 'tel', name: 'clientPhone', label: 'Client Phone', defaultValue: currentProject.clientPhone || '' },
                    { type: 'textarea', name: 'clientAddress', label: 'Client Address', defaultValue: currentProject.clientAddress || '' },
                    { type: 'number', name: 'hourlyRate', label: 'Hourly Rate ($)', step: '0.01', defaultValue: currentProject.hourlyRate || '75', placeholder: '75.00' },
                    { type: 'select', name: 'status', label: 'Project Status', options: [
                        { value: 'consultation', text: 'Consultation' },
                        { value: 'planning', text: 'Planning' },
                        { value: 'design', text: 'Design' },
                        { value: 'ordering', text: 'Ordering' },
                        { value: 'delivery', text: 'Delivery' },
                        { value: 'completed', text: 'Completed' }
                    ], defaultValue: currentProject.status },
                    { type: 'date', name: 'startDate', label: 'Start Date', defaultValue: currentProject.startDate },
                    { type: 'number', name: 'budget', label: 'Budget (Optional)', step: '0.01', defaultValue: currentProject.budget || '' }
                ],
                (data) => {
                    // Update the current project
                    currentProject.client = data.client;
                    currentProject.clientEmail = data.clientEmail;
                    currentProject.clientPhone = data.clientPhone;
                    currentProject.clientAddress = data.clientAddress;
                    currentProject.hourlyRate = data.hourlyRate ? parseFloat(data.hourlyRate) : 75;
                    currentProject.status = data.status;
                    currentProject.startDate = data.startDate;
                    currentProject.budget = data.budget ? parseFloat(data.budget) : null;
                    
                    saveCurrentProject();
                    
                    // Refresh the project detail view with updated information
                    document.getElementById('detailClientName').textContent = currentProject.client;
                    document.getElementById('detailClientEmail').textContent = currentProject.clientEmail || 'Not provided';
                    document.getElementById('detailClientPhone').textContent = currentProject.clientPhone || 'Not provided';
                    document.getElementById('detailStatus').textContent = currentProject.status;
                    document.getElementById('detailBudget').textContent = currentProject.budget ? `$${currentProject.budget.toLocaleString('en-US', { minimumFractionDigits: 2, maximumFractionDigits: 2 })}` : 'No budget set';
                    
                    displayProjects(); // Refresh the projects list
                    showCustomAlert('Project information updated successfully! ‚ú®');
                }
            );
        }

        function closeProjectDetailModal() {
            document.getElementById('projectDetailModal').style.display = 'none';
            currentProject = null;
        }

        function showProjectSection(sectionName, element) {
            document.querySelectorAll('.project-section').forEach(section => {
                section.classList.remove('active');
            });
            document.querySelectorAll('.project-tab').forEach(tab => {
                tab.classList.remove('active');
            });
            
            document.getElementById(sectionName).classList.add('active');
            
            // Use the passed element or find the clicked tab
            if (element) {
                element.classList.add('active');
            } else {
                // Fallback: find the tab by section name
                const tabButton = document.querySelector(`button.project-tab[onclick*="${sectionName}"]`);
                if (tabButton) tabButton.classList.add('active');
            }
            
            if (sectionName === 'items') {
                updateProjectSections();
            } else if (sectionName === 'orders') {
                updateReadyToOrderItems();
            } else if (sectionName === 'moodboards') {
                updateMoodBoards();
            } else if (sectionName === 'invoice') {
                updateSectionInvoiceList();
            }
        }

        function updateProjectSections() {
            if (!currentProject) return;
            
            const container = document.getElementById('projectSections');
            container.innerHTML = '';
            
            if (!currentProject.sections || currentProject.sections.length === 0) {
                container.innerHTML = '<p style="color: var(--text-secondary); text-align: center; padding: 20px;">No sections yet. Add your first section above!</p>';
                return;
            }
            
            // Separate sections into active and deactivated
            const activeSections = [];
            const deactivatedSections = [];
            
            currentProject.sections.forEach((section, originalIndex) => {
                if (section.isGrayedOut) {
                    deactivatedSections.push({ section, originalIndex });
                } else {
                    activeSections.push({ section, originalIndex });
                }
            });

            // Render active sections first
            activeSections.forEach(({ section, originalIndex: sectionIndex }) => {
                const sectionDiv = document.createElement('div');
                sectionDiv.innerHTML = `
                    <div class="section-header" style="opacity: ${section.isGrayedOut ? '0.6' : '1'};">
                        <div onclick="toggleSection(${sectionIndex})" style="cursor: pointer; flex-grow: 1; display: flex; align-items: center;">
                            <strong style="${section.isGrayedOut ? 'text-decoration: line-through;' : ''}">${section.name}</strong>
                            <span style="color: var(--text-secondary); margin-left: 10px;">(${section.items.length} items)</span>
                            ${section.isGrayedOut ? '<span style="color: var(--text-tertiary); font-size: 11px; font-weight: 500; background: var(--text-tertiary); color: white; padding: 2px 8px; border-radius: 12px; margin-left: 10px;">INACTIVE</span>' : ''}
                        </div>
                        <div style="display: flex; align-items: center; gap: 12px; margin-top: 10px;">
                            <button class="btn" onclick="event.stopPropagation(); ${section.items.length > 0 ? `toggleAllSectionItems(${sectionIndex}, ${!section.items.every(item => item.readyToOrder)})` : 'showCustomAlert(\"No items in this section to mark as ready.\")'}" 
                                    style="padding: 8px 16px; font-size: 14px; border-radius: 8px; ${section.items.length > 0 ? `background: ${section.items.every(item => item.readyToOrder) ? 'var(--success)' : 'var(--highlight)'}; color: white;` : 'background: var(--hover-bg); color: var(--text-tertiary); cursor: not-allowed;'} border: none; font-weight: 500; transition: all 0.2s ease; display: flex; align-items: center; gap: 6px;" 
                                    ${section.items.length > 0 ? `onmouseover="this.style.transform='translateY(-1px)'; this.style.boxShadow='0 4px 12px rgba(0,0,0,0.15)'" onmouseout="this.style.transform='translateY(0)'; this.style.boxShadow='none'"` : ''}>
                                <div style="width: 16px; height: 16px; border-radius: 50%; border: 2px solid ${section.items.length > 0 ? 'rgba(255,255,255,0.8)' : 'var(--text-tertiary)'}; background: ${section.items.length > 0 && section.items.every(item => item.readyToOrder) ? 'rgba(255,255,255,0.9)' : 'transparent'}; display: flex; align-items: center; justify-content: center; font-size: 10px; font-weight: bold; color: var(--text-primary);">
                                    ${section.items.length > 0 && section.items.every(item => item.readyToOrder) ? '‚úì' : ''}
                                </div>
                                ${section.items.length === 0 ? 'No Items' : (section.items.every(item => item.readyToOrder) ? 'All Ready' : 'Mark All Ready')}
                            </button>
                            
                            <button class="btn" onclick="event.stopPropagation(); toggleSectionGrayOut(${sectionIndex})" 
                                    style="padding: 8px 16px; font-size: 14px; border-radius: 8px; background: ${section.isGrayedOut ? 'var(--success)' : 'var(--warning)'}; color: ${section.isGrayedOut ? 'white' : 'var(--text-primary)'}; border: none; font-weight: 500; transition: all 0.2s ease; display: flex; align-items: center; gap: 6px;" 
                                    onmouseover="this.style.transform='translateY(-1px)'; this.style.boxShadow='0 4px 12px rgba(0,0,0,0.15)'" 
                                    onmouseout="this.style.transform='translateY(0)'; this.style.boxShadow='none'" 
                                    title="${section.isGrayedOut ? 'Reactivate this section' : 'Deactivate this section'}">
                                <span style="font-size: 12px;">${section.isGrayedOut ? '‚úì' : '‚óØ'}</span>
                                ${section.isGrayedOut ? 'Activate' : 'Deactivate'}
                            </button>
                            
                            <button class="btn" onclick="event.stopPropagation(); deleteSection(${sectionIndex})" 
                                    style="padding: 8px 16px; font-size: 14px; border-radius: 8px; background: var(--error); color: white; border: none; font-weight: 500; transition: all 0.2s ease; display: flex; align-items: center; gap: 6px;" 
                                    onmouseover="this.style.transform='translateY(-1px)'; this.style.boxShadow='0 4px 12px rgba(226,163,157,0.4)'" 
                                    onmouseout="this.style.transform='translateY(0)'; this.style.boxShadow='none'" 
                                    title="Delete this section permanently">
                                <span style="font-size: 12px;">üóëÔ∏è</span>
                                Delete
                            </button>
                        </div>
                    </div>
                    <div class="section-content" id="section-${sectionIndex}">
                        <div class="item-grid header">
                            <div>Item Name</div>
                            <div>Qty</div>
                            <div>Cost<br><small style="opacity: 0.7;">(Wholesale)</small></div>
                            <div>Sell Price<br><small style="opacity: 0.7;">(Per Unit)</small></div>
                            <div>Shipping<br><small style="opacity: 0.7;">($)</small></div>
                            <div>Tax<br><small style="opacity: 0.7;">($)</small></div>
                            <div>Customer Total<br><small style="opacity: 0.7;">(Final Price)</small></div>
                            <div>Product Link</div>
                            <div>Order Status</div>
                        </div>
                                                ${section.items.map((item, itemIndex) => `
                            <div class="item-grid">
                                <div>
                                    <div style="font-weight: 600; color: var(--text-primary);">${item.name || item.item || 'Unnamed Item'}</div>
                                </div>
                                <div>
                                    <input type="number" value="${item.qty || 1}" min="1" 
                                           onchange="updateItemQuantity(${sectionIndex}, ${itemIndex}, this.value)"
                                           style="width: 50px; padding: 4px 6px; border: 1px solid var(--section-bg); border-radius: 4px; text-align: center; font-size: 13px;">
                                </div>
                                <div>
                                    <input type="number" value="${item.wholesalePrice || 0}" step="0.01" min="0"
                                           onchange="updateItemWholesalePrice(${sectionIndex}, ${itemIndex}, this.value)"
                                           style="width: 70px; padding: 4px 6px; border: 1px solid var(--section-bg); border-radius: 4px; text-align: right; font-size: 13px;"
                                           placeholder="$0.00">
                                </div>
                                <div>
                                    <input type="number" value="${item.customerPrice || item.price || 0}" step="0.01" min="0"
                                           onchange="updateItemCustomerPrice(${sectionIndex}, ${itemIndex}, this.value)"
                                           style="width: 70px; padding: 4px 6px; border: 1px solid var(--section-bg); border-radius: 4px; text-align: right; font-size: 13px;"
                                           placeholder="$0.00">
                                </div>
                                <div>
                                    <input type="number" value="${item.shipping || 0}" step="0.01" min="0"
                                           onchange="updateItemShipping(${sectionIndex}, ${itemIndex}, this.value)"
                                           style="width: 50px; padding: 4px 6px; border: 1px solid var(--section-bg); border-radius: 4px; text-align: right; font-size: 13px;"
                                           placeholder="$0.00">
                                </div>
                                <div>
                                    <input type="number" value="${item.tax || 0}" step="0.01" min="0"
                                           onchange="updateItemTax(${sectionIndex}, ${itemIndex}, this.value)"
                                           style="width: 50px; padding: 4px 6px; border: 1px solid var(--section-bg); border-radius: 4px; text-align: right; font-size: 13px;"
                                           placeholder="$0.00">
                                </div>
                                <div>
                                    <span style="font-weight: 600; color: var(--text-primary);">
                                        ${(((item.customerPrice || item.price || 0) * (item.qty || 1)) + (item.shipping || 0) + (item.tax || 0)).toLocaleString('en-US', { style: 'currency', currency: 'USD' })}
                                    </span>
                                </div>
                                <div>
                                    ${item.link ? 
                                        `<div style="display: flex; align-items: center; gap: 4px;">
                                            <a href="${item.link}" target="_blank" style="color: var(--secondary-brand); text-decoration: none; font-weight: 500; font-size: 12px;">üîó View</a>
                                            <button onclick="editItemLink(${sectionIndex}, ${itemIndex})" style="background: none; border: 1px solid var(--section-bg); border-radius: 3px; padding: 1px 4px; font-size: 10px; cursor: pointer;" title="Edit Link">‚úèÔ∏è</button>
                                        </div>` :
                                        `<button onclick="editItemLink(${sectionIndex}, ${itemIndex})" style="background: var(--section-bg); border: 1px solid var(--section-bg); border-radius: 4px; padding: 4px 8px; font-size: 11px; cursor: pointer; color: var(--text-secondary);">+ Add Link</button>`
                                    }
                                </div>
                                <div>
                                    <button onclick="toggleReadyToOrder(${sectionIndex}, ${itemIndex}, ${!item.readyToOrder})" 
                                            style="
                                                background: ${item.readyToOrder ? 'linear-gradient(135deg, var(--success), var(--highlight))' : 'linear-gradient(135deg, #f8f9fa, #e9ecef)'};
                                                border: 2px solid ${item.readyToOrder ? 'var(--success)' : 'var(--section-bg)'};
                                                color: ${item.readyToOrder ? 'white' : 'var(--text-secondary)'};
                                                padding: 4px 8px;
                                                border-radius: 12px;
                                                font-size: 11px;
                                                font-weight: 600;
                                                cursor: pointer;
                                                transition: all 0.3s ease;
                                                text-transform: uppercase;
                                                letter-spacing: 0.3px;
                                                box-shadow: 0 1px 4px rgba(0,0,0,0.1);
                                            "
                                            onmouseover="this.style.transform='translateY(-1px)'; this.style.boxShadow='0 2px 8px rgba(0,0,0,0.2)'"
                                            onmouseout="this.style.transform='translateY(0px)'; this.style.boxShadow='0 1px 4px rgba(0,0,0,0.1)'">
                                        ${item.readyToOrder ? '‚úì READY' : 'Mark Ready'}
                                    </button>
                                </div>
                            </div>
                        `).join('')}
                        <div style="margin-top: 15px;">
                            <button class="btn btn-success" onclick="addItemToSection(${sectionIndex})">Add Item to ${section.name}</button>
                        </div>
                    </div>
                `;
                container.appendChild(sectionDiv);
                
                // Restore expanded state
                if (expandedSections.has(sectionIndex)) {
                    const content = document.getElementById(`section-${sectionIndex}`);
                    content.classList.add('expanded');
                }
            });

            // Add deactivated sections in a collapsible group
            if (deactivatedSections.length > 0) {
                const deactivatedGroupDiv = document.createElement('div');
                deactivatedGroupDiv.style.cssText = 'margin-top: 20px; border-top: 1px solid var(--hover-bg); padding-top: 20px;';
                
                // Deactivated sections header
                const deactivatedHeader = document.createElement('div');
                deactivatedHeader.style.cssText = `
                    display: flex;
                    align-items: center;
                    padding: 12px 16px;
                    background: var(--section-bg);
                    border-radius: 8px;
                    cursor: pointer;
                    margin-bottom: 10px;
                    transition: all 0.2s ease;
                `;
                deactivatedHeader.onmouseover = () => deactivatedHeader.style.background = 'var(--hover-bg)';
                deactivatedHeader.onmouseout = () => deactivatedHeader.style.background = 'var(--section-bg)';
                
                deactivatedHeader.innerHTML = `
                    <span id="deactivatedToggleIcon" style="margin-right: 10px; transition: transform 0.2s ease;">‚ñ∂</span>
                    <strong style="color: var(--text-secondary);">Deactivated Sections</strong>
                    <span style="color: var(--text-tertiary); margin-left: 10px; font-size: 13px;">(${deactivatedSections.length})</span>
                `;
                
                // Deactivated sections container (initially hidden)
                const deactivatedContainer = document.createElement('div');
                deactivatedContainer.id = 'deactivatedSectionsContainer';
                deactivatedContainer.style.cssText = 'display: none; overflow: hidden; transition: all 0.3s ease;';
                
                // Render deactivated sections
                deactivatedSections.forEach(({ section, originalIndex: sectionIndex }) => {
                    const sectionDiv = document.createElement('div');
                    sectionDiv.innerHTML = `
                        <div class="section-header" style="opacity: 0.6;">
                            <div onclick="toggleSection(${sectionIndex})" style="cursor: pointer; flex-grow: 1; display: flex; align-items: center;">
                                <strong style="text-decoration: line-through;">${section.name}</strong>
                                <span style="color: var(--text-secondary); margin-left: 10px;">(${section.items.length} items)</span>
                                <span style="color: var(--text-tertiary); font-size: 11px; font-weight: 500; background: var(--text-tertiary); color: white; padding: 2px 8px; border-radius: 12px; margin-left: 10px;">INACTIVE</span>
                            </div>
                            <div style="display: flex; align-items: center; gap: 12px; margin-top: 10px;">
                                <button class="btn" onclick="event.stopPropagation(); ${section.items.length > 0 ? `toggleAllSectionItems(${sectionIndex}, ${!section.items.every(item => item.readyToOrder)})` : 'showCustomAlert(\"No items in this section to mark as ready.\")'}"
                                        style="padding: 8px 16px; font-size: 14px; border-radius: 8px; background: var(--hover-bg); color: var(--text-tertiary); cursor: not-allowed; border: none; font-weight: 500; transition: all 0.2s ease; display: flex; align-items: center; gap: 6px;">
                                    <div style="width: 16px; height: 16px; border-radius: 50%; border: 2px solid var(--text-tertiary); background: transparent; display: flex; align-items: center; justify-content: center; font-size: 10px; font-weight: bold; color: var(--text-primary);"></div>
                                    No Items
                                </button>
                                
                                <button class="btn" onclick="event.stopPropagation(); toggleSectionGrayOut(${sectionIndex})"
                                        style="padding: 8px 16px; font-size: 14px; border-radius: 8px; background: var(--success); color: white; border: none; font-weight: 500; transition: all 0.2s ease; display: flex; align-items: center; gap: 6px;"
                                        onmouseover="this.style.transform='translateY(-1px)'; this.style.boxShadow='0 4px 12px rgba(0,0,0,0.15)'"
                                        onmouseout="this.style.transform='translateY(0)'; this.style.boxShadow='none'"
                                        title="Reactivate this section">
                                    <span style="font-size: 12px;">‚úì</span>
                                    Activate
                                </button>
                                
                                <button class="btn" onclick="event.stopPropagation(); deleteSection(${sectionIndex})"
                                        style="padding: 8px 16px; font-size: 14px; border-radius: 8px; background: var(--error); color: white; border: none; font-weight: 500; transition: all 0.2s ease; display: flex; align-items: center; gap: 6px;"
                                        onmouseover="this.style.transform='translateY(-1px)'; this.style.boxShadow='0 4px 12px rgba(226,163,157,0.4)'"
                                        onmouseout="this.style.transform='translateY(0)'; this.style.boxShadow='none'"
                                        title="Delete this section permanently">
                                    <span style="font-size: 12px;">üóëÔ∏è</span>
                                    Delete
                                </button>
                            </div>
                        </div>
                        <div class="section-content" id="section-${sectionIndex}">
                            <div class="item-grid header">
                                <div>Item Name</div>
                                <div>Qty</div>
                                <div>Cost<br><small style="opacity: 0.7;">(Wholesale)</small></div>
                                <div>Sell Price<br><small style="opacity: 0.7;">(Per Unit)</small></div>
                                <div>Shipping<br><small style="opacity: 0.7;">($)</small></div>
                                <div>Tax<br><small style="opacity: 0.7;">($)</small></div>
                                <div>Total<br><small style="opacity: 0.7;">(Per Unit)</small></div>
                                <div>Link</div>
                                <div>Ready?</div>
                            </div>
                            ${section.items.map((item, itemIndex) => `
                                <div class="item-grid">
                                    <div>
                                        <div style="font-weight: 600; color: var(--text-primary);">${item.name || item.item || 'Unnamed Item'}</div>
                                    </div>
                                    <div>
                                        <input type="number" value="${item.qty || 1}" min="1" 
                                               onchange="updateItemQuantity(${sectionIndex}, ${itemIndex}, this.value)"
                                               style="width: 50px; padding: 4px 6px; border: 1px solid var(--section-bg); border-radius: 4px; text-align: center; font-size: 13px;">
                                    </div>
                                    <div>
                                        <input type="number" value="${item.wholesalePrice || 0}" step="0.01" min="0"
                                               onchange="updateItemWholesalePrice(${sectionIndex}, ${itemIndex}, this.value)"
                                               style="width: 70px; padding: 4px 6px; border: 1px solid var(--section-bg); border-radius: 4px; text-align: right; font-size: 13px;"
                                               placeholder="$0.00">
                                    </div>
                                    <div>
                                        <input type="number" value="${item.customerPrice || item.price || 0}" step="0.01" min="0"
                                               onchange="updateItemCustomerPrice(${sectionIndex}, ${itemIndex}, this.value)"
                                               style="width: 70px; padding: 4px 6px; border: 1px solid var(--section-bg); border-radius: 4px; text-align: right; font-size: 13px;"
                                               placeholder="$0.00">
                                    </div>
                                    <div>
                                        <input type="number" value="${item.shipping || 0}" step="0.01" min="0"
                                               onchange="updateItemShipping(${sectionIndex}, ${itemIndex}, this.value)"
                                               style="width: 50px; padding: 4px 6px; border: 1px solid var(--section-bg); border-radius: 4px; text-align: right; font-size: 13px;"
                                               placeholder="$0.00">
                                    </div>
                                    <div>
                                        <input type="number" value="${item.tax || 0}" step="0.01" min="0"
                                               onchange="updateItemTax(${sectionIndex}, ${itemIndex}, this.value)"
                                               style="width: 50px; padding: 4px 6px; border: 1px solid var(--section-bg); border-radius: 4px; text-align: right; font-size: 13px;"
                                               placeholder="$0.00">
                                    </div>
                                    <div>
                                        <span style="font-weight: 600; color: var(--text-primary);">
                                            ${(((item.customerPrice || item.price || 0) * (item.qty || 1)) + (item.shipping || 0) + (item.tax || 0)).toLocaleString('en-US', { style: 'currency', currency: 'USD' })}
                                        </span>
                                    </div>
                                    <div>
                                        ${item.link ? 
                                            `<div style="display: flex; align-items: center; gap: 4px;">
                                                <a href="${item.link}" target="_blank" style="color: var(--secondary-brand); text-decoration: none; font-weight: 500; font-size: 12px;">üîó View</a>
                                                <button onclick="editItemLink(${sectionIndex}, ${itemIndex})" style="background: none; border: 1px solid var(--section-bg); border-radius: 3px; padding: 1px 4px; font-size: 10px; cursor: pointer;" title="Edit Link">‚úèÔ∏è</button>
                                            </div>` :
                                            `<button onclick="editItemLink(${sectionIndex}, ${itemIndex})" style="background: var(--section-bg); border: 1px solid var(--section-bg); border-radius: 4px; padding: 4px 8px; font-size: 11px; cursor: pointer; color: var(--text-secondary);">+ Add Link</button>`
                                        }
                                    </div>
                                    <div>
                                        <button onclick="toggleReadyToOrder(${sectionIndex}, ${itemIndex}, ${!item.readyToOrder})" 
                                                style="
                                                    background: ${item.readyToOrder ? 'linear-gradient(135deg, var(--success), var(--highlight))' : 'linear-gradient(135deg, #f8f9fa, #e9ecef)'};
                                                    border: 2px solid ${item.readyToOrder ? 'var(--success)' : 'var(--section-bg)'};
                                                    color: ${item.readyToOrder ? 'white' : 'var(--text-secondary)'};
                                                    padding: 4px 8px;
                                                    border-radius: 12px;
                                                    font-size: 11px;
                                                    font-weight: 600;
                                                    cursor: pointer;
                                                    transition: all 0.3s ease;
                                                    text-transform: uppercase;
                                                    letter-spacing: 0.3px;
                                                    box-shadow: 0 1px 4px rgba(0,0,0,0.1);
                                                "
                                                onmouseover="this.style.transform='translateY(-1px)'; this.style.boxShadow='0 2px 8px rgba(0,0,0,0.2)'"
                                                onmouseout="this.style.transform='translateY(0px)'; this.style.boxShadow='0 1px 4px rgba(0,0,0,0.1)'">
                                            ${item.readyToOrder ? '‚úì READY' : 'Mark Ready'}
                                        </button>
                                    </div>
                                </div>
                            `).join('')}
                        </div>
                    `;
                    deactivatedContainer.appendChild(sectionDiv);
                    
                    // Restore expanded state for deactivated sections too
                    if (expandedSections.has(sectionIndex)) {
                        const content = document.getElementById(`section-${sectionIndex}`);
                        content.classList.add('expanded');
                    }
                });
                
                // Add click handler to toggle deactivated sections
                deactivatedHeader.onclick = () => {
                    const container = document.getElementById('deactivatedSectionsContainer');
                    const icon = document.getElementById('deactivatedToggleIcon');
                    
                    if (container.style.display === 'none') {
                        container.style.display = 'block';
                        icon.style.transform = 'rotate(90deg)';
                        icon.textContent = '‚ñº';
                    } else {
                        container.style.display = 'none';
                        icon.style.transform = 'rotate(0deg)';
                        icon.textContent = '‚ñ∂';
                    }
                };
                
                deactivatedGroupDiv.appendChild(deactivatedHeader);
                deactivatedGroupDiv.appendChild(deactivatedContainer);
                container.appendChild(deactivatedGroupDiv);
            }
        }

        function toggleSection(sectionIndex) {
            const content = document.getElementById(`section-${sectionIndex}`);
            content.classList.toggle('expanded');
            
            // Track expanded state
            if (content.classList.contains('expanded')) {
                expandedSections.add(sectionIndex);
            } else {
                expandedSections.delete(sectionIndex);
            }
        }

        function toggleSectionGrayOut(sectionIndex) {
            if (!currentProject || !currentProject.sections || !currentProject.sections[sectionIndex]) return;
            
            const section = currentProject.sections[sectionIndex];
            const willGrayOut = !section.isGrayedOut;
            
            // Toggle the gray out state immediately without confirmation
            section.isGrayedOut = willGrayOut;
            saveCurrentProject();
            updateProjectSections();
            updateReadyToOrderItems(); // Refresh orders to exclude/include grayed out sections
        }

        function deleteSection(sectionIndex) {
            if (!currentProject || !currentProject.sections || !currentProject.sections[sectionIndex]) return;
            
            const section = currentProject.sections[sectionIndex];
            const itemCount = section.items ? section.items.length : 0;
            
            showCustomPrompt(
                'Delete Section',
                [
                    { type: 'text', name: 'confirmation', label: `Type "delete" to confirm deletion of "${section.name}"\n\nThis will permanently delete:\n‚Ä¢ ${itemCount} item${itemCount === 1 ? '' : 's'}\n‚Ä¢ All associated data\n\nThis action cannot be undone.`, required: true, placeholder: 'Type delete' }
                ],
                (data) => {
                    if (data.confirmation.toLowerCase() !== 'delete') {
                        showCustomAlert('Please type "delete" to confirm. Section deletion cancelled.');
                        return;
                    }
                    
                    // Remove the section from expanded sections tracking
                    expandedSections.delete(sectionIndex);
                    
                    // Remove section from project
                    currentProject.sections.splice(sectionIndex, 1);
                    
                    // Update expanded sections indices (shift down for sections after deleted one)
                    const newExpandedSections = new Set();
                    expandedSections.forEach(index => {
                        if (index > sectionIndex) {
                            newExpandedSections.add(index - 1);
                        } else if (index < sectionIndex) {
                            newExpandedSections.add(index);
                        }
                    });
                    expandedSections = newExpandedSections;
                    
                    saveCurrentProject();
                    updateProjectSections();
                    updateReadyToOrderItems(); // Refresh orders
                    
                    showCustomAlert(`Section "${section.name}" deleted successfully! üóëÔ∏è`);
                }
            );
        }

        function addNewSection() {
            if (!currentProject) return;
            
            showCustomPrompt(
                'Add New Section',
                [
                    { type: 'text', name: 'sectionName', label: 'Section Name', required: true, placeholder: 'e.g., Living Room, Kitchen, Bedroom' }
                ],
                (data) => {
                    if (!currentProject.sections) currentProject.sections = [];
                    
                    currentProject.sections.push({
                        id: Date.now(),
                        name: data.sectionName,
                        items: []
                    });
                    
                    saveCurrentProject();
                    updateProjectSections();
                    showCustomAlert('Section added successfully! ‚ú®');
                }
            );
        }

        function addItemToSection(sectionIndex) {
            showCustomPrompt(
                'Add New Item',
                [
                    { type: 'text', name: 'itemName', label: 'Item Name', required: true, placeholder: 'e.g. Sofa, Chair, Table...' },
                    { type: 'number', name: 'quantity', label: 'Quantity', required: true, defaultValue: '1' },
                    { type: 'number', name: 'wholesalePrice', label: 'Your Cost (Wholesale Price)', step: '0.01', placeholder: '0.00' },
                    { type: 'number', name: 'customerPrice', label: 'Sell Price (What Customer Pays Per Unit)', step: '0.01', required: true },
                    { type: 'number', name: 'shipping', label: 'Shipping Cost', step: '0.01', placeholder: '0.00' },
                    { type: 'number', name: 'tax', label: 'Tax Amount', step: '0.01', placeholder: '0.00' },
                    { type: 'url', name: 'link', label: 'Product Website Link', placeholder: 'https://store.com/product-page' }
                ],
                (data) => {
                    const customerPrice = parseFloat(data.customerPrice) || 0;
                    currentProject.sections[sectionIndex].items.push({
                        id: Date.now(),
                        name: data.itemName,
                        qty: parseInt(data.quantity) || 1,
                        price: customerPrice, // Keep for backward compatibility
                        customerPrice: customerPrice,
                        wholesalePrice: parseFloat(data.wholesalePrice) || 0,
                        shipping: parseFloat(data.shipping) || 0,
                        tax: parseFloat(data.tax) || 0,
                        link: data.link || '',
                        readyToOrder: false,
                        deliveryStatus: 'pending',
                        shippingInfo: {
                            carrier: '',
                            trackingNumber: '',
                            shippingMethod: '',
                            estimatedDelivery: '',
                            shippingCost: parseFloat(data.shipping) || 0,
                            orderDate: '',
                            notes: ''
                        }
                    });
                    
                    saveCurrentProject();
                    updateProjectSections();
                    showCustomAlert('Item added successfully! ‚ú®');
                }
            );
        }

        function toggleReadyToOrder(sectionIndex, itemIndex, isReady) {
            currentProject.sections[sectionIndex].items[itemIndex].readyToOrder = isReady;
            saveCurrentProject();
            updateReadyToOrderItems();
            updateProjectSections(); // Refresh to update the "Select All" checkbox state
        }
        
        // New function to toggle all items in a section
        function toggleAllSectionItems(sectionIndex, markAsReady) {
            currentProject.sections[sectionIndex].items.forEach(item => {
                item.readyToOrder = markAsReady;
            });
            saveCurrentProject();
            updateProjectSections();
            updateReadyToOrderItems();
            showCustomAlert(markAsReady ? 'All items in section marked as ready to order!' : 'All items in section unmarked from ready to order!');
        }
        
        // New function to update item quantity inline
        function updateItemQuantity(sectionIndex, itemIndex, newQuantity) {
            const qty = parseInt(newQuantity);
            if (qty > 0) {
                currentProject.sections[sectionIndex].items[itemIndex].qty = qty;
                saveCurrentProject();
                updateProjectSections();
                updateReadyToOrderItems();
            }
        }
        
        // Update functions for item pricing fields
        function updateItemPriceInline(sectionIndex, itemIndex, newPrice) {
            const price = parseFloat(newPrice);
            if (price >= 0) {
                currentProject.sections[sectionIndex].items[itemIndex].price = price;
                // Also update customer price if not set
                if (!currentProject.sections[sectionIndex].items[itemIndex].customerPrice) {
                    currentProject.sections[sectionIndex].items[itemIndex].customerPrice = price;
                }
                saveCurrentProject();
                updateProjectSections();
                updateReadyToOrderItems();
            }
        }
        
        function updateItemWholesalePrice(sectionIndex, itemIndex, newPrice) {
            const price = parseFloat(newPrice) || 0;
            currentProject.sections[sectionIndex].items[itemIndex].wholesalePrice = price;
            saveCurrentProject();
            updateProjectSections();
        }
        
        function updateItemCustomerPrice(sectionIndex, itemIndex, newPrice) {
            const price = parseFloat(newPrice) || 0;
            currentProject.sections[sectionIndex].items[itemIndex].customerPrice = price;
            saveCurrentProject();
            updateProjectSections();
            updateReadyToOrderItems();
        }
        
        function updateItemShipping(sectionIndex, itemIndex, newShipping) {
            const shipping = parseFloat(newShipping) || 0;
            currentProject.sections[sectionIndex].items[itemIndex].shipping = shipping;
            saveCurrentProject();
            updateProjectSections();
        }
        
        function updateItemTax(sectionIndex, itemIndex, newTax) {
            const tax = parseFloat(newTax) || 0;
            currentProject.sections[sectionIndex].items[itemIndex].tax = tax;
            saveCurrentProject();
            updateProjectSections();
        }
        

        
        // Function to edit item link with prompt
        function editItemLink(sectionIndex, itemIndex) {
            const currentLink = currentProject.sections[sectionIndex].items[itemIndex].link || '';
            
            showCustomPrompt(
                'Edit Item Link',
                [
                    { type: 'url', name: 'link', label: 'Link URL', placeholder: 'https://example.com/product', defaultValue: currentLink }
                ],
                (data) => {
                    currentProject.sections[sectionIndex].items[itemIndex].link = data.link;
                    saveCurrentProject();
                    showProjectSection('items'); // Refresh the items view
                    showCustomAlert('Link updated successfully! ‚ú®');
                }
            );
        }

                // Orders Tab - Complete Rebuild
        let orderItems = [];
        let selectedOrderItems = new Set();
        let expandedOrderSections = new Set();
        let currentOrderFilter = ''; // '' = show all, 'pending', 'ordered', 'shipped', 'delivered'
        
        // Legacy variables for backward compatibility
        let filteredOrderItems = [];
        
        function updateOrdersTab() {
            if (!currentProject || !currentProject.sections) return;
            
            // Clear existing order items
            orderItems = [];
            
            // Collect items from active sections only
            currentProject.sections.forEach((section, sectionIndex) => {
                // Skip deactivated sections
                if (section.isGrayedOut) return;
                
                section.items.forEach((item, itemIndex) => {
                    // Skip deactivated items
                    if (item.isGrayedOut) return;
                    
                    // Only include items marked as ready to order
                    if (item.readyToOrder) {
                        orderItems.push({
                            ...item,
                            sectionIndex,
                            itemIndex,
                            sectionName: section.name,
                            uniqueId: `${sectionIndex}-${itemIndex}`
                        });
                    }
                });
            });
            
            // Update the orders tab display
            renderOrderSections();
            renderDeliveryProgress();
        }

        function updateReadyToOrderItems() {
            updateOrdersTab();
        }

        
        function renderDeliveryProgress() {
            let pending = 0, ordered = 0, shipped = 0, delivered = 0;
            
            orderItems.forEach(item => {
                const status = item.deliveryStatus || 'pending';
                switch(status) {
                    case 'pending': pending++; break;
                    case 'ordered': ordered++; break;
                    case 'shipped': shipped++; break;
                    case 'delivered': delivered++; break;
                }
            });
            
            const total = orderItems.length || 1;
            const pendingPercent = (pending / total) * 100;
            const orderedPercent = (ordered / total) * 100;
            const shippedPercent = (shipped / total) * 100;
            const deliveredPercent = (delivered / total) * 100;
            
            // Update progress bar
            document.getElementById('pendingBar').style.width = `${pendingPercent}%`;
            document.getElementById('orderedBar').style.width = `${orderedPercent}%`;
            document.getElementById('shippedBar').style.width = `${shippedPercent}%`;
            document.getElementById('deliveredBar').style.width = `${deliveredPercent}%`;
            
            // Update bar text
            document.getElementById('pendingBar').textContent = pending > 0 ? pending.toString() : '';
            document.getElementById('orderedBar').textContent = ordered > 0 ? ordered.toString() : '';
            document.getElementById('shippedBar').textContent = shipped > 0 ? shipped.toString() : '';
            document.getElementById('deliveredBar').textContent = delivered > 0 ? delivered.toString() : '';
            
            // Update totals
            document.getElementById('pendingTotal').textContent = pending;
            document.getElementById('orderedTotal').textContent = ordered;
            document.getElementById('shippedTotal').textContent = shipped;
            document.getElementById('deliveredTotal').textContent = delivered;
        }
        
        function setOrderFilter(status) {
            currentOrderFilter = status;
            
            // Update visual feedback on filter buttons
            const filters = ['pending', 'ordered', 'shipped', 'delivered'];
            filters.forEach(filterStatus => {
                const filterElement = document.getElementById(`${filterStatus}Filter`);
                if (filterElement) {
                    if (filterStatus === status) {
                        // Active filter - add border and shadow
                        filterElement.style.border = '3px solid white';
                        filterElement.style.boxShadow = '0 4px 16px rgba(0,0,0,0.3)';
                        filterElement.style.transform = 'translateY(-2px)';
                    } else {
                        // Inactive filter - remove special styling
                        filterElement.style.border = 'none';
                        filterElement.style.boxShadow = 'none';
                        filterElement.style.transform = 'translateY(0)';
                    }
                }
            });
            
            // Show/hide clear filter button
            const clearButton = document.getElementById('clearFilterButton');
            if (clearButton) {
                clearButton.style.display = status ? 'block' : 'none';
            }
            
            // Re-render sections with filter applied
            renderOrderSections();
        }

        function renderOrderSections() {
            const container = document.getElementById('orderSectionsList');
            
            if (orderItems.length === 0) {
                container.innerHTML = `
                    <div style="text-align: center; padding: 60px 20px; color: var(--text-secondary);">
                        <div style="font-size: 64px; margin-bottom: 20px;">üì¶</div>
                        <h3 style="margin: 0 0 10px 0; font-weight: 500;">No Items Ready to Order</h3>
                        <p style="margin: 0; font-size: 16px;">Go to the Items tab and mark items as "ready to order" to see them here.</p>
                    </div>
                `;
                return;
            }
            
            // Filter items based on current filter
            let filteredItems = orderItems;
            if (currentOrderFilter) {
                filteredItems = orderItems.filter(item => {
                    const itemStatus = item.deliveryStatus || 'pending';
                    return itemStatus === currentOrderFilter;
                });
            }
            
            // Group filtered items by section
            const itemsBySection = {};
            filteredItems.forEach(item => {
                if (!itemsBySection[item.sectionName]) {
                    itemsBySection[item.sectionName] = [];
                }
                itemsBySection[item.sectionName].push(item);
            });
            
            // Show "no results" message if filter produces no results
            if (filteredItems.length === 0 && currentOrderFilter) {
                container.innerHTML = `
                    <div style="text-align: center; padding: 60px 20px; color: var(--text-secondary);">
                        <div style="font-size: 64px; margin-bottom: 20px;">üîç</div>
                        <h3 style="margin: 0 0 10px 0; font-weight: 500;">No ${currentOrderFilter.toUpperCase()} Items</h3>
                        <p style="margin: 0; font-size: 16px;">Try a different status filter or clear the filter to see all items.</p>
                    </div>
                `;
                return;
            }
            
            // Auto-expand all sections by default
            Object.keys(itemsBySection).forEach(sectionName => {
                const sectionId = `order-section-${sectionName.replace(/\s+/g, '-').toLowerCase()}`;
                expandedOrderSections.add(sectionId);
            });
            
            let sectionsHTML = '';
            
            Object.entries(itemsBySection).forEach(([sectionName, items]) => {
                const sectionId = `order-section-${sectionName.replace(/\s+/g, '-').toLowerCase()}`;
                const isExpanded = expandedOrderSections.has(sectionId);
                
                // Calculate section totals
                let sectionPurchasePrice = 0;
                items.forEach(item => {
                    const quantity = parseInt(item.qty) || 1;
                    const wholesale = parseFloat(item.wholesalePrice) || 0;
                    const shipping = parseFloat(item.shipping) || 0;
                    const tax = parseFloat(item.tax) || 0;
                    sectionPurchasePrice += (wholesale + shipping + tax) * quantity;
                });
                
                // Calculate section stats for status summary
                const pending = items.filter(item => !item.deliveryStatus || item.deliveryStatus === 'pending').length;
                const ordered = items.filter(item => item.deliveryStatus === 'ordered').length;
                const shipped = items.filter(item => item.deliveryStatus === 'shipped').length;
                const delivered = items.filter(item => item.deliveryStatus === 'delivered').length;
                
                sectionsHTML += `
                    <div style="margin-bottom: 15px;">
                        <div class="section-header" style="cursor: pointer;">
                            <div onclick="toggleOrderSection('${sectionId}')" style="flex-grow: 1; display: flex; align-items: center;">
                                <strong style="color: var(--text-primary); font-size: 18px;">${sectionName}</strong>
                                <span style="color: var(--text-secondary); margin-left: 12px; font-size: 14px;">(${items.length} items ‚Ä¢ ${formatCurrency(sectionPurchasePrice)})</span>
                            </div>
                            <div style="display: flex; align-items: center; gap: 15px; margin-top: 8px;">
                                <button onclick="event.stopPropagation(); selectSectionItems('${sectionName}', true)" 
                                        style="background: var(--secondary-brand); color: white; border: none; padding: 8px 16px; border-radius: 8px; font-size: 13px; cursor: pointer; font-weight: 500; transition: all 0.2s ease;" 
                                        onmouseover="this.style.transform='translateY(-1px)'; this.style.boxShadow='0 4px 12px rgba(0,0,0,0.15)'" 
                                        onmouseout="this.style.transform='translateY(0)'; this.style.boxShadow='none'">
                                    Select All
                                </button>
                            </div>
                        </div>
                        <div class="section-content" id="${sectionId}" style="display: ${isExpanded ? 'block' : 'none'}; padding: 0; background: rgba(255,255,255,0.7); border-radius: 0 0 10px 10px; margin-bottom: 0;">
                            ${renderSectionItemsTable(items)}
                        </div>
                    </div>
                `;
            });
            
            container.innerHTML = sectionsHTML;
            updateOrderBulkButtons();
        }
        
        function renderSectionItemsTable(items) {
            return `
                <div style="padding: 20px; overflow-x: auto;">
                    <table style="width: 100%; border-collapse: collapse; background: white; border-radius: 8px; overflow: hidden; box-shadow: 0 2px 8px rgba(0,0,0,0.1);">
                        <thead>
                            <tr style="background: var(--section-bg); font-weight: 600; font-size: 14px;">
                                <th style="padding: 16px; text-align: left; width: 50px; color: var(--text-primary);">
                                    <input type="checkbox" onchange="toggleSectionSelectAll(this, '${items[0]?.sectionName}')" style="cursor: pointer; transform: scale(1.2); accent-color: var(--primary-brand);">
                                </th>
                                <th style="padding: 16px; text-align: left; color: var(--text-primary);">Item Details</th>
                                <th style="padding: 16px; text-align: center; color: var(--text-primary);">Qty</th>
                                <th style="padding: 16px; text-align: center; color: var(--text-primary);">Purchase Price</th>
                                <th style="padding: 16px; text-align: center; color: var(--text-primary);">Status</th>
                                <th style="padding: 16px; text-align: center; color: var(--text-primary);">Shipping</th>
                            </tr>
                        </thead>
                        <tbody>
                            ${items.map(item => {
                                const quantity = parseInt(item.qty) || 1;
                                const wholesale = parseFloat(item.wholesalePrice) || 0;
                                const shipping = parseFloat(item.shipping) || 0;
                                const tax = parseFloat(item.tax) || 0;
                                const purchasePrice = (wholesale + shipping + tax) * quantity;
                                const hasShippingInfo = item.shippingInfo && (item.shippingInfo.trackingNumber || item.shippingInfo.carrier);
                                
                                const statusColors = {
                                    'pending': 'var(--warning)',
                                    'ordered': 'var(--secondary-brand)', 
                                    'shipped': 'var(--primary-brand)',
                                    'delivered': 'var(--success)'
                                };
                                
                                const statusEmojis = {
                                    'pending': '‚è≥',
                                    'ordered': 'üì¶',
                                    'shipped': 'üöö', 
                                    'delivered': '‚úÖ'
                                };
                                
                                const currentStatus = item.deliveryStatus || 'pending';
                                
                                return `
                                    <tr style="border-bottom: 1px solid var(--hover-bg); transition: all 0.2s ease;" onmouseover="this.style.background='rgba(248, 250, 252, 0.8)'" onmouseout="this.style.background='transparent'">
                                        <td style="padding: 18px; text-align: center;">
                                            <input type="checkbox" 
                                                   ${selectedOrderItems.has(item.uniqueId) ? 'checked' : ''} 
                                                   onchange="toggleOrderItemSelection('${item.uniqueId}')" 
                                                   style="cursor: pointer; transform: scale(1.3); accent-color: var(--primary-brand);">
                                        </td>
                                        <td style="padding: 18px;">
                                            <div style="display: flex; flex-direction: column; gap: 4px;">
                                                <div style="font-weight: 600; font-size: 16px; color: var(--text-primary);">${item.name || item.item || item.itemName || 'Unnamed Item'}</div>
                                                ${item.description ? `<div style="font-size: 13px; color: var(--text-secondary); line-height: 1.4;">${item.description}</div>` : ''}
                                                ${item.link ? `<a href="${item.link}" target="_blank" style="font-size: 12px; color: var(--secondary-brand); text-decoration: none; font-weight: 500;">üîó View Product</a>` : ''}
                                            </div>
                                        </td>
                                        <td style="padding: 18px; text-align: center;">
                                            <div style="background: var(--section-bg); color: var(--text-primary); padding: 8px 12px; border-radius: 8px; font-weight: 700; font-size: 16px; display: inline-block; min-width: 40px;">${quantity}</div>
                                        </td>
                                        <td style="padding: 18px; text-align: center;">
                                            <div style="font-weight: 700; font-size: 17px; color: var(--text-primary); margin-bottom: 2px;">${formatCurrency(purchasePrice)}</div>
                                            <div style="font-size: 11px; color: var(--text-secondary); background: rgba(102, 102, 102, 0.1); padding: 2px 8px; border-radius: 12px; display: inline-block;">Wholesale + Ship + Tax</div>
                                        </td>
                                        <td style="padding: 18px; text-align: center;">
                                            <div style="display: flex; flex-direction: column; align-items: center; gap: 8px;">
                                                <div style="background: ${statusColors[currentStatus]}; color: white; padding: 8px 16px; border-radius: 20px; font-size: 12px; font-weight: 600; display: flex; align-items: center; gap: 6px; min-width: 100px; justify-content: center;">
                                                    ${statusEmojis[currentStatus]} ${currentStatus.toUpperCase()}
                                                </div>
                                                <select onchange="updateOrderItemStatus(${item.sectionIndex}, ${item.itemIndex}, this.value)" 
                                                        style="padding: 6px 12px; border: 2px solid var(--section-bg); border-radius: 6px; font-size: 12px; font-weight: 500; cursor: pointer; background: white;">
                                                    <option value="pending" ${(!item.deliveryStatus || item.deliveryStatus === 'pending') ? 'selected' : ''}>‚è≥ PENDING</option>
                                                    <option value="ordered" ${item.deliveryStatus === 'ordered' ? 'selected' : ''}>üì¶ ORDERED</option>
                                                    <option value="shipped" ${item.deliveryStatus === 'shipped' ? 'selected' : ''}>üöö SHIPPED</option>
                                                    <option value="delivered" ${item.deliveryStatus === 'delivered' ? 'selected' : ''}>‚úÖ DELIVERED</option>
                                                </select>
                                            </div>
                                        </td>
                                        <td style="padding: 18px; text-align: center;">
                                            <div style="display: flex; flex-direction: column; align-items: center; gap: 8px;">
                                                <button onclick="openOrderShippingModal(${item.sectionIndex}, ${item.itemIndex})" 
                                                        style="background: ${hasShippingInfo ? 'var(--success)' : 'var(--secondary-brand)'}; color: white; border: none; padding: 10px 16px; border-radius: 8px; font-size: 12px; cursor: pointer; font-weight: 600; transition: all 0.2s ease; display: flex; align-items: center; gap: 6px;" 
                                                        onmouseover="this.style.transform='translateY(-1px)'; this.style.boxShadow='0 4px 8px rgba(0,0,0,0.2)'" 
                                                        onmouseout="this.style.transform='translateY(0)'; this.style.boxShadow='none'">
                                                    ${hasShippingInfo ? '‚úÖ INFO' : 'üìù ADD INFO'}
                                                </button>
                                                ${hasShippingInfo && item.shippingInfo.trackingNumber ? `
                                                    <div style="font-size: 10px; color: var(--text-secondary); background: var(--section-bg); padding: 4px 8px; border-radius: 12px; font-weight: 500; max-width: 120px; text-overflow: ellipsis; overflow: hidden;">üìã ${item.shippingInfo.trackingNumber}</div>
                                                ` : ''}
                                                ${hasShippingInfo && item.shippingInfo.carrier ? `
                                                    <div style="font-size: 10px; color: var(--text-secondary); background: var(--hover-bg); padding: 2px 6px; border-radius: 8px; font-weight: 500;">üì¶ ${item.shippingInfo.carrier}</div>
                                                ` : ''}
                                            </div>
                                        </td>
                                    </tr>
                                `;
                            }).join('')}
                        </tbody>
                    </table>
                </div>
            `;
        }
        
        // New Orders Tab Interactive Functions
        function toggleOrderSection(sectionId) {
            const sectionElement = document.getElementById(sectionId);
            if (expandedOrderSections.has(sectionId)) {
                expandedOrderSections.delete(sectionId);
                sectionElement.style.display = 'none';
            } else {
                expandedOrderSections.add(sectionId);
                sectionElement.style.display = 'block';
            }
            // Don't re-render, just toggle display
        }
        
        function selectAllOrderItems() {
            orderItems.forEach(item => selectedOrderItems.add(item.uniqueId));
            renderOrderSections();
        }
        
        function clearOrderSelections() {
            selectedOrderItems.clear();
            renderOrderSections();
        }
        
        function selectSectionItems(sectionName, select) {
            orderItems.forEach(item => {
                if (item.sectionName === sectionName) {
                    if (select) {
                        selectedOrderItems.add(item.uniqueId);
                    } else {
                        selectedOrderItems.delete(item.uniqueId);
                    }
                }
            });
            renderOrderSections();
        }
        
        function toggleSectionSelectAll(checkbox, sectionName) {
            selectSectionItems(sectionName, checkbox.checked);
        }
        
        function toggleOrderItemSelection(uniqueId) {
            if (selectedOrderItems.has(uniqueId)) {
                selectedOrderItems.delete(uniqueId);
            } else {
                selectedOrderItems.add(uniqueId);
            }
            renderOrderSections();
        }
        
        function updateOrderBulkButtons() {
            const selectedCount = selectedOrderItems.size;
            const buttons = ['bulkPendingBtn', 'bulkOrderedBtn', 'bulkShippedBtn', 'bulkDeliveredBtn'];
            
            buttons.forEach(btnId => {
                const btn = document.getElementById(btnId);
                if (btn) {
                    btn.disabled = selectedCount === 0;
                    btn.style.opacity = selectedCount === 0 ? '0.5' : '1';
                    btn.style.cursor = selectedCount === 0 ? 'not-allowed' : 'pointer';
                }
            });
        }
        
        function bulkUpdateOrderStatus(newStatus) {
            if (selectedOrderItems.size === 0) return;
            
            let updatedCount = 0;
            selectedOrderItems.forEach(uniqueId => {
                const item = orderItems.find(item => item.uniqueId === uniqueId);
                if (item) {
                    currentProject.sections[item.sectionIndex].items[item.itemIndex].deliveryStatus = newStatus;
                    
                    // Set order date when status changes to ordered
                    if (newStatus === 'ordered' && !currentProject.sections[item.sectionIndex].items[item.itemIndex].shippingInfo?.orderDate) {
                        if (!currentProject.sections[item.sectionIndex].items[item.itemIndex].shippingInfo) {
                            currentProject.sections[item.sectionIndex].items[item.itemIndex].shippingInfo = {};
                        }
                        currentProject.sections[item.sectionIndex].items[item.itemIndex].shippingInfo.orderDate = new Date().toISOString().split('T')[0];
                    }
                    
                    updatedCount++;
                }
            });
            
            selectedOrderItems.clear();
            saveProjects();
            updateOrdersTab();
            
            showCustomAlert(`${updatedCount} items updated to ${newStatus.toUpperCase()} status!`);
        }
        
        function updateOrderItemStatus(sectionIndex, itemIndex, newStatus) {
            currentProject.sections[sectionIndex].items[itemIndex].deliveryStatus = newStatus;
            
            // Set order date when status changes to ordered
            if (newStatus === 'ordered' && !currentProject.sections[sectionIndex].items[itemIndex].shippingInfo?.orderDate) {
                if (!currentProject.sections[sectionIndex].items[itemIndex].shippingInfo) {
                    currentProject.sections[sectionIndex].items[itemIndex].shippingInfo = {};
                }
                currentProject.sections[sectionIndex].items[itemIndex].shippingInfo.orderDate = new Date().toISOString().split('T')[0];
            }
            
            saveProjects();
            updateOrdersTab();
        }
        
        function openOrderShippingModal(sectionIndex, itemIndex) {
            openShippingInfoModal(sectionIndex, itemIndex);
        }
        
        // Legacy function - can be removed
        function renderOrderItems() {
            const container = document.getElementById('readyToOrderItems');
            
            if (filteredOrderItems.length === 0) {
                const noItemsMessage = allOrderItems.length === 0 
                    ? 'No items ready to order yet. Go to the Items tab and click "Mark Ready" on items you want to order.'
                    : currentStatusFilter ? `No items with status "${currentStatusFilter.toUpperCase()}". Click "Delivery Progress" above to show all items.` : 'No items match your current criteria.';
                    
                container.innerHTML = `
                    <div style="text-align: center; padding: 40px; color: var(--text-secondary);">
                        <div style="font-size: 48px; margin-bottom: 16px;">üì¶</div>
                        <p>${noItemsMessage}</p>
                    </div>
                `;
                return;
            }
            
            // Group items by section for better organization
            renderItemsBySection();
            renderSummary();
        }
        
        function renderItemsBySection() {
            const container = document.getElementById('readyToOrderItems');
            
            // Group items by section
            const itemsBySection = {};
            filteredOrderItems.forEach(item => {
                if (!itemsBySection[item.sectionName]) {
                    itemsBySection[item.sectionName] = [];
                }
                itemsBySection[item.sectionName].push(item);
            });
            
            let sectionsHTML = '';
            
            // Default: expand all sections when orders tab is opened
            Object.keys(itemsBySection).forEach(sectionName => {
                const sectionId = `order-section-${sectionName.replace(/\s+/g, '-').toLowerCase()}`;
                if (!expandedOrderSections.has(sectionId)) {
                    expandedOrderSections.add(sectionId);
                }
            });
            
            Object.entries(itemsBySection).forEach(([sectionName, items]) => {
                const sectionId = `order-section-${sectionName.replace(/\s+/g, '-').toLowerCase()}`;
                const isExpanded = expandedOrderSections.has(sectionId);
                const itemCount = items.length;
                
                // Calculate section stats
                const pending = items.filter(item => !item.deliveryStatus || item.deliveryStatus === 'pending').length;
                const ordered = items.filter(item => item.deliveryStatus === 'ordered').length;
                const shipped = items.filter(item => item.deliveryStatus === 'shipped').length;
                const delivered = items.filter(item => item.deliveryStatus === 'delivered').length;

                sectionsHTML += `
                    <div class="card" style="margin-bottom: 20px; overflow: hidden;">
                        <div onclick="toggleOrderSectionExpansion('${sectionId}')" 
                             style="cursor: pointer; padding: 20px; display: flex; justify-content: space-between; align-items: center; background: var(--section-bg); transition: all 0.2s ease;" 
                             onmouseover="this.style.background='var(--hover-bg)'" 
                             onmouseout="this.style.background='var(--section-bg)'">
                            <div>
                                <h4 style="margin: 0 0 8px 0; color: var(--text-primary);">${sectionName}</h4>
                                <div style="display: flex; gap: 15px; font-size: 12px; font-weight: 500;">
                                    <span style="color: var(--warning);">‚è≥ Pending: ${pending}</span>
                                    <span style="color: var(--secondary-brand);">üì¶ Ordered: ${ordered}</span>
                                    <span style="color: var(--primary-brand);">üöö Shipped: ${shipped}</span>
                                    <span style="color: var(--success);">‚úÖ Delivered: ${delivered}</span>
                                </div>
                            </div>
                            <div style="display: flex; align-items: center; gap: 10px;">
                                <span style="background: var(--text-primary); color: var(--text-inverse); padding: 4px 8px; border-radius: 12px; font-size: 12px; font-weight: 600;">${itemCount} items</span>
                                <span style="font-size: 20px; transform: rotate(${isExpanded ? '180' : '0'}deg); transition: transform 0.2s ease;">‚ñº</span>
                            </div>
                        </div>
                        <div id="${sectionId}" style="display: ${isExpanded ? 'block' : 'none'}; padding: 20px; padding-top: 0;">
                            ${renderSectionItemsTable(items)}
                        </div>
                    </div>
                `;
            });

            container.innerHTML = sectionsHTML;
        }
        
        function toggleOrderSectionExpansion(sectionId) {
            const sectionElement = document.getElementById(sectionId);
            const isCurrentlyExpanded = expandedOrderSections.has(sectionId);
            
            if (isCurrentlyExpanded) {
                expandedOrderSections.delete(sectionId);
                sectionElement.style.display = 'none';
            } else {
                expandedOrderSections.add(sectionId);
                sectionElement.style.display = 'block';
            }
            
            // Update the arrow rotation
            renderOrderItems();
        }
        
        function renderSectionItemsTable(items) {
            const isMobile = window.innerWidth < 768;
            
            if (isMobile) {
                return renderSectionItemsMobile(items);
            } else {
                return renderSectionItemsDesktop(items);
            }
        }
        
        function renderSectionItemsDesktop(items) {
            return `
                <div style="overflow-x: auto;">
                    <table style="width: 100%; border-collapse: collapse;">
                        <thead>
                            <tr style="background: var(--hover-bg); font-weight: 600; font-size: 14px;">
                                <th style="padding: 12px; text-align: left; width: 40px;">
                                    <input type="checkbox" onchange="toggleSectionSelectAll(this, '${items[0]?.sectionName}')" style="cursor: pointer;">
                                </th>
                                <th style="padding: 12px; text-align: left;">Item Name</th>
                                <th style="padding: 12px; text-align: center;">Quantity</th>
                                <th style="padding: 12px; text-align: center;">Purchase Price</th>
                                <th style="padding: 12px; text-align: center;">Status</th>
                                <th style="padding: 12px; text-align: center;">Shipping Info</th>
                            </tr>
                        </thead>
                        <tbody>
                            ${items.map(item => {
                                const purchasePrice = calculatePurchasePrice(item);
                                const hasShippingInfo = item.shippingInfo && (item.shippingInfo.trackingNumber || item.shippingInfo.carrier);
                                return `
                                    <tr style="border-bottom: 1px solid var(--section-bg); transition: all 0.2s ease;" onmouseover="this.style.background='var(--hover-bg)'" onmouseout="this.style.background='transparent'">
                                        <td style="padding: 12px; text-align: center;">
                                            <input type="checkbox" 
                                                   ${selectedOrderItems.has(item.uniqueId) ? 'checked' : ''} 
                                                   onchange="toggleItemSelection('${item.uniqueId}')" 
                                                   style="cursor: pointer;">
                                        </td>
                                        <td style="padding: 12px;">
                                            <div style="font-weight: 500; color: var(--text-primary); margin-bottom: 4px;">${item.name || item.item || 'Unnamed Item'}</div>
                                            ${item.description ? `<div style="font-size: 12px; color: var(--text-secondary);">${item.description}</div>` : ''}
                                        </td>
                                        <td style="padding: 12px; text-align: center; font-weight: 500; font-size: 16px;">${item.qty || 1}</td>
                                        <td style="padding: 12px; text-align: center;">
                                            <div style="font-weight: 600; font-size: 16px; color: var(--text-primary);">${formatCurrency(purchasePrice)}</div>
                                            <div style="font-size: 11px; color: var(--text-secondary); margin-top: 2px;">Wholesale + Ship + Tax</div>
                                        </td>
                                        <td style="padding: 12px; text-align: center;">
                                            <select onchange="updateItemDeliveryStatus(${item.sectionIndex}, ${item.itemIndex}, this.value)" 
                                                    style="padding: 8px 12px; border: 2px solid var(--section-bg); border-radius: 6px; font-size: 13px; font-weight: 500; cursor: pointer; min-width: 120px;">
                                                <option value="pending" ${(!item.deliveryStatus || item.deliveryStatus === 'pending') ? 'selected' : ''}>‚è≥ Pending</option>
                                                <option value="ordered" ${item.deliveryStatus === 'ordered' ? 'selected' : ''}>üì¶ Ordered</option>
                                                <option value="shipped" ${item.deliveryStatus === 'shipped' ? 'selected' : ''}>üöö Shipped</option>
                                                <option value="delivered" ${item.deliveryStatus === 'delivered' ? 'selected' : ''}>‚úÖ Delivered</option>
                                            </select>
                                        </td>
                                        <td style="padding: 12px; text-align: center;">
                                            <button onclick="openShippingInfoModal(${item.sectionIndex}, ${item.itemIndex})" 
                                                    style="background: ${hasShippingInfo ? 'var(--success)' : 'var(--secondary-brand)'}; color: white; border: none; padding: 6px 12px; border-radius: 6px; font-size: 12px; cursor: pointer; font-weight: 500;" 
                                                    onmouseover="this.style.transform='translateY(-1px)'" onmouseout="this.style.transform='translateY(0)'">
                                                ${hasShippingInfo ? '‚úì Info' : '+ Info'}
                                            </button>
                                            ${hasShippingInfo && item.shippingInfo.trackingNumber ? `
                                                <div style="font-size: 10px; color: var(--text-secondary); margin-top: 2px; max-width: 80px; overflow: hidden; text-overflow: ellipsis;">${item.shippingInfo.trackingNumber}</div>
                                            ` : ''}
                                        </td>
                                    </tr>
                                `;
                            }).join('')}
                        </tbody>
                    </table>
                </div>
            `;
        }
        
        function renderSectionItemsMobile(items) {
            return `
                <div style="display: grid; gap: 15px;">
                    ${items.map(item => {
                        const purchasePrice = calculatePurchasePrice(item);
                        const hasShippingInfo = item.shippingInfo && (item.shippingInfo.trackingNumber || item.shippingInfo.carrier);
                        return `
                            <div style="background: var(--card-bg); border-radius: 12px; padding: 20px; border: 2px solid ${selectedOrderItems.has(item.uniqueId) ? 'var(--primary-brand)' : 'var(--section-bg)'}; transition: all 0.2s ease;">
                                <div style="display: flex; align-items: flex-start; gap: 15px; margin-bottom: 15px;">
                                    <input type="checkbox" 
                                           ${selectedOrderItems.has(item.uniqueId) ? 'checked' : ''} 
                                           onchange="toggleItemSelection('${item.uniqueId}')" 
                                           style="transform: scale(1.3); cursor: pointer; margin-top: 2px;">
                                    <div style="flex: 1;">
                                        <h4 style="margin: 0 0 5px 0; font-size: 18px; color: var(--text-primary);">${item.name || item.item || 'Unnamed Item'}</h4>
                                        ${item.description ? `<p style="margin: 0 0 10px 0; color: var(--text-secondary); font-size: 14px;">${item.description}</p>` : ''}
                                    </div>
                                </div>
                                
                                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 15px; margin-bottom: 15px;">
                                    <div style="text-align: center; padding: 12px; background: var(--section-bg); border-radius: 8px;">
                                        <div style="font-size: 24px; font-weight: 700; color: var(--text-primary);">${item.qty || 1}</div>
                                        <div style="font-size: 12px; color: var(--text-secondary); font-weight: 500;">QUANTITY</div>
                                    </div>
                                    <div style="text-align: center; padding: 12px; background: var(--section-bg); border-radius: 8px;">
                                        <div style="font-size: 20px; font-weight: 700; color: var(--text-primary);">${formatCurrency(purchasePrice)}</div>
                                        <div style="font-size: 12px; color: var(--text-secondary); font-weight: 500;">PURCHASE PRICE</div>
                                    </div>
                                </div>
                                
                                <div style="display: grid; grid-template-columns: 1fr auto; gap: 10px; align-items: center;">
                                    <select onchange="updateItemDeliveryStatus(${item.sectionIndex}, ${item.itemIndex}, this.value)" 
                                            style="padding: 10px 15px; border: 2px solid var(--section-bg); border-radius: 8px; font-size: 14px; font-weight: 500; cursor: pointer;">
                                        <option value="pending" ${(!item.deliveryStatus || item.deliveryStatus === 'pending') ? 'selected' : ''}>‚è≥ Pending</option>
                                        <option value="ordered" ${item.deliveryStatus === 'ordered' ? 'selected' : ''}>üì¶ Ordered</option>
                                        <option value="shipped" ${item.deliveryStatus === 'shipped' ? 'selected' : ''}>üöö Shipped</option>
                                        <option value="delivered" ${item.deliveryStatus === 'delivered' ? 'selected' : ''}>‚úÖ Delivered</option>
                                    </select>
                                    <button onclick="openShippingInfoModal(${item.sectionIndex}, ${item.itemIndex})" 
                                            style="background: ${hasShippingInfo ? 'var(--success)' : 'var(--secondary-brand)'}; color: white; border: none; padding: 10px 15px; border-radius: 8px; font-size: 14px; cursor: pointer; font-weight: 500; white-space: nowrap;" 
                                            onmouseover="this.style.transform='translateY(-1px)'" onmouseout="this.style.transform='translateY(0)'">
                                        ${hasShippingInfo ? '‚úì Shipping' : '+ Shipping'}
                                    </button>
                                </div>
                                
                                ${hasShippingInfo && item.shippingInfo.trackingNumber ? `
                                    <div style="margin-top: 10px; padding: 8px; background: var(--hover-bg); border-radius: 6px; font-size: 12px; color: var(--text-secondary);">
                                        <strong>Tracking:</strong> ${item.shippingInfo.trackingNumber}
                                        ${item.shippingInfo.carrier ? ` (${item.shippingInfo.carrier})` : ''}
                                    </div>
                                ` : ''}
                            </div>
                        `;
                    }).join('')}
                </div>
            `;
        }

        function renderDesktopTable() {
            const container = document.getElementById('readyToOrderItems');
            
            container.innerHTML = `
                <div style="background: var(--card-bg); border-radius: 12px; overflow: hidden; box-shadow: 0 4px 12px rgba(0,0,0,0.1); margin-bottom: 20px;">
                    <div style="overflow-x: auto;">
                        <table style="width: 100%; border-collapse: collapse;">
                            <thead>
                                <tr style="background: var(--section-bg); font-weight: 600; font-size: 14px;">
                                    <th style="padding: 16px; text-align: left; border-bottom: 2px solid var(--hover-bg); width: 40px;">
                                        <input type="checkbox" id="selectAllCheckbox" onchange="toggleSelectAll()" style="cursor: pointer;">
                                    </th>
                                    <th style="padding: 16px; text-align: left; border-bottom: 2px solid var(--hover-bg);">Item / Section</th>
                                    <th style="padding: 16px; text-align: center; border-bottom: 2px solid var(--hover-bg); width: 80px;">Qty</th>
                                    <th style="padding: 16px; text-align: right; border-bottom: 2px solid var(--hover-bg); width: 120px;">Wholesale</th>
                                    <th style="padding: 16px; text-align: right; border-bottom: 2px solid var(--hover-bg); width: 120px;">Sell Price</th>
                                    <th style="padding: 16px; text-align: right; border-bottom: 2px solid var(--hover-bg); width: 100px;">Shipping</th>
                                    <th style="padding: 16px; text-align: right; border-bottom: 2px solid var(--hover-bg); width: 80px;">Tax</th>
                                    <th style="padding: 16px; text-align: center; border-bottom: 2px solid var(--hover-bg); width: 140px;">Status</th>
                                    <th style="padding: 16px; text-align: center; border-bottom: 2px solid var(--hover-bg); width: 100px;">Actions</th>
                                </tr>
                            </thead>
                            <tbody>
                                ${filteredOrderItems.map(item => `
                                    <tr style="border-bottom: 1px solid var(--hover-bg); transition: all 0.2s ease;" 
                                        onmouseover="this.style.backgroundColor='var(--hover-bg)'" 
                                        onmouseout="this.style.backgroundColor=''">
                                        <td style="padding: 16px; text-align: center;">
                                            <input type="checkbox" 
                                                   ${selectedOrderItems.has(item.uniqueId) ? 'checked' : ''} 
                                                   onchange="toggleItemSelection('${item.uniqueId}')" 
                                                   style="cursor: pointer;">
                                        </td>
                                        <td style="padding: 16px; vertical-align: top;">
                                            <div style="font-weight: 600; color: var(--text-primary); margin-bottom: 4px; font-size: 15px;">${item.name}</div>
                                            <div style="font-size: 13px; color: var(--text-secondary); margin-bottom: 4px;">${item.sectionName}</div>
                                            ${item.link ? `<a href="${item.link}" target="_blank" style="color: var(--secondary-brand); text-decoration: none; font-size: 12px; display: inline-flex; align-items: center; gap: 4px;">üîó View Product</a>` : '<span style="font-size: 12px; color: var(--text-tertiary);">No product link</span>'}
                                        </td>
                                        <td style="padding: 16px; text-align: center; font-weight: 600; font-size: 16px;">${item.qty || 1}</td>
                                        <td style="padding: 16px; text-align: right; font-weight: 500; color: var(--text-primary);">${((item.wholesalePrice || 0) * (item.qty || 1)).toLocaleString('en-US', { style: 'currency', currency: 'USD' })}</td>
                                        <td style="padding: 16px; text-align: right; font-weight: 600; color: var(--primary-brand);">${((item.customerPrice || item.price || 0) * (item.qty || 1)).toLocaleString('en-US', { style: 'currency', currency: 'USD' })}</td>
                                        <td style="padding: 16px; text-align: right; font-weight: 500; color: var(--text-primary);">${((item.shipping || 0) * (item.qty || 1)).toLocaleString('en-US', { style: 'currency', currency: 'USD' })}</td>
                                        <td style="padding: 16px; text-align: right; font-weight: 500; color: var(--text-primary);">${((item.tax || 0) * (item.qty || 1)).toLocaleString('en-US', { style: 'currency', currency: 'USD' })}</td>
                                        <td style="padding: 16px; text-align: center;">
                                            <select onchange="updateOrderStatusWithFeedback(${item.sectionIndex}, ${item.itemIndex}, this.value)" 
                                                    style="padding: 8px 12px; border: 2px solid var(--section-bg); border-radius: 8px; background: var(--card-bg); font-size: 13px; width: 100%; font-weight: 500; color: var(--text-primary); cursor: pointer;">
                                                <option value="pending" ${(item.orderStatus || 'pending') === 'pending' ? 'selected' : ''}>‚è≥ Pending</option>
                                                <option value="ordered" ${item.orderStatus === 'ordered' ? 'selected' : ''}>üì¶ Ordered</option>
                                                <option value="shipped" ${item.orderStatus === 'shipped' ? 'selected' : ''}>üöö Shipped</option>
                                                <option value="delivered" ${item.orderStatus === 'delivered' ? 'selected' : ''}>‚úÖ Delivered</option>
                                            </select>
                                        </td>
                                        <td style="padding: 16px; text-align: center;">
                                            <button onclick="removeFromReadyToOrderWithConfirm(${item.sectionIndex}, ${item.itemIndex})"
                                                    style="padding: 8px 12px; background: var(--error); color: white; border: none; border-radius: 6px; font-size: 12px; cursor: pointer; transition: all 0.2s ease;"
                                                    onmouseover="this.style.transform='translateY(-1px)'; this.style.boxShadow='0 4px 8px rgba(0,0,0,0.15)'"
                                                    onmouseout="this.style.transform='translateY(0)'; this.style.boxShadow='none'"
                                                    title="Remove from orders">
                                                üóëÔ∏è Remove
                                            </button>
                                        </td>
                                    </tr>
                                `).join('')}
                            </tbody>
                        </table>
                    </div>
                </div>
            `;
        }

        function renderMobileCards() {
            const container = document.getElementById('readyToOrderItems');
            
            container.innerHTML = `
                <div style="display: grid; gap: 16px; margin-bottom: 20px;">
                    ${filteredOrderItems.map(item => `
                        <div style="background: var(--card-bg); border-radius: 12px; padding: 16px; box-shadow: 0 2px 8px rgba(0,0,0,0.1); border: 1px solid var(--hover-bg);">
                            <div style="display: flex; justify-content: space-between; align-items: flex-start; margin-bottom: 12px;">
                                <div style="flex: 1;">
                                    <div style="font-weight: 600; color: var(--text-primary); margin-bottom: 4px; font-size: 16px;">${item.name}</div>
                                    <div style="font-size: 13px; color: var(--text-secondary); margin-bottom: 8px;">${item.sectionName}</div>
                                    ${item.link ? `<a href="${item.link}" target="_blank" style="color: var(--secondary-brand); text-decoration: none; font-size: 12px;">üîó View Product</a>` : ''}
                                </div>
                                <input type="checkbox" 
                                       ${selectedOrderItems.has(item.uniqueId) ? 'checked' : ''} 
                                       onchange="toggleItemSelection('${item.uniqueId}')" 
                                       style="cursor: pointer; margin-left: 12px;">
                            </div>
                            
                            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 12px; margin-bottom: 16px; font-size: 14px;">
                                <div>
                                    <div style="color: var(--text-secondary); font-size: 12px; margin-bottom: 2px;">Quantity</div>
                                    <div style="font-weight: 600;">${item.qty || 1}</div>
                                </div>
                                <div>
                                    <div style="color: var(--text-secondary); font-size: 12px; margin-bottom: 2px;">Sell Price</div>
                                    <div style="font-weight: 600; color: var(--primary-brand);">${((item.customerPrice || item.price || 0) * (item.qty || 1)).toLocaleString('en-US', { style: 'currency', currency: 'USD' })}</div>
                                </div>
                                <div>
                                    <div style="color: var(--text-secondary); font-size: 12px; margin-bottom: 2px;">Wholesale</div>
                                    <div style="font-weight: 500;">${((item.wholesalePrice || 0) * (item.qty || 1)).toLocaleString('en-US', { style: 'currency', currency: 'USD' })}</div>
                                </div>
                                <div>
                                    <div style="color: var(--text-secondary); font-size: 12px; margin-bottom: 2px;">Ship + Tax</div>
                                    <div style="font-weight: 500;">${(((item.shipping || 0) + (item.tax || 0)) * (item.qty || 1)).toLocaleString('en-US', { style: 'currency', currency: 'USD' })}</div>
                                </div>
                            </div>
                            
                            <div style="display: flex; gap: 8px; align-items: center;">
                                <select onchange="updateOrderStatusWithFeedback(${item.sectionIndex}, ${item.itemIndex}, this.value)" 
                                        style="flex: 1; padding: 10px 12px; border: 2px solid var(--section-bg); border-radius: 8px; background: var(--card-bg); font-size: 14px; font-weight: 500; color: var(--text-primary);">
                                    <option value="pending" ${(item.orderStatus || 'pending') === 'pending' ? 'selected' : ''}>‚è≥ Pending</option>
                                    <option value="ordered" ${item.orderStatus === 'ordered' ? 'selected' : ''}>üì¶ Ordered</option>
                                    <option value="shipped" ${item.orderStatus === 'shipped' ? 'selected' : ''}>üöö Shipped</option>
                                    <option value="delivered" ${item.orderStatus === 'delivered' ? 'selected' : ''}>‚úÖ Delivered</option>
                                </select>
                                <button onclick="removeFromReadyToOrderWithConfirm(${item.sectionIndex}, ${item.itemIndex})"
                                        style="padding: 10px 12px; background: var(--error); color: white; border: none; border-radius: 8px; font-size: 12px; cursor: pointer;">
                                    üóëÔ∏è
                                </button>
                            </div>
                        </div>
                    `).join('')}
                </div>
            `;
        }

        function renderSummary() {
            const container = document.getElementById('readyToOrderItems');
            const summaryHTML = `
                <div style="margin-top: 20px; background: var(--section-bg); border-radius: 12px; padding: 20px; border: 2px solid var(--hover-bg);">
                    <h4 style="margin: 0 0 16px 0; color: var(--text-primary); text-align: center;">Order Summary</h4>
                    <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 16px; text-align: center; font-size: 14px; font-weight: 500;">
                        <div style="padding: 16px; background: var(--card-bg); border-radius: 10px;">
                            <div style="color: var(--text-secondary); margin-bottom: 6px; font-size: 13px;">Total Items</div>
                            <div style="font-size: 24px; font-weight: 600; color: var(--text-primary);">${filteredOrderItems.length}</div>
                        </div>
                        <div style="padding: 16px; background: var(--card-bg); border-radius: 10px;">
                            <div style="color: var(--text-secondary); margin-bottom: 6px; font-size: 13px;">Total Wholesale</div>
                            <div style="font-size: 20px; font-weight: 600; color: var(--text-primary);">${filteredOrderItems.reduce((total, item) => total + ((item.wholesalePrice || 0) * (item.qty || 1)), 0).toLocaleString('en-US', { style: 'currency', currency: 'USD' })}</div>
                        </div>
                        <div style="padding: 16px; background: var(--card-bg); border-radius: 10px;">
                            <div style="color: var(--text-secondary); margin-bottom: 6px; font-size: 13px;">Total Sell Price</div>
                            <div style="font-size: 20px; font-weight: 600; color: var(--primary-brand);">${filteredOrderItems.reduce((total, item) => total + ((item.customerPrice || item.price || 0) * (item.qty || 1)), 0).toLocaleString('en-US', { style: 'currency', currency: 'USD' })}</div>
                        </div>
                        <div style="padding: 16px; background: var(--card-bg); border-radius: 10px;">
                            <div style="color: var(--text-secondary); margin-bottom: 6px; font-size: 13px;">Potential Profit</div>
                            <div style="font-size: 20px; font-weight: 600; color: var(--success);">${filteredOrderItems.reduce((total, item) => total + (((item.customerPrice || item.price || 0) - (item.wholesalePrice || 0)) * (item.qty || 1)), 0).toLocaleString('en-US', { style: 'currency', currency: 'USD' })}</div>
                        </div>
                    </div>
                </div>
            `;
            
            container.innerHTML += summaryHTML;
        }

        function updateItemPrice(sectionIndex, itemIndex, newPrice) {
            currentProject.sections[sectionIndex].items[itemIndex].price = parseFloat(newPrice);
            saveCurrentProject();
            updateReadyToOrderItems();
            updateProjectSections();
        }

        function updateOrderStatus(sectionIndex, itemIndex, status) {
            currentProject.sections[sectionIndex].items[itemIndex].orderStatus = status;
            saveCurrentProject();
            updateReadyToOrderItems(); // Refresh to update progress
            showCustomAlert(`Order status updated to "${status}"!`);
        }
        
        function updateOrderProgress(readyItems) {
            let pendingCount = 0;
            let orderedCount = 0; 
            let shippedCount = 0;
            let deliveredCount = 0;
            
            readyItems.forEach(item => {
                const status = item.deliveryStatus || 'pending';
                switch(status) {
                    case 'pending': pendingCount++; break;
                    case 'ordered': orderedCount++; break; 
                    case 'shipped': shippedCount++; break;
                    case 'delivered': deliveredCount++; break;
                }
            });
            
            const total = readyItems.length;
            const deliveredPercentage = total > 0 ? (deliveredCount / total) * 100 : 0;
            
            // Update progress bar - show different colors for each stage
            const totalReadyItems = total || 1; // Avoid division by zero
            const pendingPercentage = (pendingCount / totalReadyItems) * 100;
            const orderedPercentage = (orderedCount / totalReadyItems) * 100;
            const shippedPercentage = (shippedCount / totalReadyItems) * 100;
            const deliveredPercentageCalc = (deliveredCount / totalReadyItems) * 100;
            
            // Update progress bar widths
            document.getElementById('pendingProgress').style.width = `${pendingPercentage}%`;
            document.getElementById('orderedProgress').style.width = `${orderedPercentage}%`;
            document.getElementById('shippedProgress').style.width = `${shippedPercentage}%`;
            document.getElementById('deliveredProgress').style.width = `${deliveredPercentageCalc}%`;
            
            // Update percentage text below progress bar
            if (document.getElementById('pendingPercent')) {
                document.getElementById('pendingPercent').textContent = `${pendingPercentage.toFixed(0)}%`;
                document.getElementById('orderedPercent').textContent = `${orderedPercentage.toFixed(0)}%`;
                document.getElementById('shippedPercent').textContent = `${shippedPercentage.toFixed(0)}%`;
                document.getElementById('deliveredPercent').textContent = `${deliveredPercentageCalc.toFixed(0)}%`;
            }
            
            // Update counters
            document.getElementById('pendingCount').textContent = pendingCount;
            document.getElementById('orderedCount').textContent = orderedCount;
            document.getElementById('shippedCount').textContent = shippedCount;
            document.getElementById('deliveredCount').textContent = deliveredCount;
            
            // Update summary text with more detailed info
            const summaryText = total > 0 
                ? `${deliveredCount} delivered ‚Ä¢ ${shippedCount} shipped ‚Ä¢ ${orderedCount} ordered ‚Ä¢ ${pendingCount} pending (${total} total items)`
                : 'No items to track';
            document.getElementById('orderSummaryText').textContent = summaryText;
        }

        function removeFromReadyToOrder(sectionIndex, itemIndex) {
            currentProject.sections[sectionIndex].items[itemIndex].readyToOrder = false;
            saveCurrentProject();
            updateReadyToOrderItems();
            updateProjectSections();
        }

        // Enhanced order management functions
        function removeFromReadyToOrderWithConfirm(sectionIndex, itemIndex) {
            const item = currentProject.sections[sectionIndex].items[itemIndex];
            showCustomPrompt(
                'Remove Item from Orders',
                [
                    { type: 'text', name: 'confirm', label: `Are you sure you want to remove "${item.name}" from your orders?`, required: false, readonly: true }
                ],
                () => {
                    removeFromReadyToOrder(sectionIndex, itemIndex);
                    showSuccessToast('Item removed from orders');
                }
            );
        }

        function updateOrderStatusWithFeedback(sectionIndex, itemIndex, status) {
            const item = currentProject.sections[sectionIndex].items[itemIndex];
            const oldStatus = item.orderStatus || 'pending';
            
            currentProject.sections[sectionIndex].items[itemIndex].orderStatus = status;
            saveCurrentProject();
            updateReadyToOrderItems();
            
            // Show subtle feedback
            showSuccessToast(`${item.name} marked as ${status}`);
        }

        function toggleItemSelection(uniqueId) {
            if (selectedOrderItems.has(uniqueId)) {
                selectedOrderItems.delete(uniqueId);
            } else {
                selectedOrderItems.add(uniqueId);
            }
            updateBulkActionButtons();
            updateSelectAllCheckbox();
        }

        function toggleSelectAll() {
            const selectAllCheckbox = document.getElementById('selectAllCheckbox');
            if (selectAllCheckbox.checked) {
                filteredOrderItems.forEach(item => selectedOrderItems.add(item.uniqueId));
            } else {
                selectedOrderItems.clear();
            }
            renderOrderItems();
            updateBulkActionButtons();
        }

        function selectAllItems() {
            filteredOrderItems.forEach(item => selectedOrderItems.add(item.uniqueId));
            renderOrderItems();
            updateBulkActionButtons();
        }
        
        function toggleSectionSelectAll(checkbox, sectionName) {
            const sectionItems = filteredOrderItems.filter(item => item.sectionName === sectionName);
            
            if (checkbox.checked) {
                sectionItems.forEach(item => selectedOrderItems.add(item.uniqueId));
            } else {
                sectionItems.forEach(item => selectedOrderItems.delete(item.uniqueId));
            }
            
            renderOrderItems();
            updateBulkActionButtons();
        }
        
        function toggleItemSelection(uniqueId) {
            if (selectedOrderItems.has(uniqueId)) {
                selectedOrderItems.delete(uniqueId);
            } else {
                selectedOrderItems.add(uniqueId);
            }
            renderOrderItems();
            updateBulkActionButtons();
        }
        
        function updateItemDeliveryStatus(sectionIndex, itemIndex, newStatus) {
            if (currentProject && currentProject.sections) {
                currentProject.sections[sectionIndex].items[itemIndex].deliveryStatus = newStatus;
                
                // Set order date when item is marked as ordered
                if (newStatus === 'ordered' && !currentProject.sections[sectionIndex].items[itemIndex].shippingInfo.orderDate) {
                    currentProject.sections[sectionIndex].items[itemIndex].shippingInfo.orderDate = new Date().toISOString().split('T')[0];
                }
                
                saveProjects();
                updateReadyToOrderItems();
            }
        }
        
        function calculatePurchasePrice(item) {
            const wholesalePrice = parseFloat(item.wholesalePrice) || 0;
            const shipping = parseFloat(item.shipping) || parseFloat(item.shippingInfo?.shippingCost) || 0;
            const tax = parseFloat(item.tax) || 0;
            const quantity = parseInt(item.qty) || 1;
            
            return (wholesalePrice + shipping + tax) * quantity;
        }
        
        function formatCurrency(amount) {
            return new Intl.NumberFormat('en-US', {
                style: 'currency',
                currency: 'USD'
            }).format(amount);
        }
        
        function openShippingInfoModal(sectionIndex, itemIndex) {
            const item = currentProject.sections[sectionIndex].items[itemIndex];
            const shippingInfo = item.shippingInfo || {};
            
            const modalContent = `
                <div style="background: var(--card-bg); border-radius: 16px; padding: 30px; max-width: 500px; width: 90vw; max-height: 90vh; overflow-y: auto; box-shadow: 0 20px 60px rgba(0,0,0,0.3);">
                    <h3 style="margin: 0 0 20px 0; color: var(--text-primary); text-align: center;">Shipping Information</h3>
                    <p style="margin: 0 0 20px 0; color: var(--text-secondary); text-align: center;"><strong>${item.item || 'Item'}</strong> - ${item.sectionName || 'Section'}</p>
                    
                    <div style="display: grid; gap: 15px;">
                        <div>
                            <label style="display: block; margin-bottom: 5px; color: var(--text-primary); font-weight: 500;">Carrier</label>
                            <select id="shippingCarrier" style="width: 100%; padding: 10px; border: 2px solid var(--section-bg); border-radius: 8px; font-size: 14px;">
                                <option value="">Select Carrier</option>
                                <option value="UPS" ${shippingInfo.carrier === 'UPS' ? 'selected' : ''}>UPS</option>
                                <option value="FedEx" ${shippingInfo.carrier === 'FedEx' ? 'selected' : ''}>FedEx</option>
                                <option value="USPS" ${shippingInfo.carrier === 'USPS' ? 'selected' : ''}>USPS</option>
                                <option value="DHL" ${shippingInfo.carrier === 'DHL' ? 'selected' : ''}>DHL</option>
                                <option value="Other" ${shippingInfo.carrier === 'Other' ? 'selected' : ''}>Other</option>
                            </select>
                        </div>
                        
                        <div>
                            <label style="display: block; margin-bottom: 5px; color: var(--text-primary); font-weight: 500;">Tracking Number</label>
                            <input type="text" id="trackingNumber" value="${shippingInfo.trackingNumber || ''}" placeholder="Enter tracking number" style="width: 100%; padding: 10px; border: 2px solid var(--section-bg); border-radius: 8px; font-size: 14px;">
                        </div>
                        
                        <div>
                            <label style="display: block; margin-bottom: 5px; color: var(--text-primary); font-weight: 500;">Shipping Method</label>
                            <input type="text" id="shippingMethod" value="${shippingInfo.shippingMethod || ''}" placeholder="e.g., Ground, 2-Day Air, Overnight" style="width: 100%; padding: 10px; border: 2px solid var(--section-bg); border-radius: 8px; font-size: 14px;">
                        </div>
                        
                        <div>
                            <label style="display: block; margin-bottom: 5px; color: var(--text-primary); font-weight: 500;">Estimated Delivery</label>
                            <input type="date" id="estimatedDelivery" value="${shippingInfo.estimatedDelivery || ''}" style="width: 100%; padding: 10px; border: 2px solid var(--section-bg); border-radius: 8px; font-size: 14px;">
                        </div>
                        
                        <div>
                            <label style="display: block; margin-bottom: 5px; color: var(--text-primary); font-weight: 500;">Order Date</label>
                            <input type="date" id="orderDate" value="${shippingInfo.orderDate || ''}" style="width: 100%; padding: 10px; border: 2px solid var(--section-bg); border-radius: 8px; font-size: 14px;">
                        </div>
                        
                        <div>
                            <label style="display: block; margin-bottom: 5px; color: var(--text-primary); font-weight: 500;">Notes</label>
                            <textarea id="shippingNotes" rows="3" placeholder="Additional notes..." style="width: 100%; padding: 10px; border: 2px solid var(--section-bg); border-radius: 8px; font-size: 14px; resize: vertical;">${shippingInfo.notes || ''}</textarea>
                        </div>
                    </div>
                    
                    <div style="display: flex; gap: 10px; margin-top: 25px; justify-content: center;">
                        <button onclick="saveShippingInfo(${sectionIndex}, ${itemIndex})" style="background: var(--success); color: white; border: none; padding: 12px 24px; border-radius: 8px; font-weight: 500; cursor: pointer;">Save</button>
                        <button onclick="closeModal()" style="background: var(--hover-bg); color: var(--text-primary); border: none; padding: 12px 24px; border-radius: 8px; font-weight: 500; cursor: pointer;">Cancel</button>
                    </div>
                </div>
            `;
            
            showModal(modalContent);
        }
        
        function saveShippingInfo(sectionIndex, itemIndex) {
            const shippingInfo = {
                carrier: document.getElementById('shippingCarrier').value,
                trackingNumber: document.getElementById('trackingNumber').value,
                shippingMethod: document.getElementById('shippingMethod').value,
                estimatedDelivery: document.getElementById('estimatedDelivery').value,
                orderDate: document.getElementById('orderDate').value,
                notes: document.getElementById('shippingNotes').value,
                shippingCost: currentProject.sections[sectionIndex].items[itemIndex].shipping || 0
            };
            
            currentProject.sections[sectionIndex].items[itemIndex].shippingInfo = shippingInfo;
            saveProjects();
            updateReadyToOrderItems();
            closeModal();
            
            showCustomAlert('Shipping information saved successfully!');
        }

        function updateSelectAllCheckbox() {
            const selectAllCheckbox = document.getElementById('selectAllCheckbox');
            if (selectAllCheckbox) {
                const allSelected = filteredOrderItems.length > 0 && filteredOrderItems.every(item => selectedOrderItems.has(item.uniqueId));
                selectAllCheckbox.checked = allSelected;
            }
        }

        function updateBulkActionButtons() {
            const selectedCount = selectedOrderItems.size;
            const buttons = ['bulkOrderedBtn', 'bulkShippedBtn', 'bulkDeliveredBtn'];
            
            buttons.forEach(btnId => {
                const btn = document.getElementById(btnId);
                if (btn) {
                    btn.disabled = selectedCount === 0;
                    btn.style.opacity = selectedCount === 0 ? '0.5' : '1';
                    btn.style.cursor = selectedCount === 0 ? 'not-allowed' : 'pointer';
                }
            });
        }

        function bulkUpdateStatus(newStatus) {
            if (selectedOrderItems.size === 0) return;
            
            const statusEmoji = {
                'pending': '‚è≥',
                'ordered': 'üì¶',
                'shipped': 'üöö',
                'delivered': '‚úÖ'
            };
            
            let updatedCount = 0;
            selectedOrderItems.forEach(uniqueId => {
                const item = allOrderItems.find(item => item.uniqueId === uniqueId);
                if (item) {
                    currentProject.sections[item.sectionIndex].items[item.itemIndex].deliveryStatus = newStatus;
                    updatedCount++;
                }
            });
            
            selectedOrderItems.clear();
            saveCurrentProject();
            updateReadyToOrderItems();
            
            showSuccessToast(`${updatedCount} items marked as ${statusEmoji[newStatus]} ${newStatus}`);
        }

        function filterByStatus(status) {
            currentStatusFilter = status;
            applyStatusFilter();
        }
        
        function showAllItems() {
            currentStatusFilter = '';
            applyStatusFilter();
        }

        function clearAllFilters() {
            currentStatusFilter = '';
            selectedOrderItems.clear();
            applyStatusFilter();
        }

        function exportOrdersCSV() {
            if (filteredOrderItems.length === 0) {
                showCustomAlert('No items to export. Add some items to orders first.');
                return;
            }
            
            const headers = [
                'Item Name', 'Section', 'Quantity', 'Wholesale Price', 'Sell Price', 
                'Shipping', 'Tax', 'Status', 'Product Link', 'Total Wholesale', 'Total Sell'
            ];
            
            const csvData = filteredOrderItems.map(item => [
                item.name,
                item.sectionName,
                item.qty || 1,
                (item.wholesalePrice || 0).toFixed(2),
                (item.customerPrice || item.price || 0).toFixed(2),
                (item.shipping || 0).toFixed(2),
                (item.tax || 0).toFixed(2),
                item.orderStatus || 'pending',
                item.link || '',
                ((item.wholesalePrice || 0) * (item.qty || 1)).toFixed(2),
                ((item.customerPrice || item.price || 0) * (item.qty || 1)).toFixed(2)
            ]);
            
            const csvContent = [headers, ...csvData]
                .map(row => row.map(field => `"${field}"`).join(','))
                .join('\n');
            
            const blob = new Blob([csvContent], { type: 'text/csv' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `${currentProject.name}-orders-${new Date().toISOString().split('T')[0]}.csv`;
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            URL.revokeObjectURL(url);
            
            showSuccessToast('Orders exported to CSV successfully!');
        }

        function printOrdersList() {
            if (filteredOrderItems.length === 0) {
                showCustomAlert('No items to print. Add some items to orders first.');
                return;
            }
            
            const printContent = `
                <html>
                <head>
                    <title>Orders - ${currentProject.name}</title>
                    <style>
                        body { font-family: Arial, sans-serif; margin: 20px; }
                        h1 { color: #333; border-bottom: 3px solid #D8A7A7; padding-bottom: 10px; }
                        table { width: 100%; border-collapse: collapse; margin-top: 20px; }
                        th, td { padding: 12px; text-align: left; border-bottom: 1px solid #ddd; }
                        th { background-color: #f5f5f5; font-weight: bold; }
                        .status-pending { color: #D8C690; }
                        .status-ordered { color: #9CAEC2; }
                        .status-shipped { color: #D8A7A7; }
                        .status-delivered { color: #B7C4B2; }
                        .summary { background: #f9f9f9; padding: 15px; margin-top: 20px; border-radius: 8px; }
                    </style>
                </head>
                <body>
                    <h1>Order List - ${currentProject.name}</h1>
                    <p>Generated on ${new Date().toLocaleDateString()}</p>
                    
                    <table>
                        <thead>
                            <tr>
                                <th>Item</th>
                                <th>Section</th>
                                <th>Qty</th>
                                <th>Wholesale</th>
                                <th>Sell Price</th>
                                <th>Status</th>
                            </tr>
                        </thead>
                        <tbody>
                            ${filteredOrderItems.map(item => `
                                <tr>
                                    <td>${item.name}</td>
                                    <td>${item.sectionName}</td>
                                    <td>${item.qty || 1}</td>
                                    <td>$${((item.wholesalePrice || 0) * (item.qty || 1)).toFixed(2)}</td>
                                    <td>$${((item.customerPrice || item.price || 0) * (item.qty || 1)).toFixed(2)}</td>
                                    <td class="status-${item.orderStatus || 'pending'}">${item.orderStatus || 'pending'}</td>
                                </tr>
                            `).join('')}
                        </tbody>
                    </table>
                    
                    <div class="summary">
                        <h3>Summary</h3>
                        <p><strong>Total Items:</strong> ${filteredOrderItems.length}</p>
                        <p><strong>Total Wholesale:</strong> $${filteredOrderItems.reduce((total, item) => total + ((item.wholesalePrice || 0) * (item.qty || 1)), 0).toFixed(2)}</p>
                        <p><strong>Total Sell Price:</strong> $${filteredOrderItems.reduce((total, item) => total + ((item.customerPrice || item.price || 0) * (item.qty || 1)), 0).toFixed(2)}</p>
                        <p><strong>Potential Profit:</strong> $${filteredOrderItems.reduce((total, item) => total + (((item.customerPrice || item.price || 0) - (item.wholesalePrice || 0)) * (item.qty || 1)), 0).toFixed(2)}</p>
                    </div>
                </body>
                </html>
            `;
            
            const printWindow = window.open('', '_blank');
            printWindow.document.write(printContent);
            printWindow.document.close();
            printWindow.print();
        }

        function showSuccessToast(message) {
            // Create a subtle toast notification
            const toast = document.createElement('div');
            toast.style.cssText = `
                position: fixed;
                top: 20px;
                right: 20px;
                background: var(--success);
                color: white;
                padding: 12px 20px;
                border-radius: 8px;
                box-shadow: 0 4px 12px rgba(0,0,0,0.15);
                z-index: 10000;
                font-size: 14px;
                font-weight: 500;
                opacity: 0;
                transform: translateY(-10px);
                transition: all 0.3s ease;
            `;
            toast.textContent = message;
            document.body.appendChild(toast);
            
            // Animate in
            setTimeout(() => {
                toast.style.opacity = '1';
                toast.style.transform = 'translateY(0)';
            }, 10);
            
            // Animate out and remove
            setTimeout(() => {
                toast.style.opacity = '0';
                toast.style.transform = 'translateY(-10px)';
                setTimeout(() => {
                    if (toast.parentNode) {
                        document.body.removeChild(toast);
                    }
                }, 300);
            }, 3000);
        }

        // Add window resize listener for responsive design
        window.addEventListener('resize', () => {
            if (document.getElementById('orders').style.display !== 'none') {
                renderOrderItems();
            }
        });

        function updateProjectHours() {
            if (!currentProject) return;
            
            const hoursWorked = currentProject.hoursWorked || 0;
            const hoursRemaining = (currentProject.hoursPaid || 0) - hoursWorked;
            
            // Update only the elements that exist in the current UI (detailHoursWorked and detailHoursRemaining)
            const hoursWorkedDisplay = document.getElementById('detailHoursWorked');
            const hoursRemainingDisplay = document.getElementById('detailHoursRemaining');
            
            if (hoursWorkedDisplay) {
                hoursWorkedDisplay.textContent = `${hoursWorked.toFixed(1)}h`;
            }
            if (hoursRemainingDisplay) {
                hoursRemainingDisplay.textContent = `${hoursRemaining.toFixed(1)}h`;
            }
        }

        function logProjectHours() {
            if (!currentProject) return;
            
            showCustomPrompt(
                'Log Hours',
                [
                    { type: 'number', name: 'hours', label: 'Hours Worked', step: '0.25', required: true, placeholder: 'e.g. 2.5' },
                    { type: 'date', name: 'date', label: 'Date', required: true, defaultValue: new Date().toISOString().split('T')[0] },
                    { type: 'textarea', name: 'description', label: 'Description', required: true, placeholder: 'What did you work on?' }
                ],
                (data) => {
                    const hours = parseFloat(data.hours);
                    if (isNaN(hours) || hours <= 0) {
                        showCustomAlert('Please enter valid hours.');
                        return;
                    }
                    
                    if (!currentProject.hoursLog) currentProject.hoursLog = [];
                    
                    currentProject.hoursLog.push({
                        id: Date.now(),
                        date: data.date,
                        hours: hours,
                        description: data.description
                    });
                    
                    currentProject.hoursWorked = (currentProject.hoursWorked || 0) + hours;
                    
                    saveCurrentProject();
                    updateProjectHours();
                    updateDashboard();
                    displayProjects();
                    
                    showCustomAlert(`Logged ${hours} hours successfully! ‚ú®`);
                }
            );
        }

        function updateProjectUpcomingEvents() {
            if (!currentProject) return;
            
            const container = document.getElementById('projectUpcomingEvents');
            const upcomingEvents = [];
            
            if (currentProject.events) {
                currentProject.events.forEach((event, index) => {
                    const eventDate = new Date(event.date);
                    const today = new Date();
                    if (eventDate >= today && !event.completed) {
                        upcomingEvents.push({...event, originalIndex: index});
                    }
                });
            }
            
            upcomingEvents.sort((a, b) => new Date(a.date) - new Date(b.date));
            
            if (upcomingEvents.length === 0) {
                container.innerHTML = '<p style="color: var(--text-secondary);">No upcoming events for this project.</p>';
            } else {
                container.innerHTML = upcomingEvents.map(event => `
                    <div class="upcoming-event" style="
                        display: flex;
                        justify-content: space-between;
                        align-items: center;
                        padding: 12px 15px;
                        background: rgba(255,255,255,0.7);
                        border-radius: 8px;
                        margin-bottom: 8px;
                        border: 1px solid var(--hover-bg);
                        transition: all 0.2s ease;
                    " onmouseover="this.style.boxShadow='0 2px 8px rgba(0,0,0,0.1)'; this.style.transform='translateY(-1px)'" onmouseout="this.style.boxShadow='none'; this.style.transform='translateY(0)'">
                        <div style="flex: 1;">
                            <div style="font-weight: 600; color: var(--text-primary); margin-bottom: 4px;">${event.title}</div>
                            <div style="font-size: 13px; color: var(--text-secondary); margin-bottom: 2px;">${event.notes || 'No notes'}</div>
                            <div style="display: flex; gap: 15px; font-size: 12px; color: var(--text-secondary);">
                                <span>üìÖ ${new Date(event.date).toLocaleDateString()}</span>
                                <span>üïê ${event.time || 'No time set'}</span>
                                ${event.type ? `<span style="background: ${getEventTypeColor(event.type)}; color: white; padding: 2px 6px; border-radius: 10px; font-size: 10px; text-transform: capitalize;">${event.type}</span>` : ''}
                        </div>
                        </div>
                        <div style="display: flex; gap: 6px; align-items: center; margin-left: 15px;">
                            <button onclick="editProjectEvent(${event.originalIndex})" style="
                                background: var(--secondary-brand);
                                color: white;
                                border: none;
                                padding: 6px 10px;
                                border-radius: 4px;
                                font-size: 11px;
                                cursor: pointer;
                                transition: all 0.2s ease;
                            " onmouseover="this.style.background='var(--primary-brand)'" onmouseout="this.style.background='var(--secondary-brand)'" title="Edit Event">
                                ‚úèÔ∏è Edit
                            </button>
                            <button onclick="deleteProjectEvent(${event.originalIndex})" style="
                                background: var(--error);
                                color: white;
                                border: none;
                                padding: 6px 10px;
                                border-radius: 4px;
                                font-size: 11px;
                                cursor: pointer;
                                transition: all 0.2s ease;
                            " onmouseover="this.style.background='#c53030'" onmouseout="this.style.background='var(--error)'" title="Delete Event">
                                üóëÔ∏è Delete
                            </button>
                        </div>
                    </div>
                `).join('');
            }
        }

        function updateSectionInvoiceList() {
            if (!currentProject || !currentProject.sections) return;
            
            const container = document.getElementById('sectionInvoiceList');
            if (!container) return;
            
            // Rebuild the invoice section structure
            const invoiceContainer = document.getElementById('invoice');
            invoiceContainer.innerHTML = `
                <div style="margin-bottom: 30px;">
                    <h3 style="margin: 0 0 15px 0; color: var(--text-primary);">Generate Invoices by Section</h3>
                    <p style="margin: 0 0 20px 0; color: var(--text-secondary); font-size: 14px;">Create separate invoices for each project section/category. This allows for flexible billing and payment tracking.</p>
                    
                    <div id="sectionInvoiceList" style="display: grid; gap: 15px;">
                        <!-- Section invoice options will be populated here -->
                    </div>
                </div>
                
                <div class="invoice-preview" id="projectInvoicePreview">
                    <!-- Invoice preview will be populated here -->
                </div>
            `;
            
            const sectionListContainer = document.getElementById('sectionInvoiceList');
            
            if (currentProject.sections.length === 0) {
                sectionListContainer.innerHTML = '<p style="color: var(--text-secondary); text-align: center; padding: 20px;">No sections available. Add items in the Items tab to create invoices.</p>';
                return;
            }
            
            // Filter sections that have items
            const sectionsWithItems = currentProject.sections.filter(section => 
                section.items && section.items.length > 0
            );
            
            if (sectionsWithItems.length === 0) {
                sectionListContainer.innerHTML = '<p style="color: var(--text-secondary); text-align: center; padding: 20px;">No sections with items available. Add items to your sections in the Items tab to create invoices.</p>';
                return;
            }
            
            sectionListContainer.innerHTML = currentProject.sections.map((section, sectionIndex) => {
                const hasItems = section.items && section.items.length > 0;
                const sectionTotal = hasItems ? section.items.reduce((total, item) => {
                    const customerUnitPrice = item.customerPrice || item.price || 0;
                    const quantity = item.qty || 1;
                    const unitTotal = customerUnitPrice * quantity;
                    const totalWithShippingTax = unitTotal + (item.shipping || 0) + (item.tax || 0);
                    return total + totalWithShippingTax;
                }, 0) : 0;
                
                const itemCount = hasItems ? section.items.length : 0;
                
                return `
                    <div class="card" style="padding: 20px; ${!hasItems ? 'opacity: 0.6; border: 2px dashed var(--section-bg);' : ''}">
                        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px;">
                            <div>
                                <h4 style="margin: 0; color: var(--text-primary);">${section.name}</h4>
                                <p style="margin: 5px 0 0 0; color: var(--text-secondary); font-size: 13px;">
                                    ${hasItems 
                                        ? `${itemCount} item${itemCount === 1 ? '' : 's'} ‚Ä¢ Total: $${sectionTotal.toLocaleString('en-US', { minimumFractionDigits: 2, maximumFractionDigits: 2 })}` 
                                        : '‚ö†Ô∏è No items - cannot generate invoice'
                                    }
                                </p>
                            </div>
                            <div style="display: flex; gap: 10px;">
                                <button class="btn ${hasItems ? 'btn-success' : 'btn-disabled'}" 
                                        onclick="${hasItems ? `generateAndDownloadSectionInvoice(${sectionIndex})` : `showCustomAlert('This section has no items. Please add items in the Items tab before generating an invoice.')`}" 
                                        style="padding: 8px 16px; font-size: 14px; ${!hasItems ? 'background: #ccc; cursor: not-allowed;' : ''}">
                                    üìÑ Download PDF
                                </button>
                                <button class="btn ${hasItems ? 'btn-coral' : 'btn-disabled'}" 
                                        onclick="${hasItems ? `previewSectionInvoice(${sectionIndex})` : `showCustomAlert('This section has no items. Please add items in the Items tab before previewing an invoice.')`}" 
                                        style="padding: 8px 16px; font-size: 14px; ${!hasItems ? 'background: #ccc; cursor: not-allowed;' : ''}">
                                    üëÅÔ∏è Preview
                                </button>
                            </div>
                        </div>
                        
                        <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 10px; margin-top: 10px;">
                            ${hasItems ? section.items.map(item => {
                                const customerPrice = item.customerPrice || item.price || 0;
                                const total = (customerPrice * (item.qty || 1)) + (item.shipping || 0) + (item.tax || 0);
                                return `
                                    <div style="padding: 8px 12px; background: var(--section-bg); border-radius: 6px; font-size: 12px;">
                                        <strong>${item.name}</strong><br>
                                        <span style="color: var(--text-secondary);">Qty: ${item.qty || 1} ‚Ä¢ $${total.toFixed(2)}</span>
                                    </div>
                                `;
                            }).join('') : `
                                <div style="padding: 12px; text-align: center; color: var(--text-secondary); font-style: italic; grid-column: 1 / -1;">
                                    No items in this section. <a href="#" onclick="showProjectSection('items', document.querySelector('.project-tab[onclick*=items]'))" style="color: var(--secondary-brand);">Add items here ‚Üí</a>
                                </div>
                            `}
                        </div>
                    </div>
                `;
            }).join('');
        }

        function previewSectionInvoice(sectionIndex) {
            if (!currentProject || !currentProject.sections || !currentProject.sections[sectionIndex]) {
                showCustomAlert('Error: Section not found. Please refresh and try again.');
                return;
            }
            
            const section = currentProject.sections[sectionIndex];
            
            // Open preview in new window/tab
            const previewWindow = window.open('', '_blank', 'width=900,height=800,scrollbars=yes,resizable=yes');
            
            if (!previewWindow) {
                showCustomAlert('Pop-up blocked! Please allow pop-ups and try again.');
                return;
            }
            
            // Write the invoice HTML to the new window
            previewWindow.document.write(`
                <!DOCTYPE html>
                <html>
                <head>
                    <meta charset="UTF-8">
                    <title>Invoice Preview - ${currentProject.name} - ${section.name}</title>
                    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
                    <style>
                        body {
                            font-family: 'Inter', Arial, sans-serif;
                            margin: 0;
                            padding: 20px;
                            background: #f9f9f9;
                            color: #333;
                        }
                        
                        .container {
                            max-width: 800px;
                            margin: 0 auto;
                            background: white;
                            padding: 40px;
                            border-radius: 12px;
                            box-shadow: 0 4px 20px rgba(0,0,0,0.1);
                        }
                        
                        .no-print {
                            background: #007bff;
                            color: white;
                            border: none;
                            padding: 12px 24px;
                            border-radius: 6px;
                            font-size: 16px;
                            cursor: pointer;
                            margin: 0 10px 20px 0;
                        }
                        
                        .no-print:hover {
                            background: #0056b3;
                        }
                        
                        @media print {
                            body { background: white; padding: 0; }
                            .container { box-shadow: none; padding: 20px; margin: 0; }
                            .no-print { display: none; }
                        }
                    </style>
                </head>
                <body>
                    <div class="no-print" style="text-align: center; margin-bottom: 30px;">
                        <button class="no-print" onclick="window.print()">üñ®Ô∏è Print Invoice</button>
                        <button class="no-print" onclick="window.close()">‚úï Close Preview</button>
                    </div>
                    
                    <div class="container">
                        ${generateCleanInvoiceHTML(sectionIndex)}
                    </div>
                </body>
                </html>
            `);
            
            previewWindow.document.close();
            previewWindow.focus();
        }

        function generateAndDownloadSectionInvoice(sectionIndex) {
            if (!currentProject || !currentProject.sections || !currentProject.sections[sectionIndex]) {
                showCustomAlert('Error: Section not found. Please refresh and try again.');
                return;
            }
            
            const section = currentProject.sections[sectionIndex];
            
            // Show loading message with better styling
            const loadingAlert = document.createElement('div');
            loadingAlert.id = 'pdf-loading';
            loadingAlert.style.cssText = `
                position: fixed;
                top: 20px;
                right: 20px;
                background: linear-gradient(135deg, var(--secondary-brand), var(--primary-brand));
                color: white;
                padding: 16px 24px;
                border-radius: 8px;
                box-shadow: 0 4px 20px rgba(0,0,0,0.15);
                z-index: 10000;
                font-weight: 500;
                display: flex;
                align-items: center;
                gap: 10px;
            `;
            loadingAlert.innerHTML = `
                <div style="width: 20px; height: 20px; border: 2px solid rgba(255,255,255,0.3); border-top: 2px solid white; border-radius: 50%; animation: spin 1s linear infinite;"></div>
                Generating PDF... Please wait
            `;
            
            // Add spinner animation
            if (!document.getElementById('spinner-style')) {
                const style = document.createElement('style');
                style.id = 'spinner-style';
                style.textContent = `
                    @keyframes spin {
                        0% { transform: rotate(0deg); }
                        100% { transform: rotate(360deg); }
                    }
                `;
                document.head.appendChild(style);
            }
            
            document.body.appendChild(loadingAlert);
            
            // Create a temporary element with the invoice HTML
            const tempElement = document.createElement('div');
            tempElement.innerHTML = generateCleanInvoiceHTML(sectionIndex);
            tempElement.style.position = 'absolute';
            tempElement.style.left = '-9999px';
            tempElement.style.top = '-9999px';
            document.body.appendChild(tempElement);
            
            // Configure PDF options
            const filename = `Invoice-${currentProject.name.replace(/[^a-z0-9]/gi, '-')}-${section.name.replace(/[^a-z0-9]/gi, '-')}.pdf`;
            const opt = {
                margin: [0.5, 0.5, 0.5, 0.5],
                filename: filename,
                image: { type: 'jpeg', quality: 0.98 },
                html2canvas: { 
                    scale: 2, 
                    useCORS: true,
                    letterRendering: true,
                    logging: false
                },
                jsPDF: { 
                    unit: 'in', 
                    format: 'letter', 
                    orientation: 'portrait',
                    compress: true
                },
                pagebreak: { mode: ['avoid-all', 'css', 'legacy'] }
            };
            
            // Generate and download PDF
            html2pdf()
                .set(opt)
                .from(tempElement)
                .save()
                .then(() => {
                    // Clean up
                    document.body.removeChild(tempElement);
                    const loading = document.getElementById('pdf-loading');
                    if (loading) document.body.removeChild(loading);
                    
                    // Show success message
                    const successAlert = document.createElement('div');
                    successAlert.style.cssText = `
                        position: fixed;
                        top: 20px;
                        right: 20px;
                        background: linear-gradient(135deg, var(--success), var(--highlight));
                        color: white;
                        padding: 16px 24px;
                        border-radius: 8px;
                        box-shadow: 0 4px 20px rgba(0,0,0,0.15);
                        z-index: 10000;
                        font-weight: 500;
                    `;
                    successAlert.innerHTML = '‚úÖ Invoice PDF downloaded successfully!';
                    document.body.appendChild(successAlert);
                    
                    setTimeout(() => {
                        if (document.body.contains(successAlert)) {
                            document.body.removeChild(successAlert);
                        }
                    }, 4000);
                })
                .catch((error) => {
                    console.error('PDF generation failed:', error);
                    document.body.removeChild(tempElement);
                    const loading = document.getElementById('pdf-loading');
                    if (loading) document.body.removeChild(loading);
                    
                    // Show error message
                    const errorAlert = document.createElement('div');
                    errorAlert.style.cssText = `
                        position: fixed;
                        top: 20px;
                        right: 20px;
                        background: linear-gradient(135deg, var(--error), #E2A39D);
                        color: white;
                        padding: 16px 24px;
                        border-radius: 8px;
                        box-shadow: 0 4px 20px rgba(0,0,0,0.15);
                        z-index: 10000;
                        font-weight: 500;
                    `;
                    errorAlert.innerHTML = '‚ùå Error generating PDF. Please try again or use the preview option.';
                    document.body.appendChild(errorAlert);
                    
                    setTimeout(() => {
                        if (document.body.contains(errorAlert)) {
                            document.body.removeChild(errorAlert);
                        }
                    }, 5000);
                });
        }
        
        function generateCleanInvoiceHTML(sectionIndex) {
            const section = currentProject.sections[sectionIndex];
            let sectionTotal = 0;
            let invoiceItems = [];
            
            // Generate items for this section only
            section.items.forEach(item => {
                const customerUnitPrice = item.customerPrice || item.price || 0;
                const quantity = item.qty || 1;
                const unitTotal = customerUnitPrice * quantity;
                const totalWithShippingTax = unitTotal + (item.shipping || 0) + (item.tax || 0);
                
                invoiceItems.push({
                    description: item.name,
                    unitPrice: customerUnitPrice,
                    qty: quantity,
                    unitTotal: unitTotal,
                    total: totalWithShippingTax
                });
                sectionTotal += totalWithShippingTax;
            });
            
            return `
                <div style="font-family: 'Inter', Arial, sans-serif; max-width: 800px; margin: 0 auto; padding: 40px; background: white; color: #333;">
                    <!-- Header -->
                    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 40px; border-bottom: 3px solid #D8A7A7; padding-bottom: 20px;">
                        <div style="display: flex; align-items: center; gap: 20px;">
                            <div style="width: 60px; height: 60px; background: #F2EFEB; border-radius: 8px; display: flex; align-items: center; justify-content: center;">
                                <svg viewBox="0 0 400 300" xmlns="http://www.w3.org/2000/svg" style="width: 40px; height: 40px;">
                                    <g stroke="#333" stroke-width="6" fill="none">
                                        <path d="M50 250 L50 150 L120 100 L190 150 L190 250 Z"/>
                                        <path d="M210 250 L210 170 L280 120 L350 170 L350 250 Z"/>
                                        <path d="M30 150 L120 90 L210 150"/>
                                        <path d="M190 170 L280 110 L370 170"/>
                                        <line x1="80" y1="130" x2="80" y2="250"/>
                                        <line x1="160" y1="130" x2="160" y2="250"/>
                                        <line x1="240" y1="150" x2="240" y2="250"/>
                                        <line x1="320" y1="150" x2="320" y2="250"/>
                                        <line x1="30" y1="250" x2="370" y2="250"/>
                                    </g>
                                </svg>
                            </div>
                            <div>
                                <h1 style="margin: 0; font-size: 28px; font-weight: 600; color: #333; letter-spacing: 1px;">KELLY RAM DESIGNS</h1>
                                <p style="margin: 5px 0 0 0; color: #666; font-size: 16px; font-weight: 400;">INTERIOR DESIGN</p>
                            </div>
                        </div>
                        <div style="text-align: right;">
                            <h2 style="margin: 0; font-size: 42px; font-weight: 300; color: #333; letter-spacing: 4px;">INVOICE</h2>
                        </div>
                    </div>
                    
                    <!-- Client and Invoice Info -->
                    <div style="display: flex; justify-content: space-between; margin-bottom: 40px;">
                        <div style="width: 45%;">
                            <div style="margin-bottom: 25px;">
                                <h3 style="margin: 0 0 8px 0; font-size: 16px; font-weight: 600; color: #333;">ISSUED TO:</h3>
                                <div style="font-size: 15px; line-height: 1.5; color: #333;">
                                    <strong>${currentProject.client}</strong><br>
                                    ${currentProject.clientEmail ? currentProject.clientEmail + '<br>' : ''}
                                    ${currentProject.clientPhone ? currentProject.clientPhone + '<br>' : ''}
                                    ${currentProject.clientAddress ? currentProject.clientAddress.replace(/\n/g, '<br>') : ''}
                                </div>
                            </div>
                            <div>
                                <h3 style="margin: 0 0 8px 0; font-size: 16px; font-weight: 600; color: #333;">PAY TO:</h3>
                                <div style="font-size: 15px; color: #333;">
                                    <strong>Kelly Ram Designs</strong><br>
                                    kellyramdesigns@gmail.com
                                </div>
                            </div>
                        </div>
                        <div style="width: 45%; text-align: right;">
                            <div style="font-size: 15px; line-height: 1.8;">
                                <div><strong>PROJECT:</strong> ${currentProject.name}</div>
                                <div><strong>SECTION:</strong> ${section.name}</div>
                                <div><strong>INVOICE NO:</strong> ${currentProject.invoiceNumber || 'TBD'}-${sectionIndex + 1}</div>
                                <div><strong>DATE:</strong> ${new Date().toLocaleDateString('en-US', { month: '2-digit', day: '2-digit', year: 'numeric' }).replace(/\//g, '.')}</div>
                            </div>
                        </div>
                    </div>

                    <!-- Items Table -->
                    <table style="width: 100%; border-collapse: collapse; margin: 30px 0;">
                        <thead>
                            <tr style="background: #D3DCE6;">
                                <th style="padding: 15px 12px; text-align: left; font-weight: 600; font-size: 14px; color: #333; border-bottom: 2px solid #9CAEC2;">DESCRIPTION</th>
                                <th style="padding: 15px 12px; text-align: right; font-weight: 600; font-size: 14px; color: #333; border-bottom: 2px solid #9CAEC2;">UNIT PRICE</th>
                                <th style="padding: 15px 12px; text-align: center; font-weight: 600; font-size: 14px; color: #333; border-bottom: 2px solid #9CAEC2;">QTY</th>
                                <th style="padding: 15px 12px; text-align: right; font-weight: 600; font-size: 14px; color: #333; border-bottom: 2px solid #9CAEC2;">SUBTOTAL</th>
                                <th style="padding: 15px 12px; text-align: right; font-weight: 600; font-size: 14px; color: #333; border-bottom: 2px solid #9CAEC2;">TOTAL</th>
                            </tr>
                        </thead>
                        <tbody>
                            ${invoiceItems.map((item, index) => `
                                <tr style="border-bottom: 1px solid #EDEAE6;">
                                    <td style="padding: 15px 12px; font-size: 14px; color: #333;">${item.description}</td>
                                    <td style="padding: 15px 12px; text-align: right; font-size: 14px; color: #333;">$${item.unitPrice.toLocaleString('en-US', { minimumFractionDigits: 2, maximumFractionDigits: 2 })}</td>
                                    <td style="padding: 15px 12px; text-align: center; font-size: 14px; color: #333;">${item.qty}</td>
                                    <td style="padding: 15px 12px; text-align: right; font-size: 14px; color: #333;">$${item.unitTotal.toLocaleString('en-US', { minimumFractionDigits: 2, maximumFractionDigits: 2 })}</td>
                                    <td style="padding: 15px 12px; text-align: right; font-size: 14px; font-weight: 600; color: #333;">$${item.total.toLocaleString('en-US', { minimumFractionDigits: 2, maximumFractionDigits: 2 })}</td>
                                </tr>
                            `).join('')}
                        </tbody>
                    </table>
                    
                    <!-- Tax/Shipping Note -->
                    <div style="text-align: right; margin: 20px 0; padding: 12px 16px; background: #EDEAE6; border-radius: 6px; border-left: 4px solid #9CAEC2;">
                        <p style="margin: 0; font-size: 13px; color: #666; font-style: italic;">
                            * Total prices include applicable shipping and tax charges
                        </p>
                    </div>

                    <!-- Total Section -->
                    <div style="text-align: right; margin: 30px 0; padding: 25px; background: #F0E5D8; border-radius: 8px; border-top: 3px solid #D8A7A7;">
                        <div style="font-size: 24px; font-weight: 700; color: #333;">
                            SECTION TOTAL: $${sectionTotal.toLocaleString('en-US', { minimumFractionDigits: 2, maximumFractionDigits: 2 })}
                        </div>
                    </div>

                    <!-- Payment Info -->
                    <div style="margin-top: 50px; padding-top: 20px; border-top: 1px solid #EDEAE6; font-size: 14px; color: #666; line-height: 1.6;">
                        <p style="margin: 0 0 12px 0;"><strong>Payment Options:</strong></p>
                        <p style="margin: 0 0 8px 0;">‚Ä¢ Zelle: kellyramdesigns@gmail.com</p>
                        <p style="margin: 0 0 20px 0;">‚Ä¢ Check payable to: Kelly Ram Designs</p>
                        
                        <p style="margin: 0 0 8px 0; font-size: 13px;"><strong>Please note:</strong> Most products are final sale and cannot be returned</p>
                        <p style="margin: 0; font-size: 13px;">*All prices are subject to change</p>
                    </div>
                </div>
            `;
        }

        function generateInvoiceHTML(sectionIndex) {
            const section = currentProject.sections[sectionIndex];
            let sectionTotal = 0;
            let invoiceItems = [];
            
            // Skip if section is deactivated
            if (section.isGrayedOut) {
                return null;
            }
            
            // Generate items for this section only - but skip deactivated items
            section.items.forEach(item => {
                // Skip deactivated/grayed out items
                if (item.isGrayedOut) return;
                const customerUnitPrice = item.customerPrice || item.price || 0;
                const quantity = item.qty || 1;
                const unitTotal = customerUnitPrice * quantity;
                const totalWithShippingTax = unitTotal + (item.shipping || 0) + (item.tax || 0);
                
                invoiceItems.push({
                    description: item.name,
                    unitPrice: customerUnitPrice,
                    qty: quantity,
                    unitTotal: unitTotal,
                    total: totalWithShippingTax
                });
                sectionTotal += totalWithShippingTax;
            });
            
            // Get uploaded logo or use default house icon
            const companyLogo = localStorage.getItem('companyLogo');
            const logoSection = companyLogo ? 
                `<img src="${companyLogo}" style="width: 60px; height: 60px; border-radius: 8px; object-fit: contain;">` :
                `<div style="width: 60px; height: 60px; background: #F2EFEB; border-radius: 8px; display: flex; align-items: center; justify-content: center; box-shadow: 0 2px 8px rgba(51,51,51,0.1);">
                    <svg viewBox="0 0 400 300" xmlns="http://www.w3.org/2000/svg" style="width: 40px; height: 40px;">
                        <g stroke="#333" stroke-width="6" fill="none">
                            <path d="M50 250 L50 150 L120 100 L190 150 L190 250 Z"/>
                            <path d="M210 250 L210 170 L280 120 L350 170 L350 250 Z"/>
                            <path d="M30 150 L120 90 L210 150"/>
                            <path d="M190 170 L280 110 L370 170"/>
                            <line x1="80" y1="130" x2="80" y2="250"/>
                            <line x1="160" y1="130" x2="160" y2="250"/>
                            <line x1="240" y1="150" x2="240" y2="250"/>
                            <line x1="320" y1="150" x2="320" y2="250"/>
                            <line x1="30" y1="250" x2="370" y2="250"/>
                        </g>
                    </svg>
                </div>`;
            
            return `<!DOCTYPE html>
            <html>
            <head>
                <meta charset="UTF-8">
                <title>Invoice - ${currentProject.name} - ${section.name}</title>
                <style>
                    @import url('https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap');
                    
                    body {
                        font-family: 'Inter', -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
                        margin: 0;
                        padding: 30px;
                        background: white;
                        color: #333;
                        line-height: 1.6;
                    }
                    
                    .invoice-container {
                        max-width: 800px;
                        margin: 0 auto;
                    }
                    
                    table {
                        width: 100%;
                        border-collapse: collapse;
                        margin: 20px 0;
                    }
                    
                    th, td {
                        padding: 15px;
                        text-align: left;
                        border-bottom: 1px solid #EDEAE6;
                    }
                    
                    th {
                        background: #D3DCE6;
                        color: #333;
                        font-weight: 600;
                    }
                    
                    @media print {
                        body { margin: 0; padding: 20px; }
                        .no-print { display: none; }
                    }
                </style>
            </head>
            <body>
                <div class="invoice-container">
                    <div style="display: flex; align-items: center; justify-content: space-between; margin-bottom: 30px; border-bottom: 2px solid #D8A7A7; padding-bottom: 20px;">
                        <div style="display: flex; align-items: center; gap: 20px;">
                            ${logoSection}
                            <div>
                                <h2 style="margin: 0; color: #333;">KELLY RAM DESIGNS</h2>
                                <p style="margin: 5px 0; color: #666;">INTERIOR DESIGN</p>
                            </div>
                        </div>
                        <div style="font-size: 36px; font-weight: 200; color: #333; letter-spacing: 3px;">INVOICE</div>
                    </div>
                    
                    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 40px; margin-bottom: 30px;">
                        <div>
                            <div style="margin-bottom: 20px;">
                                <strong>ISSUED TO:</strong><br>
                                ${currentProject.client}<br>
                                ${currentProject.clientEmail ? currentProject.clientEmail + '<br>' : ''}
                                ${currentProject.clientPhone ? currentProject.clientPhone + '<br>' : ''}
                                ${currentProject.clientAddress ? currentProject.clientAddress.replace(/\n/g, '<br>') : ''}
                            </div>
                            <div>
                                <strong>PAY TO:</strong><br>
                                Kelly Ram Designs
                            </div>
                        </div>
                        <div style="text-align: right;">
                            <div style="margin-bottom: 10px;">
                                <strong>PROJECT:</strong> ${currentProject.name}
                            </div>
                            <div style="margin-bottom: 10px;">
                                <strong>SECTION:</strong> ${section.name}
                            </div>
                            <div style="margin-bottom: 10px;">
                                <strong>INVOICE NO:</strong> ${currentProject.invoiceNumber || 'TBD'}-${sectionIndex + 1}
                            </div>
                            <div>
                                <strong>DATE:</strong> ${new Date().toLocaleDateString('en-US', { month: '2-digit', day: '2-digit', year: 'numeric' }).replace(/\//g, '.')}
                            </div>
                        </div>
                    </div>

                    <table>
                        <thead>
                            <tr>
                                <th>DESCRIPTION</th>
                                <th>UNIT PRICE</th>
                                <th>QTY</th>
                                <th>SUBTOTAL</th>
                                <th>TOTAL</th>
                            </tr>
                        </thead>
                        <tbody>
                            ${invoiceItems.map(item => `
                                <tr>
                                    <td>${item.description}</td>
                                    <td>$${item.unitPrice.toLocaleString('en-US', { minimumFractionDigits: 2, maximumFractionDigits: 2 })}</td>
                                    <td>${item.qty}</td>
                                    <td>$${item.unitTotal.toLocaleString('en-US', { minimumFractionDigits: 2, maximumFractionDigits: 2 })}</td>
                                    <td>$${item.total.toLocaleString('en-US', { minimumFractionDigits: 2, maximumFractionDigits: 2 })}</td>
                                </tr>
                            `).join('')}
                        </tbody>
                    </table>
                    
                    <div style="text-align: right; margin-top: 10px; margin-bottom: 20px; padding: 10px 15px; background: #EDEAE6; border-radius: 8px; border-left: 4px solid #9CAEC2;">
                        <p style="margin: 0; font-size: 13px; color: #666; font-style: italic;">
                            * Total prices include applicable shipping and tax charges
                        </p>
                    </div>

                    <div style="text-align: right; margin-top: 30px; padding: 25px; background: #F0E5D8; border-radius: 12px;">
                        <div style="font-weight: 600; font-size: 24px; color: #333; padding-top: 15px; border-top: 2px solid #D8A7A7;">
                            <strong>SECTION TOTAL: $${sectionTotal.toLocaleString('en-US', { minimumFractionDigits: 2, maximumFractionDigits: 2 })}</strong>
                        </div>
                    </div>

                    <div style="margin-top: 40px; padding-top: 20px; border-top: 1px solid #EDEAE6; color: #666; font-size: 14px;">
                        <p>Payment can be sent via Zelle to kellyramdesigns@gmail.com or check to Kelly Ram Designs</p>
                        <p style="margin-top: 20px;">Please note: Most products are final sale and cannot be returned</p>
                        <p>*All prices are subject to change</p>
                    </div>
                </div>
            </body>
            </html>`;
        }

        function generateProjectInvoice() {
            if (!currentProject) return;
            
            let projectTotal = 0;
            let invoiceItems = [];
            
            if (currentProject.sections) {
                currentProject.sections.forEach(section => {
                    // Skip deactivated sections
                    if (section.isGrayedOut) return;
                    
                    section.items.forEach(item => {
                        // Skip deactivated items
                        if (item.isGrayedOut) return;
                        const customerUnitPrice = item.customerPrice || item.price || 0;
                        const quantity = item.qty || 1;
                        const unitTotal = customerUnitPrice * quantity;
                        const totalWithShippingTax = unitTotal + (item.shipping || 0) + (item.tax || 0);
                        
                        invoiceItems.push({
                            description: `${item.name} (${section.name})`,
                            unitPrice: customerUnitPrice,
                            qty: quantity,
                            unitTotal: unitTotal,
                            total: totalWithShippingTax
                        });
                        projectTotal += totalWithShippingTax;
                    });
                });
            }
            
            const preview = document.getElementById('projectInvoicePreview');
            
            // Get uploaded logo or use default house icon
            const companyLogo = localStorage.getItem('companyLogo');
            const logoSection = companyLogo ? 
                `<img src="${companyLogo}" style="width: 60px; height: 60px; border-radius: 8px; object-fit: contain;">` :
                `<div style="width: 60px; height: 60px; background: var(--card-bg); border-radius: 8px; display: flex; align-items: center; justify-content: center; box-shadow: 0 2px 8px rgba(51,51,51,0.1);">
                    <svg viewBox="0 0 400 300" xmlns="http://www.w3.org/2000/svg" style="width: 40px; height: 40px;">
                        <g stroke="#333" stroke-width="6" fill="none">
                            <path d="M50 250 L50 150 L120 100 L190 150 L190 250 Z"/>
                            <path d="M210 250 L210 170 L280 120 L350 170 L350 250 Z"/>
                            <path d="M30 150 L120 90 L210 150"/>
                            <path d="M190 170 L280 110 L370 170"/>
                            <line x1="80" y1="130" x2="80" y2="250"/>
                            <line x1="160" y1="130" x2="160" y2="250"/>
                            <line x1="240" y1="150" x2="240" y2="250"/>
                            <line x1="320" y1="150" x2="320" y2="250"/>
                            <line x1="30" y1="250" x2="370" y2="250"/>
                        </g>
                    </svg>
                </div>`;
            
            preview.innerHTML = `
                <div style="display: flex; align-items: center; justify-content: space-between; margin-bottom: 30px; border-bottom: 2px solid var(--soft-rose); padding-bottom: 20px;">
                    <div style="display: flex; align-items: center; gap: 20px;">
                        ${logoSection}
                        <div>
                            <h2 style="margin: 0; color: var(--text-primary);">KELLY RAM DESIGNS</h2>
                            <p style="margin: 5px 0; color: var(--text-secondary);">INTERIOR DESIGN</p>
                        </div>
                    </div>
                    <div style="font-size: 36px; font-weight: 200; color: var(--text-primary); letter-spacing: 3px;">INVOICE</div>
                </div>
                
                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 40px; margin-bottom: 30px;">
                    <div>
                        <div style="margin-bottom: 20px;">
                            <strong>ISSUED TO:</strong><br>
                            ${currentProject.client}<br>
                            ${currentProject.clientEmail ? currentProject.clientEmail + '<br>' : ''}
                            ${currentProject.clientPhone ? currentProject.clientPhone + '<br>' : ''}
                            ${currentProject.clientAddress ? currentProject.clientAddress.replace(/\n/g, '<br>') : ''}
                        </div>
                        <div>
                            <strong>PAY TO:</strong><br>
                            Kelly Ram Designs
                        </div>
                    </div>
                    <div style="text-align: right;">
                        <div style="margin-bottom: 10px;">
                            <strong>INVOICE NO:</strong> ${currentProject.invoiceNumber}
                        </div>
                        <div>
                            <strong>DATE:</strong> ${new Date().toLocaleDateString('en-US').replace(/\//g, '.')}
                        </div>
                    </div>
                </div>

                <table style="width: 100%; border-collapse: collapse; margin: 20px 0; border-radius: 12px; overflow: hidden;">
                    <thead>
                        <tr style="background: var(--task-bg);">
                            <th style="padding: 15px; text-align: left; color: var(--text-primary);">DESCRIPTION</th>
                            <th style="padding: 15px; text-align: left; color: var(--text-primary);">UNIT PRICE</th>
                            <th style="padding: 15px; text-align: left; color: var(--text-primary);">QTY</th>
                            <th style="padding: 15px; text-align: left; color: var(--text-primary);">SUBTOTAL</th>
                            <th style="padding: 15px; text-align: left; color: var(--text-primary);">TOTAL</th>
                        </tr>
                    </thead>
                    <tbody>
                        ${invoiceItems.map(item => `
                            <tr>
                                <td style="padding: 15px; border-bottom: 1px solid var(--section-bg);">${item.description}</td>
                                <td style="padding: 15px; border-bottom: 1px solid var(--section-bg);">$${item.unitPrice.toLocaleString('en-US', { minimumFractionDigits: 2, maximumFractionDigits: 2 })}</td>
                                <td style="padding: 15px; border-bottom: 1px solid var(--section-bg);">${item.qty}</td>
                                <td style="padding: 15px; border-bottom: 1px solid var(--section-bg);">$${item.unitTotal.toLocaleString('en-US', { minimumFractionDigits: 2, maximumFractionDigits: 2 })}</td>
                                <td style="padding: 15px; border-bottom: 1px solid var(--section-bg);">$${item.total.toLocaleString('en-US', { minimumFractionDigits: 2, maximumFractionDigits: 2 })}</td>
                            </tr>
                        `).join('')}
                    </tbody>
                </table>
                
                <div style="text-align: right; margin-top: 10px; margin-bottom: 20px; padding: 10px 15px; background: var(--section-bg); border-radius: 8px; border-left: 4px solid var(--info);">
                    <p style="margin: 0; font-size: 13px; color: var(--text-secondary); font-style: italic;">
                        * Total prices include applicable shipping and tax charges
                    </p>
                </div>

                <div style="text-align: right; margin-top: 30px; padding: 25px; background: var(--warm-cream); border-radius: 12px;">
                    <div style="margin: 10px 0; font-size: 16px; color: var(--text-primary);"><strong>PRODUCT TOTAL: $${projectTotal.toLocaleString('en-US', { minimumFractionDigits: 2, maximumFractionDigits: 2 })}</strong></div>
                    <div style="margin: 10px 0; font-size: 16px; color: var(--text-primary);"><strong>AMOUNT PAID: $${(currentProject.amountPaid || 0).toLocaleString('en-US', { minimumFractionDigits: 2, maximumFractionDigits: 2 })}</strong></div>
                    <div style="font-weight: 600; font-size: 24px; color: var(--text-primary); padding-top: 15px; border-top: 2px solid var(--soft-rose);"><strong>TOTAL AMOUNT DUE: $${(projectTotal - (currentProject.amountPaid || 0)).toLocaleString('en-US', { minimumFractionDigits: 2, maximumFractionDigits: 2 })}</strong></div>
                </div>

                <div style="margin-top: 40px; padding-top: 20px; border-top: 1px solid var(--soft-rose);">
                    <p>Payment can be sent via Zelle to kellyramdesigns@gmail.com or check to Kelly Ram Designs</p>
                    <p style="margin-top: 20px; font-size: 14px;">Please note: Most products are final sale and cannot be returned</p>
                    <p style="font-size: 14px;">*All prices are subject to change</p>
                </div>
            `;
        }

        function printInvoice() {
            window.print();
        }

        function saveCurrentProject() {
            if (!currentProject) return;
            
            const index = projects.findIndex(p => p.id === currentProject.id);
            if (index !== -1) {
                projects[index] = currentProject;
                localStorage.setItem('projects', JSON.stringify(projects));
            }
        }

        // Enhanced event system
        function addEvent() {
            if (!currentProject) return;
            
            showCustomPrompt(
                'Add New Event',
                [
                    { type: 'select', name: 'type', label: 'Event Type', options: [
                        { value: 'consultation', text: 'Consultation' },
                        { value: 'design', text: 'Design' },
                        { value: 'meeting', text: 'Meeting' },
                        { value: 'delivery', text: 'Delivery' }
                    ], defaultValue: 'meeting' },
                    { type: 'text', name: 'title', label: 'Event Title', required: true },
                    { type: 'date', name: 'date', label: 'Date', required: true },
                    { type: 'time', name: 'time', label: 'Time' },
                    { type: 'textarea', name: 'notes', label: 'Event Notes' }
                ],
                (data) => {
                    if (!currentProject.events) currentProject.events = [];
                    
                    currentProject.events.push({
                        id: Date.now(),
                        type: data.type,
                        title: data.title,
                        date: data.date,
                        time: data.time || '',
                        notes: data.notes || '',
                        completed: false
                    });
                    
                    saveCurrentProject();
                    updateProjectUpcomingEvents();
                    updateUpcomingEvents();
                    showCustomAlert('Event added successfully! ‚ú®');
                }
            );
        }

        // Project-specific event management functions
        function addProjectEvent() {
            if (!currentProject) return;
            
            showCustomPrompt(
                'Add New Event',
                [
                    { type: 'select', name: 'type', label: 'Event Type', options: [
                        { value: 'consultation', text: 'Consultation' },
                        { value: 'design', text: 'Design' },
                        { value: 'meeting', text: 'Meeting' },
                        { value: 'delivery', text: 'Delivery' }
                    ], defaultValue: 'meeting', required: true },
                    { type: 'text', name: 'title', label: 'Event Title', required: true },
                    { type: 'date', name: 'date', label: 'Date', required: true },
                    { type: 'time', name: 'time', label: 'Time' },
                    { type: 'textarea', name: 'notes', label: 'Notes' }
                ],
                (data) => {
                    if (!currentProject.events) {
                        currentProject.events = [];
                    }
                    
                    currentProject.events.push({
                        id: Date.now() + Math.random(),
                        type: data.type,
                        title: data.title,
                        date: data.date,
                        time: data.time || '',
                        notes: data.notes || '',
                        completed: false
                    });
                    
                    saveCurrentProject();
                    updateProjectUpcomingEvents();
                    updateUpcomingEvents(); // Update main dashboard calendar
                    showCustomAlert('Event added successfully! ‚ú®');
                }
            );
        }

        function editProjectEvent(eventIndex) {
            if (!currentProject || !currentProject.events || !currentProject.events[eventIndex]) return;
            
            const event = currentProject.events[eventIndex];
            
            showCustomPrompt(
                'Edit Event',
                [
                    { type: 'select', name: 'type', label: 'Event Type', options: [
                        { value: 'consultation', text: 'Consultation' },
                        { value: 'design', text: 'Design' },
                        { value: 'meeting', text: 'Meeting' },
                        { value: 'delivery', text: 'Delivery' }
                    ], defaultValue: event.type || 'meeting', required: true },
                    { type: 'text', name: 'title', label: 'Event Title', defaultValue: event.title, required: true },
                    { type: 'date', name: 'date', label: 'Date', defaultValue: event.date, required: true },
                    { type: 'time', name: 'time', label: 'Time', defaultValue: event.time || '' },
                    { type: 'textarea', name: 'notes', label: 'Notes', defaultValue: event.notes || '' },
                    { type: 'checkbox', name: 'completed', label: 'Mark as completed', defaultValue: event.completed || false }
                ],
                (data) => {
                    currentProject.events[eventIndex] = {
                        ...event,
                        type: data.type,
                        title: data.title,
                        date: data.date,
                        time: data.time || '',
                        notes: data.notes || '',
                        completed: data.completed
                    };
                    
                    saveCurrentProject();
                    updateProjectUpcomingEvents();
                    updateUpcomingEvents(); // Update main dashboard calendar
                    showCustomAlert('Event updated successfully! ‚ú®');
                }
            );
        }

        function deleteProjectEvent(eventIndex) {
            if (!currentProject || !currentProject.events || !currentProject.events[eventIndex]) return;
            
            const event = currentProject.events[eventIndex];
            
            showCustomPrompt(
                'Delete Event',
                [
                    { type: 'text', name: 'confirmation', label: `Type "delete" to confirm deletion of "${event.title}"\n\nThis action cannot be undone.`, required: true, placeholder: 'Type delete' }
                ],
                (data) => {
                    if (data.confirmation.toLowerCase() !== 'delete') {
                        showCustomAlert('Please type "delete" to confirm. Event deletion cancelled.');
                        return;
                    }
                    
                    currentProject.events.splice(eventIndex, 1);
                    saveCurrentProject();
                    updateProjectUpcomingEvents();
                    updateUpcomingEvents(); // Update main dashboard calendar
                    showCustomAlert(`Event "${event.title}" deleted successfully! üóëÔ∏è`);
                }
            );
        }

        function addQuickEvent() {
            showCustomPrompt(
                'Quick Add Event',
                [
                    { type: 'select', name: 'projectId', label: 'Project', options: projects.map(p => ({ value: p.id, text: `${p.name} - ${p.client}` })), required: true },
                    { type: 'text', name: 'title', label: 'Event Title', required: true },
                    { type: 'date', name: 'date', label: 'Date', required: true },
                    { type: 'time', name: 'time', label: 'Time' }
                ],
                (data) => {
                    const project = projects.find(p => p.id == data.projectId);
                    if (!project) return;
                    
                    if (!project.events) project.events = [];
                    
                    project.events.push({
                        id: Date.now(),
                        type: 'meeting',
                        title: data.title,
                        date: data.date,
                        time: data.time || '',
                        notes: '',
                        completed: false
                    });
                    
                    localStorage.setItem('projects', JSON.stringify(projects));
                    updateUpcomingEvents();
                    showCustomAlert('Event added successfully! ‚ú®');
                }
            );
        }

        function addPaidHours() {
            if (!currentProject) return;
            
            showCustomPrompt(
                'Add Paid Hours',
                [
                    { type: 'number', name: 'hours', label: 'Additional Hours', step: '0.25', required: true, placeholder: 'e.g. 5.5' }
                ],
                (data) => {
                    const hoursToAdd = parseFloat(data.hours);
                    if (isNaN(hoursToAdd) || hoursToAdd <= 0) {
                        showCustomAlert('Please enter a valid number of hours.');
                        return;
                    }
                    
                    currentProject.hoursPaid = (currentProject.hoursPaid || 0) + hoursToAdd;
                    
                    if (!currentProject.events) currentProject.events = [];
                    currentProject.events.push({
                        id: Date.now(),
                        type: 'meeting',
                        title: 'Additional Hours Purchased',
                        date: new Date().toISOString().split('T')[0],
                        time: '',
                        notes: `Client purchased ${hoursToAdd} additional hours. Total paid hours: ${currentProject.hoursPaid}`,
                        completed: true
                    });
                    
                    saveCurrentProject();
                    updateProjectHours();
                    updateProjectUpcomingEvents();
                    displayProjects();
                    updateDashboard();
                    
                    showCustomAlert(`Added ${hoursToAdd} hours successfully! ‚ú®\nTotal paid hours: ${currentProject.hoursPaid}`);
                }
            );
        }

        // Quick action to change project status
        function changeProjectStatus() {
            if (!currentProject) return;
            
            showCustomPrompt(
                'Change Project Status',
                [
                    { type: 'select', name: 'status', label: 'New Status', options: [
                        { value: 'consultation', text: 'Consultation' },
                        { value: 'design', text: 'Design' },
                        { value: 'sourcing', text: 'Sourcing' },
                        { value: 'ordering', text: 'Ordering' },
                        { value: 'delivery', text: 'Delivery' },
                        { value: 'completed', text: 'Completed' }
                    ], defaultValue: currentProject.status, required: true }
                ],
                (data) => {
                    const oldStatus = currentProject.status;
                    currentProject.status = data.status;
                    saveCurrentProject();
                    
                    // Update the UI
                    showProjectDetails(currentProject.id);
                    updateProjectsList();
                    
                    showCustomAlert(`Project status changed from "${oldStatus}" to "${data.status}"! ‚ú®`);
                }
            );
        }

        // Toggle file management section
        function toggleFileManagement() {
            const section = document.getElementById('fileManagementSection');
            const icon = document.getElementById('fileManagementIcon');
            
            if (section.style.display === 'none' || section.style.display === '') {
                section.style.display = 'block';
                icon.innerHTML = 'üîß';
            } else {
                section.style.display = 'none';
                icon.innerHTML = '‚öôÔ∏è';
            }
        }

        // Import CSV functionality
        function importItemsCSV() {
            const input = document.createElement('input');
            input.type = 'file';
            input.accept = '.csv';
            
            input.onchange = function(e) {
                const file = e.target.files[0];
                if (!file) return;
                
                const reader = new FileReader();
                reader.onload = function(e) {
                    try {
                        const csv = e.target.result;
                        const lines = csv.split('\n').filter(line => line.trim());
                        
                        if (lines.length < 2) {
                            showCustomAlert('CSV file must have at least a header row and one data row.');
                            return;
                        }
                        
                        // Expected format: Section,Item Name,Quantity,Wholesale Price,Sell Price,Shipping,Tax,Product Link
                        const importedSections = {};
                        
                        for (let i = 1; i < lines.length; i++) {
                            const values = lines[i].split(',');
                            if (values.length >= 8) {
                                const sectionName = values[0].trim();
                                const itemName = values[1].trim();
                                const qty = parseInt(values[2]) || 1;
                                const wholesalePrice = parseFloat(values[3]) || 0;
                                const sellPrice = parseFloat(values[4]) || 0;
                                const shipping = parseFloat(values[5]) || 0;
                                const tax = parseFloat(values[6]) || 0;
                                const link = values[7] ? values[7].trim() : '';
                                
                                if (!importedSections[sectionName]) {
                                    importedSections[sectionName] = [];
                                }
                                
                                importedSections[sectionName].push({
                                    id: Date.now() + Math.random(),
                                    name: itemName,
                                    qty: qty,
                                    wholesalePrice: wholesalePrice,
                                    customerPrice: sellPrice,
                                    price: sellPrice, // Keep for backward compatibility
                                    shipping: shipping,
                                    tax: tax,
                                    link: link,
                                    readyToOrder: false,
                                    deliveryStatus: 'pending',
                                    shippingInfo: {
                                        carrier: '',
                                        trackingNumber: '',
                                        shippingMethod: '',
                                        estimatedDelivery: '',
                                        shippingCost: shipping,
                                        orderDate: '',
                                        notes: ''
                                    },
                                    orderStatus: 'pending'
                                });
                            } else {
                                console.warn(`Skipping row ${i}: insufficient columns (expected 8, got ${values.length})`);
                            }
                        }
                        
                        // Add sections to current project
                        if (!currentProject.sections) currentProject.sections = [];
                        
                        Object.keys(importedSections).forEach(sectionName => {
                            const existingSection = currentProject.sections.find(s => s.name === sectionName);
                            if (existingSection) {
                                existingSection.items.push(...importedSections[sectionName]);
                            } else {
                                currentProject.sections.push({
                                    id: Date.now() + Math.random(),
                                    name: sectionName,
                                    items: importedSections[sectionName]
                                });
                            }
                        });
                        
                        saveCurrentProject();
                        updateProjectSections();
                        showCustomAlert(`CSV imported successfully! Added ${Object.keys(importedSections).length} sections with items. ‚ú®`);
                        
                    } catch (error) {
                        showCustomAlert('Error importing CSV: ' + error.message);
                    }
                };
                reader.readAsText(file);
            };
            
            input.click();
        }
        
        // Download CSV template functionality
        function downloadCSVTemplate() {
            const csvContent = [
                "Section,Item Name,Quantity,Wholesale Price,Sell Price,Shipping,Tax,Product Link",
                "Living Room,Sofa,1,899.99,1299.99,75.00,95.00,https://example.com/sofa",
                "Living Room,Coffee Table,1,399.99,549.99,25.00,40.00,https://example.com/coffee-table",
                "Bedroom,Bed Frame,1,649.99,899.99,100.00,65.00,https://example.com/bed",
                "Bedroom,Nightstand,2,129.99,199.99,15.00,30.00,https://example.com/nightstand"
            ].join('\n');
            
            const blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' });
            const link = document.createElement('a');
            
            if (link.download !== undefined) {
                const url = URL.createObjectURL(blob);
                link.setAttribute('href', url);
                link.setAttribute('download', 'items-import-template.csv');
                link.style.visibility = 'hidden';
                document.body.appendChild(link);
                link.click();
                document.body.removeChild(link);
            }
        }

        // Download project items as CSV
        function downloadProjectItemsCSV() {
            if (!currentProject || !currentProject.sections || currentProject.sections.length === 0) {
                showCustomAlert('No items found in this project to download.');
                return;
            }
            
            // Create CSV content with all project items
            const csvRows = ['Section,Item Name,Quantity,Wholesale Price,Sell Price,Shipping,Tax,Total Wholesale,Total Sell,Product Link,Ready to Order,Order Status'];
            
            currentProject.sections.forEach(section => {
                // Skip deactivated sections
                if (section.isGrayedOut) return;
                
                if (section.items && section.items.length > 0) {
                    section.items.forEach(item => {
                        // Skip deactivated items
                        if (item.isGrayedOut) return;
                        const wholesalePrice = item.wholesalePrice || 0;
                        const sellPrice = item.customerPrice || item.price || 0;
                        const shipping = item.shipping || 0;
                        const tax = item.tax || 0;
                        const qty = item.qty || 1;
                        const totalWholesale = (wholesalePrice * qty) + (shipping * qty) + (tax * qty);
                        const totalSell = (sellPrice * qty) + (shipping * qty) + (tax * qty);
                        
                        csvRows.push([
                            section.name,
                            item.name,
                            qty,
                            wholesalePrice.toFixed(2),
                            sellPrice.toFixed(2),
                            shipping.toFixed(2),
                            tax.toFixed(2),
                            totalWholesale.toFixed(2),
                            totalSell.toFixed(2),
                            item.link || '',
                            item.readyToOrder ? 'Yes' : 'No',
                            item.orderStatus || 'pending'
                        ].join(','));
                    });
                }
            });
            
            if (csvRows.length === 1) {
                showCustomAlert('No items found in this project to download.');
                return;
            }
            
            const csvContent = csvRows.join('\n');
            const blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' });
            const link = document.createElement('a');
            
            if (link.download !== undefined) {
                const url = URL.createObjectURL(blob);
                link.setAttribute('href', url);
                link.setAttribute('download', `${currentProject.name.replace(/[^a-zA-Z0-9]/g, '_')}_items.csv`);
                link.style.visibility = 'hidden';
                document.body.appendChild(link);
                link.click();
                document.body.removeChild(link);
                
                showCustomAlert(`Downloaded ${csvRows.length - 1} items from "${currentProject.name}" successfully! üì•`);
            }
        }

        // Mood board functionality
        function updateMoodBoards() {
            if (!currentProject) return;
            
            const container = document.getElementById('moodBoardGallery');
            if (!container) return;
            
            // Rebuild the moodboards section structure
            const moodboardsContainer = document.getElementById('moodboards');
            moodboardsContainer.innerHTML = `
                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
                    <h3 style="margin: 0; color: var(--text-primary);">Mood Boards</h3>
                    <button class="btn btn-success" onclick="uploadMoodBoard()">Upload Mood Board</button>
                </div>
                <div id="moodBoardGallery">
                    <!-- Mood boards will be populated here -->
                </div>
            `;
            
            const galleryContainer = document.getElementById('moodBoardGallery');
            
            if (!currentProject.moodBoards || currentProject.moodBoards.length === 0) {
                galleryContainer.innerHTML = '<p style="color: var(--text-secondary); text-align: center; padding: 40px;">No mood boards uploaded yet. Upload your first mood board above!</p>';
                return;
            }
            
            galleryContainer.innerHTML = currentProject.moodBoards.map((moodBoard, index) => `
                <div class="card" style="margin: 15px; display: inline-block; width: 250px;">
                    <img src="${moodBoard.dataUrl}" alt="${moodBoard.name}" style="width: 100%; height: 200px; object-fit: cover; border-radius: 10px;">
                    <h4 style="margin: 10px 0 5px 0;">${moodBoard.name}</h4>
                    <p style="font-size: 12px; color: var(--text-secondary); margin: 0;">Uploaded: ${new Date(moodBoard.uploadDate).toLocaleDateString()}</p>
                    <div style="margin-top: 10px;">
                        <button class="btn btn-small btn-coral" onclick="downloadMoodBoard(${index})">Download</button>
                        <button class="btn btn-small" onclick="removeMoodBoard(${index})" style="background: #e74c3c; margin-left: 5px;">Remove</button>
                    </div>
                </div>
            `).join('');
        }

        function uploadMoodBoard() {
            if (!currentProject) return;
            
            const input = document.createElement('input');
            input.type = 'file';
            input.accept = 'image/*';
            
            input.onchange = function(e) {
                const file = e.target.files[0];
                if (!file) return;
                
                const reader = new FileReader();
                reader.onload = function(e) {
                    if (!currentProject.moodBoards) currentProject.moodBoards = [];
                    
                    currentProject.moodBoards.push({
                        id: Date.now(),
                        name: file.name,
                        dataUrl: e.target.result,
                        uploadDate: new Date().toISOString()
                    });
                    
                    saveCurrentProject();
                    updateMoodBoards();
                    showCustomAlert('Mood board uploaded successfully! ‚ú®');
                };
                reader.readAsDataURL(file);
            };
            
            input.click();
        }

        function downloadMoodBoard(index) {
            if (!currentProject || !currentProject.moodBoards[index]) return;
            
            const moodBoard = currentProject.moodBoards[index];
            const link = document.createElement('a');
            link.href = moodBoard.dataUrl;
            link.download = moodBoard.name;
            link.click();
        }

        function removeMoodBoard(index) {
            if (!currentProject || !currentProject.moodBoards[index]) return;
            
            currentProject.moodBoards.splice(index, 1);
            saveCurrentProject();
            updateMoodBoards();
            showCustomAlert('Mood board removed.');
        }

        // Reporting functions


        // Utility functions
        function duplicateProject() {
            if (projects.length === 0) {
                showCustomAlert('No projects to duplicate. Create your first project!');
                return;
            }
            
            const lastProject = projects[projects.length - 1];
            const duplicatedProject = {
                ...lastProject,
                id: Date.now(),
                name: lastProject.name + ' (Copy)',
                startDate: new Date().toISOString().split('T')[0],
                hoursWorked: 0,
                hoursLog: [],
                events: [],
                moodBoards: [],
                invoiceNumber: (++invoiceCounter).toString().padStart(6, '0'),
                amountPaid: 0
            };
            
            projects.push(duplicatedProject);
            localStorage.setItem('projects', JSON.stringify(projects));
            localStorage.setItem('invoiceCounter', invoiceCounter.toString());
            
            displayProjects();
            updateDashboard();
            
            showCustomAlert(`Project "${duplicatedProject.name}" created successfully! ‚ú®`);
        }

        // Custom modal functions
        function showCustomAlert(message) {
            const existingAlert = document.querySelector('.custom-alert');
            const existingOverlay = document.querySelector('.custom-alert-overlay');
            if (existingAlert) existingAlert.remove();
            if (existingOverlay) existingOverlay.remove();
            
            const overlay = document.createElement('div');
            overlay.className = 'custom-alert-overlay';
            
            const alertBox = document.createElement('div');
            alertBox.className = 'custom-alert';
            alertBox.innerHTML = `
                <div style="margin-bottom: 20px; color: var(--text-primary); font-size: 16px; line-height: 1.5;">${message}</div>
                <button class="btn btn-success" onclick="closeCustomAlert()">OK</button>
            `;
            
            document.body.appendChild(overlay);
            document.body.appendChild(alertBox);
            
            setTimeout(() => {
                if (document.querySelector('.custom-alert')) {
                    closeCustomAlert();
                }
            }, 3000);
        }

        function closeCustomAlert() {
            const alertBox = document.querySelector('.custom-alert');
            const overlay = document.querySelector('.custom-alert-overlay');
            if (alertBox) alertBox.remove();
            if (overlay) overlay.remove();
        }

        function showCustomPrompt(title, fields, callback) {
            const existingPrompt = document.querySelector('.custom-prompt');
            const existingOverlay = document.querySelector('.custom-prompt-overlay');
            if (existingPrompt) existingPrompt.remove();
            if (existingOverlay) existingOverlay.remove();
            
            const overlay = document.createElement('div');
            overlay.style.cssText = 'position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(45, 43, 40, 0.7); backdrop-filter: blur(5px); z-index: 1999; cursor: pointer;';
            overlay.onclick = function() {
                closeCustomPrompt();
            };
            
            const promptBox = document.createElement('div');
            promptBox.style.cssText = 'position: fixed; top: 50%; left: 50%; transform: translate(-50%, -50%); background: var(--card-bg); border: 2px solid var(--gentle-blue); border-radius: 16px; padding: 30px; box-shadow: 0 20px 60px rgba(45, 43, 40, 0.3); z-index: 2000; max-width: 500px; width: 90%; max-height: 80vh; overflow-y: auto;';
            promptBox.onclick = function(e) {
                e.stopPropagation(); // Prevent closing when clicking inside the popup
            };
            
            let fieldsHtml = '';
            fields.forEach(field => {
                if (field.type === 'select') {
                    fieldsHtml += `
                        <label style="display: block; margin-bottom: 8px; font-weight: 500; color: var(--text-primary);">${field.label}:</label>
                        <select id="prompt-${field.name}" style="width: 100%; padding: 12px; border: 2px solid var(--section-bg); border-radius: 8px; margin-bottom: 15px; font-size: 15px;">
                    `;
                    field.options.forEach(option => {
                        const selected = option.value === field.defaultValue ? 'selected' : '';
                        fieldsHtml += `<option value="${option.value}" ${selected}>${option.text}</option>`;
                    });
                    fieldsHtml += '</select>';
                } else if (field.type === 'textarea') {
                    fieldsHtml += `
                        <label style="display: block; margin-bottom: 8px; font-weight: 500; color: var(--text-primary);">${field.label}:</label>
                        <textarea id="prompt-${field.name}" rows="3" placeholder="${field.placeholder || ''}" style="width: 100%; padding: 12px; border: 2px solid var(--section-bg); border-radius: 8px; margin-bottom: 15px; font-size: 15px; font-family: inherit;">${field.defaultValue || ''}</textarea>
                    `;
                } else {
                    fieldsHtml += `
                        <label style="display: block; margin-bottom: 8px; font-weight: 500; color: var(--text-primary);">${field.label}:</label>
                        <input type="${field.type}" id="prompt-${field.name}" ${field.step ? 'step="' + field.step + '"' : ''} ${field.required ? 'required' : ''} placeholder="${field.placeholder || ''}" value="${field.defaultValue || ''}" style="width: 100%; padding: 12px; border: 2px solid var(--section-bg); border-radius: 8px; margin-bottom: 15px; font-size: 15px;">
                    `;
                }
            });
            
            promptBox.innerHTML = `
                <h3 style="margin-top: 0; color: var(--text-primary); text-align: center; margin-bottom: 20px;">${title}</h3>
                ${fieldsHtml}
                <div style="display: flex; gap: 15px; justify-content: center; margin-top: 20px;">
                    <button class="btn btn-success" onclick="submitCustomPrompt()">Submit</button>
                    <button class="btn" onclick="closeCustomPrompt()">Cancel</button>
                </div>
            `;
            
            window.currentPromptCallback = callback;
            
            document.body.appendChild(overlay);
            document.body.appendChild(promptBox);
            
            const firstInput = promptBox.querySelector('input, select, textarea');
            if (firstInput) {
                setTimeout(() => firstInput.focus(), 100);
            }
        }

        function submitCustomPrompt() {
            const promptBox = document.querySelector('[style*="position: fixed"][style*="z-index: 2000"]');
            const data = {};
            
            const inputs = promptBox.querySelectorAll('input, select, textarea');
            inputs.forEach(input => {
                const fieldName = input.id.replace('prompt-', '');
                data[fieldName] = input.value;
            });
            
            let hasError = false;
            inputs.forEach(input => {
                if (input.hasAttribute('required') && !input.value.trim()) {
                    input.style.borderColor = '#e74c3c';
                    hasError = true;
                } else {
                    input.style.borderColor = 'var(--soft-rose)';
                }
            });
            
            if (hasError) {
                showCustomAlert('Please fill in all required fields.');
                return;
            }
            
            if (window.currentPromptCallback) {
                window.currentPromptCallback(data);
                window.currentPromptCallback = null;
            }
            
            closeCustomPrompt();
        }

        function closeCustomPrompt() {
            const promptBox = document.querySelector('[style*="position: fixed"][style*="z-index: 2000"]');
            const overlay = document.querySelector('[style*="position: fixed"][style*="z-index: 1999"]');
            if (promptBox) promptBox.remove();
            if (overlay) overlay.remove();
            window.currentPromptCallback = null;
        }

        // Initialize
        document.addEventListener('DOMContentLoaded', function() {
            // Migrate old project data format
            migrateOldProjects();
            
            document.getElementById('startDate').valueAsDate = new Date();
            // Removed hours form initialization since Hours section was removed
            
            displayProjects();
            updateDashboard();
            updateUpcomingEvents();
        });
        
        // Logo upload functionality
        function uploadCompanyLogo() {
            const input = document.createElement('input');
            input.type = 'file';
            input.accept = 'image/*';
            
            input.onchange = function(e) {
                const file = e.target.files[0];
                if (!file) return;
                
                // Check file size (limit to 2MB)
                if (file.size > 2 * 1024 * 1024) {
                    showCustomAlert('Logo file size must be less than 2MB.');
                    return;
                }
                
                const reader = new FileReader();
                reader.onload = function(e) {
                    const logoData = e.target.result;
                    localStorage.setItem('companyLogo', logoData);
                    showCustomAlert('Logo uploaded successfully! It will appear on all future invoices. ‚ú®');
                };
                reader.readAsDataURL(file);
            };
            
            input.click();
        }
    </script>
</body>
</html>